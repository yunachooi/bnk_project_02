<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>회원가입</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Noto Sans KR", Arial, sans-serif; padding:16px; }
    h2 { margin: 8px 0 16px; }
    label { display:inline-block; margin:8px 0; }
    input, select, button { font-size:16px; padding:8px; }
    .msg-error { color:#d32f2f; margin-top:6px; }
    .msg-ok { color:#2e7d32; margin-top:6px; }
  </style>
</head>
<body>

<a th:href="@{/}">&lt;뒤로가기</a>
<h2>회원가입</h2>

<form id="signForm" th:action="@{/user/signup}" th:object="${userDto}" method="post" autocomplete="off">

  <!-- ID -->
  <div>
    <label>ID :
      <input th:field="*{uid}" id="uid"
             inputmode="latin" lang="en"
             autocomplete="off" autocapitalize="off" spellcheck="false"
             pattern="[A-Za-z0-9._-]{3,50}" />
      <button type="button" id="dupBtn">중복확인</button>
    </label>
    <div th:if="${#fields.hasErrors('uid')}" th:errors="*{uid}" class="msg-error"></div>
    <div id="uidCheckMsg" style="margin-top:5px;"></div>
  </div>

  <!-- PW -->
  <div>
    <label>PW :
      <input type="password" th:field="*{upw}" id="pw"
             inputmode="latin" lang="en"
             autocomplete="off" autocapitalize="off" spellcheck="false" />
    </label>
    <div th:if="${#fields.hasErrors('upw')}" th:errors="*{upw}" class="msg-error"></div>
  </div>

  <!-- PW 확인 -->
  <div>
    <label>PW 확인 :
      <input type="password" id="pw2"
             inputmode="latin" lang="en"
             autocomplete="off" autocapitalize="off" spellcheck="false" />
    </label>
    <div id="pwErr" class="msg-error"></div>
  </div>

  <!-- 이름 -->
  <div>
    <label>이름 :
      <input th:field="*{uname}"
             inputmode="latin" lang="en"
             autocomplete="off" autocapitalize="off" spellcheck="false" />
    </label>
    <div th:if="${#fields.hasErrors('uname')}" th:errors="*{uname}" class="msg-error"></div>
  </div>

  <!-- 생년월일 (드롭다운) -->
  <div>
    <span>생년월일 :</span>
    <select id="year"><option value="">YYYY</option>
      <th:block th:each="y : ${#numbers.sequence(1950, T(java.time.Year).now().value)}">
        <option th:value="${y}" th:text="${y}"></option>
      </th:block>
    </select>
    <select id="month"><option value="">MM</option>
      <th:block th:each="m : ${#numbers.sequence(1,12)}">
        <option th:value="${m < 10 ? '0'+m : m}" th:text="${m < 10 ? '0'+m : m}"></option>
      </th:block>
    </select>
    <select id="day"><option value="">DD</option>
      <th:block th:each="d : ${#numbers.sequence(1,31)}">
        <option th:value="${d < 10 ? '0'+d : d}" th:text="${d < 10 ? '0'+d : d}"></option>
      </th:block>
    </select>

    <input type="hidden" th:field="*{ubirth}" id="ubirth"/>
    <div th:if="${#fields.hasErrors('ubirth')}" th:errors="*{ubirth}" class="msg-error"></div>
  </div>

  <!-- 휴대폰 -->
  <div>
    <label>휴대폰 :
      <!-- 숫자패드 대신 QWERTY를 원하므로 tel/type 미사용 -->
      <input th:field="*{uphone}"
             inputmode="latin" lang="en"
             autocomplete="off" autocapitalize="off" spellcheck="false" />
    </label>
    <div th:if="${#fields.hasErrors('uphone')}" th:errors="*{uphone}" class="msg-error"></div>
  </div>

  <!-- 성별 -->
  <div>
    <span>성별 :</span>
    <label><input type="radio" th:field="*{ugender}" value="M"/> Male</label>
    <label><input type="radio" th:field="*{ugender}" value="F"/> Female</label>
    <div th:if="${#fields.hasErrors('ugender')}" th:errors="*{ugender}" class="msg-error"></div>
  </div>

  <!-- 관심통화 -->
  <div>
    <span>관심통화 :</span>
    <label><input type="checkbox" th:field="*{ucurrency}" value="USD"/> USD</label>
    <label><input type="checkbox" th:field="*{ucurrency}" value="EUR"/> EUR</label>
    <label><input type="checkbox" th:field="*{ucurrency}" value="JPY"/> JPY</label>
    <label><input type="checkbox" th:field="*{ucurrency}" value="CHF"/> CHF</label>
    <label><input type="checkbox" th:field="*{ucurrency}" value="CNY"/> CNY</label>
    <label><input type="checkbox" th:field="*{ucurrency}" value="VND"/> VND</label>
  </div>

  <!-- 관심분야 -->
  <div>
    <span>관심분야 :</span>
    <label><input type="checkbox" th:field="*{uinterest}" value="여행"/> 여행</label>
    <label><input type="checkbox" th:field="*{uinterest}" value="재테크"/> 재테크</label>
    <label><input type="checkbox" th:field="*{uinterest}" value="유학"/> 유학</label>
    <label><input type="checkbox" th:field="*{uinterest}" value="쇼핑"/> 쇼핑</label>
    <label><input type="checkbox" th:field="*{uinterest}" value="기타"/> 기타</label>
  </div>

  <button type="submit">가입하기</button>
</form>

<p><a th:href="@{/user/login}">이미 계정이 있나요? 로그인</a></p>

<!-- ✅ JavaScript -->
<script>
  // 페이지 로드시 ID에 포커스(웹뷰에서 키보드 바로 띄우기)
  window.addEventListener('load', () => {
    const uid = document.getElementById('uid');
    if (uid) uid.focus();
  });

  // 제로폭 문자 정규식
  const ZERO_WIDTH = /[\u200B\u200C\u200D\uFEFF]/g;

  // 비밀번호 일치 검증
  const pw  = document.getElementById('pw');
  const pw2 = document.getElementById('pw2');
  const pwErr = document.getElementById('pwErr');

  function validatePw() {
    if (!pw.value || !pw2.value) { pwErr.textContent=''; return false; }
    if (pw.value === pw2.value)  { pwErr.textContent=''; return true; }
    pwErr.textContent = '비밀번호가 일치하지 않습니다.'; return false;
  }
  pw.addEventListener('input', validatePw);
  pw2.addEventListener('input', validatePw);

  // 제출 전 정리 & 생년월일 합치기
  document.getElementById('signForm').addEventListener('submit', (e) => {
    if (!validatePw()) { e.preventDefault(); pw2.focus(); return; }

    // uid 정규화: 제로폭 제거 + trim + 소문자 통일(로그인과 동일 규칙)
    const uidInput = document.getElementById('uid');
    uidInput.value = (uidInput.value || '')
      .replace(ZERO_WIDTH, '')
      .trim()
      .toLowerCase();

    // 비밀번호도 제로폭/공백 제거
    pw.value  = (pw.value  || '').replace(ZERO_WIDTH, '').trim();
    pw2.value = (pw2.value || '').replace(ZERO_WIDTH, '').trim();

    // 생년월일 합치기
    const y = document.getElementById('year').value;
    const m = document.getElementById('month').value;
    const d = document.getElementById('day').value;
    if (y && m && d) document.getElementById('ubirth').value = y + m + d;
  });

  // 아이디 중복확인
  document.getElementById('dupBtn').addEventListener('click', () => {
    const msgDiv = document.getElementById('uidCheckMsg');
    let uid = document.getElementById('uid').value;
    uid = (uid || '').replace(ZERO_WIDTH, '').trim().toLowerCase(); // 서버 조회와 동일 규칙
    if (!uid) {
      msgDiv.textContent = '아이디를 입력하세요.';
      msgDiv.className = 'msg-error';
      return;
    }

    fetch(`/user/check-uid?uid=${encodeURIComponent(uid)}`)
      .then(res => res.text())
      .then(msg => {
        msgDiv.textContent = msg;
        msgDiv.className = msg.includes('사용 가능') ? 'msg-ok' : 'msg-error';
      })
      .catch(() => {
        msgDiv.textContent = '확인 중 오류가 발생했습니다.';
        msgDiv.className = 'msg-error';
      });
  });
</script>

</body>
</html>