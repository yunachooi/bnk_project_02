<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>회원가입 1/3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" th:href="@{/css/user.css}">
</head>
<body class="signup">
  <div class="container">
    <header class="page-top">
      <a th:href="@{/}" aria-label="이전 페이지로 이동">&lt;뒤로가기</a>
      <span></span>
    </header>

    <div class="stepper" th:insert="~{fragments/stepper :: stepper(current=1)}"></div>
    <h1 class="title">회원가입</h1>

    <!-- 서버 검증 전제: novalidate 유지(브라우저 기본 검증 off) -->
    <form th:action="@{/user/signup/step1}" th:object="${userDto}" method="post" class="form" novalidate>

      <!-- ID + 중복확인 -->
      <div class="field">
        <label for="uid">ID</label>
        <div class="row">
          <input th:field="*{uid}" id="uid" class="input" autocomplete="off" th:errorclass="th-invalid" />
          <button type="button" id="btnCheckUid" class="btn">중복확인</button>
        </div>
        <p id="uidMsg" class="err"></p>
        <!-- 서버 검증 메시지 -->
        <p id="err-uid" class="err"
           th:text="${#fields.hasErrors('uid')} ? ${#fields.errors('uid')[0]} : ''"></p>
      </div>

      <!-- PW -->
      <div class="field">
        <label for="upw">PW</label>
        <input th:field="*{upw}" id="upw" type="password" class="input"
               placeholder="대문자·특수문자 포함 8자 이상" th:errorclass="th-invalid" />
        <p id="err-upw" class="err"
           th:text="${#fields.hasErrors('upw')} ? ${#fields.errors('upw')[0]} : ''"></p>
      </div>

      <!-- PW 확인 -->
      <div class="field">
        <label for="confirmUpw">PW 확인</label>
        <input th:field="*{confirmUpw}" id="confirmUpw" type="password" class="input" th:errorclass="th-invalid" />
        <!-- 전역(비번 불일치 등) 서버 에러 -->
        <p id="err-global" class="err"
           th:text="${#fields.hasGlobalErrors()} ? ${#fields.globalErrors()[0]} : ''"></p>
        <p id="err-confirmUpw" class="err"
           th:text="${#fields.hasErrors('confirmUpw')} ? ${#fields.errors('confirmUpw')[0]} : ''"></p>
      </div>

      <!-- 이름 -->
      <div class="field">
        <label for="uname">이름</label>
        <input th:field="*{uname}" id="uname" class="input" th:errorclass="th-invalid" />
        <p id="err-uname" class="err"
           th:text="${#fields.hasErrors('uname')} ? ${#fields.errors('uname')[0]} : ''"></p>
      </div>

      <!-- 주민등록번호 -->
      <div class="field">
        <label>주민등록번호</label>
        <div class="row row-rrn">
          <!-- UI 보조용 maxlength만 유지(검증은 서버) -->
          <input th:field="*{rrnFront}" class="input" maxlength="6" placeholder="생년월일" inputmode="numeric" th:errorclass="th-invalid" />
          <span class="sep">-</span>
          <input th:field="*{rrnBack}" class="input" maxlength="7" placeholder="뒷자리" inputmode="numeric" th:errorclass="th-invalid" />
        </div>
        <p id="err-rrnFront" class="err"
           th:text="${#fields.hasErrors('rrnFront')} ? ${#fields.errors('rrnFront')[0]} : ''"></p>
        <p id="err-rrnBack" class="err"
           th:text="${#fields.hasErrors('rrnBack')} ? ${#fields.errors('rrnBack')[0]} : ''"></p>
      </div>

      <!-- 휴대전화 -->
      <div class="field">
        <label for="uphone">휴대전화</label>
        <input th:field="*{uphone}" id="uphone" class="input"
               placeholder="010-0000-0000" inputmode="tel" th:errorclass="th-invalid" />
        <p id="err-uphone" class="err"
           th:text="${#fields.hasErrors('uphone')} ? ${#fields.errors('uphone')[0]} : ''"></p>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-cta" aria-label="다음 단계로 이동">다 음</button>
      </div>
    </form>
  </div>

  <!-- ID 중복확인(UX용) & 입력 시 메시지 초기화 -->
  <script>
    (function () {
      const btn = document.getElementById('btnCheckUid');
      const uidInput = document.getElementById('uid');
      const uidMsgEl = document.getElementById('uidMsg');

      uidInput?.addEventListener('input', () => {
        uidMsgEl.textContent = '';
        uidMsgEl.classList.remove('ok');
      });

      btn?.addEventListener('click', async () => {
        const uid = (uidInput.value || '').trim();
        if (!uid) {
          uidMsgEl.textContent = 'ID를 입력하세요.';
          uidMsgEl.classList.remove('ok');
          return;
        }
        try {
          const res = await fetch(`/user/check-uid?uid=${encodeURIComponent(uid)}`, { cache: 'no-store' });
          const text = await res.text();
          const ok = /사용\s*가능한\s*아이디입니다/.test(text);
          uidMsgEl.textContent = text;
          uidMsgEl.classList.toggle('ok', ok);
        } catch (e) {
          uidMsgEl.textContent = '중복 확인 실패. 잠시 후 다시 시도하세요.';
          uidMsgEl.classList.remove('ok');
        }
      });
    })();
  </script>
</body>
</html>