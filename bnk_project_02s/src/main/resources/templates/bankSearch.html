<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="origin-when-cross-origin">
  <title>BNK ÏßÄÏ†ê/ÎîîÏßÄÌÑ∏ ÏßÄÎèÑ</title>

  <style>
    :root{
      --ink:#1f2937; --muted:#6b7280; --border:#e5e7eb; --bg:#fff;
      --bar:#f3f4f6;
      --branch:#d81b60; --digital:#14b8a6;
      --card:#ffffff; --wash:#fafafa; --accent:#111827;
      --radius:12px; --shadow:0 1px 0 rgba(0,0,0,.04); --shadow-lg:0 8px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;color:var(--ink);background:var(--bg)}
    .wrap{max-width:min(1200px, 100vw);margin:0 auto;padding:12px 16px 28px}
    .bar{background:var(--bar);text-align:center;border-radius:8px;padding:10px 0;font-weight:800;margin-bottom:10px}
    .lang-bar{display:flex;gap:8px;justify-content:flex-end;margin:0 0 10px 0}
    .layout{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 768px){ .layout{grid-template-columns: minmax(420px, 1.15fr) minmax(360px, .85fr)} }
    .card{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;background:#fff;box-shadow:var(--shadow)}
    #map{height:clamp(320px, 40vh, 520px);width:100%}
    @media (min-width: 768px){
      #map{height:clamp(520px, 70vh, 760px)} .map-card{position:sticky; top:12px}
    }
    .legend{display:flex;gap:10px;padding:8px 12px;color:var(--muted);font-size:13px;border-top:1px solid var(--border);align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px}.dot{width:12px;height:12px;border-radius:999px;display:inline-block}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px}
    .cta{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:12px;background:#fff;cursor:pointer;border:1px solid var(--border);font-weight:800;transition:.2s ease;text-align:center}
    .cta.active{outline:2px solid var(--accent)} .cta:hover{box-shadow:var(--shadow-lg)}
    .sub{display:block;font-size:12px;color:var(--muted);font-weight:600}
    .search{grid-column:1/-1;display:flex;gap:8px}
    .search input{flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:14px}
    .list-card{border-top:1px solid var(--border);background:#fff}
    .list-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#fff}
    .list{display:flex;flex-direction:column}
    .item{border-bottom:1px solid var(--border);padding:12px;background:#fff;transition:background .15s ease}
    .item:last-child{border-bottom:none}.item:hover{background:#fcfcfc}
    .i-name{font-weight:800;display:flex;align-items:center;gap:6px;justify-content:space-between}
    .i-addr,.i-phone{font-size:13px;color:var(--muted);margin-top:3px}
    .badge{display:inline-block;font-size:11px;font-weight:800;padding:3px 8px;border-radius:999px;background:var(--digital);color:#fff;margin-left:6px}
    .badge.hq{background:#111827}
    .empty{padding:20px;color:var(--muted);text-align:center;background:#fafafa;white-space:pre-line}
    .row-actions{display:flex;gap:8px;margin-top:8px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:700;font-size:13px}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .pager{display:flex;gap:6px;justify-content:center;align-items:center;padding:12px;border-top:1px solid var(--border);background:#fff;flex-wrap:wrap}
    .pg-btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700;font-size:14px}
    .pg-btn[disabled]{opacity:.4;cursor:not-allowed}
    .pg-info{font-size:13px;color:var(--muted);padding:0 6px}
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa3af; --border:#242a33; --bar:#0f1720; }
      .card{background:#0e141b}.item:hover{background:#0d131a}
    }

    /* ===== BNK InfoWindow Ïπ¥Îìú ===== */
    .bnk-infowin{position:relative; min-width:260px; max-width:320px; font-size:14px; line-height:1.35}
    .bnk-infowin .head{display:flex; align-items:center; gap:10px; margin-bottom:6px}
    .bnk-infowin .logo{width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
      font-weight:900; font-size:11px; color:#fff; background:var(--branch); box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .bnk-infowin .title{font-weight:900; font-size:15px; display:flex; align-items:center; gap:6px; flex:1}
    .bnk-infowin .badge{background:var(--digital); color:#fff; font-weight:800; font-size:11px; padding:2px 8px; border-radius:999px}
    .bnk-infowin .badge.hq{background:#111827}
    .bnk-infowin .meta{display:grid; gap:3px; margin:8px 0 10px; color:var(--muted)}
    .bnk-infowin .meta-row{display:flex; gap:8px}
    .bnk-infowin .meta .ico{width:18px; text-align:center; opacity:.75}
    .bnk-infowin .actions{display:flex; gap:8px; margin-top:8px}
    .bnk-infowin .btn{border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 12px;
      cursor:pointer; font-weight:800; font-size:13px; flex:1}
    .bnk-infowin .btn:hover{box-shadow:var(--shadow-lg)}
    .bnk-infowin .btn.primary{background:#2563eb; color:#fff; border-color:#2563eb}
    .bnk-infowin .close{
      position:absolute; top:8px; right:8px; width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
      border:1px solid var(--border); background:#fff; cursor:pointer; font-weight:800;
    }
    .bnk-infowin .close:hover{box-shadow:var(--shadow-lg)}
    .bnk-infowin{transform:translateY(2px); opacity:.98; animation:bnk-pop .14s ease-out}
    @keyframes bnk-pop{from{transform:translateY(6px); opacity:.0} to{transform:translateY(2px); opacity:.98}}
    @media (prefers-color-scheme: dark){
      .bnk-infowin .btn{background:#0e141b}
      .bnk-infowin .btn.primary{color:#fff}
      .bnk-infowin .close{background:#0e141b}
    }
  </style>

  <script>
    /* ========== i18n ÏÇ¨Ï†Ñ ========== */
    const I18N = {
      ko: {
        title: 'ÏòÅÏóÖÏ†ê Ï∞æÍ∏∞',
        tabBranch: 'üè¶ ÏßÄÏ†ê',
        tabBranchSub: 'Î™®Îì† Î∂ÄÏÇ∞ÏùÄÌñâ ÏßÄÏ†ê',
        tabDigital: 'üíª ÎîîÏßÄÌÑ∏ Îç∞Ïä§ÌÅ¨ ÏßÄÏ†ê',
        tabDigitalSub: 'ÏòÅÏÉÅÏó∞Í≤∞Î°ú ÏóÖÎ¨¥ Í∞ÄÎä•',
        legendBranch: 'ÏßÄÏ†ê',
        legendDigital: 'ÎîîÏßÄÌÑ∏',
        searchPH: 'ÏßÄÏ†êÎ™Ö¬∑Ï£ºÏÜå¬∑Ï†ÑÌôîÎ°ú Í≤ÄÏÉâ',
        listTitle: 'ÏßÄÏ†ê Î¶¨Ïä§Ìä∏',
        badgeDigital: 'ÎîîÏßÄÌÑ∏',
        badgeHQ: 'Î≥∏Ï†ê',
        btnViewOnMap: 'ÏßÄÎèÑÏóêÏÑú Î≥¥Í∏∞',
        btnDirections: 'ÎÑ§Ïù¥Î≤Ñ Í∏∏Ï∞æÍ∏∞',
        empty: 'ÌëúÏãúÌï† ÏßÄÏ†êÏù¥ ÏóÜÏäµÎãàÎã§.',
        pageFirst: '¬´ Ï≤òÏùå', pagePrev: '‚Äπ Ïù¥Ï†Ñ', pageNext: 'Îã§Ïùå ‚Ä∫', pageLast: 'ÎÅù ¬ª',
        pageInfo: (cur,pages)=>`${cur} / ${pages} ÌéòÏù¥ÏßÄ`,
        countLabel: (s,e,t)=>`ÌëúÏãú: ${s}-${e} / ${t}Í∞ú`,
        hqTitle: 'BNK Î≥∏Ï†ê',
        centerCoord: (lat,lng)=>`Ï§ëÏã¨ Ï¢åÌëú: ${lat}, ${lng}`
      },
      en: {
        title: 'Find Branches',
        tabBranch: 'üè¶ Branches',
        tabBranchSub: 'All BNK branches',
        tabDigital: 'üíª Digital Desk',
        tabDigitalSub: 'Video-assisted services',
        legendBranch: 'Branch',
        legendDigital: 'Digital',
        searchPH: 'Search by name, address, phone',
        listTitle: 'Branch List',
        badgeDigital: 'Digital',
        badgeHQ: 'HQ',
        btnViewOnMap: 'Show on Map',
        btnDirections: 'Directions (Naver)',
        empty: 'No branches to display.',
        pageFirst: '¬´ First', pagePrev: '‚Äπ Prev', pageNext: 'Next ‚Ä∫', pageLast: 'Last ¬ª',
        pageInfo: (cur,pages)=>`${cur} / ${pages} pages`,
        countLabel: (s,e,t)=>`Showing: ${s}-${e} of ${t}`,
        hqTitle: 'BNK Headquarters',
        centerCoord: (lat,lng)=>`Center: ${lat}, ${lng}`
      },
      ja: {
        title: 'ÊîØÂ∫óÊ§úÁ¥¢',
        tabBranch: 'üè¶ ÊîØÂ∫ó',
        tabBranchSub: 'BNKÂÖ®ÊîØÂ∫ó',
        tabDigital: 'üíª „Éá„Ç∏„Çø„É´„Éá„Çπ„ÇØ',
        tabDigitalSub: '„Éì„Éá„Ç™Áõ∏Ë´áÂØæÂøú',
        legendBranch: 'ÊîØÂ∫ó',
        legendDigital: '„Éá„Ç∏„Çø„É´',
        searchPH: 'ÊîØÂ∫óÂêç„Éª‰ΩèÊâÄ„ÉªÈõªË©±„ÅßÊ§úÁ¥¢',
        listTitle: 'ÊîØÂ∫ó„É™„Çπ„Éà',
        badgeDigital: '„Éá„Ç∏„Çø„É´',
        badgeHQ: 'Êú¨Â∫ó',
        btnViewOnMap: 'Âú∞Âõ≥„ÅßË°®Á§∫',
        btnDirections: 'ÁµåË∑ØÊ°àÂÜÖÔºàNAVERÔºâ',
        empty: 'Ë°®Á§∫„Åô„ÇãÊîØÂ∫ó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
        pageFirst: '¬´ ÊúÄÂàù', pagePrev: '‚Äπ Ââç', pageNext: 'Ê¨° ‚Ä∫', pageLast: 'ÊúÄÂæå ¬ª',
        pageInfo: (cur,pages)=>`${cur} / ${pages} „Éö„Éº„Ç∏`,
        countLabel: (s,e,t)=>`Ë°®Á§∫Ôºö${s}-${e} / ${t}`,
        hqTitle: 'BNK Êú¨Â∫ó',
        centerCoord: (lat,lng)=>`‰∏≠ÂøÉÂ∫ßÊ®ôÔºö${lat}, ${lng}`
      },
      zh: {
        title: 'ÁΩëÁÇπÊü•ËØ¢',
        tabBranch: 'üè¶ ÁΩëÁÇπ',
        tabBranchSub: 'BNKÂÖ®ÈÉ®ÁΩëÁÇπ',
        tabDigital: 'üíª Êï∞Â≠óÊüúÂè∞',
        tabDigitalSub: 'ÊîØÊåÅËßÜÈ¢ëÊúçÂä°',
        legendBranch: 'ÁΩëÁÇπ',
        legendDigital: 'Êï∞Â≠ó',
        searchPH: 'ÊåâÂêçÁß∞/Âú∞ÂùÄ/ÁîµËØùÊêúÁ¥¢',
        listTitle: 'ÁΩëÁÇπÂàóË°®',
        badgeDigital: 'Êï∞Â≠ó',
        badgeHQ: 'ÊÄªË°å',
        btnViewOnMap: 'Âú®Âú∞Âõæ‰∏äÊü•Áúã',
        btnDirections: 'Ë∑ØÁ∫øÔºàNAVERÔºâ',
        empty: 'ÊöÇÊó†ÂèØÊòæÁ§∫ÁöÑÁΩëÁÇπ„ÄÇ',
        pageFirst: '¬´ È¶ñÈ°µ', pagePrev: '‚Äπ ‰∏ä‰∏ÄÈ°µ', pageNext: '‰∏ã‰∏ÄÈ°µ ‚Ä∫', pageLast: 'Êú´È°µ ¬ª',
        pageInfo: (cur,pages)=>`${cur} / ${pages} È°µ`,
        countLabel: (s,e,t)=>`ÊòæÁ§∫Ôºö${s}-${e} / ÂÖ±${t}`,
        hqTitle: 'BNK ÊÄªË°å',
        centerCoord: (lat,lng)=>`‰∏≠ÂøÉÂùêÊ†áÔºö${lat}, ${lng}`
      }
    };

    // ÌòÑÏû¨ Ïñ∏Ïñ¥
    const DEFAULT_LANG = (() => {
      try{
        const saved = localStorage.getItem('bnk.lang');
        if (saved && I18N[saved]) return saved;
      }catch(e){}
      const n = (navigator.language||'ko').slice(0,2).toLowerCase();
      return (n==='en'||n==='ja'||n==='zh') ? n : 'ko';
    })();
    let CUR_LANG = DEFAULT_LANG;

    // ‚úÖ Ìï≠ÏÉÅ "Î¨∏ÏûêÏó¥"ÏùÑ Î∞òÌôòÌïòÎäî t()
    const t = (key, ...args) => {
      const pack = I18N[CUR_LANG] || I18N.ko || {};
      let val = pack[key];
      if (val === undefined && I18N.ko) val = I18N.ko[key]; // ko Ìè¥Î∞±
      if (typeof val === 'function') return val(...args);
      return (val ?? String(key));
    };

    /* ===== Ïú†Ìã∏ ===== */
    function escapeHtml(str){ return String(str ?? '').replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c])); }
    function jsStr(s){ return String(s ?? '').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
    function num(v){ const n = parseFloat(v); return Number.isFinite(n) ? n : null; }

    /* ===== API_BASE Í≤∞Ï†ï ===== */
    const API_BASE = (() => {
      const p = new URLSearchParams(location.search).get('api');
      if (p) return p.replace(/\/+$/,'');
      if (/^https?:/i.test(location.protocol)) return '';
      return 'http://10.0.2.2:8093';
    })();

    /* ===== ÏÉÅÌÉú ===== */
    const DEFAULT_CENTER = { lat: 35.1454909, lng: 129.0658220 };
    let map, all = [], filtered = [], markers = [], infoWindows = [];
    let filter = 'branch', currentPage = 1, PAGE_SIZE = 15, searchTerm = '';

    /* ===== Ïù∏Ï¶ù Ïã§Ìå® ÏΩúÎ∞± ===== */
    window.navermap_authFailure = function () {
      alert('ÎÑ§Ïù¥Î≤Ñ ÏßÄÎèÑ Ïù∏Ï¶ù Ïã§Ìå®\n- Web ÏÑúÎπÑÏä§ URLÏóê Ïù¥ Ïò§Î¶¨ÏßÑ Îì±Î°ù ÌïÑÏöî: ' + location.origin +
            '\n- ÏóêÎÆ¨Î†àÏù¥ÌÑ∞/Ïã§Í∏∞Í∏∞ Ïò§Î¶¨ÏßÑÏù¥ Îã§Î•¥Î©¥ Í∞ÅÏûê Îì±Î°ù\n- ÌÇ§Îäî ncpKeyId ÏÇ¨Ïö© Ï§ë');
    };

    /* ===== ÏïÑÏù¥ÏΩò ===== */
    const iconHtmlHQ = `
      <div style="transform:translate(-50%,-50%);display:grid;place-items:center">
        <div style="width:40px;height:40px;border-radius:999px;background:#111827;border:2px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.2);color:#fff;font-weight:900;font-size:11px;display:flex;align-items:center;justify-content:center;">BNK</div>
      </div>`;
    const iconHtml = (isDigital) => `
      <div style="transform:translate(-50%,-50%);display:grid;place-items:center">
        <div style="width:36px;height:36px;border-radius:999px;background:${isDigital ? 'var(--digital)' : 'var(--branch)'};border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.18);color:#fff;font-weight:900;font-size:11px;display:flex;align-items:center;justify-content:center;">BNK</div>
      </div>`;

    /* ===== Í∏∏Ï∞æÍ∏∞ ===== */
    function openNaverDirections(name, lat, lng){
      const dname = encodeURIComponent(name || 'Î™©Ï†ÅÏßÄ');
      const appUrl = `nmap://route/public?dlat=${lat}&dlng=${lng}&dname=${dname}&appname=bnk.forex`;
      const webUrl = `https://map.naver.com/v5/directions/-/${lng},${lat}`;
      try{
        if (window.NAVER && typeof window.NAVER.postMessage === 'function') {
          window.NAVER.postMessage(JSON.stringify({ type: 'openUrl', url: appUrl, fallback: webUrl }));
          return;
        }
      }catch(e){}
      const timer = setTimeout(()=>{ window.open(webUrl, '_blank'); }, 700);
      window.location.href = appUrl;
      window.addEventListener('pagehide', ()=>clearTimeout(timer), { once:true });
    }

    /* ===== Í≥µÌÜµ: Î™®Îì† Ïù∏Ìè¨ÏúàÎèÑÏö∞ Îã´Í∏∞ ===== */
    function closeAllInfo(){
      infoWindows.forEach(w => { try{ w.close(); }catch(e){} });
      if (hqInfo) { try{ hqInfo.close(); }catch(e){} }
    }

    /* ===== Î≥∏Ï†ê ÎßàÏª§ ===== */
    let hqMarker=null, hqInfo=null;
    function ensureHQMarker(){
      if (!map) return;
      if (!hqMarker) {
        const pos = new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng);
        hqMarker = new naver.maps.Marker({ position: pos, map, icon: { content: iconHtmlHQ }, zIndex: 500 });
        updateHQInfoWindow();
        naver.maps.Event.addListener(hqMarker, 'click', () => { closeAllInfo(); hqInfo.open(map, hqMarker); });
      } else {
        updateHQInfoWindow();
        hqMarker.setMap(map);
      }
    }
    function updateHQInfoWindow(){
      const html = `
        <div class="bnk-infowin">
          <button class="close" onclick="closeAllInfo()" aria-label="Îã´Í∏∞">√ó</button>
          <div class="head">
            <div class="logo" style="background:#111827">BNK</div>
            <div class="title">${t('hqTitle')} <span class="badge hq">${t('badgeHQ')}</span></div>
          </div>
          <div class="meta">
            <div class="meta-row"><span class="ico">üìç</span><span>${t('centerCoord', DEFAULT_CENTER.lat, DEFAULT_CENTER.lng)}</span></div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="openNaverDirections('${jsStr(t('hqTitle'))}', ${DEFAULT_CENTER.lat}, ${DEFAULT_CENTER.lng})">${t('btnDirections')}</button>
          </div>
        </div>`;
      if (!hqInfo) hqInfo = new naver.maps.InfoWindow({ content: html });
      else hqInfo.setContent(html);
    }

    /* ===== Îã§Íµ≠Ïñ¥ UI Î∞òÏòÅ ===== */
    function applyLangToStaticUI(){
      const bar = document.querySelector('.bar'); if (bar) bar.textContent = t('title');
      const btnBranch = document.getElementById('btn-branch');
      const btnDigital = document.getElementById('btn-digital');
      if (btnBranch) btnBranch.innerHTML = `${t('tabBranch')} <span class="sub">${t('tabBranchSub')}</span>`;
      if (btnDigital) btnDigital.innerHTML = `${t('tabDigital')} <span class="sub">${t('tabDigitalSub')}</span>`;
      const q = document.getElementById('q'); if (q) q.placeholder = t('searchPH');
      const listTitle = document.querySelector('.list-title'); if (listTitle) listTitle.textContent = t('listTitle');
      const legendBranch = document.getElementById('legend-branch');
      const legendDigital = document.getElementById('legend-digital');
      if (legendBranch) legendBranch.textContent = t('legendBranch');
      if (legendDigital) legendDigital.textContent = t('legendDigital');
    }
    function bindLangSwitcher(){
      document.querySelectorAll('.lang-bar .btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          const lang = b.getAttribute('data-lang');
          if (I18N[lang]){
            CUR_LANG = lang;
            try{ localStorage.setItem('bnk.lang', lang); }catch(e){}
            applyLangToStaticUI();
            applySearch();
            renderMapAndList();
            ensureHQMarker();
          }
        });
      });
    }

    /* ===== Îç∞Ïù¥ÌÑ∞ Ï†ïÍ∑úÌôî/Î°úÎìú ===== */
    function normalizeRows(json){
      const arr = Array.isArray(json) ? json
                : (json?.data ?? json?.items ?? json?.content ?? json?.rows ?? []);
      return (arr || []).map(r => ({
        name:    r.name ?? r.branchName ?? r.bname ?? '',
        name_en: r.name_en ?? r.nameEn,
        name_ja: r.name_ja ?? r.nameJa,
        name_zh: r.name_zh ?? r.nameZh,
        addr:    r.addr ?? r.address ?? '',
        addr_en: r.addr_en ?? r.addrEn,
        addr_ja: r.addr_ja ?? r.addrJa,
        addr_zh: r.addr_zh ?? r.addrZh,
        phone:   r.phone ?? r.tel ?? r.telephone ?? '',
        lat:     num(r.lat ?? r.latitude ?? r.latY ?? r.y),
        lng:     num(r.lng ?? r.longitude ?? r.lonX  ?? r.x),
        digital: r.digital ?? r.isDigital ?? (r.type==='digital' ? 'Y' : 'N'),
      })).filter(r => r.lat!=null && r.lng!=null);
    }

    // ÏÉòÌîå Ìè¥Î∞± ÏÇ¨Ïö© Ïó¨Î∂Ä
    const USE_SAMPLE_ON_ERROR = true;
    const SAMPLE_BRANCHES = [
      { name:'Í∞ÄÏïºÎèôÏßÄÏ†ê', addr:'Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ ...', phone:'051-111-2222', lat:35.1547247, lng:129.0384844, digital:'N' },
      { name:'ÏÑúÎ©¥ÎîîÏßÄÌÑ∏Îç∞Ïä§ÌÅ¨', addr:'Î∂ÄÏÇ∞ Î∂ÄÏÇ∞ÏßÑÍµ¨ ...', phone:'051-333-4444', lat:35.1577, lng:129.0591, digital:'Y' }
    ];

    function showListError(msg){
      const list = document.getElementById('branchList');
      if (list) list.innerHTML = `<div class="empty">${msg}</div>`;
    }

    async function loadBranches(digitalOnly){
      try{
        const url = `${API_BASE}/api/branches${digitalOnly ? '?digital=true' : ''}`;
        const res = await fetch(url, { headers: { 'Accept':'application/json' } });
        if (!res.ok) {
          showListError(`ÏßÄÏ†ê API Ìò∏Ï∂ú Ïã§Ìå®\nURL: ${url}\nHTTP: ${res.status} ${res.statusText}\n‚Äª Ïã§Í∏∞Í∏∞Îäî ?api=http://<PC-IP>:8093 Î°ú Ï†ëÏÜç / CORS¬∑ÌòºÌï©ÏΩòÌÖêÏ∏† ÌôïÏù∏`);
          all = USE_SAMPLE_ON_ERROR ? normalizeRows(SAMPLE_BRANCHES) : [];
          return;
        }
        const json = await res.json();
        all = normalizeRows(json);
        if (!all.length) {
          showListError(`ÏßÄÏ†ê Î™©Î°ù 0Í±¥\nURL: ${url}\n‚Äª Ï¢åÌëú ÌÇ§ Î∂àÏùºÏπò Í∞ÄÎä•(lat/lng, latitude/longitude Îì±)`);
          if (USE_SAMPLE_ON_ERROR) all = normalizeRows(SAMPLE_BRANCHES);
        }
      } catch (e) {
        showListError(`ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: ${e?.message||e}\nURL: ${API_BASE}/api/branches`);
        all = USE_SAMPLE_ON_ERROR ? normalizeRows(SAMPLE_BRANCHES) : [];
      }
    }

    /* ===== Í≤ÄÏÉâ/ÌïÑÌÑ∞/ÌéòÏù¥ÏßÄ ===== */
    function pickName(r){
      return (
        (CUR_LANG==='en' && (r.name_en||r.nameEn)) ||
        (CUR_LANG==='ja' && (r.name_ja||r.nameJa)) ||
        (CUR_LANG==='zh' && (r.name_zh||r.nameZh)) ||
        r.name || 'ÏßÄÏ†ê'
      );
    }
    function pickAddr(r){
      return (
        (CUR_LANG==='en' && (r.addr_en||r.addrEn)) ||
        (CUR_LANG==='ja' && (r.addr_ja||r.addrJa)) ||
        (CUR_LANG==='zh' && (r.addr_zh||r.addrZh)) ||
        r.addr || ''
      );
    }
    function applySearch(){
      const q = (searchTerm||'').toLowerCase();
      if (!q){
        filtered = all.slice();
      } else {
        filtered = all.filter(r => {
          const fields = [
            r.name || '', r.addr || '', r.phone || '',
            r.name_en||r.nameEn||'', r.addr_en||r.addrEn||'',
            r.name_ja||r.nameJa||'', r.addr_ja||r.addrJa||'',
            r.name_zh||r.nameZh||'', r.addr_zh||r.addrZh||'',
          ].map(s=>String(s).toLowerCase());
          return fields.some(s => s.includes(q));
        });
      }
      const maxPage = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (currentPage > maxPage) currentPage = maxPage;
    }
    function setFilter(type){
      filter = type;
      document.getElementById('btn-branch')?.classList.toggle('active', type==='branch');
      document.getElementById('btn-digital')?.classList.toggle('active', type==='digital');
      currentPage = 1; searchTerm = '';
      const q = document.getElementById('q'); if (q) q.value = '';
      loadBranches(type==='digital').then(() => {
        applySearch();
        map.setCenter(new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng));
        map.setZoom(15);
        renderMapAndList();
        ensureHQMarker();
        closeAllInfo();
      });
    }
    function clearMarkers(){ markers.forEach(m => { try{ m.setMap(null);}catch{} }); markers = []; infoWindows = []; }
    function pagedData(){ const start=(currentPage-1)*PAGE_SIZE, end=start+PAGE_SIZE; return filtered.slice(start, end); }

    /* ===== Ï†ïÎ≥¥Ï∞Ω HTML ÏÉùÏÑ± ===== */
    function buildInfoHtml(r){
      const isDigital = (String(r.digital ?? '').toUpperCase() === 'Y') || (filter==='digital');
      const nm = pickName(r), nmEsc = escapeHtml(nm), nmJS = jsStr(nm);
      const ad = escapeHtml(pickAddr(r));
      const ph = escapeHtml(r.phone||'');
      const lat = Number(r.lat), lng = Number(r.lng);

      return `
        <div class="bnk-infowin">
          <button class="close" onclick="closeAllInfo()" aria-label="Îã´Í∏∞">√ó</button>
          <div class="head">
            <div class="logo" style="background:${isDigital ? 'var(--digital)':'var(--branch)'}">BNK</div>
            <div class="title">${nmEsc}${isDigital ? `<span class="badge">${t('badgeDigital')}</span>`:''}</div>
          </div>
          <div class="meta">
            <div class="meta-row"><span class="ico">üìç</span><span>${ad}</span></div>
            ${ph ? `<div class="meta-row"><span class="ico">‚òéÔ∏è</span><span>${ph}</span></div>` : ''}
          </div>
          <div class="actions">
            <button class="btn" onclick="window.__openOnMap(${lat}, ${lng})">${t('btnViewOnMap')}</button>
            <button class="btn primary" onclick="openNaverDirections('${nmJS}', ${lat}, ${lng})">${t('btnDirections')}</button>
          </div>
        </div>`;
    }

    /* ===== ÏßÄÎèÑ/Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ ===== */
    window.__openOnMap = (lat, lng) => {
      const pos = new naver.maps.LatLng(lat, lng);
      map.panTo(pos); map.setZoom(16);
    };

    function renderMapAndList(){
      closeAllInfo();
      clearMarkers();
      const pageRows = pagedData();

      pageRows.forEach((r) => {
        const lat = parseFloat(r.lat), lng = parseFloat(r.lng);
        const isDigitalMarker = (filter === 'digital') || (String(r.digital ?? '').toUpperCase() === 'Y');
        const pos = new naver.maps.LatLng(lat, lng);
        const marker = new naver.maps.Marker({ position: pos, map, icon:{ content: iconHtml(isDigitalMarker) }, zIndex:200 });
        const iw = new naver.maps.InfoWindow({ content: buildInfoHtml(r) });
        naver.maps.Event.addListener(marker, 'click', () => { closeAllInfo(); iw.open(map, marker); });
        markers.push(marker); infoWindows.push(iw);
      });

      const total = filtered.length;
      const startN = total ? ((currentPage-1)*PAGE_SIZE + 1) : 0;
      const endN = Math.min(currentPage*PAGE_SIZE, total);
      const countLabel = document.getElementById('countLabel');
      if (countLabel) countLabel.textContent = t('countLabel', startN, endN, total);

      const list = document.getElementById('branchList'); if (!list) return;
      if (!pageRows.length) {
        list.innerHTML = `<div class="empty">${t('empty')}</div>`;
      } else {
        list.innerHTML = pageRows.map((r, i) => {
          const isDigital = (String(r.digital ?? '').toUpperCase() === 'Y') || (filter==='digital');
          const nmEsc = escapeHtml(pickName(r));
          const ad = escapeHtml(pickAddr(r));
          const ph = escapeHtml(r.phone||'');
          return `
            <div class="item" data-idx="${i}">
              <div class="i-name">
                <span>${nmEsc}${isDigital?`<span class="badge">${t('badgeDigital')}</span>`:''}</span>
                <span class="row-actions">
                  <button class="btn js-focus">${t('btnViewOnMap')}</button>
                  <button class="btn primary js-nav">${t('btnDirections')}</button>
                </span>
              </div>
              <div class="i-addr">${ad}</div>
              ${ph?`<div class="i-phone">${ph}</div>`:''}
            </div>`;
        }).join('');
      }

      list.querySelectorAll('.item').forEach(el => {
        const idx = Number(el.getAttribute('data-idx'));
        const m = markers[idx], iw = infoWindows[idx];
        const focus = ()=>{ if(m&&iw){ map.panTo(m.getPosition()); map.setZoom(16); closeAllInfo(); iw.open(map, m); } };
        el.querySelector('.js-focus')?.addEventListener('click', ev=>{ ev.stopPropagation(); focus(); });
        el.querySelector('.js-nav')?.addEventListener('click', ev=>{ ev.stopPropagation(); focus(); });
        el.addEventListener('click', focus);
      });

      renderPager(); ensureHQMarker();
    }

    function renderPager(){
      const pager = document.getElementById('pager'); if (!pager) return;
      const total = filtered.length; const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const prevDisabled = currentPage <= 1; const nextDisabled = currentPage >= pages;
      const pageInfoText = t('pageInfo', currentPage, pages);
      pager.innerHTML = `
        <button class="pg-btn" ${prevDisabled?'disabled':''} data-act="first">${t('pageFirst')}</button>
        <button class="pg-btn" ${prevDisabled?'disabled':''} data-act="prev">${t('pagePrev')}</button>
        <span class="pg-info">${pageInfoText}</span>
        <button class="pg-btn" ${nextDisabled?'disabled':''} data-act="next">${t('pageNext')}</button>
        <button class="pg-btn" ${nextDisabled?'disabled':''} data-act="last">${t('pageLast')}</button>`;
      pager.querySelectorAll('.pg-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const act = btn.getAttribute('data-act');
          const pages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
          if (act === 'first' && currentPage !== 1) currentPage = 1;
          if (act === 'prev' && currentPage > 1)    currentPage--;
          if (act === 'next' && currentPage < pages) currentPage++;
          if (act === 'last' && currentPage !== pages) currentPage = pages;
          renderMapAndList();
          map.setCenter(new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng)); map.setZoom(13);
          closeAllInfo();
        });
      });
    }

    /* ===== Ï¥àÍ∏∞Ìôî ===== */
    function initMap(){
      const deadline = Date.now() + 8000;
      (function boot(){
        if (window.naver && naver.maps && document.getElementById('map')) {
          map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng),
            zoom: 15, zoomControl: true
          });

          // ÏßÄÎèÑ Îπà Í≥≥ ÌÅ¥Î¶≠ Ïãú Ï†ïÎ≥¥Ï∞Ω Îã´Í∏∞
          naver.maps.Event.addListener(map, 'click', () => { closeAllInfo(); });

          const mq = window.matchMedia('(min-width: 768px)');
          const onMQ = () => { PAGE_SIZE = mq.matches ? 25 : 15; currentPage = 1; renderMapAndList(); };
          mq.addEventListener ? mq.addEventListener('change', onMQ) : mq.addListener(onMQ);

          document.getElementById('btn-branch')?.addEventListener('click', () => setFilter('branch'));
          document.getElementById('btn-digital')?.addEventListener('click', () => setFilter('digital'));
          const qInput = document.getElementById('q');
          if (qInput){
            let tmo;
            qInput.addEventListener('input', () => {
              clearTimeout(tmo);
              tmo = setTimeout(()=>{ searchTerm=qInput.value.trim(); currentPage=1; applySearch(); renderMapAndList(); },150);
            });
          }

          applyLangToStaticUI();
          bindLangSwitcher();

          loadBranches(false).then(()=>{ applySearch(); renderMapAndList(); ensureHQMarker(); });
        } else if (Date.now() < deadline) {
          setTimeout(boot, 50);
        } else {
          alert('NAVER Maps SDKÍ∞Ä Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
        }
      })();
    }

    // Ï†ÑÏó≠ ÏΩúÎ∞±
    window.initMap = initMap;
  </script>

  <!-- Í∞úÎ∞ú¬∑ÌÖåÏä§Ìä∏Ïö©: http Ïä§ÌÇ¥ (HTTPS ÎØ∏ÏÇ¨Ïö© ÌôòÍ≤ΩÏóêÏÑúÎèÑ ÎèôÏûë) -->
  <script src="http://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=t4sef40746&callback=initMap&_v=bnk_http_001"></script>
</head>

<body>
  <div class="wrap">
    <div class="bar">ÏòÅÏóÖÏ†ê Ï∞æÍ∏∞</div>

    <!-- Ïñ∏Ïñ¥ Ïä§ÏúÑÏ≤ò -->
    <div class="lang-bar">
      <button class="btn" data-lang="ko" title="ÌïúÍµ≠Ïñ¥">üá∞üá∑ ÌïúÍµ≠Ïñ¥</button>
      <button class="btn" data-lang="en" title="English">EN</button>
      <button class="btn" data-lang="ja" title="Êó•Êú¨Ë™û">Êó•Êú¨Ë™û</button>
      <button class="btn" data-lang="zh" title="ÁÆÄ‰Ωì‰∏≠Êñá">ÁÆÄ‰Ωì‰∏≠Êñá</button>
    </div>

    <div class="layout">
      <div class="card map-card">
        <div id="map"></div>
        <div class="legend">
          <span class="chip"><span class="dot" style="background:var(--branch)"></span><span id="legend-branch">ÏßÄÏ†ê</span></span>
          <span class="chip"><span class="dot" style="background:var(--digital)"></span><span id="legend-digital">ÎîîÏßÄÌÑ∏</span></span>
          <span style="margin-left:auto" id="countLabel"></span>
        </div>
      </div>

      <div class="card">
        <div class="controls">
          <button class="cta active" id="btn-branch">üè¶ ÏßÄÏ†ê <span class="sub">Î™®Îì† Î∂ÄÏÇ∞ÏùÄÌñâ ÏßÄÏ†ê</span></button>
          <button class="cta" id="btn-digital">üíª ÎîîÏßÄÌÑ∏ Îç∞Ïä§ÌÅ¨ ÏßÄÏ†ê <span class="sub">ÏòÅÏÉÅÏó∞Í≤∞Î°ú ÏóÖÎ¨¥ Í∞ÄÎä•</span></button>
          <div class="search">
            <input id="q" type="search" placeholder="ÏßÄÏ†êÎ™Ö¬∑Ï£ºÏÜå¬∑Ï†ÑÌôîÎ°ú Í≤ÄÏÉâ" aria-label="ÏßÄÏ†ê Í≤ÄÏÉâ"/>
          </div>
        </div>

        <div class="list-card">
          <div class="list-head"><div class="list-title" style="font-weight:800">ÏßÄÏ†ê Î¶¨Ïä§Ìä∏</div></div>
          <div id="branchList" class="list"></div>
          <div id="pager" class="pager"></div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
