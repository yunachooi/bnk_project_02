<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BNK 지점/디지털 지도</title>

  <style>
    :root{
      --ink:#1f2937; --muted:#6b7280; --border:#e5e7eb; --bg:#fff;
      --bar:#f3f4f6;
      --branch:#d81b60;   /* 일반 지점 */
      --digital:#14b8a6;  /* 디지털 지점 */
      --card:#ffffff; --wash:#fafafa;
      --accent:#111827;   /* 활성 탭 테두리 */
      --radius:12px;
      --shadow:0 1px 0 rgba(0,0,0,.04);
      --shadow-lg:0 8px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;color:var(--ink);background:var(--bg)}

    /* 레이아웃 */
    .wrap{max-width:min(1200px, 100vw);margin:0 auto;padding:12px 16px 28px}
    .bar{background:var(--bar);text-align:center;border-radius:8px;padding:10px 0;font-weight:800;margin-bottom:16px}

    .layout{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 768px){ /* 태블릿 이상: 2단 레이아웃 */
      .layout{grid-template-columns: minmax(420px, 1.15fr) minmax(360px, .85fr)}
    }

    /* 카드 공통 */
    .card{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;background:#fff;box-shadow:var(--shadow)}

    /* 지도 */
    #map{height:clamp(320px, 40vh, 520px);width:100%}
    @media (min-width: 768px){
      #map{height:clamp(520px, 70vh, 760px)}
      .map-card{position:sticky; top:12px}  /* 사이드 스크롤 시 지도 고정 */
    }

    .legend{display:flex;gap:10px;padding:8px 12px;color:var(--muted);font-size:13px;border-top:1px solid var(--border);align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block}

    /* 컨트롤(검색/탭/카운트) */
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px}
    .cta{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:12px;background:#fff;cursor:pointer;border:1px solid var(--border);font-weight:800;transition:.2s ease;text-align:center}
    .cta.active{outline:2px solid var(--accent)}
    .cta:hover{box-shadow:var(--shadow-lg)}
    .sub{display:block;font-size:12px;color:var(--muted);font-weight:600}
    .search{grid-column:1/-1;display:flex;gap:8px}
    .search input{flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:14px}

    /* 리스트 */
    .list-card{border-top:1px solid var(--border);background:#fff}
    .list-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#fff}
    .list{display:flex;flex-direction:column}
    .item{border-bottom:1px solid var(--border);padding:12px;background:#fff;transition:background .15s ease}
    .item:last-child{border-bottom:none}
    .item:hover{background:#fcfcfc}
    .i-name{font-weight:800;display:flex;align-items:center;gap:6px;justify-content:space-between}
    .i-addr,.i-phone{font-size:13px;color:var(--muted);margin-top:3px}
    .badge{display:inline-block;font-size:11px;font-weight:800;padding:3px 8px;border-radius:999px;background:var(--digital);color:#fff;margin-left:6px}
    .badge.hq{background:#111827}
    .empty{padding:20px;color:var(--muted);text-align:center;background:#fafafa}

    .row-actions{display:flex;gap:8px;margin-top:8px}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:700;font-size:13px}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}

    /* 페이지네이션 */
    .pager{display:flex;gap:6px;justify-content:center;align-items:center;padding:12px;border-top:1px solid var(--border);background:#fff;flex-wrap:wrap}
    .pg-btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700;font-size:14px}
    .pg-btn[disabled]{opacity:.4;cursor:not-allowed}
    .pg-info{font-size:13px;color:var(--muted);padding:0 6px}

     @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa3af; --border:#242a33; --bar:#0f1720; }
      .card{background:#0e141b}
      .item:hover{background:#0d131a}
    }
  </style>

  <script>
    const DEFAULT_CENTER = { lat: 35.1454909, lng: 129.0658220 };

    let map;
    let all = [];
    let filtered = [];
    let markers = [];
    let infoWindows = [];
    let filter = 'branch';
    let currentPage = 1;
    let PAGE_SIZE = window.matchMedia('(min-width: 768px)').matches ? 25 : 15; // 화면에 따라 페이지 크기 가변
    let searchTerm = '';

    /* ✅ 본점 전용 마커/인포윈도우 */
    let hqMarker = null, hqInfo = null;
    const iconHtmlHQ = `
      <div style="transform:translate(-50%,-50%);display:grid;place-items:center">
        <div style="
          width:40px;height:40px;border-radius:999px;
          background:#111827;
          border:2px solid #fff; box-shadow:0 2px 10px rgba(0,0,0,.2);
          color:#fff; font-weight:900; font-size:11px;
          display:flex; align-items:center; justify-content:center;">BNK
        </div>
      </div>`;

    window.navermap_authFailure = function () {
      alert('네이버 지도 인증 실패: ncpKeyId 및 Web 서비스 URL(리퍼러) 등록을 확인하세요.');
    };

    const iconHtml = (isDigital) => `
      <div style="transform:translate(-50%,-50%);display:grid;place-items:center">
        <div style="
          width:36px;height:36px;border-radius:999px;
          background:${isDigital ? 'var(--digital)' : 'var(--branch)'};
          border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.18);
          color:#fff;font-weight:900;font-size:11px;
          display:flex;align-items:center;justify-content:center;">BNK
        </div>
      </div>`;

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));
    }

    /* ✅ 네이버 길찾기 열기 (앱 우선 → 웹 폴백) */
    function openNaverDirections(name, lat, lng){
      const dname = encodeURIComponent(name || '목적지');
      const appUrl = `nmap://route/public?dlat=${lat}&dlng=${lng}&dname=${dname}&appname=bnk.forex`;
      const webUrl = `https://map.naver.com/v5/directions/-/${lng},${lat}`; // 경도,위도 순서
      const timer = setTimeout(()=>{ window.open(webUrl, '_blank'); }, 700);
      window.location.href = appUrl;
      window.addEventListener('pagehide', ()=>clearTimeout(timer), { once:true });
    }

    /* ✅ 본점 마커를 항상 보장 */
    function ensureHQMarker(){
      if (!map) return;
      if (!hqMarker) {
        const pos = new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng);
        hqMarker = new naver.maps.Marker({
          position: pos, map, icon: { content: iconHtmlHQ }, zIndex: 500
        });
        const hqContentHtml = `
          <div style="min-width:230px;padding:2px 0">
            <div class="i-name">부산은행 본점 <span class="badge hq">본점</span></div>
            <div class="i-addr">중심 좌표: ${DEFAULT_CENTER.lat}, ${DEFAULT_CENTER.lng}</div>
            <div class="row-actions">
              <button class="btn primary" onclick="openNaverDirections('부산은행 본점', ${DEFAULT_CENTER.lat}, ${DEFAULT_CENTER.lng})">네이버 길찾기</button>
            </div>
          </div>`;
        hqInfo = new naver.maps.InfoWindow({ content: hqContentHtml });
        naver.maps.Event.addListener(hqMarker, 'click', () => {
          infoWindows.forEach(w => w.close());
          hqInfo.open(map, hqMarker);
        });
      } else {
        hqMarker.setMap(map); // 탭/페이지 전환 시에도 유지
      }
    }

    async function initMap(){
      // DOM 준비 보장
      if (!document.getElementById('map')) {
        document.addEventListener('DOMContentLoaded', initMap, { once:true });
        return;
      }
      if (!window.naver || !naver.maps) { setTimeout(initMap, 50); return; }

      map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng),
        zoom: 15, zoomControl: true
      });

      /* 요소 바인딩 */
      const btnBranch  = document.getElementById('btn-branch');
      const btnDigital = document.getElementById('btn-digital');
      const qInput     = document.getElementById('q');

      btnBranch  && btnBranch.addEventListener('click', () => setFilter('branch'));
      btnDigital && btnDigital.addEventListener('click', () => setFilter('digital'));

      if (qInput){
        let t;
        qInput.addEventListener('input', () => {
          clearTimeout(t);
          t = setTimeout(() => {
            searchTerm = qInput.value.trim();
            currentPage = 1;
            applySearch();
            renderMapAndList();
          }, 150);
        });
      }

      // 화면 크기에 따라 PAGE_SIZE 재설정
      const mq = window.matchMedia('(min-width: 768px)');
      const onMQ = () => { PAGE_SIZE = mq.matches ? 25 : 15; currentPage = 1; renderMapAndList(); };
      mq.addEventListener ? mq.addEventListener('change', onMQ) : mq.addListener(onMQ);

      await loadBranches(false);
      applySearch();
      renderMapAndList();
      ensureHQMarker();
    }

    async function loadBranches(digitalOnly){
      try{
        const url = digitalOnly ? '/api/branches?digital=true' : '/api/branches';
        const res = await fetch(url);
        const rows = await res.json();
        all = (rows||[]).filter(r => Number.isFinite(parseFloat(r.lat)) && Number.isFinite(parseFloat(r.lng)));
      }catch(e){
        console.error('지점 데이터를 불러오지 못했습니다.', e);
        all = [];
      }
    }

    function applySearch(){
      const q = (searchTerm||'').toLowerCase();
      filtered = !q ? all.slice() : all.filter(r => {
        const name = (r.name||'').toLowerCase();
        const addr = (r.addr||'').toLowerCase();
        const phone = (r.phone||'').toLowerCase();
        return name.includes(q) || addr.includes(q) || phone.includes(q);
      });
      const maxPage = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (currentPage > maxPage) currentPage = maxPage;
    }

    function setFilter(type){
      filter = type;
      const btnBranch  = document.getElementById('btn-branch');
      const btnDigital = document.getElementById('btn-digital');
      btnBranch  && btnBranch.classList.toggle('active', type==='branch');
      btnDigital && btnDigital.classList.toggle('active', type==='digital');
      currentPage = 1; searchTerm = '';
      const q = document.getElementById('q'); if (q) q.value = '';
      loadBranches(type==='digital').then(() => {
        applySearch();
        map.setCenter(new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng));
        map.setZoom(15);
        renderMapAndList();
        ensureHQMarker();
      });
    }

    function clearMarkers(){
      markers.forEach(m => { try{ m.setMap(null);}catch{} });
      markers = [];
      infoWindows = [];
    }

    function pagedData(){
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      return filtered.slice(start, end);
    }

    function buildInfoHtml(r){
      const isDigitalBadge = (String(r.digital ?? '').toUpperCase() === 'Y') || (filter==='digital');
      return `
        <div style="min-width:230px;padding:2px 0">
          <div class="i-name">
            <span>${escapeHtml(r.name||'지점')}${isDigitalBadge?'<span class="badge">디지털</span>':''}</span>
          </div>
          <div class="i-addr">${escapeHtml(r.addr||'')}</div>
          ${r.phone?`<div class="i-phone">${escapeHtml(r.phone)}</div>`:''}
          <div class="row-actions">
            <button class="btn" onclick="window.__openOnMap(${Number(r.lat)}, ${Number(r.lng)})">지도에서 보기</button>
            <button class="btn primary" onclick="openNaverDirections('${escapeHtml(r.name||'지점')}', ${Number(r.lat)}, ${Number(r.lng)})">네이버 길찾기</button>
          </div>
        </div>`;
    }

    // 말풍선에서 지도 이동을 위해 전역 함수로 노출
    window.__openOnMap = (lat, lng) => {
      const pos = new naver.maps.LatLng(lat, lng);
      map.panTo(pos);
      map.setZoom(16);
    };

    function renderMapAndList(){
      clearMarkers();
      const pageRows = pagedData();

      pageRows.forEach((r, idxOnPage) => {
        const lat = parseFloat(r.lat), lng = parseFloat(r.lng);
        const isDigitalMarker = (filter === 'digital') || (String(r.digital ?? '').toUpperCase() === 'Y');
        const pos = new naver.maps.LatLng(lat, lng);

        const marker = new naver.maps.Marker({
          position: pos, map, icon:{ content: iconHtml(isDigitalMarker) }, zIndex:200
        });

        const iw = new naver.maps.InfoWindow({ content: buildInfoHtml(r) });

        naver.maps.Event.addListener(marker, 'click', () => {
          infoWindows.forEach(w => w.close());
          iw.open(map, marker);
        });

        markers.push(marker);
        infoWindows.push(iw);
      });

      const total = filtered.length;
      const startN = total ? ( (currentPage-1)*PAGE_SIZE + 1 ) : 0;
      const endN = Math.min(currentPage*PAGE_SIZE, total);
      const countLabel = document.getElementById('countLabel');
      if (countLabel) countLabel.textContent = `표시: ${startN}-${endN} / ${total}개`;

      const list = document.getElementById('branchList');
      if (!list) return;

      if (!pageRows.length) {
        list.innerHTML = `<div class="empty">표시할 지점이 없습니다.</div>`;
      } else {
        list.innerHTML = pageRows.map((r, i) => {
          const isDigital = (String(r.digital ?? '').toUpperCase() === 'Y') || (filter==='digital');
          return `
            <div class="item" data-idx="${i}">
              <div class="i-name">
                <span>${escapeHtml(r.name||'지점')}${isDigital?'<span class="badge">디지털</span>':''}</span>
                <span class="row-actions">
                  <button class="btn js-focus">지도에서 보기</button>
                  <button class="btn primary js-nav">길찾기</button>
                </span>
              </div>
              <div class="i-addr">${escapeHtml(r.addr||'')}</div>
              ${r.phone?`<div class="i-phone">${escapeHtml(r.phone)}</div>`:''}
            </div>`;
        }).join('');
      }

      // 리스트 액션: "지도에서 보기" → 말풍선 열기, "길찾기" → 말풍선 먼저 띄우고 버튼 통해 이동
      list.querySelectorAll('.item').forEach(el => {
        const idxOnPage = Number(el.getAttribute('data-idx'));
        const m = markers[idxOnPage], iw = infoWindows[idxOnPage];
        el.querySelector('.js-focus')?.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          if (m && iw){
            map.panTo(m.getPosition());
            map.setZoom(16);
            infoWindows.forEach(w => w.close());
            iw.open(map, m);
          }
        });
        el.querySelector('.js-nav')?.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          if (m && iw){
            map.panTo(m.getPosition());
            map.setZoom(16);
            infoWindows.forEach(w => w.close());
            iw.open(map, m); // 사용자가 말풍선 내 "네이버 길찾기" 버튼을 눌러 이동
          }
        });
        // 전체 아이템 클릭 시에도 말풍선 오픈(기존 동작 유지)
        el.addEventListener('click', () => {
          if (m && iw){
            map.panTo(m.getPosition());
            map.setZoom(16);
            infoWindows.forEach(w => w.close());
            iw.open(map, m);
          }
        });
      });

      renderPager();
      ensureHQMarker();
    }

    function renderPager(){
      const pager = document.getElementById('pager');
      if (!pager) return;

      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const prevDisabled = currentPage <= 1;
      const nextDisabled = currentPage >= pages;

      pager.innerHTML = `
        <button class="pg-btn" ${prevDisabled?'disabled':''} data-act="first">« 처음</button>
        <button class="pg-btn" ${prevDisabled?'disabled':''} data-act="prev">‹ 이전</button>
        <span class="pg-info">${currentPage} / ${pages} 페이지</span>
        <button class="pg-btn" ${nextDisabled?'disabled':''} data-act="next">다음 ›</button>
        <button class="pg-btn" ${nextDisabled?'disabled':''} data-act="last">끝 »</button>
      `;

      pager.querySelectorAll('.pg-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const act = btn.getAttribute('data-act');
          const pages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
          if (act === 'first' && currentPage !== 1){ currentPage = 1; }
          if (act === 'prev' && currentPage > 1){ currentPage--; }
          if (act === 'next' && currentPage < pages){ currentPage++; }
          if (act === 'last' && currentPage !== pages){ currentPage = pages; }
          renderMapAndList();
          map.setCenter(new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng));
          map.setZoom(13);
        });
      });
    }

    // 전역 콜백으로 등록 (네이버 스크립트에서 호출)
    window.initMap = initMap;
  </script>

  <!-- 실제 키로 교체하세요 (ncpKeyId) -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=t4sef40746&callback=initMap"></script>
</head>
<body>
  <div class="wrap">
    <div class="bar">영업점 찾기</div>

    <div class="layout">
      <!-- Left: Map -->
      <div class="card map-card">
        <div id="map"></div>
        <div class="legend">
          <span class="chip"><span class="dot" style="background:var(--branch)"></span>지점</span>
          <span class="chip"><span class="dot" style="background:var(--digital)"></span>디지털</span>
          <span style="margin-left:auto" id="countLabel"></span>
        </div>
      </div>

      <!-- Right: Controls + List -->
      <div class="card">
        <div class="controls">
          <button class="cta active" id="btn-branch">🏦 지점 <span class="sub">모든 부산은행 지점</span></button>
          <button class="cta" id="btn-digital">💻 디지털 데스크 지점 <span class="sub">영상연결로 업무 가능</span></button>
          <div class="search">
            <input id="q" type="search" placeholder="지점명·주소·전화로 검색" aria-label="지점 검색"/>
          </div>
        </div>

        <div class="list-card">
          <div class="list-head">
            <div class="list-title" style="font-weight:800">지점 리스트</div>
          </div>
          <div id="branchList" class="list"></div>
          <div id="pager" class="pager"></div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
