<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BNK 지점/디지털 지도</title>

  <style>
    :root{
      --ink:#1f2937; --muted:#6b7280; --border:#e5e7eb; --bg:#fff;
      --branch:#d81b60;   /* 일반 지점 */
      --digital:#14b8a6;  /* 디지털 지점 */
      --card:#ffffff; --wash:#fafafa;
      --accent:#111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;color:var(--ink);background:var(--bg)}
    .app{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;min-height:100%}

    .topbar{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:10}
    .title{flex:1;text-align:center;font-weight:800}
    .section{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:800;text-align:center;background:#fff}

    .main{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
    @media (min-width: 900px){
      .main{grid-template-columns:1.1fr .9fr;align-items:start}
    }

    .map-card{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
    #map{height:45vh;width:100%}
    @media (min-width: 900px){
      #map{height:60vh}
    }
    .legend{display:flex;gap:10px;padding:8px 12px;color:var(--muted);font-size:13px;border-top:1px solid var(--border);align-items:center}
    .chip{display:inline-flex;align-items:center;gap:6px}
    .dot{width:12px;height:12px;border-radius:999px;display:inline-block}

    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .cta{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:12px;background:#fff;cursor:pointer;border:1px solid var(--border);font-weight:800}
    .cta.active{outline:2px solid var(--accent)}
    .sub{display:block;font-size:12px;color:var(--muted);font-weight:600}
    .search{grid-column:1/-1;display:flex;gap:8px}
    .search input{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px}

    .list-card{border:1px solid var(--border);border-radius:12px;background:#fff;overflow:hidden}
    .list-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#fff}
    .list{display:flex;flex-direction:column}
    .item{border-bottom:1px solid var(--border);padding:12px;background:#fff;cursor:pointer}
    .item:last-child{border-bottom:none}
    .item:hover{background:#fcfcfc}
    .i-name{font-weight:800;display:flex;align-items:center;gap:6px}
    .i-addr,.i-phone{font-size:13px;color:var(--muted);margin-top:3px}
    .badge{display:inline-block;font-size:11px;font-weight:800;padding:3px 8px;border-radius:999px;background:var(--digital);color:#fff}
    .badge.hq{background:#111827}
    .empty{padding:20px;color:var(--muted);text-align:center;background:var(--wash)}

    .pager{display:flex;gap:6px;justify-content:center;align-items:center;padding:12px;border-top:1px solid var(--border);background:#fff;flex-wrap:wrap}
    .pg-btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700;font-size:14px}
    .pg-btn[disabled]{opacity:.4;cursor:not-allowed}
    .pg-info{font-size:13px;color:var(--muted);padding:0 6px}
  </style>

  <script>
    const DEFAULT_CENTER = { lat: 35.1454909, lng: 129.0658220 };

    let map;
    let all = [];
    let filtered = [];
    let markers = [];
    let infoWindows = [];
    let filter = 'branch';
    let currentPage = 1;
    const PAGE_SIZE = 15;
    let searchTerm = '';

    /* ✅ 본점 전용 마커/인포윈도우 */
    let hqMarker = null, hqInfo = null;
    const iconHtmlHQ = `
      <div style="transform:translate(-50%,-50%);display:grid;place-items:center">
        <div style="
          width:40px;height:40px;border-radius:999px;
          background:#111827;
          border:2px solid #fff; box-shadow:0 2px 10px rgba(0,0,0,.2);
          color:#fff; font-weight:900; font-size:11px;
          display:flex; align-items:center; justify-content:center;">BNK
        </div>
      </div>`;

    window.navermap_authFailure = function () {
      alert('네이버 지도 인증 실패: ncpKeyId 및 Web 서비스 URL(리퍼러) 등록을 확인하세요.');
    };

    const iconHtml = (isDigital) => `
      <div style="transform:translate(-50%,-50%);display:grid;place-items:center">
        <div style="
          width:36px;height:36px;border-radius:999px;
          background:${isDigital ? 'var(--digital)' : 'var(--branch)'};
          border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.18);
          color:#fff;font-weight:900;font-size:11px;
          display:flex;align-items:center;justify-content:center;">BNK
        </div>
      </div>`;

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]));
    }

    /* ✅ 본점 마커를 항상 보장 */
    function ensureHQMarker(){
      if (!map) return;
      if (!hqMarker) {
        const pos = new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng);
        hqMarker = new naver.maps.Marker({
          position: pos, map, icon: { content: iconHtmlHQ }, zIndex: 500
        });
        hqInfo = new naver.maps.InfoWindow({
          content: `
            <div style="min-width:220px;padding:2px 0">
              <div class="i-name">부산은행 본점 <span class="badge hq">본점</span></div>
              <div class="i-addr">중심 좌표: ${DEFAULT_CENTER.lat}, ${DEFAULT_CENTER.lng}</div>
            </div>`
        });
        naver.maps.Event.addListener(hqMarker, 'click', () => {
          infoWindows.forEach(w => w.close());
          hqInfo.open(map, hqMarker);
        });
      } else {
        hqMarker.setMap(map); // 탭/페이지 전환 시에도 유지
      }
    }

    async function initMap(){
      if (!window.naver || !naver.maps) { setTimeout(initMap, 50); return; }

      map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng),
        zoom: 15, zoomControl: true
      });

      document.getElementById('btn-branch').addEventListener('click', () => setFilter('branch'));
      document.getElementById('btn-digital').addEventListener('click', () => setFilter('digital'));

      const q = document.getElementById('q');
      let t;
      q.addEventListener('input', () => {
        clearTimeout(t);
        t = setTimeout(() => {
          searchTerm = q.value.trim();
          currentPage = 1;
          applySearch();
          renderMapAndList();
        }, 150);
      });

      await loadBranches(false);
      applySearch();
      renderMapAndList();
      ensureHQMarker();                 /* ⬅️ 본점 마커 항상 추가 */
      // setTimeout(()=>{ hqInfo?.open(map, hqMarker); }, 150); // (선택) 초기 자동 오픈
    }

    async function loadBranches(digitalOnly){
      try{
        const url = digitalOnly ? '/api/branches?digital=true' : '/api/branches';
        const res = await fetch(url);
        const rows = await res.json();
        all = (rows||[]).filter(r => Number.isFinite(parseFloat(r.lat)) && Number.isFinite(parseFloat(r.lng)));
      }catch(e){
        console.error('지점 데이터를 불러오지 못했습니다.', e);
        all = [];
      }
    }

    function applySearch(){
      const q = (searchTerm||'').toLowerCase();
      filtered = !q ? all.slice() : all.filter(r => {
        const name = (r.name||'').toLowerCase();
        const addr = (r.addr||'').toLowerCase();
        const phone = (r.phone||'').toLowerCase();
        return name.includes(q) || addr.includes(q) || phone.includes(q);
      });
      const maxPage = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (currentPage > maxPage) currentPage = maxPage;
    }

    function setFilter(type){
      filter = type;
      document.getElementById('btn-branch').classList.toggle('active', type==='branch');
      document.getElementById('btn-digital').classList.toggle('active', type==='digital');
      currentPage = 1; searchTerm = ''; document.getElementById('q').value = '';
      loadBranches(type==='digital').then(() => {
        applySearch();
        map.setCenter(new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng));
        map.setZoom(15);
        renderMapAndList();
        ensureHQMarker();               /* ⬅️ 탭 전환 후에도 본점 유지 */
      });
    }

    function clearMarkers(){
      markers.forEach(m => { try{ m.setMap(null);}catch{} });
      markers = [];
      infoWindows = [];
    }

    function pagedData(){
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      return filtered.slice(start, end);
    }

    function renderMapAndList(){
      clearMarkers();

      const pageRows = pagedData();

      pageRows.forEach((r, idxOnPage) => {
        const lat = parseFloat(r.lat), lng = parseFloat(r.lng);
        const isDigitalMarker = (filter === 'digital') || (String(r.digital ?? '').toUpperCase() === 'Y');
        const pos = new naver.maps.LatLng(lat, lng);

        const marker = new naver.maps.Marker({
          position: pos, map, icon:{ content: iconHtml(isDigitalMarker) }, zIndex:200
        });

        const isDigitalBadge = (String(r.digital ?? '').toUpperCase() === 'Y') || (filter==='digital');
        const html = `
          <div style="min-width:220px;padding:2px 0">
            <div class="i-name">${escapeHtml(r.name||'지점')}${isDigitalBadge?'<span class="badge">디지털</span>':''}</div>
            <div class="i-addr">${escapeHtml(r.addr||'')}</div>
            ${r.phone?`<div class="i-phone">${escapeHtml(r.phone)}</div>`:''}
          </div>`;
        const iw = new naver.maps.InfoWindow({ content: html });

        naver.maps.Event.addListener(marker, 'click', () => {
          infoWindows.forEach(w => w.close());
          iw.open(map, marker);
        });

        markers.push(marker);
        infoWindows.push(iw);
      });

      const total = filtered.length;
      const startN = total ? ( (currentPage-1)*PAGE_SIZE + 1 ) : 0;
      const endN = Math.min(currentPage*PAGE_SIZE, total);
      document.getElementById('countLabel').textContent = `표시: ${startN}-${endN} / ${total}개`;

      const list = document.getElementById('branchList');
      if (!pageRows.length) {
        list.innerHTML = `<div class="empty">표시할 지점이 없습니다.</div>`;
      } else {
        list.innerHTML = pageRows.map((r, i) => {
          const isDigital = (String(r.digital ?? '').toUpperCase() === 'Y') || (filter==='digital');
          return `
            <div class="item" data-idx="${i}">
              <div class="i-name">${escapeHtml(r.name||'지점')}${isDigital?'<span class="badge">디지털</span>':''}</div>
              <div class="i-addr">${escapeHtml(r.addr||'')}</div>
              ${r.phone?`<div class="i-phone">${escapeHtml(r.phone)}</div>`:''}
            </div>`;
        }).join('');
      }

      list.querySelectorAll('.item').forEach(el => {
        el.addEventListener('click', () => {
          const idxOnPage = Number(el.getAttribute('data-idx'));
          const m = markers[idxOnPage], iw = infoWindows[idxOnPage];
          if (m) {
            map.panTo(m.getPosition());
            map.setZoom(16);
            infoWindows.forEach(w => w.close());
            iw?.open(map, m);
          }
        });
      });

      renderPager();
      ensureHQMarker();                 /* ⬅️ 렌더 후에도 본점 마커 보장 */
    }

    function renderPager(){
      const pager = document.getElementById('pager');
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const prevDisabled = currentPage <= 1;
      const nextDisabled = currentPage >= pages;

      pager.innerHTML = `
        <button class="pg-btn" ${prevDisabled?'disabled':''} data-act="first">« 처음</button>
        <button class="pg-btn" ${prevDisabled?'disabled':''} data-act="prev">‹ 이전</button>
        <span class="pg-info">${currentPage} / ${pages} 페이지</span>
        <button class="pg-btn" ${nextDisabled?'disabled':''} data-act="next">다음 ›</button>
        <button class="pg-btn" ${nextDisabled?'disabled':''} data-act="last">끝 »</button>
      `;

      pager.querySelectorAll('.pg-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const act = btn.getAttribute('data-act');
          const pages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
          if (act === 'first' && currentPage !== 1){ currentPage = 1; }
          if (act === 'prev' && currentPage > 1){ currentPage--; }
          if (act === 'next' && currentPage < pages){ currentPage++; }
          if (act === 'last' && currentPage !== pages){ currentPage = pages; }
          renderMapAndList();
          map.setCenter(new naver.maps.LatLng(DEFAULT_CENTER.lat, DEFAULT_CENTER.lng));
          map.setZoom(13);
        });
      });
    }

    window.initMap = initMap;
  </script>

  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=t4sef40746&callback=initMap"></script>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div style="color:#ef4444;font-weight:800;cursor:pointer" onclick="history.back()">&lt; 뒤로가기</div>
    
    <div style="width:56px"></div>
  </div>

  <div class="section">영업점 찾기</div>

  <div class="main">
    <div class="map-card">
      <div id="map"></div>
      <div class="legend">
        <span class="chip"><span class="dot" style="background:var(--branch)"></span>지점</span>
        <span class="chip"><span class="dot" style="background:var(--digital)"></span>디지털</span>
        <span style="margin-left:auto" id="countLabel"></span>
      </div>
    </div>

    <div class="side">
      <div class="controls">
        <button class="cta active" id="btn-branch">🏦 지점 <span class="sub">모든 부산은행 지점</span></button>
        <button class="cta" id="btn-digital">💻 디지털 데스크 지점 <span class="sub">영상연결로 업무 가능</span></button>
        <div class="search">
          <input id="q" type="search" placeholder="지점명·주소·전화로 검색" aria-label="지점 검색"/>
        </div>
      </div>

      <div class="list-card" style="margin-top:12px">
        <div class="list-head">
          <div class="list-title" style="font-weight:800">지점 리스트</div>
        </div>
        <div id="branchList" class="list"></div>
        <div id="pager" class="pager"></div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
