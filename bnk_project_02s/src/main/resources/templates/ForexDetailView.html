<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${currencyName} + ' 상세 환율'">환율 상세</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 20px;
      background: #fff;
      color: #222;
    }

    .header {
      font-weight: bold;
      color: red;
      cursor: pointer;
    }

    .title-box {
      background: #eee;
      padding: 10px;
      margin: 16px 0;
      text-align: center;
      font-weight: bold;
    }

    .rate-info {
      font-size: 1rem;
      margin-bottom: 12px;
    }

    .rate-info strong {
      font-size: 1.3rem;
    }

    .rate-info .up {
      color: red;
    }

    .rate-info .down {
      color: blue;
    }

    .chart-area {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .range-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 30px;
    }

    .range-buttons button {
      background: #ddd;
      border: none;
      padding: 6px 14px;
      border-radius: 16px;
      cursor: pointer;
      font-weight: bold;
    }

    .action-button {
      text-align: center;
    }

    .buy-button {
      background: #d32f2f;
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 12px 30px;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="header" onclick="history.back()">&lt;뒤로가기</div>

<div class="title-box" th:text="${currencyName}">미국 달러</div>

<div class="rate-info">
  <p>금일 환율</p>
  <p><strong th:text="${todayRate} + ' 원'">1,403.47원</strong></p>
  <p th:if="${diff > 0}" class="up">
    어제보다 +<span th:text="${diff}"></span>원 (<span th:text="${diffPercent}"></span>%)
  </p>
  <p th:if="${diff < 0}" class="down">
    어제보다 -<span th:text="${diff}"></span>원 (<span th:text="${diffPercent}"></span>%)
  </p>
</div>

<div class="chart-area">
  <canvas id="rateChart" height="220"></canvas>
</div>

<div class="range-buttons">
  <button onclick="updateChart('week')">1주 평균</button>
  <button onclick="updateChart('month')">1달 평균</button>
</div>

<div class="action-button">
  <button class="buy-button">구매하기</button>
</div>

<script th:inline="javascript">
	const weekData = JSON.parse(/*[[${weekRatesJson}]]*/ '[]');
	const monthData = JSON.parse(/*[[${monthRatesJson}]]*/ '[]');

  let chart;

  function createChart(dataSet) {
    const ctx = document.getElementById("rateChart").getContext("2d");
    if (chart) chart.destroy();

    const labels = dataSet.map(d => d.date);
    const data = dataSet.map(d => Number(d.rvalue)); // rvalue는 BigDecimal → 숫자로 변환

    const max = Math.max(...data);
    const min = Math.min(...data);
    const maxIdx = data.indexOf(max);
    const minIdx = data.indexOf(min);

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "환율",
          data,
          borderColor: "#FF0004",
          backgroundColor: "rgba(255,0,4,0.1)",
          fill: true,
          tension: 0.4,
          pointRadius: (ctx) => ctx.dataIndex === data.length - 1 ? 5 : 0,
          pointBackgroundColor: "#FF0004"
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.raw.toFixed(4)} 원`
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (val) => `${val}원`
            }
          }
        }
      },
      plugins: [{
        id: 'extremaLabels',
        afterDatasetsDraw(chart) {
          const {ctx, data, scales: {x, y}} = chart;
          ctx.save();
          ctx.font = '12px Noto Sans KR';
          ctx.fillStyle = "#FF0004";

          ctx.fillText(`최고 ${max.toFixed(2)}원`, x.getPixelForValue(maxIdx), y.getPixelForValue(max) - 10);
          ctx.fillText(`최저 ${min.toFixed(2)}원`, x.getPixelForValue(minIdx), y.getPixelForValue(min) + 20);

          ctx.restore();
        }
      }]
    });
  }

  function updateChart(type) {
    if (type === 'week') {
      createChart(weekData);
    } else {
      createChart(monthData);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    updateChart('week');
  });
</script>
</body>
</html>
