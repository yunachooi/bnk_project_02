<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="uid" th:if="${loggedIn}" th:content="${uid}"/>
  <title>BNK 쇼핑환전통장</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Inter',sans-serif;background:#f0f4f8;margin:0;padding:0;overflow-x:hidden;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
    .container{width:100%;max-width:500px;margin:0 auto;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:100vh;display:flex;flex-direction:column;border-radius:1rem;overflow:hidden}
    .header{background:#fff;padding:1rem;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.02)}
    .nav-bar{display:flex;justify-content:space-around;width:100%;background:#fff;border-top:1px solid #e0e0e0;padding:.75rem 0;box-shadow:0 -2px 4px rgba(0,0,0,.02)}
    .nav-button{display:flex;flex-direction:column;align-items:center;font-size:.85rem;color:#6b7280;font-weight:500;transition:color .2s ease}
    .nav-button.active{color:#1a73e8;font-weight:600}
    .content-box{background:#fff;border-radius:1rem;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:1.5rem}
    .primary-button{background:#2563eb;color:#fff;font-weight:600;padding:.75rem 1.5rem;border-radius:.75rem;box-shadow:0 4px 10px rgba(37,99,235,.2);transition:background .3s,transform .2s,box-shadow .3s;width:100%;text-align:center}
    .primary-button:hover{background:#1d4ed8;transform:translateY(-2px);box-shadow:0 6px 14px rgba(37,99,235,.3)}
    .secondary-button{background:#e2e8f0;color:#4a5568;font-weight:600;padding:.75rem 1.5rem;border-radius:.75rem;box-shadow:0 2px 6px rgba(0,0,0,.08);transition:background .3s,transform .2s,box-shadow .3s;width:100%;display:flex;justify-content:center;align-items:center;gap:.5rem}
    .muted{color:#666;font-size:13px}
    .review-tag-button{display:inline-flex;align-items:center;padding:.75rem 1.25rem;border-radius:999px;border:1px solid currentColor;background:var(--tag-bg-color);color:var(--tag-color);font-size:.85rem;cursor:pointer;transition:.2s;margin:.35rem;justify-content:center;gap:.5rem;min-width:120px;flex-shrink:0}
    .review-tag-button.selected{background:#2563eb!important;color:#fff!important;border-color:#2563eb!important;box-shadow:0 2px 5px rgba(37,99,235,.2)}
    .tag-count{margin-left:.5rem;padding:.1rem .4rem;background:#cbd5e0;border-radius:999px;font-size:.75rem;font-weight:600;color:#4a5568;border:1px solid #a0aec0}
    .star-rating{display:flex;align-items:center;gap:.25rem;cursor:pointer}
    .star-rating .star-icon{width:24px;height:24px;color:#d1d5db;transition:color .2s,transform .1s}
    .star-rating .star-icon.filled{color:#f59e0b}
    .star-rating .star-icon.hovered{color:#fbbf24}
    .tag-stats-item{display:flex;flex-direction:column;align-items:flex-start;padding:.5rem 0;border-bottom:1px dashed #e0e0e0}
    .tag-stats-item:last-child{border-bottom:none}
    .tag-stats-name{font-size:.95rem;font-weight:500;display:flex;align-items:center;gap:.25rem}
    .tag-stats-count{font-size:.95rem;font-weight:600;color:#2563eb}
    .tag-bar-container{width:100%;background:#e5e7eb;border-radius:.25rem;height:8px;overflow:hidden;margin-top:.25rem}
    .tag-bar{height:100%;background:linear-gradient(to right,#63b3ed,#2563eb);border-radius:.25rem;transition:width .5s ease-out}
    .pagination-button{background:#e2e8f0;color:#4a5568;font-weight:600;padding:.5rem 1rem;border-radius:.5rem;transition:background .2s}
    .pagination-button:hover:not(:disabled){background:#cbd5e0}
    .pagination-button:disabled{opacity:.5;cursor:not-allowed}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;visibility:hidden;opacity:0;transition:visibility 0s, opacity .3s}
    .modal-overlay.show{visibility:visible;opacity:1}
    .modal-content{background:#fff;padding:2rem;border-radius:1rem;box-shadow:0 8px 20px rgba(0,0,0,.2);text-align:center;max-width:90%;width:min(90vw,350px);position:relative;transform:translateY(20px);transition:transform .3s;display:flex;flex-direction:column;justify-content:center;align-items:center}
    .modal-overlay.show .modal-content{transform:translateY(0)}
    .modal-close-button{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;color:#6b7280;cursor:pointer}
    #benefits-slider-content{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;opacity:0;transform:translateY(100%);transition:all .7s}
    #benefits-slider-content.active{opacity:1;transform:translateY(0)}
    #average-rating-display-container,#average-rating-display,#total-reviews-summary{display:none}
    .tag-scroll-container{display:flex;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:.5rem;margin-bottom:1rem}
    .tag-scroll-container::-webkit-scrollbar{display:none}
    .tag-scroll-container-modal{max-height:150px;overflow-y:auto;flex-wrap:wrap;justify-content:center;padding:.5rem;margin:1rem 0;border:1px solid #e0e0e0;border-radius:.5rem;background:#f9fafb}
    .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;font-size:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:1100;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px);pointer-events:auto}
    .modal-content p{white-space:pre-line}
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1 class="text-2xl font-bold text-gray-800">BNK 쇼핑환전 앱 🌐</h1>
      <div class="flex items-center space-x-2">
        <button id="notification-bell-button" class="relative p-2 rounded-full hover:bg-gray-100" aria-label="알림함 열기">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
          <span id="notification-badge" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center -mt-1 -mr-1 hidden"></span>
        </button>
            <button id="auth-button"
            class="px-3 py-2 rounded-lg border border-gray-200 text-sm font-semibold text-gray-700 hover:bg-gray-100">
      		로그인
    		</button>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-grow p-4 overflow-y-auto">
      <div id="content-area" class="space-y-6"></div>

      <!-- Quick actions -->
      <div class="quick-action-buttons-container mt-6 flex gap-3">
        <a id="card-payment-tile" href="/user/card" class="primary-button" aria-label="카드 결제">카드 결제</a>
        <a class="primary-button" href="/branches" aria-label="영업점 찾기">영업점 찾기</a>
      </div>

      <div class="mt-6 content-box">
        <h3 id="benefits-section-title" class="text-blue-700 mb-3 text-center">BNK 쇼핑환전통장 가입<br/>✨ 고객님들이 받은 혜택이에요! ✨</h3>
        <div id="benefits-info" class="p-8 bg-blue-50 rounded-lg shadow-md text-center text-gray-800 font-medium border border-blue-200 relative overflow-hidden h-48">
          <div id="benefits-slider-content"></div>
        </div>
      </div>

      <!-- Reviews -->
      <section class="mt-6 content-box" id="reviews">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-semibold text-gray-700">상품 후기</h3>
          <div class="flex items-center gap-3">
            <button id="summarize-reviews-button" class="text-blue-600 text-sm font-medium hover:underline">AI 후기 요약 ✨</button>
            <button id="trigger-review-modal-button-header" class="text-blue-600 text-sm font-medium hover:underline flex items-center gap-1">
              리뷰 작성
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>
          </div>
        </div>

        <div id="average-rating-display-container">
          <div id="average-rating-display"></div>
          <span id="total-reviews-summary"></span>
        </div>

        <div class="card p-4 rounded-lg border border-gray-200 bg-white">
          <div id="tag-statistics" class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <p class="font-semibold text-gray-700">어떤 점이 좋았나요? <span id="tag-reviews-count" class="text-sm font-normal text-gray-500"></span></p>
              <button id="toggle-tag-stats" class="text-blue-600 text-sm font-medium hover:underline">펼치기 ></button>
            </div>
            <div id="tag-stats-list"></div>
          </div>

          <div id="reviewList" class="grid gap-4"></div>
          <div id="review-pagination" class="flex justify-center items-center space-x-4 mt-4">
            <button id="prev-review-page" class="pagination-button"><</button>
            <span id="review-page-info" class="text-gray-700 text-sm"></span>
            <button id="next-review-page" class="pagination-button">></button>
          </div>

          <div style="margin-top:10px" id="review-input-section"></div>
          <div class="muted mt-4" id="review-login-prompt">로그인하면 후기를 남길 수 있어요.</div>
        </div>
      </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="nav-bar">
      <a class="nav-button" href="/user/shopping/products" aria-label="해외직구">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
        <span>해외직구</span>
      </a>
      <a class="nav-button active" href="#" aria-current="page">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <span>홈</span>
      </a>
      <a class="nav-button" href="/forex" aria-label="환전">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
        <span>환전</span>
      </a>
    </nav>
  </div>

  <!-- Alert Modal -->
  <div id="payment-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <button id="modal-close-button" class="modal-close-button" aria-label="닫기">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-4">알림</h3>
      <p class="text-gray-700 mb-6">메시지</p>
      <button id="modal-confirm-button" class="primary-button">확인</button>
    </div>
  </div>

  <!-- Inbox Modal -->
  <div id="inbox-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <button id="inbox-modal-close-button" class="modal-close-button" aria-label="닫기">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-4">알림함</h3>
      <div id="inbox-list" class="space-y-2 mb-4"></div>
      <div class="flex gap-2 w-full">
        <button id="inbox-clear-button" class="secondary-button w-1/2">모두 삭제</button>
        <button id="inbox-modal-confirm-button" class="primary-button w-1/2">확인</button>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="review-input-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <button id="review-modal-close-button" class="modal-close-button" aria-label="닫기">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-2">후기 작성</h3>
      <p class="font-semibold text-gray-700">후기를 남겨주시면 BNK에 힘이 됩니다!</p>

      <div id="review-input-modal-tags" class="tag-scroll-container-modal"></div>

      <div class="flex justify-center items-center space-x-4 mb-4">
        <span class="text-gray-700">평점:</span>
        <div id="review-input-modal-star-rating" class="star-rating"></div>
      </div>

      <textarea id="review-input-modal-content" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-y" placeholder="솔직한 후기를 남겨주세요.&#10;(후기 수정 및 삭제는 불가능합니다.)"></textarea>
      <button id="review-input-modal-submit" class="primary-button mt-4">등록하기</button>
    </div>
  </div>

  <!-- Create Child Account Modal -->
  <div id="create-account-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <button id="create-account-modal-close-button" class="modal-close-button" aria-label="닫기">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-4">환전 계좌 추가</h3>
      <p class="font-semibold text-gray-700 mb-4">새로운 통화를 추가할 수 있어요.</p>

      <div class="w-full mb-4">
        <label for="currency-select" class="block text-left text-sm font-medium text-gray-700 mb-1">통화 선택</label>
        <select id="currency-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <option value="USD">USD (미국 달러)</option>
          <option value="JPY">JPY (일본 엔)</option>
          <option value="EUR">EUR (유럽 유로)</option>
        </select>
      </div>

      <div class="w-full mb-4">
        <label class="block text-left text-sm font-medium text-gray-700 mb-1">입금</label>
      </div>

      <div class="w-full mb-6">
        <label for="amount-input" class="block text-left text-sm font-medium text-gray-700 mb-1">금액 (외화)</label>
        <input type="number" id="amount-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="금액을 입력하세요" />
        <p id="krw-equivalent-display" class="text-right text-sm text-gray-600 mt-1"></p>
      </div>

      <button id="create-child-account-submit" class="primary-button">계좌 생성하기</button>
    </div>
  </div>

  <!-- AI Summary Modal -->
  <div id="summary-modal-overlay" class="modal-overlay">
    <div class="modal-content min-h-[300px] h-auto p-6 flex flex-col items-center justify-center">
      <button id="summary-modal-close-button" class="modal-close-button" aria-label="닫기">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-4">AI 후기 요약</h3>
      <div id="summary-loader" class="loader hidden"></div>
      <textarea id="summary-text-area" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none resize-none text-sm text-gray-800 bg-gray-50 leading-relaxed" readonly placeholder="AI가 후기를 요약해 드립니다. 잠시만 기다려 주세요..."></textarea>
      <button id="summary-modal-confirm-button" class="primary-button mt-4">확인</button>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  /* ---------------- auth helpers ---------------- */
  let isLoggedInGlobal = false; // 헤더 토글 표시용

  function renderAuthButton() {
    const btn = document.getElementById('auth-button');
    if (!btn) return;

    // 상태에 따라 라벨과 핸들러 바꿈
    if (isLoggedInGlobal) {
      btn.textContent = '로그아웃';
      btn.onclick = async () => {
        // 1) 서버 로그아웃 시도 (프로젝트에 맞게 경로 변경 가능)
        //    보통 /user/logout 혹은 /logout 을 씀
        const tryLogout = async (url, method='GET') => {
          try {
            const res = await fetch(url, { method, credentials: 'include' });
            return res.ok;
          } catch { return false; }
        };

        let ok = await tryLogout('/user/logout', 'GET');
        if (!ok) ok = await tryLogout('/user/logout', 'POST');
        if (!ok) ok = await tryLogout('/logout', 'POST'); // 스프링 시큐리티 기본값 fallback

        // 2) 클라이언트 상태 리셋
        isLoggedInGlobal = false;
        inboxNotifications.length = 0;
        updateInboxBadge();

        // 3) 메인으로 이동(로그아웃된 상태로 재로딩)
        //    네 구성에 맞춰 홈이 /foreign 이면 그대로 사용
        location.href = '/foreign';
      };
    } else {
      btn.textContent = '로그인';
      btn.onclick = () => {
        // 네 로그인 페이지 경로로 이동
        location.href = '/user/login';
      };
    }
  }
  
  
    /* ---------------- core state ---------------- */
    let currentReviews = [];               // 최신 리뷰 캐시
    let isLoadingReviews = false;          // 동시 로드 방지
    const reviewsPerPage = 1;
    let currentReviewPage = 1;
    let totalReviewPages = 1;
    let showAllTagStats = false;
    let showAllChildAccounts = false;
    let reviewSliderInterval;
    let benefitsInterval;
    let globalAccountData = null;

    /* ---------------- user status ---------------- */
    async function fetchUserStatus(){
      try{
        const res = await fetch('/api/foreign/summary', { headers:{'Accept':'application/json'}, credentials:'include' });
        if(!res.ok) return { isLoggedIn:false, hasProducts:false, accountData:null };
        return await res.json();
      }catch(e){ return { isLoggedIn:false, hasProducts:false, accountData:null }; }
    }

    /* ---------------- inbox / toast / modal ---------------- */
    const inboxNotifications = [];
    const notificationBadge = document.getElementById('notification-badge');
    const inboxModalOverlay = document.getElementById('inbox-modal-overlay');
    const inboxListEl = document.getElementById('inbox-list');

    function updateInboxBadge(){
      const c = inboxNotifications.length;
      if(c>0){ notificationBadge.textContent=c; notificationBadge.classList.remove('hidden'); }
      else { notificationBadge.textContent=''; notificationBadge.classList.add('hidden'); }
    }
    function renderInboxList(){
      if(inboxNotifications.length===0){ inboxListEl.innerHTML='<p class="text-gray-700">새 알림이 없습니다.</p>'; return; }
      inboxListEl.innerHTML = inboxNotifications.map(n=>{
        let cls='border-gray-200 bg-gray-50'; if(n.type==='review') cls='border-emerald-200 bg-emerald-50'; if(n.type==='warning') cls='border-red-200 bg-red-50';
        return `<div class="p-3 rounded-lg border ${cls} text-sm text-gray-800">${escapeHtml(n.message)}</div>`;
      }).join('');
    }
    function showInboxModal(){ renderInboxList(); inboxModalOverlay.classList.add('show'); document.body.style.overflow='hidden'; }
    function hideInboxModal(){ inboxModalOverlay.classList.remove('show'); document.body.style.overflow=''; }

    const paymentModalOverlay = document.getElementById('payment-modal-overlay');
    const modalTitle = paymentModalOverlay.querySelector('h3');
    const modalMessage = paymentModalOverlay.querySelector('p');
    function showPaymentModal(title,message){ modalTitle.textContent=title; modalMessage.textContent=message; paymentModalOverlay.classList.add('show'); document.body.style.overflow='hidden'; }
    function hidePaymentModal(){ paymentModalOverlay.classList.remove('show'); document.body.style.overflow=''; }

    function showToast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2200); }

    /* ---------------- tags / colors ---------------- */
    let allAvailableTags = ["사용하기 편해요","다양한 통화 지원","환전 수수료 저렴","해외직구 필수","계좌 관리 편리","빠른 처리","고객 서비스 우수"];
    const tagColors = ['#007bff','#28a745','#dc3545','#ffc107','#6f42c1','#fd7e14','#20c997','#6c757d'];
    const tagEmojis = {"사용하기 편해요":"👍","다양한 통화 지원":"🌍","환전 수수료 저렴":"💰","해외직구 필수":"🛒","계좌 관리 편리":"💼","빠른 처리":"⚡","고객 서비스 우수":"✨"};
    function getColorForTag(tag){ const i = allAvailableTags.indexOf(tag); return i!==-1 ? tagColors[i%tagColors.length] : '#000'; }
    function hexToRgb(hex){ const b=parseInt(hex.slice(1),16); return {r:(b>>16)&255,g:(b>>8)&255,b:b&255}; }
    function getTagStyle(tag){ const c=getColorForTag(tag); const {r,g,b}=hexToRgb(c); return {backgroundColor:`rgba(${r},${g},${b},0.1)`,color:c}; }

    /* ---------------- helpers ---------------- */
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&#34;',"'":'&#39;' }[m])); }
    function renderStarIcons(rating){ let h=''; for(let i=1;i<=5;i++){ h+=`<svg class="star-icon ${i<=rating?'filled':''}" data-star="${i}" fill="currentColor" viewBox="0 0 24 24"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.691h4.178c.969 0 1.371 1.24.588 1.81l-3.388 2.464a1 1 0 00-.363 1.118l1.287 3.957c.3.921-.755 1.683-1.539 1.118l-3.388-2.464a1 1 0 00-1.176 0l-3.388 2.464c-.784.565-1.839-.197-1.539-1.118l1.287-3.957a1 1 0 00-.363-1.118L2.583 9.385c-.783-.57-.381-1.81.588-1.81h4.178a1 1 0 00.95-.691l1.286-3.957z"/></svg>`; } return h; }
    function formatAccountNo(num, groups=[3,4,6], sep="-"){ const d=String(num??"").replace(/\D/g,""); let i=0,out=[]; for(const g of groups){ if(i>=d.length) break; out.push(d.slice(i,i+g)); i+=g; } if(i<d.length) out.push(d.slice(i)); return out.join(sep); }

    /* ---------------- API: reviews ---------------- */
    async function fetchReviewsFromApi(){
      const res = await fetch('/api/reviews/recent2?limit=50', { headers:{'Accept':'application/json'}, credentials:'include' });
      if(!res.ok){ currentReviews = []; return { items:[] }; }
      const data = await res.json().catch(()=>({ items:[] }));
      currentReviews = (data.items||[]).map(x=>({
        id: x.id ?? x.rvno ?? 0,
        uidMasked: x.uidMasked ?? (x.uid ? (x.uid.length<=2 ? x.uid+'***' : x.uid.slice(0,2)+'***') : '익명'),
        date: x.date ?? x.rvdate ?? '',
        rating: Number(x.rating ?? x.rvrating ?? 0),
        content: x.content ?? x.rvcontent ?? '',
        tags: x.tags ?? []
      }));
      return { items: currentReviews };
    }

    async function submitReviewToApi(content, rating){
      const body = new URLSearchParams({ content: content ?? '', rating: String(rating ?? 5) });
      const res = await fetch('/api/reviews/create', {
        method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json'},
        credentials:'include', body
      });
      return await res.json().catch(()=>({ ok:false }));
    }

    /* ---------------- reviews rendering ---------------- */
    const reviewList = document.getElementById('reviewList');
    const tagStatsList = document.getElementById('tag-stats-list');
    const tagReviewsCountSpan = document.getElementById('tag-reviews-count');
    const prevReviewPageButton = document.getElementById('prev-review-page');
    const nextReviewPageButton = document.getElementById('next-review-page');
    const reviewPageInfoSpan = document.getElementById('review-page-info');

    function updatePaginationControls(){
      prevReviewPageButton.disabled = (currentReviewPage===1);
      nextReviewPageButton.disabled = (currentReviewPage===totalReviewPages || totalReviewPages===0);
      reviewPageInfoSpan.textContent = `${currentReviewPage} / ${totalReviewPages}`;
    }

    function updateTagStatistics(){
      const counts = {};
      (currentReviews||[]).forEach(r => (r.tags||[]).forEach(t => counts[t]=(counts[t]||0)+1));
      const display = allAvailableTags.map(name=>({name, count: counts[name]||0}));
      const topTags = display.filter(t=>t.count>0).sort((a,b)=>b.count-a.count);
      const maxCount = topTags.length>0 ? topTags[0].count : 1;
      let html='';
      const tagsToShow = showAllTagStats ? topTags : topTags.slice(0,2);
      if(tagsToShow.length>0){
        tagsToShow.forEach(tag=>{
          const pct = (tag.count/maxCount)*100;
          const color = getColorForTag(tag.name);
          const emoji = tagEmojis[tag.name] || '';
          html += `
            <div class="tag-stats-item">
              <div class="flex justify-between w-full mb-1">
                <span class="tag-stats-name" style="color:${color};">${emoji} ${escapeHtml(tag.name)}</span>
                <span class="tag-stats-count">${tag.count}회</span>
              </div>
              <div class="tag-bar-container"><div class="tag-bar" style="width:${pct}%;"></div></div>
            </div>`;
        });
      } else {
        html = '<p class="text-center text-gray-500 text-sm">아직 태그 후기가 없습니다.</p>';
      }
      tagStatsList.innerHTML = html;
      const toggleBtn = document.getElementById('toggle-tag-stats');
      if(topTags.length>2){ toggleBtn.style.display='block'; toggleBtn.textContent = showAllTagStats ? '접기 <' : '펼치기 >'; }
      else { toggleBtn.style.display='none'; }
      tagReviewsCountSpan.textContent = `(총 ${currentReviews.length.toLocaleString('ko-KR')}개)`;
    }

    function renderReviewsPage(){
      reviewList.innerHTML = '';
      const startIndex = (currentReviewPage-1)*reviewsPerPage;
      const endIndex = startIndex + reviewsPerPage;
      const reviewsToDisplay = currentReviews.slice(startIndex, endIndex);
      if(reviewsToDisplay.length===0){
        reviewList.innerHTML = '<div class="text-center text-gray-500 p-4">등록된 후기가 없습니다.</div>';
        return;
      }
      reviewsToDisplay.forEach(it=>{
        const div=document.createElement('div');
        div.className='p-3 bg-gray-50 rounded-lg shadow-sm text-gray-700 border border-gray-100';
        const tagsHtml = it.tags && it.tags.length ? `<div class="flex flex-wrap gap-1 mt-2">${
          it.tags.map(tag=>{ const st=getTagStyle(tag); const emoji=tagEmojis[tag]||''; return `<span class="px-2 py-0.5 rounded-full text-xs font-medium flex items-center gap-1" style="background-color:${st.backgroundColor};color:${st.color};">${emoji} ${escapeHtml(tag)}</span>`; }).join('')
        }</div>` : '';
        div.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <b>${it.uidMasked||''}</b>
            <span class="muted">${it.date||''}</span>
          </div>
          <div class="flex items-center mb-2"><div class="star-rating">${renderStarIcons(it.rating)}</div></div>
          <p class="text-base">${escapeHtml(it.content||'')}</p>
          ${tagsHtml}`;
        reviewList.appendChild(div);
      });
    }

    async function loadReviews(refetch=false){
      stopReviewSlider();
      if(isLoadingReviews) return;
      try{
        isLoadingReviews = true;
        if(refetch || currentReviews.length===0){
          await fetchReviewsFromApi();    // 서버 호출: 최초/등록 후에만
        }
        totalReviewPages = Math.ceil(currentReviews.length / reviewsPerPage) || 1;
        if(currentReviewPage>totalReviewPages) currentReviewPage=1;
        renderReviewsPage();
        updatePaginationControls();
        updateTagStatistics();
      } finally {
        isLoadingReviews = false;
        startReviewSlider();              // 화면만 넘김(재요청 없음)
      }
    }

    function startReviewSlider(){
      if(reviewSliderInterval) clearInterval(reviewSliderInterval);
      reviewSliderInterval = setInterval(()=>{
        currentReviewPage++;
        if(currentReviewPage>totalReviewPages || totalReviewPages===0) currentReviewPage=1;
        renderReviewsPage();              // 캐시만 사용
        updatePaginationControls();
      }, 4000);
    }
    function stopReviewSlider(){ if(reviewSliderInterval){ clearInterval(reviewSliderInterval); reviewSliderInterval=null; } }

    /* ---------------- review modal ---------------- */
    const reviewInputModalOverlay = document.getElementById('review-input-modal-overlay');
    const reviewInputModalContent = document.getElementById('review-input-modal-content');
    const reviewInputModalSubmitButton = document.getElementById('review-input-modal-submit');
    const reviewLoginPrompt = document.getElementById('review-login-prompt');
    let selectedTagsForModal = new Set();
    let currentRatingForModal = 0;

    function renderTagsForModal(){
      const div=document.getElementById('review-input-modal-tags'); div.innerHTML='';
      allAvailableTags.forEach(tag=>{
        const btn=document.createElement('button'); btn.type='button';
        const emoji=tagEmojis[tag]||''; const st=getTagStyle(tag);
        btn.innerHTML=`${emoji} ${escapeHtml(tag)}`; btn.className='review-tag-button';
        btn.style.setProperty('--tag-bg-color', st.backgroundColor); btn.style.setProperty('--tag-color', st.color);
        if(selectedTagsForModal.has(tag)) btn.classList.add('selected');
        btn.addEventListener('click', ()=>{
          if(selectedTagsForModal.has(tag)){ selectedTagsForModal.delete(tag); btn.classList.remove('selected'); }
          else { selectedTagsForModal.add(tag); btn.classList.add('selected'); }
        });
        div.appendChild(btn);
      });
    }
    function setupStarRatingForModal(){
      const div=document.getElementById('review-input-modal-star-rating'); div.innerHTML=renderStarIcons(currentRatingForModal);
      const stars = div.querySelectorAll('.star-icon');
      stars.forEach(star=>{
        star.addEventListener('mouseover',()=>{ const v=parseInt(star.dataset.star,10); stars.forEach((s,idx)=>(idx<v? s.classList.add('hovered') : s.classList.remove('hovered'))); });
        star.addEventListener('mouseout',()=>{ stars.forEach(s=>s.classList.remove('hovered')); });
        star.addEventListener('click',()=>{ const v=parseInt(star.dataset.star,10); currentRatingForModal=v; stars.forEach((s,idx)=>(idx<v? s.classList.add('filled') : s.classList.remove('filled'))); });
      });
    }
    function closeReviewModal(){ reviewInputModalOverlay.classList.remove('show'); document.body.style.overflow=''; }

    /* ---------------- summary ---------------- */
    const summaryModalOverlay = document.getElementById('summary-modal-overlay');
    const summaryLoader = document.getElementById('summary-loader');
    const summaryTextArea = document.getElementById('summary-text-area');
    function summarizeReviewsLocally(revs){
      if(!revs || revs.length===0) return '아직 등록된 후기가 없어 요약할 내용이 없습니다.';
      const total=revs.length, avg=(revs.reduce((s,r)=>s+r.rating,0)/total).toFixed(1);
      const positives=revs.filter(r=>r.rating>=4), negatives=revs.filter(r=>r.rating<=2), neutrals=revs.filter(r=>r.rating===3);
      const tagCount={}; revs.forEach(r=>(r.tags||[]).forEach(t=>tagCount[t]=(tagCount[t]||0)+1));
      const topTags=Object.entries(tagCount).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=>`${k} (${v})`);
      const improv=negatives.concat(neutrals).slice(0,3).map(r=>`- ${r.content}`);
      return [
        `총 ${total}개 후기, 평균 ★${avg}`,
        ``,
        `👍 긍정 요약: ${positives.length}건`,
        topTags.length ? `• 많이 언급된 태그: ${topTags.join(', ')}` : `• 많이 언급된 태그가 아직 없습니다.`,
        ``,
        `🤔 보통/부정 요약: ${neutrals.length + negatives.length}건`,
        improv.length ? improv.join('\n') : '• 크게 드러난 개선 의견이 적습니다.',
        ``,
        `한 줄 정리: 사용성/수수료가 강점으로 나타납니다.`
      ].join('\n');
    }
    async function generateReviewSummary(){
      summaryTextArea.value=''; summaryLoader.classList.remove('hidden'); summaryTextArea.classList.add('hidden'); summaryModalOverlay.classList.add('show');
      try{ if(currentReviews.length===0) await fetchReviewsFromApi(); summaryTextArea.value=summarizeReviewsLocally(currentReviews); }
      catch{ summaryTextArea.value='후기 요약에 실패했습니다. 다시 시도해 주세요.'; }
      finally{ summaryLoader.classList.add('hidden'); summaryTextArea.classList.remove('hidden'); }
    }

    /* ---------------- benefits ---------------- */
    let currentBenefitIndex=0;
    const benefitItems=[
      { type:'savings',  emoji:'💰', firstLine:'환전 수수료를<br>', value:0,max:75000000,minIncrement:500000,maxIncrement:1500000,valueSuffix:'원', verb:'아끼셨어요!' },
      { type:'interest', emoji:'📈', firstLine:'이자 혜택을<br>',   value:0,max:5000000, minIncrement:50000, maxIncrement:150000,  valueSuffix:'원', verb:'받으셨어요!' },
      { type:'theft',    emoji:'🔒', firstLine:'결제 비활성화 기능으로<br>도난을 ', value:0,max:2000,minIncrement:50,maxIncrement:150,valueSuffix:'번', verb:'방지했어요!' }
    ];
    const benefitsSliderContent = document.getElementById('benefits-slider-content');
    function showNextBenefit(){
      const cur=benefitItems[currentBenefitIndex];
      const rand=Math.floor(Math.random()*(cur.maxIncrement-cur.minIncrement+1))+cur.minIncrement;
      cur.value = cur.value<cur.max ? Math.min(cur.value+rand,cur.max) : 0;
      benefitsSliderContent.style.transition='none'; benefitsSliderContent.style.opacity='0'; benefitsSliderContent.style.transform='translateY(100%)';
      setTimeout(()=>{ const val=cur.value.toLocaleString('ko-KR'); benefitsSliderContent.innerHTML=`<p class="text-xl font-bold benefit-text">${cur.emoji}${cur.firstLine}<span class="text-red-600">${val}${cur.valueSuffix}</span> ${cur.verb}</p>`;
        benefitsSliderContent.style.transition='all .7s'; benefitsSliderContent.style.opacity='1'; benefitsSliderContent.style.transform='translateY(0)';
        currentBenefitIndex=(currentBenefitIndex+1)%benefitItems.length;
      },50);
    }
    function startBenefitsSlider(){ showNextBenefit(); benefitsInterval=setInterval(showNextBenefit,3000); }

    /* ---------------- content (accounts) ---------------- */
    function renderReviewInputSection(isLoggedIn){ const s=document.getElementById('review-input-section'); const p=document.getElementById('review-login-prompt'); if(isLoggedIn){ s.innerHTML=''; p.style.display='none'; } else { s.innerHTML=''; p.style.display='block'; } }
    function getCardDesignStyle(){ return { backgroundImage:'none', textColor:'#111827' }; }
    function renderContent(isLoggedIn, hasProducts, accountData){
    	isLoggedInGlobal = !!isLoggedIn;  // ✅ 전역 상태 업데이트
    	renderAuthButton();               // ✅ 헤더 버튼 그리기
    	globalAccountData=accountData;
      const contentArea=document.getElementById('content-area');
      if(!isLoggedIn){
        contentArea.innerHTML = `
          <div class="content-box text-center mt-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">내 통장 정보</h2>
            <p class="text-lg font-medium text-gray-800 mb-6">로그인이 필요합니다!</p>
            <button id="login-button" class="primary-button">로그인 페이지로 이동</button>
          </div>`;
        document.getElementById('login-button').addEventListener('click',()=>location.href='/user/login');
        renderReviewInputSection(false); return;
      }
      if(!hasProducts){
        contentArea.innerHTML = `
          <div class="content-box text-center mt-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">내 통장 정보</h2>
            <p class="text-lg font-medium text-gray-800 mb-6">상품을 가입해 주세요!</p>
            <button id="signup-button" class="primary-button">상품 가입하기</button>
          </div>`;
        document.getElementById('signup-button').addEventListener('click',()=>location.href='/foreign1');
        renderReviewInputSection(false); return;
      }
      const allChildAccounts = accountData.childAccounts||[];
      const maxDisplayChildren=3;
      const childrenToDisplay = showAllChildAccounts ? allChildAccounts : allChildAccounts.slice(0,maxDisplayChildren);
      const hasMoreChildren = allChildAccounts.length>maxDisplayChildren;
      const cardDesign=getCardDesignStyle();
      const dynamicBgStyle = cardDesign.backgroundImage?`background-image:${cardDesign.backgroundImage};background-size:cover;background-position:center;`:'';
      const accountNumberColor='#4a5568';
      let childHtml='';
      if(allChildAccounts.length>0){
        childHtml = `<div class="mt-4"><div class="grid grid-cols-3 gap-3">`+
          childrenToDisplay.map(c=>`
            <div class="p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200 text-center">
              <div class="flex justify-center items-center mb-1"><b class="text-gray-800">${c.currencyCode}</b></div>
              <div class="text-gray-800 mt-1 text-base font-bold">${c.balance}</div>
            </div>`).join('') + `</div>` + (hasMoreChildren?`
            <div class="mt-4 text-center">
              <button id="toggle-child-accounts" class="text-blue-600 text-sm font-medium hover:underline">${showAllChildAccounts?'접기 <':'더보기 >'}</button>
            </div>`:'') + `</div>`;
      }else{ childHtml='<div class="muted mt-4">연결된 자식 통장이 없습니다.</div>'; }
      contentArea.innerHTML = `
        <div class="content-box relative overflow-hidden" style="${dynamicBgStyle}">
          <div class="flex justify-between items-start mb-4">
            <h2 class="text-xl font-semibold text-gray-800">BNK 쇼핑환전통장</h2>
            <button id="add-child-account-button" class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-blue-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
          </div>
          <div class="mb-4">
            <div class="flex items-center" style="color:${accountNumberColor};">
              <span id="parent-account-number" data-raw="${accountData.parentAccountNo}" class="text-lg font-bold">${formatAccountNo(accountData.parentAccountNo,[3,2,6])}</span>
              <button id="copy-account-number" class="p-1 rounded-full hover:bg-gray-100 ml-1" aria-label="계좌번호 복사">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color:${accountNumberColor};"><path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"/></svg>
              </button>
            </div>
          </div>
          ${childHtml}
        </div>`;
      document.getElementById('add-child-account-button').addEventListener('click', showCreateAccountModal);
      const copyBtn=document.getElementById('copy-account-number');
      if(copyBtn) copyBtn.addEventListener('click',()=>{
        const el=document.getElementById('parent-account-number'); const num = el?(el.dataset.raw || el.textContent.replace(/\D/g,'').trim()):'';
        if(!num){ showPaymentModal('알림','복사할 계좌번호가 없습니다.'); return; }
        try{ const ta=document.createElement('textarea'); ta.value=num; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showPaymentModal('알림','계좌번호가 복사되었습니다!'); }
        catch{ showPaymentModal('알림','계좌번호 복사에 실패했습니다.'); }
      });
      const toggleBtn=document.getElementById('toggle-child-accounts');
      if(toggleBtn) toggleBtn.addEventListener('click',()=>{ showAllChildAccounts=!showAllChildAccounts; renderContent(isLoggedIn,hasProducts,globalAccountData); });
      renderReviewInputSection(true);
    }

    /* ---------------- create child account (mock UI) ---------------- */
    const mockExchangeRates={'USD':1350,'JPY':9.2,'EUR':1480};
    const createAccountModalOverlay=document.getElementById('create-account-modal-overlay');
    const currencySelect=document.getElementById('currency-select');
    const amountInput=document.getElementById('amount-input');
    const krwEquivalentDisplay=document.getElementById('krw-equivalent-display');
    function updateKrwEquivalent(){ const c=currencySelect.value; const amt=parseFloat(amountInput.value); if(!isNaN(amt)&&amt>0&&mockExchangeRates[c]){ const krw=amt*mockExchangeRates[c]; krwEquivalentDisplay.textContent=`(약 ${krw.toLocaleString('ko-KR')}원)`; } else { krwEquivalentDisplay.textContent=''; } }
    function showCreateAccountModal(){ createAccountModalOverlay.classList.add('show'); document.body.style.overflow='hidden'; currencySelect.value='USD'; amountInput.value=''; krwEquivalentDisplay.textContent=''; }
    function hideCreateAccountModal(){ createAccountModalOverlay.classList.remove('show'); document.body.style.overflow=''; }
    async function createChildAccount(currencyCode, amount){
      return new Promise(resolve=>{ setTimeout(()=>{ if(globalAccountData && globalAccountData.childAccounts){ const idx=globalAccountData.childAccounts.findIndex(a=>a.currencyCode===currencyCode);
        if(idx>-1){ let cur=parseFloat(String(globalAccountData.childAccounts[idx].balance).replace(/,/g,'')); cur += parseFloat(amount);
          globalAccountData.childAccounts[idx].balance = cur.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        } else { globalAccountData.childAccounts.push({ currencyCode, currencyFullName:`${currencyCode}`, balance: `${parseFloat(amount).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}` }); }
        resolve({success:true}); } else resolve({success:false}); }, 400); });
    }

    /* ---------------- forbidden words ---------------- */
    const forbiddenPatterns=[
      {label:'씨발',re:/(?:ㅅ\s*ㅂ|시+\s*발|씨+\s*발)/gi},
      {label:'개새끼',re:/개\s*새+끼/gi},
      {label:'병신',re:/병\s*신/gi},
      {label:'지랄',re:/지\s*랄/gi},
      {label:'염병',re:/염\s*병/gi},
      {label:'욕설(영문 f)',re:/f\s*u\s*c\s*k/gi},
      {label:'욕설(영문 s)',re:/s\s*h\s*i\s*t/gi},
      {label:'bitch',re:/b\s*i\s*t\s*c\s*h/gi},
      {label:'asshole',re:/a\s*s\s*s\s*h\s*o\s*l\s*e/gi}
    ];
    function findForbiddenWords(text){ const found=new Set(); const n=String(text||'').normalize('NFKC'); forbiddenPatterns.forEach(({label,re})=>{ if(re.test(n)) found.add(label); re.lastIndex=0; }); return [...found]; }

    /* ---------------- DOM refs ---------------- */
    const contentArea=document.getElementById('content-area');
    const notificationBellButton=document.getElementById('notification-bell-button');
    const paymentModalCloseButton=document.getElementById('modal-close-button');
    const paymentModalConfirmButton=document.getElementById('modal-confirm-button');
    const inboxModalCloseButton=document.getElementById('inbox-modal-close-button');
    const inboxModalConfirmButton=document.getElementById('inbox-modal-confirm-button');
    const inboxClearButton=document.getElementById('inbox-clear-button');
    const reviewModalCloseButton=document.getElementById('review-modal-close-button');
    const triggerReviewModalButton=document.getElementById('trigger-review-modal-button-header');
    const summarizeReviewsButton=document.getElementById('summarize-reviews-button');
    const summaryModalCloseButton=document.getElementById('summary-modal-close-button');
    const summaryModalConfirmButton=document.getElementById('summary-modal-confirm-button');
    const benefitsSectionTitle=document.getElementById('benefits-section-title');

    /* ---------------- init ---------------- */
    document.addEventListener('DOMContentLoaded', async ()=>{
      const { isLoggedIn, hasProducts, accountData } = await fetchUserStatus();
      renderContent(isLoggedIn, hasProducts, accountData);
      await loadReviews(true);      // 최초 1회만 서버 조회
      startBenefitsSlider();

      paymentModalCloseButton.addEventListener('click', hidePaymentModal);
      paymentModalConfirmButton.addEventListener('click', hidePaymentModal);
      paymentModalOverlay.addEventListener('click',e=>{ if(e.target===paymentModalOverlay) hidePaymentModal(); });

      notificationBellButton.addEventListener('click', showInboxModal);
      inboxModalCloseButton.addEventListener('click', hideInboxModal);
      inboxModalConfirmButton.addEventListener('click', hideInboxModal);
      inboxModalOverlay.addEventListener('click',e=>{ if(e.target===inboxModalOverlay) hideInboxModal(); });
      inboxClearButton.addEventListener('click',()=>{ inboxNotifications.length=0; renderInboxList(); updateInboxBadge(); showToast('알림함이 비워졌습니다.'); });

      triggerReviewModalButton.addEventListener('click', ()=>{
        selectedTagsForModal.clear(); currentRatingForModal=0; reviewInputModalContent.value='';
        renderTagsForModal(); setupStarRatingForModal();
        reviewInputModalOverlay.classList.add('show'); document.body.style.overflow='hidden';
      });
      reviewModalCloseButton.addEventListener('click', closeReviewModal);
      reviewInputModalOverlay.addEventListener('click',e=>{ if(e.target===reviewInputModalOverlay) closeReviewModal(); });

      reviewInputModalSubmitButton.addEventListener('click', async ()=>{
        const content = reviewInputModalContent.value.trim();
        const rating = currentRatingForModal;
        const tags = Array.from(selectedTagsForModal);

        if(!content){ showPaymentModal('알림','내용을 입력하세요.'); return; }
        if(rating===0){ showPaymentModal('알림','평점을 선택해 주세요.'); return; }

        const bad = findForbiddenWords(content);
        if(bad.length>0){
          closeReviewModal();
          inboxNotifications.unshift({type:'warning', message:`후기 등록 거절: 금지 표현(${bad.join(', ')})이 포함되어 있습니다.`, at:Date.now()});
          updateInboxBadge(); renderInboxList();
          showPaymentModal('경고','욕설/모욕적인 표현이 포함되어\n후기를 등록할 수 없습니다.');
          return;
        }

        const res = await submitReviewToApi(content, rating /*, tags - 서버 미저장*/);
        if(res.ok){
          closeReviewModal();
          inboxNotifications.unshift({type:'review', message:'후기가 등록되었습니다. 감사합니다!', at:Date.now()});
          updateInboxBadge();
          currentReviewPage=1;
          await loadReviews(true);     // 등록 직후에만 재조회
          showToast('후기가 등록되었습니다.');
        }else{
          if(res.error==='LOGIN_REQUIRED'){ reviewLoginPrompt.style.display='block'; showPaymentModal('알림','로그인이 필요합니다.'); }
          else if(res.error==='EMPTY_CONTENT'){ showPaymentModal('알림','내용을 입력해주세요.'); }
          else { showPaymentModal('알림','후기 등록에 실패했습니다.'); }
        }
      });

      summarizeReviewsButton.addEventListener('click', generateReviewSummary);
      summaryModalCloseButton.addEventListener('click', ()=>summaryModalOverlay.classList.remove('show'));
      summaryModalConfirmButton.addEventListener('click', ()=>summaryModalOverlay.classList.remove('show'));

      document.getElementById('toggle-tag-stats').addEventListener('click', ()=>{ showAllTagStats=!showAllTagStats; updateTagStatistics(); });
      prevReviewPageButton.addEventListener('click', ()=>{ if(currentReviewPage>1){ currentReviewPage--; renderReviewsPage(); updatePaginationControls(); } });
      nextReviewPageButton.addEventListener('click', ()=>{ if(currentReviewPage<totalReviewPages){ currentReviewPage++; renderReviewsPage(); updatePaginationControls(); } });

      // create account modal events
      const createAccountModalCloseButton=document.getElementById('create-account-modal-close-button');
      const createChildAccountSubmitButton=document.getElementById('create-child-account-submit');
      const currencySel=document.getElementById('currency-select'); const amountInp=document.getElementById('amount-input');
      document.getElementById('add-child-account-button')?.addEventListener('click',showCreateAccountModal);
      createAccountModalCloseButton.addEventListener('click', hideCreateAccountModal);
      createAccountModalOverlay.addEventListener('click',e=>{ if(e.target===createAccountModalOverlay) hideCreateAccountModal(); });
      currencySel.addEventListener('change', updateKrwEquivalent);
      amountInp.addEventListener('input', updateKrwEquivalent);
      createChildAccountSubmitButton.addEventListener('click', async ()=>{
        const c=currencySel.value; const a=parseFloat(amountInp.value);
        if(isNaN(a)||a<=0){ showPaymentModal('알림','금액을 입력하세요.'); return; }
        const { success } = await createChildAccount(c,a);
        if(success){ hideCreateAccountModal(); renderContent(true,true,globalAccountData); showToast('계좌가 추가/갱신되었습니다.'); }
        else { showPaymentModal('알림','계좌 생성 실패'); }
      });

    });

  </script>
</body>
</html>
