<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="uid" th:if="${loggedIn}" th:content="${uid}"/>
  <title>BNK ì‡¼í•‘í™˜ì „í†µì¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Inter',sans-serif;background:#f0f4f8;margin:0;padding:0;overflow-x:hidden;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
    .container{width:100%;max-width:500px;margin:0 auto;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:100vh;display:flex;flex-direction:column;border-radius:1rem;overflow:hidden}
    .header{background:#fff;padding:1rem;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.02)}
    .nav-bar{display:flex;justify-content:space-around;width:100%;background:#fff;border-top:1px solid #e0e0e0;padding:.75rem 0;box-shadow:0 -2px 4px rgba(0,0,0,.02)}
    .nav-button{display:flex;flex-direction:column;align-items:center;font-size:.85rem;color:#6b7280;font-weight:500;transition:color .2s ease}
    .nav-button.active{color:#1a73e8;font-weight:600}
    .content-box{background:#fff;border-radius:1rem;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:1.5rem}
    .primary-button{background:#2563eb;color:#fff;font-weight:600;padding:.75rem 1.5rem;border-radius:.75rem;box-shadow:0 4px 10px rgba(37,99,235,.2);transition:background .3s,transform .2s,box-shadow .3s;width:100%;text-align:center}
    .primary-button:hover{background:#1d4ed8;transform:translateY(-2px);box-shadow:0 6px 14px rgba(37,99,235,.3)}
    .secondary-button{background:#e2e8f0;color:#4a5568;font-weight:600;padding:.75rem 1.5rem;border-radius:.75rem;box-shadow:0 2px 6px rgba(0,0,0,.08);transition:background .3s,transform .2s,box-shadow .3s;width:100%;display:flex;justify-content:center;align-items:center;gap:.5rem}
    .muted{color:#666;font-size:13px}
    .review-tag-button{display:inline-flex;align-items:center;padding:.75rem 1.25rem;border-radius:999px;border:1px solid currentColor;background:var(--tag-bg-color);color:var(--tag-color);font-size:.85rem;cursor:pointer;transition:.2s;margin:.35rem;justify-content:center;gap:.5rem;min-width:120px;flex-shrink:0}
    .review-tag-button.selected{background:#2563eb!important;color:#fff!important;border-color:#2563eb!important;box-shadow:0 2px 5px rgba(37,99,235,.2)}
    .tag-count{margin-left:.5rem;padding:.1rem .4rem;background:#cbd5e0;border-radius:999px;font-size:.75rem;font-weight:600;color:#4a5568;border:1px solid #a0aec0}
    .star-rating{display:flex;align-items:center;gap:.25rem;cursor:pointer}
    .star-rating .star-icon{width:24px;height:24px;color:#d1d5db;transition:color .2s,transform .1s}
    .star-rating .star-icon.filled{color:#f59e0b}
    .star-rating .star-icon.hovered{color:#fbbf24}
    .tag-stats-item{display:flex;flex-direction:column;align-items:flex-start;padding:.5rem 0;border-bottom:1px dashed #e0e0e0}
    .tag-stats-item:last-child{border-bottom:none}
    .tag-stats-name{font-size:.95rem;font-weight:500;display:flex;align-items:center;gap:.25rem}
    .tag-stats-count{font-size:.95rem;font-weight:600;color:#2563eb}
    .tag-bar-container{width:100%;background:#e5e7eb;border-radius:.25rem;height:8px;overflow:hidden;margin-top:.25rem}
    .tag-bar{height:100%;background:linear-gradient(to right,#63b3ed,#2563eb);border-radius:.25rem;transition:width .5s ease-out}
    .pagination-button{background:#e2e8f0;color:#4a5568;font-weight:600;padding:.5rem 1rem;border-radius:.5rem;transition:background .2s}
    .pagination-button:hover:not(:disabled){background:#cbd5e0}
    .pagination-button:disabled{opacity:.5;cursor:not-allowed}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;visibility:hidden;opacity:0;transition:visibility 0s, opacity .3s}
    .modal-overlay.show{visibility:visible;opacity:1}
    .modal-content{background:#fff;padding:2rem;border-radius:1rem;box-shadow:0 8px 20px rgba(0,0,0,.2);text-align:center;max-width:90%;width:min(90vw,350px);position:relative;transform:translateY(20px);transition:transform .3s;display:flex;flex-direction:column;justify-content:center;align-items:center}
    .modal-overlay.show .modal-content{transform:translateY(0)}
    .modal-close-button{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;color:#6b7280;cursor:pointer}
    #benefits-slider-content{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;opacity:0;transform:translateY(100%);transition:all .7s}
    #benefits-slider-content.active{opacity:1;transform:translateY(0)}
    #average-rating-display-container,#average-rating-display,#total-reviews-summary{display:none}
    .tag-scroll-container{display:flex;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:.5rem;margin-bottom:1rem}
    .tag-scroll-container::-webkit-scrollbar{display:none}
    .tag-scroll-container-modal{max-height:150px;overflow-y:auto;flex-wrap:wrap;justify-content:center;padding:.5rem;margin:1rem 0;border:1px solid #e0e0e0;border-radius:.5rem;background:#f9fafb}
    .loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;font-size:14px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:1100;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px);pointer-events:auto}
    .modal-content p{white-space:pre-line}
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1 class="text-2xl font-bold text-gray-800">BNK ì‡¼í•‘í™˜ì „ ì•± ğŸŒ</h1>
      <div class="flex items-center space-x-2">
        <button id="notification-bell-button" class="relative p-2 rounded-full hover:bg-gray-100" aria-label="ì•Œë¦¼í•¨ ì—´ê¸°">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
          <span id="notification-badge" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center -mt-1 -mr-1 hidden"></span>
        </button>
            <button id="auth-button"
            class="px-3 py-2 rounded-lg border border-gray-200 text-sm font-semibold text-gray-700 hover:bg-gray-100">
      		ë¡œê·¸ì¸
    		</button>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-grow p-4 overflow-y-auto">
      <div id="content-area" class="space-y-6"></div>

      <!-- Quick actions -->
      <div class="quick-action-buttons-container mt-6 flex gap-3">
        <a id="card-payment-tile" href="/user/card" class="primary-button" aria-label="ì¹´ë“œ ê²°ì œ">ì¹´ë“œ ê²°ì œ</a>
        <a class="primary-button" href="/branches" aria-label="ì˜ì—…ì  ì°¾ê¸°">ì˜ì—…ì  ì°¾ê¸°</a>
      </div>

      <div class="mt-6 content-box">
        <h3 id="benefits-section-title" class="text-blue-700 mb-3 text-center">BNK ì‡¼í•‘í™˜ì „í†µì¥ ê°€ì…<br/>âœ¨ ê³ ê°ë‹˜ë“¤ì´ ë°›ì€ í˜œíƒì´ì—ìš”! âœ¨</h3>
        <div id="benefits-info" class="p-8 bg-blue-50 rounded-lg shadow-md text-center text-gray-800 font-medium border border-blue-200 relative overflow-hidden h-48">
          <div id="benefits-slider-content"></div>
        </div>
      </div>

      <!-- Reviews -->
      <section class="mt-6 content-box" id="reviews">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-semibold text-gray-700">ìƒí’ˆ í›„ê¸°</h3>
          <div class="flex items-center gap-3">
            <button id="summarize-reviews-button" class="text-blue-600 text-sm font-medium hover:underline">AI í›„ê¸° ìš”ì•½ âœ¨</button>
            <button id="trigger-review-modal-button-header" class="text-blue-600 text-sm font-medium hover:underline flex items-center gap-1">
              ë¦¬ë·° ì‘ì„±
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>
          </div>
        </div>

        <div id="average-rating-display-container">
          <div id="average-rating-display"></div>
          <span id="total-reviews-summary"></span>
        </div>

        <div class="card p-4 rounded-lg border border-gray-200 bg-white">
          <div id="tag-statistics" class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <p class="font-semibold text-gray-700">ì–´ë–¤ ì ì´ ì¢‹ì•˜ë‚˜ìš”? <span id="tag-reviews-count" class="text-sm font-normal text-gray-500"></span></p>
              <button id="toggle-tag-stats" class="text-blue-600 text-sm font-medium hover:underline">í¼ì¹˜ê¸° ></button>
            </div>
            <div id="tag-stats-list"></div>
          </div>

          <div id="reviewList" class="grid gap-4"></div>
          <div id="review-pagination" class="flex justify-center items-center space-x-4 mt-4">
            <button id="prev-review-page" class="pagination-button"><</button>
            <span id="review-page-info" class="text-gray-700 text-sm"></span>
            <button id="next-review-page" class="pagination-button">></button>
          </div>

          <div style="margin-top:10px" id="review-input-section"></div>
          <div class="muted mt-4" id="review-login-prompt">ë¡œê·¸ì¸í•˜ë©´ í›„ê¸°ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”.</div>
        </div>
      </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="nav-bar">
      <a class="nav-button" href="/user/shopping/products" aria-label="í•´ì™¸ì§êµ¬">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
        <span>í•´ì™¸ì§êµ¬</span>
      </a>
      <a class="nav-button active" href="#" aria-current="page">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        <span>í™ˆ</span>
      </a>
      <a class="nav-button" href="/forex" aria-label="í™˜ì „">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
        <span>í™˜ì „</span>
      </a>
    </nav>
  </div>

  <!-- Alert Modal -->
  <div id="payment-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <button id="modal-close-button" class="modal-close-button" aria-label="ë‹«ê¸°">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-4">ì•Œë¦¼</h3>
      <p class="text-gray-700 mb-6">ë©”ì‹œì§€</p>
      <button id="modal-confirm-button" class="primary-button">í™•ì¸</button>
    </div>
  </div>

  <!-- Inbox Modal -->
  <div id="inbox-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <button id="inbox-modal-close-button" class="modal-close-button" aria-label="ë‹«ê¸°">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-4">ì•Œë¦¼í•¨</h3>
      <div id="inbox-list" class="space-y-2 mb-4"></div>
      <div class="flex gap-2 w-full">
        <button id="inbox-clear-button" class="secondary-button w-1/2">ëª¨ë‘ ì‚­ì œ</button>
        <button id="inbox-modal-confirm-button" class="primary-button w-1/2">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="review-input-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <button id="review-modal-close-button" class="modal-close-button" aria-label="ë‹«ê¸°">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-2">í›„ê¸° ì‘ì„±</h3>
      <p class="font-semibold text-gray-700">í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì‹œë©´ BNKì— í˜ì´ ë©ë‹ˆë‹¤!</p>

      <div id="review-input-modal-tags" class="tag-scroll-container-modal"></div>

      <div class="flex justify-center items-center space-x-4 mb-4">
        <span class="text-gray-700">í‰ì :</span>
        <div id="review-input-modal-star-rating" class="star-rating"></div>
      </div>

      <textarea id="review-input-modal-content" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-y" placeholder="ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.&#10;(í›„ê¸° ìˆ˜ì • ë° ì‚­ì œëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.)"></textarea>
      <button id="review-input-modal-submit" class="primary-button mt-4">ë“±ë¡í•˜ê¸°</button>
    </div>
  </div>

  <!-- Create Child Account Modal -->
  <div id="create-account-modal-overlay" class="modal-overlay">
    <div class="modal-content">
      <button id="create-account-modal-close-button" class="modal-close-button" aria-label="ë‹«ê¸°">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-4">í™˜ì „ ê³„ì¢Œ ì¶”ê°€</h3>
      <p class="font-semibold text-gray-700 mb-4">ìƒˆë¡œìš´ í†µí™”ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.</p>

      <div class="w-full mb-4">
        <label for="currency-select" class="block text-left text-sm font-medium text-gray-700 mb-1">í†µí™” ì„ íƒ</label>
        <select id="currency-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
          <option value="USD">USD (ë¯¸êµ­ ë‹¬ëŸ¬)</option>
          <option value="JPY">JPY (ì¼ë³¸ ì—”)</option>
          <option value="EUR">EUR (ìœ ëŸ½ ìœ ë¡œ)</option>
        </select>
      </div>

      <div class="w-full mb-4">
        <label class="block text-left text-sm font-medium text-gray-700 mb-1">ì…ê¸ˆ</label>
      </div>

      <div class="w-full mb-6">
        <label for="amount-input" class="block text-left text-sm font-medium text-gray-700 mb-1">ê¸ˆì•¡ (ì™¸í™”)</label>
        <input type="number" id="amount-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" />
        <p id="krw-equivalent-display" class="text-right text-sm text-gray-600 mt-1"></p>
      </div>

      <button id="create-child-account-submit" class="primary-button">ê³„ì¢Œ ìƒì„±í•˜ê¸°</button>
    </div>
  </div>

  <!-- AI Summary Modal -->
  <div id="summary-modal-overlay" class="modal-overlay">
    <div class="modal-content min-h-[300px] h-auto p-6 flex flex-col items-center justify-center">
      <button id="summary-modal-close-button" class="modal-close-button" aria-label="ë‹«ê¸°">&times;</button>
      <h3 class="text-xl font-bold text-gray-800 mb-4">AI í›„ê¸° ìš”ì•½</h3>
      <div id="summary-loader" class="loader hidden"></div>
      <textarea id="summary-text-area" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none resize-none text-sm text-gray-800 bg-gray-50 leading-relaxed" readonly placeholder="AIê°€ í›„ê¸°ë¥¼ ìš”ì•½í•´ ë“œë¦½ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”..."></textarea>
      <button id="summary-modal-confirm-button" class="primary-button mt-4">í™•ì¸</button>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  /* ---------------- auth helpers ---------------- */
  let isLoggedInGlobal = false; // í—¤ë” í† ê¸€ í‘œì‹œìš©

  function renderAuthButton() {
    const btn = document.getElementById('auth-button');
    if (!btn) return;

    // ìƒíƒœì— ë”°ë¼ ë¼ë²¨ê³¼ í•¸ë“¤ëŸ¬ ë°”ê¿ˆ
    if (isLoggedInGlobal) {
      btn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
      btn.onclick = async () => {
        // 1) ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì‹œë„ (í”„ë¡œì íŠ¸ì— ë§ê²Œ ê²½ë¡œ ë³€ê²½ ê°€ëŠ¥)
        //    ë³´í†µ /user/logout í˜¹ì€ /logout ì„ ì”€
        const tryLogout = async (url, method='GET') => {
          try {
            const res = await fetch(url, { method, credentials: 'include' });
            return res.ok;
          } catch { return false; }
        };

        let ok = await tryLogout('/user/logout', 'GET');
        if (!ok) ok = await tryLogout('/user/logout', 'POST');
        if (!ok) ok = await tryLogout('/logout', 'POST'); // ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ê¸°ë³¸ê°’ fallback

        // 2) í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ ë¦¬ì…‹
        isLoggedInGlobal = false;
        inboxNotifications.length = 0;
        updateInboxBadge();

        // 3) ë©”ì¸ìœ¼ë¡œ ì´ë™(ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœë¡œ ì¬ë¡œë”©)
        //    ë„¤ êµ¬ì„±ì— ë§ì¶° í™ˆì´ /foreign ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        location.href = '/foreign';
      };
    } else {
      btn.textContent = 'ë¡œê·¸ì¸';
      btn.onclick = () => {
        // ë„¤ ë¡œê·¸ì¸ í˜ì´ì§€ ê²½ë¡œë¡œ ì´ë™
        location.href = '/user/login';
      };
    }
  }
  
  
    /* ---------------- core state ---------------- */
    let currentReviews = [];               // ìµœì‹  ë¦¬ë·° ìºì‹œ
    let isLoadingReviews = false;          // ë™ì‹œ ë¡œë“œ ë°©ì§€
    const reviewsPerPage = 1;
    let currentReviewPage = 1;
    let totalReviewPages = 1;
    let showAllTagStats = false;
    let showAllChildAccounts = false;
    let reviewSliderInterval;
    let benefitsInterval;
    let globalAccountData = null;

    /* ---------------- user status ---------------- */
    async function fetchUserStatus(){
      try{
        const res = await fetch('/api/foreign/summary', { headers:{'Accept':'application/json'}, credentials:'include' });
        if(!res.ok) return { isLoggedIn:false, hasProducts:false, accountData:null };
        return await res.json();
      }catch(e){ return { isLoggedIn:false, hasProducts:false, accountData:null }; }
    }

    /* ---------------- inbox / toast / modal ---------------- */
    const inboxNotifications = [];
    const notificationBadge = document.getElementById('notification-badge');
    const inboxModalOverlay = document.getElementById('inbox-modal-overlay');
    const inboxListEl = document.getElementById('inbox-list');

    function updateInboxBadge(){
      const c = inboxNotifications.length;
      if(c>0){ notificationBadge.textContent=c; notificationBadge.classList.remove('hidden'); }
      else { notificationBadge.textContent=''; notificationBadge.classList.add('hidden'); }
    }
    function renderInboxList(){
      if(inboxNotifications.length===0){ inboxListEl.innerHTML='<p class="text-gray-700">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
      inboxListEl.innerHTML = inboxNotifications.map(n=>{
        let cls='border-gray-200 bg-gray-50'; if(n.type==='review') cls='border-emerald-200 bg-emerald-50'; if(n.type==='warning') cls='border-red-200 bg-red-50';
        return `<div class="p-3 rounded-lg border ${cls} text-sm text-gray-800">${escapeHtml(n.message)}</div>`;
      }).join('');
    }
    function showInboxModal(){ renderInboxList(); inboxModalOverlay.classList.add('show'); document.body.style.overflow='hidden'; }
    function hideInboxModal(){ inboxModalOverlay.classList.remove('show'); document.body.style.overflow=''; }

    const paymentModalOverlay = document.getElementById('payment-modal-overlay');
    const modalTitle = paymentModalOverlay.querySelector('h3');
    const modalMessage = paymentModalOverlay.querySelector('p');
    function showPaymentModal(title,message){ modalTitle.textContent=title; modalMessage.textContent=message; paymentModalOverlay.classList.add('show'); document.body.style.overflow='hidden'; }
    function hidePaymentModal(){ paymentModalOverlay.classList.remove('show'); document.body.style.overflow=''; }

    function showToast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2200); }

    /* ---------------- tags / colors ---------------- */
    let allAvailableTags = ["ì‚¬ìš©í•˜ê¸° í¸í•´ìš”","ë‹¤ì–‘í•œ í†µí™” ì§€ì›","í™˜ì „ ìˆ˜ìˆ˜ë£Œ ì €ë ´","í•´ì™¸ì§êµ¬ í•„ìˆ˜","ê³„ì¢Œ ê´€ë¦¬ í¸ë¦¬","ë¹ ë¥¸ ì²˜ë¦¬","ê³ ê° ì„œë¹„ìŠ¤ ìš°ìˆ˜"];
    const tagColors = ['#007bff','#28a745','#dc3545','#ffc107','#6f42c1','#fd7e14','#20c997','#6c757d'];
    const tagEmojis = {"ì‚¬ìš©í•˜ê¸° í¸í•´ìš”":"ğŸ‘","ë‹¤ì–‘í•œ í†µí™” ì§€ì›":"ğŸŒ","í™˜ì „ ìˆ˜ìˆ˜ë£Œ ì €ë ´":"ğŸ’°","í•´ì™¸ì§êµ¬ í•„ìˆ˜":"ğŸ›’","ê³„ì¢Œ ê´€ë¦¬ í¸ë¦¬":"ğŸ’¼","ë¹ ë¥¸ ì²˜ë¦¬":"âš¡","ê³ ê° ì„œë¹„ìŠ¤ ìš°ìˆ˜":"âœ¨"};
    function getColorForTag(tag){ const i = allAvailableTags.indexOf(tag); return i!==-1 ? tagColors[i%tagColors.length] : '#000'; }
    function hexToRgb(hex){ const b=parseInt(hex.slice(1),16); return {r:(b>>16)&255,g:(b>>8)&255,b:b&255}; }
    function getTagStyle(tag){ const c=getColorForTag(tag); const {r,g,b}=hexToRgb(c); return {backgroundColor:`rgba(${r},${g},${b},0.1)`,color:c}; }

    /* ---------------- helpers ---------------- */
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&#34;',"'":'&#39;' }[m])); }
    function renderStarIcons(rating){ let h=''; for(let i=1;i<=5;i++){ h+=`<svg class="star-icon ${i<=rating?'filled':''}" data-star="${i}" fill="currentColor" viewBox="0 0 24 24"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.691h4.178c.969 0 1.371 1.24.588 1.81l-3.388 2.464a1 1 0 00-.363 1.118l1.287 3.957c.3.921-.755 1.683-1.539 1.118l-3.388-2.464a1 1 0 00-1.176 0l-3.388 2.464c-.784.565-1.839-.197-1.539-1.118l1.287-3.957a1 1 0 00-.363-1.118L2.583 9.385c-.783-.57-.381-1.81.588-1.81h4.178a1 1 0 00.95-.691l1.286-3.957z"/></svg>`; } return h; }
    function formatAccountNo(num, groups=[3,4,6], sep="-"){ const d=String(num??"").replace(/\D/g,""); let i=0,out=[]; for(const g of groups){ if(i>=d.length) break; out.push(d.slice(i,i+g)); i+=g; } if(i<d.length) out.push(d.slice(i)); return out.join(sep); }

    /* ---------------- API: reviews ---------------- */
    async function fetchReviewsFromApi(){
      const res = await fetch('/api/reviews/recent2?limit=50', { headers:{'Accept':'application/json'}, credentials:'include' });
      if(!res.ok){ currentReviews = []; return { items:[] }; }
      const data = await res.json().catch(()=>({ items:[] }));
      currentReviews = (data.items||[]).map(x=>({
        id: x.id ?? x.rvno ?? 0,
        uidMasked: x.uidMasked ?? (x.uid ? (x.uid.length<=2 ? x.uid+'***' : x.uid.slice(0,2)+'***') : 'ìµëª…'),
        date: x.date ?? x.rvdate ?? '',
        rating: Number(x.rating ?? x.rvrating ?? 0),
        content: x.content ?? x.rvcontent ?? '',
        tags: x.tags ?? []
      }));
      return { items: currentReviews };
    }

    async function submitReviewToApi(content, rating){
      const body = new URLSearchParams({ content: content ?? '', rating: String(rating ?? 5) });
      const res = await fetch('/api/reviews/create', {
        method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json'},
        credentials:'include', body
      });
      return await res.json().catch(()=>({ ok:false }));
    }

    /* ---------------- reviews rendering ---------------- */
    const reviewList = document.getElementById('reviewList');
    const tagStatsList = document.getElementById('tag-stats-list');
    const tagReviewsCountSpan = document.getElementById('tag-reviews-count');
    const prevReviewPageButton = document.getElementById('prev-review-page');
    const nextReviewPageButton = document.getElementById('next-review-page');
    const reviewPageInfoSpan = document.getElementById('review-page-info');

    function updatePaginationControls(){
      prevReviewPageButton.disabled = (currentReviewPage===1);
      nextReviewPageButton.disabled = (currentReviewPage===totalReviewPages || totalReviewPages===0);
      reviewPageInfoSpan.textContent = `${currentReviewPage} / ${totalReviewPages}`;
    }

    function updateTagStatistics(){
      const counts = {};
      (currentReviews||[]).forEach(r => (r.tags||[]).forEach(t => counts[t]=(counts[t]||0)+1));
      const display = allAvailableTags.map(name=>({name, count: counts[name]||0}));
      const topTags = display.filter(t=>t.count>0).sort((a,b)=>b.count-a.count);
      const maxCount = topTags.length>0 ? topTags[0].count : 1;
      let html='';
      const tagsToShow = showAllTagStats ? topTags : topTags.slice(0,2);
      if(tagsToShow.length>0){
        tagsToShow.forEach(tag=>{
          const pct = (tag.count/maxCount)*100;
          const color = getColorForTag(tag.name);
          const emoji = tagEmojis[tag.name] || '';
          html += `
            <div class="tag-stats-item">
              <div class="flex justify-between w-full mb-1">
                <span class="tag-stats-name" style="color:${color};">${emoji} ${escapeHtml(tag.name)}</span>
                <span class="tag-stats-count">${tag.count}íšŒ</span>
              </div>
              <div class="tag-bar-container"><div class="tag-bar" style="width:${pct}%;"></div></div>
            </div>`;
        });
      } else {
        html = '<p class="text-center text-gray-500 text-sm">ì•„ì§ íƒœê·¸ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
      tagStatsList.innerHTML = html;
      const toggleBtn = document.getElementById('toggle-tag-stats');
      if(topTags.length>2){ toggleBtn.style.display='block'; toggleBtn.textContent = showAllTagStats ? 'ì ‘ê¸° <' : 'í¼ì¹˜ê¸° >'; }
      else { toggleBtn.style.display='none'; }
      tagReviewsCountSpan.textContent = `(ì´ ${currentReviews.length.toLocaleString('ko-KR')}ê°œ)`;
    }

    function renderReviewsPage(){
      reviewList.innerHTML = '';
      const startIndex = (currentReviewPage-1)*reviewsPerPage;
      const endIndex = startIndex + reviewsPerPage;
      const reviewsToDisplay = currentReviews.slice(startIndex, endIndex);
      if(reviewsToDisplay.length===0){
        reviewList.innerHTML = '<div class="text-center text-gray-500 p-4">ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      reviewsToDisplay.forEach(it=>{
        const div=document.createElement('div');
        div.className='p-3 bg-gray-50 rounded-lg shadow-sm text-gray-700 border border-gray-100';
        const tagsHtml = it.tags && it.tags.length ? `<div class="flex flex-wrap gap-1 mt-2">${
          it.tags.map(tag=>{ const st=getTagStyle(tag); const emoji=tagEmojis[tag]||''; return `<span class="px-2 py-0.5 rounded-full text-xs font-medium flex items-center gap-1" style="background-color:${st.backgroundColor};color:${st.color};">${emoji} ${escapeHtml(tag)}</span>`; }).join('')
        }</div>` : '';
        div.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <b>${it.uidMasked||''}</b>
            <span class="muted">${it.date||''}</span>
          </div>
          <div class="flex items-center mb-2"><div class="star-rating">${renderStarIcons(it.rating)}</div></div>
          <p class="text-base">${escapeHtml(it.content||'')}</p>
          ${tagsHtml}`;
        reviewList.appendChild(div);
      });
    }

    async function loadReviews(refetch=false){
      stopReviewSlider();
      if(isLoadingReviews) return;
      try{
        isLoadingReviews = true;
        if(refetch || currentReviews.length===0){
          await fetchReviewsFromApi();    // ì„œë²„ í˜¸ì¶œ: ìµœì´ˆ/ë“±ë¡ í›„ì—ë§Œ
        }
        totalReviewPages = Math.ceil(currentReviews.length / reviewsPerPage) || 1;
        if(currentReviewPage>totalReviewPages) currentReviewPage=1;
        renderReviewsPage();
        updatePaginationControls();
        updateTagStatistics();
      } finally {
        isLoadingReviews = false;
        startReviewSlider();              // í™”ë©´ë§Œ ë„˜ê¹€(ì¬ìš”ì²­ ì—†ìŒ)
      }
    }

    function startReviewSlider(){
      if(reviewSliderInterval) clearInterval(reviewSliderInterval);
      reviewSliderInterval = setInterval(()=>{
        currentReviewPage++;
        if(currentReviewPage>totalReviewPages || totalReviewPages===0) currentReviewPage=1;
        renderReviewsPage();              // ìºì‹œë§Œ ì‚¬ìš©
        updatePaginationControls();
      }, 4000);
    }
    function stopReviewSlider(){ if(reviewSliderInterval){ clearInterval(reviewSliderInterval); reviewSliderInterval=null; } }

    /* ---------------- review modal ---------------- */
    const reviewInputModalOverlay = document.getElementById('review-input-modal-overlay');
    const reviewInputModalContent = document.getElementById('review-input-modal-content');
    const reviewInputModalSubmitButton = document.getElementById('review-input-modal-submit');
    const reviewLoginPrompt = document.getElementById('review-login-prompt');
    let selectedTagsForModal = new Set();
    let currentRatingForModal = 0;

    function renderTagsForModal(){
      const div=document.getElementById('review-input-modal-tags'); div.innerHTML='';
      allAvailableTags.forEach(tag=>{
        const btn=document.createElement('button'); btn.type='button';
        const emoji=tagEmojis[tag]||''; const st=getTagStyle(tag);
        btn.innerHTML=`${emoji} ${escapeHtml(tag)}`; btn.className='review-tag-button';
        btn.style.setProperty('--tag-bg-color', st.backgroundColor); btn.style.setProperty('--tag-color', st.color);
        if(selectedTagsForModal.has(tag)) btn.classList.add('selected');
        btn.addEventListener('click', ()=>{
          if(selectedTagsForModal.has(tag)){ selectedTagsForModal.delete(tag); btn.classList.remove('selected'); }
          else { selectedTagsForModal.add(tag); btn.classList.add('selected'); }
        });
        div.appendChild(btn);
      });
    }
    function setupStarRatingForModal(){
      const div=document.getElementById('review-input-modal-star-rating'); div.innerHTML=renderStarIcons(currentRatingForModal);
      const stars = div.querySelectorAll('.star-icon');
      stars.forEach(star=>{
        star.addEventListener('mouseover',()=>{ const v=parseInt(star.dataset.star,10); stars.forEach((s,idx)=>(idx<v? s.classList.add('hovered') : s.classList.remove('hovered'))); });
        star.addEventListener('mouseout',()=>{ stars.forEach(s=>s.classList.remove('hovered')); });
        star.addEventListener('click',()=>{ const v=parseInt(star.dataset.star,10); currentRatingForModal=v; stars.forEach((s,idx)=>(idx<v? s.classList.add('filled') : s.classList.remove('filled'))); });
      });
    }
    function closeReviewModal(){ reviewInputModalOverlay.classList.remove('show'); document.body.style.overflow=''; }

    /* ---------------- summary ---------------- */
    const summaryModalOverlay = document.getElementById('summary-modal-overlay');
    const summaryLoader = document.getElementById('summary-loader');
    const summaryTextArea = document.getElementById('summary-text-area');
    function summarizeReviewsLocally(revs){
      if(!revs || revs.length===0) return 'ì•„ì§ ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ì–´ ìš”ì•½í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
      const total=revs.length, avg=(revs.reduce((s,r)=>s+r.rating,0)/total).toFixed(1);
      const positives=revs.filter(r=>r.rating>=4), negatives=revs.filter(r=>r.rating<=2), neutrals=revs.filter(r=>r.rating===3);
      const tagCount={}; revs.forEach(r=>(r.tags||[]).forEach(t=>tagCount[t]=(tagCount[t]||0)+1));
      const topTags=Object.entries(tagCount).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=>`${k} (${v})`);
      const improv=negatives.concat(neutrals).slice(0,3).map(r=>`- ${r.content}`);
      return [
        `ì´ ${total}ê°œ í›„ê¸°, í‰ê·  â˜…${avg}`,
        ``,
        `ğŸ‘ ê¸ì • ìš”ì•½: ${positives.length}ê±´`,
        topTags.length ? `â€¢ ë§ì´ ì–¸ê¸‰ëœ íƒœê·¸: ${topTags.join(', ')}` : `â€¢ ë§ì´ ì–¸ê¸‰ëœ íƒœê·¸ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.`,
        ``,
        `ğŸ¤” ë³´í†µ/ë¶€ì • ìš”ì•½: ${neutrals.length + negatives.length}ê±´`,
        improv.length ? improv.join('\n') : 'â€¢ í¬ê²Œ ë“œëŸ¬ë‚œ ê°œì„  ì˜ê²¬ì´ ì ìŠµë‹ˆë‹¤.',
        ``,
        `í•œ ì¤„ ì •ë¦¬: ì‚¬ìš©ì„±/ìˆ˜ìˆ˜ë£Œê°€ ê°•ì ìœ¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.`
      ].join('\n');
    }
    async function generateReviewSummary(){
      summaryTextArea.value=''; summaryLoader.classList.remove('hidden'); summaryTextArea.classList.add('hidden'); summaryModalOverlay.classList.add('show');
      try{ if(currentReviews.length===0) await fetchReviewsFromApi(); summaryTextArea.value=summarizeReviewsLocally(currentReviews); }
      catch{ summaryTextArea.value='í›„ê¸° ìš”ì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'; }
      finally{ summaryLoader.classList.add('hidden'); summaryTextArea.classList.remove('hidden'); }
    }

    /* ---------------- benefits ---------------- */
    let currentBenefitIndex=0;
    const benefitItems=[
      { type:'savings',  emoji:'ğŸ’°', firstLine:'í™˜ì „ ìˆ˜ìˆ˜ë£Œë¥¼<br>', value:0,max:75000000,minIncrement:500000,maxIncrement:1500000,valueSuffix:'ì›', verb:'ì•„ë¼ì…¨ì–´ìš”!' },
      { type:'interest', emoji:'ğŸ“ˆ', firstLine:'ì´ì í˜œíƒì„<br>',   value:0,max:5000000, minIncrement:50000, maxIncrement:150000,  valueSuffix:'ì›', verb:'ë°›ìœ¼ì…¨ì–´ìš”!' },
      { type:'theft',    emoji:'ğŸ”’', firstLine:'ê²°ì œ ë¹„í™œì„±í™” ê¸°ëŠ¥ìœ¼ë¡œ<br>ë„ë‚œì„ ', value:0,max:2000,minIncrement:50,maxIncrement:150,valueSuffix:'ë²ˆ', verb:'ë°©ì§€í–ˆì–´ìš”!' }
    ];
    const benefitsSliderContent = document.getElementById('benefits-slider-content');
    function showNextBenefit(){
      const cur=benefitItems[currentBenefitIndex];
      const rand=Math.floor(Math.random()*(cur.maxIncrement-cur.minIncrement+1))+cur.minIncrement;
      cur.value = cur.value<cur.max ? Math.min(cur.value+rand,cur.max) : 0;
      benefitsSliderContent.style.transition='none'; benefitsSliderContent.style.opacity='0'; benefitsSliderContent.style.transform='translateY(100%)';
      setTimeout(()=>{ const val=cur.value.toLocaleString('ko-KR'); benefitsSliderContent.innerHTML=`<p class="text-xl font-bold benefit-text">${cur.emoji}${cur.firstLine}<span class="text-red-600">${val}${cur.valueSuffix}</span> ${cur.verb}</p>`;
        benefitsSliderContent.style.transition='all .7s'; benefitsSliderContent.style.opacity='1'; benefitsSliderContent.style.transform='translateY(0)';
        currentBenefitIndex=(currentBenefitIndex+1)%benefitItems.length;
      },50);
    }
    function startBenefitsSlider(){ showNextBenefit(); benefitsInterval=setInterval(showNextBenefit,3000); }

    /* ---------------- content (accounts) ---------------- */
    function renderReviewInputSection(isLoggedIn){ const s=document.getElementById('review-input-section'); const p=document.getElementById('review-login-prompt'); if(isLoggedIn){ s.innerHTML=''; p.style.display='none'; } else { s.innerHTML=''; p.style.display='block'; } }
    function getCardDesignStyle(){ return { backgroundImage:'none', textColor:'#111827' }; }
    function renderContent(isLoggedIn, hasProducts, accountData){
    	isLoggedInGlobal = !!isLoggedIn;  // âœ… ì „ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
    	renderAuthButton();               // âœ… í—¤ë” ë²„íŠ¼ ê·¸ë¦¬ê¸°
    	globalAccountData=accountData;
      const contentArea=document.getElementById('content-area');
      if(!isLoggedIn){
        contentArea.innerHTML = `
          <div class="content-box text-center mt-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">ë‚´ í†µì¥ ì •ë³´</h2>
            <p class="text-lg font-medium text-gray-800 mb-6">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!</p>
            <button id="login-button" class="primary-button">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™</button>
          </div>`;
        document.getElementById('login-button').addEventListener('click',()=>location.href='/user/login');
        renderReviewInputSection(false); return;
      }
      if(!hasProducts){
        contentArea.innerHTML = `
          <div class="content-box text-center mt-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">ë‚´ í†µì¥ ì •ë³´</h2>
            <p class="text-lg font-medium text-gray-800 mb-6">ìƒí’ˆì„ ê°€ì…í•´ ì£¼ì„¸ìš”!</p>
            <button id="signup-button" class="primary-button">ìƒí’ˆ ê°€ì…í•˜ê¸°</button>
          </div>`;
        document.getElementById('signup-button').addEventListener('click',()=>location.href='/foreign1');
        renderReviewInputSection(false); return;
      }
      const allChildAccounts = accountData.childAccounts||[];
      const maxDisplayChildren=3;
      const childrenToDisplay = showAllChildAccounts ? allChildAccounts : allChildAccounts.slice(0,maxDisplayChildren);
      const hasMoreChildren = allChildAccounts.length>maxDisplayChildren;
      const cardDesign=getCardDesignStyle();
      const dynamicBgStyle = cardDesign.backgroundImage?`background-image:${cardDesign.backgroundImage};background-size:cover;background-position:center;`:'';
      const accountNumberColor='#4a5568';
      let childHtml='';
      if(allChildAccounts.length>0){
        childHtml = `<div class="mt-4"><div class="grid grid-cols-3 gap-3">`+
          childrenToDisplay.map(c=>`
            <div class="p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200 text-center">
              <div class="flex justify-center items-center mb-1"><b class="text-gray-800">${c.currencyCode}</b></div>
              <div class="text-gray-800 mt-1 text-base font-bold">${c.balance}</div>
            </div>`).join('') + `</div>` + (hasMoreChildren?`
            <div class="mt-4 text-center">
              <button id="toggle-child-accounts" class="text-blue-600 text-sm font-medium hover:underline">${showAllChildAccounts?'ì ‘ê¸° <':'ë”ë³´ê¸° >'}</button>
            </div>`:'') + `</div>`;
      }else{ childHtml='<div class="muted mt-4">ì—°ê²°ëœ ìì‹ í†µì¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; }
      contentArea.innerHTML = `
        <div class="content-box relative overflow-hidden" style="${dynamicBgStyle}">
          <div class="flex justify-between items-start mb-4">
            <h2 class="text-xl font-semibold text-gray-800">BNK ì‡¼í•‘í™˜ì „í†µì¥</h2>
            <button id="add-child-account-button" class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-blue-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
          </div>
          <div class="mb-4">
            <div class="flex items-center" style="color:${accountNumberColor};">
              <span id="parent-account-number" data-raw="${accountData.parentAccountNo}" class="text-lg font-bold">${formatAccountNo(accountData.parentAccountNo,[3,2,6])}</span>
              <button id="copy-account-number" class="p-1 rounded-full hover:bg-gray-100 ml-1" aria-label="ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color:${accountNumberColor};"><path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"/></svg>
              </button>
            </div>
          </div>
          ${childHtml}
        </div>`;
      document.getElementById('add-child-account-button').addEventListener('click', showCreateAccountModal);
      const copyBtn=document.getElementById('copy-account-number');
      if(copyBtn) copyBtn.addEventListener('click',()=>{
        const el=document.getElementById('parent-account-number'); const num = el?(el.dataset.raw || el.textContent.replace(/\D/g,'').trim()):'';
        if(!num){ showPaymentModal('ì•Œë¦¼','ë³µì‚¬í•  ê³„ì¢Œë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        try{ const ta=document.createElement('textarea'); ta.value=num; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showPaymentModal('ì•Œë¦¼','ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); }
        catch{ showPaymentModal('ì•Œë¦¼','ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
      });
      const toggleBtn=document.getElementById('toggle-child-accounts');
      if(toggleBtn) toggleBtn.addEventListener('click',()=>{ showAllChildAccounts=!showAllChildAccounts; renderContent(isLoggedIn,hasProducts,globalAccountData); });
      renderReviewInputSection(true);
    }

    /* ---------------- create child account (mock UI) ---------------- */
    const mockExchangeRates={'USD':1350,'JPY':9.2,'EUR':1480};
    const createAccountModalOverlay=document.getElementById('create-account-modal-overlay');
    const currencySelect=document.getElementById('currency-select');
    const amountInput=document.getElementById('amount-input');
    const krwEquivalentDisplay=document.getElementById('krw-equivalent-display');
    function updateKrwEquivalent(){ const c=currencySelect.value; const amt=parseFloat(amountInput.value); if(!isNaN(amt)&&amt>0&&mockExchangeRates[c]){ const krw=amt*mockExchangeRates[c]; krwEquivalentDisplay.textContent=`(ì•½ ${krw.toLocaleString('ko-KR')}ì›)`; } else { krwEquivalentDisplay.textContent=''; } }
    function showCreateAccountModal(){ createAccountModalOverlay.classList.add('show'); document.body.style.overflow='hidden'; currencySelect.value='USD'; amountInput.value=''; krwEquivalentDisplay.textContent=''; }
    function hideCreateAccountModal(){ createAccountModalOverlay.classList.remove('show'); document.body.style.overflow=''; }
    async function createChildAccount(currencyCode, amount){
      return new Promise(resolve=>{ setTimeout(()=>{ if(globalAccountData && globalAccountData.childAccounts){ const idx=globalAccountData.childAccounts.findIndex(a=>a.currencyCode===currencyCode);
        if(idx>-1){ let cur=parseFloat(String(globalAccountData.childAccounts[idx].balance).replace(/,/g,'')); cur += parseFloat(amount);
          globalAccountData.childAccounts[idx].balance = cur.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
        } else { globalAccountData.childAccounts.push({ currencyCode, currencyFullName:`${currencyCode}`, balance: `${parseFloat(amount).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}` }); }
        resolve({success:true}); } else resolve({success:false}); }, 400); });
    }

    /* ---------------- forbidden words ---------------- */
    const forbiddenPatterns=[
      {label:'ì”¨ë°œ',re:/(?:ã……\s*ã…‚|ì‹œ+\s*ë°œ|ì”¨+\s*ë°œ)/gi},
      {label:'ê°œìƒˆë¼',re:/ê°œ\s*ìƒˆ+ë¼/gi},
      {label:'ë³‘ì‹ ',re:/ë³‘\s*ì‹ /gi},
      {label:'ì§€ë„',re:/ì§€\s*ë„/gi},
      {label:'ì—¼ë³‘',re:/ì—¼\s*ë³‘/gi},
      {label:'ìš•ì„¤(ì˜ë¬¸ f)',re:/f\s*u\s*c\s*k/gi},
      {label:'ìš•ì„¤(ì˜ë¬¸ s)',re:/s\s*h\s*i\s*t/gi},
      {label:'bitch',re:/b\s*i\s*t\s*c\s*h/gi},
      {label:'asshole',re:/a\s*s\s*s\s*h\s*o\s*l\s*e/gi}
    ];
    function findForbiddenWords(text){ const found=new Set(); const n=String(text||'').normalize('NFKC'); forbiddenPatterns.forEach(({label,re})=>{ if(re.test(n)) found.add(label); re.lastIndex=0; }); return [...found]; }

    /* ---------------- DOM refs ---------------- */
    const contentArea=document.getElementById('content-area');
    const notificationBellButton=document.getElementById('notification-bell-button');
    const paymentModalCloseButton=document.getElementById('modal-close-button');
    const paymentModalConfirmButton=document.getElementById('modal-confirm-button');
    const inboxModalCloseButton=document.getElementById('inbox-modal-close-button');
    const inboxModalConfirmButton=document.getElementById('inbox-modal-confirm-button');
    const inboxClearButton=document.getElementById('inbox-clear-button');
    const reviewModalCloseButton=document.getElementById('review-modal-close-button');
    const triggerReviewModalButton=document.getElementById('trigger-review-modal-button-header');
    const summarizeReviewsButton=document.getElementById('summarize-reviews-button');
    const summaryModalCloseButton=document.getElementById('summary-modal-close-button');
    const summaryModalConfirmButton=document.getElementById('summary-modal-confirm-button');
    const benefitsSectionTitle=document.getElementById('benefits-section-title');

    /* ---------------- init ---------------- */
    document.addEventListener('DOMContentLoaded', async ()=>{
      const { isLoggedIn, hasProducts, accountData } = await fetchUserStatus();
      renderContent(isLoggedIn, hasProducts, accountData);
      await loadReviews(true);      // ìµœì´ˆ 1íšŒë§Œ ì„œë²„ ì¡°íšŒ
      startBenefitsSlider();

      paymentModalCloseButton.addEventListener('click', hidePaymentModal);
      paymentModalConfirmButton.addEventListener('click', hidePaymentModal);
      paymentModalOverlay.addEventListener('click',e=>{ if(e.target===paymentModalOverlay) hidePaymentModal(); });

      notificationBellButton.addEventListener('click', showInboxModal);
      inboxModalCloseButton.addEventListener('click', hideInboxModal);
      inboxModalConfirmButton.addEventListener('click', hideInboxModal);
      inboxModalOverlay.addEventListener('click',e=>{ if(e.target===inboxModalOverlay) hideInboxModal(); });
      inboxClearButton.addEventListener('click',()=>{ inboxNotifications.length=0; renderInboxList(); updateInboxBadge(); showToast('ì•Œë¦¼í•¨ì´ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.'); });

      triggerReviewModalButton.addEventListener('click', ()=>{
        selectedTagsForModal.clear(); currentRatingForModal=0; reviewInputModalContent.value='';
        renderTagsForModal(); setupStarRatingForModal();
        reviewInputModalOverlay.classList.add('show'); document.body.style.overflow='hidden';
      });
      reviewModalCloseButton.addEventListener('click', closeReviewModal);
      reviewInputModalOverlay.addEventListener('click',e=>{ if(e.target===reviewInputModalOverlay) closeReviewModal(); });

      reviewInputModalSubmitButton.addEventListener('click', async ()=>{
        const content = reviewInputModalContent.value.trim();
        const rating = currentRatingForModal;
        const tags = Array.from(selectedTagsForModal);

        if(!content){ showPaymentModal('ì•Œë¦¼','ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        if(rating===0){ showPaymentModal('ì•Œë¦¼','í‰ì ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

        const bad = findForbiddenWords(content);
        if(bad.length>0){
          closeReviewModal();
          inboxNotifications.unshift({type:'warning', message:`í›„ê¸° ë“±ë¡ ê±°ì ˆ: ê¸ˆì§€ í‘œí˜„(${bad.join(', ')})ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`, at:Date.now()});
          updateInboxBadge(); renderInboxList();
          showPaymentModal('ê²½ê³ ','ìš•ì„¤/ëª¨ìš•ì ì¸ í‘œí˜„ì´ í¬í•¨ë˜ì–´\ní›„ê¸°ë¥¼ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const res = await submitReviewToApi(content, rating /*, tags - ì„œë²„ ë¯¸ì €ì¥*/);
        if(res.ok){
          closeReviewModal();
          inboxNotifications.unshift({type:'review', message:'í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!', at:Date.now()});
          updateInboxBadge();
          currentReviewPage=1;
          await loadReviews(true);     // ë“±ë¡ ì§í›„ì—ë§Œ ì¬ì¡°íšŒ
          showToast('í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }else{
          if(res.error==='LOGIN_REQUIRED'){ reviewLoginPrompt.style.display='block'; showPaymentModal('ì•Œë¦¼','ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); }
          else if(res.error==='EMPTY_CONTENT'){ showPaymentModal('ì•Œë¦¼','ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
          else { showPaymentModal('ì•Œë¦¼','í›„ê¸° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        }
      });

      summarizeReviewsButton.addEventListener('click', generateReviewSummary);
      summaryModalCloseButton.addEventListener('click', ()=>summaryModalOverlay.classList.remove('show'));
      summaryModalConfirmButton.addEventListener('click', ()=>summaryModalOverlay.classList.remove('show'));

      document.getElementById('toggle-tag-stats').addEventListener('click', ()=>{ showAllTagStats=!showAllTagStats; updateTagStatistics(); });
      prevReviewPageButton.addEventListener('click', ()=>{ if(currentReviewPage>1){ currentReviewPage--; renderReviewsPage(); updatePaginationControls(); } });
      nextReviewPageButton.addEventListener('click', ()=>{ if(currentReviewPage<totalReviewPages){ currentReviewPage++; renderReviewsPage(); updatePaginationControls(); } });

      // create account modal events
      const createAccountModalCloseButton=document.getElementById('create-account-modal-close-button');
      const createChildAccountSubmitButton=document.getElementById('create-child-account-submit');
      const currencySel=document.getElementById('currency-select'); const amountInp=document.getElementById('amount-input');
      document.getElementById('add-child-account-button')?.addEventListener('click',showCreateAccountModal);
      createAccountModalCloseButton.addEventListener('click', hideCreateAccountModal);
      createAccountModalOverlay.addEventListener('click',e=>{ if(e.target===createAccountModalOverlay) hideCreateAccountModal(); });
      currencySel.addEventListener('change', updateKrwEquivalent);
      amountInp.addEventListener('input', updateKrwEquivalent);
      createChildAccountSubmitButton.addEventListener('click', async ()=>{
        const c=currencySel.value; const a=parseFloat(amountInp.value);
        if(isNaN(a)||a<=0){ showPaymentModal('ì•Œë¦¼','ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const { success } = await createChildAccount(c,a);
        if(success){ hideCreateAccountModal(); renderContent(true,true,globalAccountData); showToast('ê³„ì¢Œê°€ ì¶”ê°€/ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        else { showPaymentModal('ì•Œë¦¼','ê³„ì¢Œ ìƒì„± ì‹¤íŒ¨'); }
      });

    });

  </script>
</body>
</html>
