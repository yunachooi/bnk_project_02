<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#ffffff"/>
  <title>BNK 쇼핑환전통장 - 카드 최종 확인</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bottom-bar-h:72px; --vh:1vh; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; overflow:hidden; }
    body{ font-family:'Inter',sans-serif; background:#f0f4f8; margin:0; padding:0; color:#111827; font-size:16px; line-height:1.5; }
    .container{ width:100%; background:#fff; min-height:100svh; height:calc(var(--vh,1vh)*100); display:flex; flex-direction:column; overflow:hidden; }
    header{ flex:none; background:#fff; border-bottom:1px solid #e5e7eb; }
    .header-bar{ display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; }
    .header-back{ display:flex; align-items:center; gap:.25rem; color:#ef4444; font-weight:800; text-decoration:none; padding:.25rem .375rem; border-radius:.5rem; }
    .header-back svg{ width:20px; height:20px; }
    .header-title{ font-size:1.15rem; font-weight:800; }
    .sticky-top-wrap{ flex:none; background:#fff; padding:.5rem 1rem .5rem; border-bottom:1px solid #eef2f7; }
    .step-indicator{ display:flex; width:100%; height:4px; background:#e5e7eb; margin:0 0 .5rem; }
    .step-indicator-progress{ width:100%; height:100%; background:#ef4444; }
    .main-content{ flex:0 0 auto; padding:.9rem 1rem 1rem; display:flex; flex-direction:column; gap:.9rem; overflow:hidden; max-width:40rem; margin:0 auto; width:100%; }
    .card{ background:#fff; border:1px solid #eef2f7; border-radius:.75rem; box-shadow:0 4px 12px rgba(0,0,0,.05); }
    .card-body{ padding:1rem; width:100%; }
    .review-title{ font-weight:900; font-size:1.1rem; text-align:center; margin-top:.15rem; margin-bottom:.35rem; }
    .review-title .break{ display:block; }
    .summary-box{ display:flex; align-items:center; justify-content:center; padding:.8rem; background:#f9fafb; border-radius:.75rem; border:1px solid #eef2f7; }
    .summary-box img{ width:360px; height:224px; object-fit:cover; border-radius:.6rem; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    .kv{ display:grid; grid-template-columns: 120px 1fr; row-gap:.5rem; column-gap:.75rem; margin-top:.6rem; }
    .kv .k{ color:#6b7280; font-weight:700; }
    .kv .v{ color:#111827; font-weight:800; word-break:break-word; }
    .confirm-area{ margin-top:1.1rem; padding:.8rem; background:#fff7f7; border:1px solid #fecaca; border-radius:.75rem; }
    .confirm-area label{ display:flex; align-items:flex-start; gap:.6rem; cursor:pointer; }
    .confirm-area input{ transform:scale(1.2); accent-color:#ef4444; margin-top:.18rem; }
    .bottom-bar{ margin-top:auto; position:sticky; bottom:0; left:0; right:0; flex:none; width:100%; background:#fff; border-top:1px solid #e2e8f0; padding:.5rem 1rem; padding-bottom:calc(.5rem + env(safe-area-inset-bottom,0px)); box-shadow:0 -4px 12px rgba(0,0,0,.03); display:flex; justify-content:space-around; gap:.5rem; z-index:60; }
    .bottom-bar button{ flex:1; padding:.9rem 1rem; border-radius:.9rem; font-weight:800; font-size:1rem; transition:background-color .2s, transform .15s; box-shadow:0 2px 6px rgba(0,0,0,.08); border:none; user-select:none; }
    .bottom-bar button:active{ transform:scale(.98); }
    @media (max-width:420px){ .summary-box img{ width:340px; height:212px; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-bar">
        <a href="/foreign" class="header-back">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
          홈으로
        </a>
        <h1 class="header-title">카드 최종 확인</h1>
        <span class="w-5 h-5 opacity-0"></span>
      </div>
    </header>

    <div class="sticky-top-wrap">
      <div class="step-indicator"><div class="step-indicator-progress"></div></div>
      <div id="encouragementMessage" class="text-center text-base font-semibold text-gray-700 p-3 rounded-lg bg-yellow-100 mx-0 mt-2 shadow-sm">
        정말 마지막 단계입니다.<br>내용을 확인하고 발급을 완료해 주세요! ✨
      </div>
    </div>

    <main class="main-content">
      <div class="card">
        <div class="card-body">
          <div class="review-title">BNK쇼핑환전체크카드를<span class="break"></span>발급하시겠습니까?</div>
          <div class="summary-box"><img id="cardPreviewImg" alt="선택한 카드"></div>
          <div class="kv">
            <div class="k">영문 이름</div><div class="v" id="vEnglishName">-</div>
            <div class="k">카드 종류</div><div class="v">체크카드</div>
            <div class="k">결제은행</div><div class="v">부산은행</div>
            <div class="k">결제계좌</div><div class="v">BNK쇼핑환전예금</div>
            <div class="k">카드 수령지</div><div class="v" id="vAddress">-</div>
            <div class="k">본인 자금 여부</div><div class="v" id="vOwnFunds">-</div>
          </div>
          <div class="confirm-area">
            <label>
              <input type="checkbox" id="finalConfirmCheckbox">
              <span class="text-[0.95rem] leading-[1.4]">상기 내용을 모두 확인하였으며, BNK쇼핑환전체크카드 발급에 최종 동의합니다. (필수)</span>
            </label>
          </div>
        </div>
      </div>
    </main>

    <footer class="bottom-bar">
      <button id="prevButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300">이전</button>
      <button id="issueButton" class="bg-gray-400 text-white cursor-not-allowed" disabled>카드 최종 발급</button>
    </footer>
  </div>

  <!-- 안내 모달 -->
  <div id="infoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[3000] p-4 min-h-[100svh]">
    <div class="bg-white rounded-xl w-[96vw] max-w-[420px] shadow-2xl">
      <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
        <div class="font-extrabold">안내</div>
        <button id="infoClose" class="text-gray-400 hover:text-gray-600 text-xl leading-none">×</button>
      </div>
      <div class="p-4"><p id="infoText" class="text-center text-gray-700 whitespace-pre-line"></p></div>
      <div class="px-4 pb-4">
        <button id="infoOk" class="w-full bg-red-500 hover:bg-red-600 text-white font-extrabold rounded-lg py-2.5">확인</button>
      </div>
    </div>
  </div>

  <!-- 완료 모달 -->
  <div id="completeModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[3100] p-4 min-h-[100svh]">
    <div class="bg-white rounded-xl w-[96vw] max-w-[420px] shadow-2xl">
      <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
        <div class="font-extrabold">완료</div>
        <button id="completeClose" class="text-gray-400 hover:text-gray-600 text-xl leading-none">×</button>
      </div>
      <div class="p-5">
        <p class="text-center text-gray-800 font-bold leading-relaxed">😊 가입이 모두 완료되었어요 😊<br>이용해 주셔서 감사합니다!</p>
      </div>
      <div class="px-4 pb-4">
        <button id="completeOk" class="w-full bg-red-500 hover:bg-red-600 text-white font-extrabold rounded-lg py-2.5">확인</button>
      </div>
    </div>
  </div>

  <script>
  /* ===== 공통 ===== */
  const STORAGE_KEY='bnkCardIssueData';
  const KEYS_TO_CLEAR=['bnkEnrollmentData','bnkConfirmedStatus','bnkEnrollmentComplete','bnkPassword','bnkCardIssueData'];

  function clearAllRelatedSessions(){ try{ KEYS_TO_CLEAR.forEach(k=>sessionStorage.removeItem(k)); }catch(e){ console.warn(e); } }
  function setVHUnit(){ const vh=window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
  setVHUnit(); window.addEventListener('resize', setVHUnit);

  function showModal(el){ el.classList.remove('hidden'); el.classList.add('flex'); }
  function hideModal(el){ el.classList.add('hidden'); el.classList.remove('flex'); }

  const infoModal=document.getElementById('infoModal');
  const infoText=document.getElementById('infoText');
  document.getElementById('infoOk').onclick=()=> hideModal(infoModal);
  document.getElementById('infoClose').onclick=()=> hideModal(infoModal);
  function info(msg){ infoText.textContent=msg; showModal(infoModal); }

  const completeModal=document.getElementById('completeModal');
  const completeOk=document.getElementById('completeOk');
  const completeClose=document.getElementById('completeClose');
  function showComplete(){ showModal(completeModal); }
  function closeComplete(){ hideModal(completeModal); }

  const prevButton=document.getElementById('prevButton');
  const issueButton=document.getElementById('issueButton');
  const finalConfirmCheckbox=document.getElementById('finalConfirmCheckbox');

  const cardPreviewImg=document.getElementById('cardPreviewImg');
  const vEnglishName=document.getElementById('vEnglishName');
  const vAddress=document.getElementById('vAddress');
  const vOwnFunds=document.getElementById('vOwnFunds');

  function mapCardImageById(id){
    if(id==='card-a') return 'images/option1.png';
    if(id==='card-b') return 'images/option2.png';
    if(id==='card-c') return 'images/option3.png';
    return '';
  }

  // ====== 데이터 복원 ======
  (function restore(){
    try{
      const raw=sessionStorage.getItem(STORAGE_KEY);
      if(!raw){ info('이전 단계의 정보가 없습니다.\n처음 화면으로 이동합니다.'); setTimeout(()=>location.href='/foreign',1200); return; }
      const data=JSON.parse(raw);
      const card=data.selectedCard;
      if(card?.id){ cardPreviewImg.src=mapCardImageById(card.id); cardPreviewImg.alt='선택한 카드'; }
      vEnglishName.textContent=(data.customer?.englishName||'').toUpperCase()||'-';
      const addr=data.customer?.address||{};
      const addrText=[addr.postalCode?`[${addr.postalCode}]`:'', addr.baseAddress||'', addr.detailAddress||''].filter(Boolean).join(' ');
      vAddress.textContent=addrText||'-';
      vOwnFunds.textContent=data.customer?.ownFunds==='yes'?'예':(data.customer?.ownFunds==='no'?'아니오':'-');
    }catch(e){
      info('정보 복원 중 오류가 발생했습니다.\n처음 화면으로 이동합니다.');
      setTimeout(()=>location.href='/foreign',1300);
    }
  })();

  // ====== 버튼 enable/disable ======
  function updateIssueButton(){
    const enabled = !!finalConfirmCheckbox?.checked;
    issueButton.disabled = !enabled;
    issueButton.classList.toggle('bg-gray-400',!enabled);
    issueButton.classList.toggle('cursor-not-allowed',!enabled);
    issueButton.classList.toggle('bg-red-500',enabled);
    issueButton.classList.toggle('hover:bg-red-600',enabled);
  }
  if (finalConfirmCheckbox) {
    finalConfirmCheckbox.addEventListener('change', updateIssueButton, {passive:true});
  }
  updateIssueButton();
  prevButton.addEventListener('click', ()=> history.back());

  // ====== 선택 통화만 회수(중복 제거 + 대문자 정규화 + 100단위 정리) ======
  function getSelectedCurrencies(enroll, cardData){
    let list = [];
    if (Array.isArray(enroll?.currencies) && enroll.currencies.length) {
      list = enroll.currencies;
    } else if (enroll?.currencyDisplay) {            // 구버전 호환
      list = [enroll.currencyDisplay];
    } else if (Array.isArray(cardData?.currencies)) {
      list = cardData.currencies;
    } else if (Array.isArray(cardData?.selectedCurrencies)) {
      list = cardData.selectedCurrencies;
    }
    list = list
      .filter(Boolean)
      .map(s => String(s).trim().toUpperCase().replace(/100$/,''));
    return [...new Set(list)]; // ✅ 오타 주의 (...new Set)
  }

  async function postFinalIssue(payload){
    const res = await fetch('/api/foreign/final-issue', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body:JSON.stringify(payload),
    });
    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      throw new Error(`발급 API 오류(${res.status}): ${txt || 'no body'}`);
    }
    return res.json();
  }

  // ====== 발급 처리 ======
  issueButton.addEventListener('click', async () => {
    if (issueButton.disabled) return;

    issueButton.disabled = true;
    issueButton.classList.add('cursor-wait');
    const prevLabel = issueButton.textContent;
    issueButton.textContent = '발급 처리 중...';

    try{
      const rawEnroll = sessionStorage.getItem('bnkEnrollmentData');
      const rawCard   = sessionStorage.getItem(STORAGE_KEY);
      const enroll    = rawEnroll ? JSON.parse(rawEnroll) : {};
      const cardData  = rawCard   ? JSON.parse(rawCard)   : {};

      // ✅ 오직 선택한 통화만
      const currencies = getSelectedCurrencies(enroll, cardData);
      if (currencies.length === 0) {
        info('선택한 통화가 없습니다.\n이전 화면에서 결제 통화를 선택해 주세요.');
        return;
      }

      // 가입금액(외화)도 함께 전달 → 서버(DB) 저장용
      const amountForeign = Number(enroll?.amountForeign ?? enroll?.amount) || undefined;

      const cardName = cardData?.selectedCard?.name || 'BNK 글로벌 체크';
      const fno      = enroll.fno ?? 1;
      const pabank   = enroll.pabank || '부산본점';

      const payload = { fno, pabank, currencies, amountForeign, cardName };
      console.log('[final-issue] payload:', payload);

      const data = await postFinalIssue(payload);
      console.log('발급 결과:', data);

      // 결과는 세션에만 기록(화면에 번호 미노출)
      try{
        const raw = sessionStorage.getItem(STORAGE_KEY);
        const cur = raw ? JSON.parse(raw) : {};
        cur.final = { issued:true, issuedAt:new Date().toISOString(), result:data };
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(cur));
      }catch(e){}

      // ✅ 곧바로 완료 모달(계좌/카드번호는 화면 노출 X)
      showComplete();

    }catch(err){
      console.error(err);
      info(`처리 중 오류가 발생했습니다.\n\n${err.message || err}`);
    }finally{
      issueButton.textContent = prevLabel;
      issueButton.classList.remove('cursor-wait');
      updateIssueButton();
    }
  });

  completeOk.addEventListener('click', () => { clearAllRelatedSessions(); location.href='/foreign'; });
  completeClose.addEventListener('click', ()=> hideModal(completeModal));

  </script>
</body>
</html>
