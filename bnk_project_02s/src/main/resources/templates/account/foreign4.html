<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNK ì‡¼í•‘í™˜ì „í†µì¥ - ë³¸ì¸í™•ì¸ (íœ´ëŒ€í° & ê³„ì¢Œ)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
        }

        /* Footer styles */
        .bottom-bar {
            flex: none;
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            z-index: 10;
        }
        .bottom-bar button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .bottom-bar button:active { transform: scale(0.98); }

        /* Main content area */
        .main-content {
            flex-grow: 1;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        .section-block {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: none;
            margin-bottom: 0; 
        }
        .section-title .checkmark {
            color: #10b981; 
            font-size: 1.2rem;
            margin-left: 0.5rem;
            display: none; 
        }
        .section-title .title-text {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        /* Form elements */
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            box-sizing: border-box;
            background-color: #f9fafb; 
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .form-group input[readonly] {
            background-color: #e5e7eb; 
            cursor: not-allowed;
        }

        .input-with-button { display: flex; gap: 0.5rem; }
        .input-with-button input { flex-grow: 1; }
        .input-with-button button {
            flex-shrink: 0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }

        .cert-status { 
            font-size: 0.85rem;
            color: #10b981; 
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            width: 100%;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .step-indicator-progress {
            width: 33.33%;
            height: 100%;
            background-color: #2563eb;
            border-radius: 2px;
        }

        #encouragementMessage { white-space: pre-wrap; font-size: 1rem; }
        .hidden { display: none !important; }

        /* Accordion */
        .section-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            border-top: none;
            margin-top: 0;
        }
        .section-content.collapsed { max-height: 0; border-top: none; margin-top: 0; }
        .section-content:not(.collapsed) { border-top: 1px solid #f0f4f8; }
        .section-content-inner { padding: 1.5rem; }

        .section-block.collapsible .section-title { cursor: pointer; }
        .section-block.collapsible .section-title .toggle-icon { transition: transform 0.3s ease; display: inline-block; }
        .section-block.collapsible .section-title.rotated .toggle-icon { transform: rotate(180deg); }
        .section-block.collapsible.confirmed .section-title .toggle-icon { display: none; }

        /* ===== ìŒì„± ì•ˆë‚´ íŒ¨ë„ ===== */
        .voice-panel{
            position:absolute;right:.75rem;top:3.25rem;width:300px;background:#fff;
            border:1px solid #e5e7eb;border-radius:.75rem;box-shadow:0 10px 20px rgba(0,0,0,.08);
            padding:.75rem;z-index:50;display:none
        }
        .voice-panel.open{display:block}

        /* ===== í°ìƒ‰ í™•ì¸ ë²„íŠ¼ ê³µí†µ ===== */
        .btn-white{
            background:#fff;
            color:#1f2937; /* gray-800 */
            border:1px solid #d1d5db; /* gray-300 */
        }
        .btn-white:hover{ background:#f9fafb; } /* gray-50 */
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        <!-- Header: ê°€ìš´ë° ì •ë ¬ì„ ìœ„í•´ 3ì—´ ê·¸ë¦¬ë“œ -->
        <header class="grid grid-cols-3 items-center p-4 bg-white border-b border-gray-200">
            <a href="/foreign" class="justify-self-start flex items-center text-blue-700 font-medium text-base hover:text-blue-800 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
                í™ˆìœ¼ë¡œ
            </a>

            <h1 class="justify-self-center text-xl font-bold text-gray-800 text-center">ë³¸ì¸í™•ì¸</h1>

            <!-- ìš°ì¸¡ ìƒë‹¨: ìŒì„± ì•ˆë‚´ ë²„íŠ¼ + íŒ¨ë„ -->
            <div class="relative justify-self-end">
                <button id="voiceGuideBtn"
                        class="px-2 py-1 rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-1"
                        aria-pressed="false"
                        aria-label="ìŒì„± ì•ˆë‚´ ì¼œê¸°"
                        title="ìŒì„± ì•ˆë‚´ ì¼œê¸°">
                    <!-- Play -->
                    <svg id="voiceIconPlay" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M3 10v4a1 1 0 001 1h3l3.293 3.293A1 1 0 0011 18v-12a1 1 0 00-1.707-.707L7 8H4a1 1 0 00-1 1zm13.586-3.414a1 1 0 10-1.414 1.414A5.969 5.969 0 0117 12c0 1.657-.672 3.157-1.828 4.243a1 1 0 101.414 1.414A7.968 7.968 0 0019 12a7.968 7.968 0 00-2.414-5.414z"/>
                    </svg>
                    <!-- Stop -->
                    <svg id="voiceIconStop" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M6 6h12v12H6z"/>
                    </svg>
                    <span id="voiceLabel" class="text-xs font-semibold">ìŒì„± ì•ˆë‚´ ì¼œê¸°</span>
                </button>

                <!-- íŒ¨ë„: ë„ì›€ë§ + ë‹¤ì‹œ ë“£ê¸° + ë‹«ê¸° -->
                <div id="voicePanel" class="voice-panel" role="dialog" aria-label="ìŒì„± ì•ˆë‚´ ì„¤ì •">
                    <div class="mb-2 flex items-center justify-between">
                        <p class="text-sm font-semibold text-gray-800">ìŒì„± ì•ˆë‚´</p>
                        <button id="voiceCloseBtn" class="text-gray-500 hover:text-gray-700 text-xs px-2 py-1 rounded" aria-label="ì„¤ì • ë‹«ê¸°">ë‹«ê¸°</button>
                    </div>
                    <div class="mb-3 text-xs text-gray-700 leading-5">
                        <p class="mb-1">ì‹œì‘/ì •ì§€: ìš°ì¸¡ ìƒë‹¨ â€˜<span class="font-semibold">ìŒì„± ì•ˆë‚´ ì¼œê¸°Â·ë„ê¸°</span>â€™ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                        <p class="mb-1">íœ´ëŒ€í°: <span class="font-semibold">í†µì‹ ì‚¬ ì„ íƒ â†’ ë²ˆí˜¸ ì…ë ¥ â†’ ì¸ì¦ë²ˆí˜¸ ìš”ì²­</span> í›„ ì½”ë“œ í™•ì¸ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                        <p class="mb-0">ê³„ì¢Œ: <span class="font-semibold">ì€í–‰ ì„ íƒ â†’ ê³„ì¢Œë²ˆí˜¸ ì…ë ¥ â†’ 1ì› ì†¡ê¸ˆ ìš”ì²­</span> í›„ ì…ê¸ˆìëª… 3ìë¦¬ í™•ì¸ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                    </div>
                    <div class="flex">
                        <button id="voiceReplayBtn" class="flex-1 bg-blue-600 text-white rounded-md px-3 py-2 text-sm font-semibold hover:bg-blue-700">ë‹¤ì‹œ ë“£ê¸°</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator mx-4 mt-4">
            <div class="step-indicator-progress"></div>
        </div>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- ì‘ì› ë¬¸êµ¬ -->
            <div id="encouragementMessage" class="text-center text-base font-semibold text-gray-700 p-3 rounded-lg bg-yellow-100 mx-0 mt-0 shadow-sm" style="white-space: pre-wrap;">
                <!-- ë©”ì‹œì§€ëŠ” JavaScriptì— ì˜í•´ ë™ì ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. -->
            </div>

            <!-- íœ´ëŒ€í° ì¸ì¦ ì„¹ì…˜ -->
            <div id="phoneAuthSection" class="section-block collapsible">
                <h2 class="section-title">
                    <span class="title-text">
                        íœ´ëŒ€í° ì¸ì¦
                        <span id="phoneCheckmark" class="checkmark">âœ”</span>
                    </span>
                    <svg id="phoneToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="phoneAuthContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="telecomProvider">í†µì‹ ì‚¬</label>
                            <select id="telecomProvider">
                                <option value="">í†µì‹ ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                                <option value="SKT">SKT</option>
                                <option value="KT">KT</option>
                                <option value="LG U+">LG U+</option>
                                <option value="MVNO">ì•Œëœ°í°</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">íœ´ëŒ€í° ë²ˆí˜¸</label>
                            <div class="input-with-button">
                                <input type="text" id="phoneNumber" placeholder="010-XXXX-XXXX" maxlength="13">
                                <button id="requestAuthCodeBtn" class="bg-blue-600 text-white hover:bg-blue-700">ì¸ì¦ë²ˆí˜¸ ìš”ì²­</button>
                            </div>
                        </div>
                        <div class="form-group hidden" id="authCodeGroup">
                            <label for="authCode">ì¸ì¦ë²ˆí˜¸</label>
                            <div class="input-with-button">
                                <input type="text" id="authCode" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬" maxlength="6">
                                <!-- í™•ì¸ ë²„íŠ¼: í°ìƒ‰ -->
                                <button id="verifyAuthCodeBtn" class="btn-white">í™•ì¸</button>
                            </div>
                            <p id="authCodeTimer" class="text-sm text-gray-500 mt-2 text-center"></p>
                        </div>
                        <p id="phoneCertStatus" class="cert-status hidden text-center"></p>
                    </div>
                </div>
            </div>

            <!-- ê³„ì¢Œ ì¸ì¦ ì„¹ì…˜ -->
            <div id="accountAuthSection" class="section-block collapsible">
                <h2 class="section-title">
                    <span class="title-text">
                        ê³„ì¢Œ ì¸ì¦
                        <span id="accountCheckmark" class="checkmark">âœ”</span>
                    </span>
                    <svg id="accountToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="accountAuthContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="bankName">ì€í–‰</label>
                            <select id="bankName">
                                <option value="">ì€í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                                <option value="êµ­ë¯¼ì€í–‰">êµ­ë¯¼ì€í–‰</option>
                                <option value="ì‹ í•œì€í–‰">ì‹ í•œì€í–‰</option>
                                <option value="ìš°ë¦¬ì€í–‰">ìš°ë¦¬ì€í–‰</option>
                                <option value="í•˜ë‚˜ì€í–‰">í•˜ë‚˜ì€í–‰</option>
                                <option value="ë†í˜‘ì€í–‰">ë†í˜‘ì€í–‰</option>
                                <option value="ë¶€ì‚°ì€í–‰">ë¶€ì‚°ì€í–‰</option>
                                <option value="BNKê²½ë‚¨ì€í–‰">BNKê²½ë‚¨ì€í–‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="accountNumber">ê³„ì¢Œë²ˆí˜¸</label>
                            <div class="input-with-button">
                                <input type="text" id="accountNumber" placeholder="ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
                                <button id="requestTransferBtn" class="bg-blue-600 text-white hover:bg-blue-700">1ì› ì†¡ê¸ˆ ìš”ì²­</button>
                            </div>
                        </div>
                        
                        <div class="form-group hidden" id="depositCodeGroup">
                            <label for="depositCode">ì…ê¸ˆìëª…</label>
                            <div class="input-with-button">
                                <input type="text" id="depositCode" placeholder="ì…ê¸ˆìëª… 3ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="3">
                                <!-- í™•ì¸ ë²„íŠ¼: í°ìƒ‰ -->
                                <button id="verifyDepositCodeBtn" class="btn-white">í™•ì¸</button>
                            </div>
                            <p id="depositCodeTimer" class="text-sm text-gray-500 mt-2 text-center"></p>
                        </div>
                        <p id="accountCertStatus" class="cert-status hidden text-center"></p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Bottom Bar -->
        <footer class="bottom-bar">
            <button id="prevButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300">ì´ì „</button>
            <button id="nextButton" class="bg-blue-600 text-white hover:bg-blue-700">ë‹¤ìŒìœ¼ë¡œ</button>
        </footer>
    </div>

    <script>
        // --- DOM ìš”ì†Œ ì •ì˜ ---
        const homeButton = document.querySelector('header a');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const encouragementMessageDiv = document.getElementById('encouragementMessage');

        // íœ´ëŒ€í° ì¸ì¦ ì„¹ì…˜
        const phoneAuthSection = document.getElementById('phoneAuthSection');
        const phoneAuthTitle = phoneAuthSection.querySelector('.section-title');
        const phoneCheckmark = document.getElementById('phoneCheckmark');
        const phoneAuthContent = document.getElementById('phoneAuthContent');
        const phoneToggleIcon = document.getElementById('phoneToggleIcon');
        const telecomProviderSelect = document.getElementById('telecomProvider');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const requestAuthCodeBtn = document.getElementById('requestAuthCodeBtn');
        const authCodeGroup = document.getElementById('authCodeGroup');
        const authCodeInput = document.getElementById('authCode');
        const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
        const authCodeTimer = document.getElementById('authCodeTimer');
        const phoneCertStatus = document.getElementById('phoneCertStatus');

        // ê³„ì¢Œ ì¸ì¦ ì„¹ì…˜
        const accountAuthSection = document.getElementById('accountAuthSection');
        const accountAuthTitle = accountAuthSection.querySelector('.section-title');
        const accountCheckmark = document.getElementById('accountCheckmark');
        const accountAuthContent = document.getElementById('accountAuthContent');
        const accountToggleIcon = document.getElementById('accountToggleIcon');
        const bankNameSelect = document.getElementById('bankName');
        const accountNumberInput = document.getElementById('accountNumber');
        const requestTransferBtn = document.getElementById('requestTransferBtn');
        const depositCodeGroup = document.getElementById('depositCodeGroup');
        const depositCodeInput = document.getElementById('depositCode');
        const verifyDepositCodeBtn = document.getElementById('verifyDepositCodeBtn');
        const depositCodeTimer = document.getElementById('depositCodeTimer');
        const accountCertStatus = document.getElementById('accountCertStatus');

        // ===== ìŒì„± ì•ˆë‚´ ìš”ì†Œ
        const voiceBtn = document.getElementById('voiceGuideBtn');
        const voiceIconPlay = document.getElementById('voiceIconPlay');
        const voiceIconStop = document.getElementById('voiceIconStop');
        const voiceLabel = document.getElementById('voiceLabel');
        const voicePanel = document.getElementById('voicePanel');
        const voiceCloseBtn = document.getElementById('voiceCloseBtn');
        const voiceReplayBtn = document.getElementById('voiceReplayBtn');

        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let phoneAuthenticated = false;
        let accountAuthenticated = false;

        let phoneCountdownInterval;
        let accountCountdownInterval;

        let simulatedAuthCode = '123456';
        let simulatedDepositCode = '';

        // --- ì´ˆê¸° UI ì„¤ì • í•¨ìˆ˜ ---
        function initializeUI() {
            phoneAuthContent.classList.remove('collapsed');
            phoneAuthTitle.classList.add('rotated');
            accountAuthContent.classList.remove('collapsed');
            accountAuthTitle.classList.add('rotated');
            updateNextButtonState(); 
        }

        // --- 'ë‹¤ìŒ' ë²„íŠ¼ ë° ì‘ì› ë©”ì‹œì§€ ---
        function updateNextButtonState() {
            if (phoneAuthenticated && accountAuthenticated) {
                nextButton.disabled = false;
                nextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                encouragementMessageDiv.textContent = 'ëª¨ë“  ë³¸ì¸ í™•ì¸ ì ˆì°¨ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰\në‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•´ ì£¼ì„¸ìš” ğŸ˜„';
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                encouragementMessageDiv.textContent = 'ë³¸ì¸ í™•ì¸ì˜ ë§ˆì§€ë§‰ ë‹¨ê³„ì…ë‹ˆë‹¤.\nì¡°ê¸ˆë§Œ ë” í˜ë‚´ì£¼ì„¸ìš”! ğŸ’ª';
            }
        }

        // --- ì¸ì¦ íƒ€ì´ë¨¸ ê³µí†µ ---
        function startTimer(timerElement, buttonToDisable, buttonToEnable, duration, onExpireCallback) {
            let timer = duration;
            clearInterval(phoneCountdownInterval); 
            clearInterval(accountCountdownInterval);

            let currentInterval;
            if (timerElement === authCodeTimer) {
                currentInterval = setInterval(updateTimer, 1000);
                phoneCountdownInterval = currentInterval;
            } else if (timerElement === depositCodeTimer) {
                currentInterval = setInterval(updateTimer, 1000);
                accountCountdownInterval = currentInterval;
            }
            
            timerElement.classList.remove('hidden');
            buttonToDisable.disabled = true;
            buttonToDisable.classList.add('bg-gray-400', 'cursor-not-allowed');
            buttonToDisable.classList.remove('bg-blue-600', 'hover:bg-blue-700');

            function updateTimer() {
                const minutes = parseInt(timer / 60, 10);
                const seconds = parseInt(timer % 60, 10);

                timerElement.textContent = `ë‚¨ì€ ì‹œê°„: ${minutes < 10 ? "0" + minutes : minutes}:${seconds < 10 ? "0" + seconds : seconds}`;

                if (--timer < 0) {
                    clearInterval(currentInterval);
                    timerElement.textContent = 'ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ì£¼ì„¸ìš”.';
                    timerElement.style.color = '#ef4444';
                    buttonToEnable.disabled = false;
                    buttonToEnable.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    buttonToEnable.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    if (onExpireCallback) onExpireCallback();
                }
            }
        }

        // --- íœ´ëŒ€í° ë²ˆí˜¸ ìë™ í¬ë§· ---
        phoneNumberInput.addEventListener('input', (event) => {
            let value = event.target.value.replace(/[^0-9]/g, '');
            let formattedValue = '';

            if (value.startsWith('010')) {
                if (value.length > 10) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7, 11);
                } else if (value.length > 6) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7);
                } else if (value.length > 3) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3);
                } else {
                    formattedValue = value;
                }
            } else {
                formattedValue = value;
            }

            event.target.value = formattedValue.substring(0, 13);
        });

        // --- ì•„ì½”ë””ì–¸ í† ê¸€ ---
        function toggleAccordion(contentElement, titleElement, toggleIconElement, sectionBlockElement) {
            if (sectionBlockElement.classList.contains('confirmed')) return;
            contentElement.classList.toggle('collapsed');
            titleElement.classList.toggle('rotated');
            if (contentElement.classList.contains('collapsed')) {
                toggleIconElement.classList.remove('rotated');
            } else {
                toggleIconElement.classList.add('rotated');
            }
        }

        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

        // íœ´ëŒ€í° ì¸ì¦ë²ˆí˜¸ ìš”ì²­
        requestAuthCodeBtn.addEventListener('click', () => {
            const telecom = telecomProviderSelect.value;
            const phoneNum = phoneNumberInput.value;

            if (!telecom || !phoneNum) { alert('í†µì‹ ì‚¬ì™€ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(phoneNum)) { alert('ìœ íš¨í•œ íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 010-XXXX-XXXX)'); return; }

            simulatedAuthCode = Math.floor(100000 + Math.random() * 900000).toString(); 

            authCodeGroup.classList.remove('hidden');
            // í™•ì¸ ë²„íŠ¼ í™œì„±í™”: í°ìƒ‰ ìŠ¤íƒ€ì¼ ìœ ì§€
            verifyAuthCodeBtn.disabled = false;
            verifyAuthCodeBtn.classList.remove('bg-gray-200','bg-gray-400','cursor-not-allowed','bg-blue-600','hover:bg-blue-700');
            verifyAuthCodeBtn.classList.add('btn-white');

            setTimeout(() => {
                authCodeInput.value = simulatedAuthCode;
                authCodeTimer.textContent = '';
                authCodeTimer.style.color = '';
                clearInterval(phoneCountdownInterval);
                requestAuthCodeBtn.disabled = true;
                requestAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestAuthCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }, 3000);

            startTimer(authCodeTimer, requestAuthCodeBtn, requestAuthCodeBtn, 180, () => {
                if (!phoneAuthenticated) {
                    verifyAuthCodeBtn.disabled = true;
                    verifyAuthCodeBtn.classList.remove('btn-white');
                    verifyAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            }); 
        });

        // íœ´ëŒ€í° ì¸ì¦ë²ˆí˜¸ í™•ì¸
        verifyAuthCodeBtn.addEventListener('click', () => {
            const enteredCode = authCodeInput.value;

            if (enteredCode === simulatedAuthCode) {
                clearInterval(phoneCountdownInterval); 
                authCodeTimer.classList.add('hidden');
                phoneCertStatus.textContent = 'íœ´ëŒ€í° ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. âœ…';
                phoneCertStatus.style.color = '#10b981';
                phoneCertStatus.classList.remove('hidden');
                
                verifyAuthCodeBtn.disabled = true;
                verifyAuthCodeBtn.classList.remove('btn-white');
                verifyAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

                requestAuthCodeBtn.disabled = true; 
                requestAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestAuthCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                
                telecomProviderSelect.disabled = true; 
                phoneNumberInput.disabled = true; 
                authCodeInput.disabled = true; 

                phoneAuthenticated = true;
                updateNextButtonState();
                
                setTimeout(() => {
                    phoneAuthContent.classList.add('collapsed'); 
                    phoneAuthTitle.classList.remove('rotated'); 
                    phoneCheckmark.style.display = 'inline-block';
                    phoneAuthSection.classList.add('confirmed');
                }, 1000);
            } else {
                alert('ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                authCodeInput.value = '';
            }
        });

        // 1ì› ì†¡ê¸ˆ ìš”ì²­
        requestTransferBtn.addEventListener('click', () => {
            const bank = bankNameSelect.value;
            const account = accountNumberInput.value;

            if (!bank || !account) { alert('ì€í–‰ê³¼ ê³„ì¢Œë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!/^\d+$/.test(account)) { alert('ìœ íš¨í•œ ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ìˆ«ìë§Œ ì…ë ¥).'); return; }

            simulatedDepositCode = Math.floor(100 + Math.random() * 900).toString(); 

            depositCodeGroup.classList.remove('hidden');
            // í™•ì¸ ë²„íŠ¼ í™œì„±í™”: í°ìƒ‰ ìŠ¤íƒ€ì¼ ìœ ì§€
            verifyDepositCodeBtn.disabled = false;
            verifyDepositCodeBtn.classList.remove('bg-gray-200','bg-gray-400','cursor-not-allowed','bg-blue-600','hover:bg-blue-700');
            verifyDepositCodeBtn.classList.add('btn-white');

            setTimeout(() => {
                depositCodeInput.value = simulatedDepositCode;
                depositCodeTimer.textContent = '';
                depositCodeTimer.style.color = '';
                clearInterval(accountCountdownInterval);
                requestTransferBtn.disabled = true;
                requestTransferBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestTransferBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }, 3000);

            startTimer(depositCodeTimer, requestTransferBtn, requestTransferBtn, 180, () => {
                if (!accountAuthenticated) {
                    verifyDepositCodeBtn.disabled = true;
                    verifyDepositCodeBtn.classList.remove('btn-white');
                    verifyDepositCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            });
        });

        // ì…ê¸ˆìëª… í™•ì¸
        verifyDepositCodeBtn.addEventListener('click', () => {
            const enteredCode = depositCodeInput.value;

            if (enteredCode === simulatedDepositCode) {
                clearInterval(accountCountdownInterval); 
                depositCodeTimer.classList.add('hidden');
                accountCertStatus.textContent = 'ê³„ì¢Œ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. âœ…';
                accountCertStatus.style.color = '#10b981';
                accountCertStatus.classList.remove('hidden');
                
                bankNameSelect.disabled = true;
                accountNumberInput.disabled = true;
                requestTransferBtn.disabled = true;
                requestTransferBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestTransferBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                depositCodeInput.disabled = true;
                verifyDepositCodeBtn.disabled = true;
                verifyDepositCodeBtn.classList.remove('btn-white');
                verifyDepositCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

                accountAuthenticated = true;
                updateNextButtonState();
                
                setTimeout(() => {
                    accountAuthContent.classList.add('collapsed'); 
                    accountAuthTitle.classList.remove('rotated'); 
                    accountCheckmark.style.display = 'inline-block';
                    accountAuthSection.classList.add('confirmed');
                }, 1000);
            } else {
                alert('ì…ê¸ˆìëª…ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                depositCodeInput.value = '';
            }
        });

        // --- ë‚´ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ---
        homeButton.addEventListener('click', function(event) {
            event.preventDefault();
            Voice.cancel();
            window.location.href = '/foreign';
        });

        prevButton.addEventListener('click', function() {
            Voice.cancel();
            window.location.href = '/foreign3';
        });

        nextButton.addEventListener('click', async function() {
        	  if (phoneAuthenticated && accountAuthenticated) {
        	    try { await saveAccountToSession(); } catch (e) { console.warn(e); }
        	    Voice.cancel();
        	    window.location.href = '/foreign5';
        	  } else {
        	    alert('ëª¨ë“  ë³¸ì¸ í™•ì¸ ì ˆì°¨(íœ´ëŒ€í°, ê³„ì¢Œ)ë¥¼ ì™„ë£Œí•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        	  }
        	});

        // ì„¹ì…˜ ì œëª© í´ë¦­ ì‹œ ì•„ì½”ë””ì–¸ í† ê¸€
        phoneAuthTitle.addEventListener('click', () => {
            toggleAccordion(phoneAuthContent, phoneAuthTitle, phoneToggleIcon, phoneAuthSection);
        });
        accountAuthTitle.addEventListener('click', () => {
            toggleAccordion(accountAuthContent, accountAuthTitle, accountToggleIcon, accountAuthSection);
        });

        // DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeUI);

        /* ===== ìŒì„± ì•ˆë‚´ (Web Speech + ë„¤ì´í‹°ë¸Œ ë¸Œë¦¿ì§€) ===== */
        const Voice = (function(){
            let speaking = false;
            let queue = [];
            let current = null;

            const hasWebSpeech = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
            const hasAndroid = !!window.AndroidTTS?.speak;
            const hasIOS = !!(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.tts);

            function useNativeSpeak(text){
                const r = 1.0;
                if(hasAndroid){
                    try{ window.AndroidTTS.speak(String(text), r); return true; }catch(e){ console.warn(e); }
                }
                if(hasIOS){
                    try{ window.webkit.messageHandlers.tts.postMessage({action:'speak', text:String(text), rate:r}); return true; }catch(e){ console.warn(e); }
                }
                return false;
            }
            function useNativeStop(){
                if(hasAndroid){
                    try{ window.AndroidTTS.stop(); return true; }catch(e){ console.warn(e); }
                }
                if(hasIOS){
                    try{ window.webkit.messageHandlers.tts.postMessage({action:'stop'}); return true; }catch(e){ console.warn(e); }
                }
                return false;
            }

            function speakWeb(text, onend){
                const u = new SpeechSynthesisUtterance(String(text));
                u.lang = 'ko-KR';
                u.rate = 1.0;
                u.onend = onend || null;
                u.onerror = function(){ onend && onend(); };
                window.speechSynthesis.speak(u);
            }

            function nextInQueue(){
                if(queue.length === 0){ current = null; speaking = false; setUI(false); return; }
                current = queue.shift();
                if(useNativeSpeak(current)){
                    speaking = true; setUI(true);
                    const approx = Math.max(1500, current.length * 60);
                    setTimeout(()=>{ nextInQueue(); }, approx);
                }else if(hasWebSpeech){
                    speaking = true; setUI(true);
                    speakWeb(current, ()=> nextInQueue());
                }else{
                    speaking = false; setUI(false);
                }
            }

            function setUI(isOn){
                voiceBtn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
                voiceIconPlay.classList.toggle('hidden', isOn);
                voiceIconStop.classList.toggle('hidden', !isOn);
                voiceLabel.textContent = isOn ? 'ìŒì„± ì•ˆë‚´ ë„ê¸°' : 'ìŒì„± ì•ˆë‚´ ì¼œê¸°';
                voiceBtn.setAttribute('aria-label', voiceLabel.textContent);
                voiceBtn.setAttribute('title', voiceLabel.textContent);
            }

            function start(scriptLines){
                if(speaking) cancel();
                queue = Array.isArray(scriptLines) ? scriptLines.slice() : [String(scriptLines||'')];
                nextInQueue();
            }

            function cancel(){
                queue = [];
                current = null;
                speaking = false;
                useNativeStop();
                if(('speechSynthesis' in window)){ try{ window.speechSynthesis.cancel(); }catch(e){} }
                setUI(false);
            }

            function toggle(scriptLines){
                if(speaking){ cancel(); }
                else{ start(scriptLines); }
            }

            return { start, cancel, toggle, isSpeaking:()=>speaking };
        })();

        function buildVoiceScript(){
            const s1 = 'ì•ˆë‚´: ì§€ê¸ˆì€ ë³¸ì¸í™•ì¸ ë‹¨ê³„ì…ë‹ˆë‹¤. íœ´ëŒ€í° ì¸ì¦ê³¼ ê³„ì¢Œ ì¸ì¦ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.';
            const s2 = 'íœ´ëŒ€í° ì¸ì¦: í†µì‹ ì‚¬ë¥¼ ì„ íƒí•˜ê³  íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•œ ë’¤ ì¸ì¦ë²ˆí˜¸ ìš”ì²­ì„ ëˆ„ë¥´ì„¸ìš”. ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆ„ë¥´ë©´ ì™„ë£Œë©ë‹ˆë‹¤.';
            const s3 = 'ê³„ì¢Œ ì¸ì¦: ì€í–‰ì„ ì„ íƒí•˜ê³  ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•œ ë’¤ 1ì› ì†¡ê¸ˆ ìš”ì²­ì„ ëˆ„ë¥´ì„¸ìš”. ë„ì°©í•œ ì…ê¸ˆìëª… ìˆ«ì 3ìë¦¬ë¥¼ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆ„ë¥´ë©´ ì™„ë£Œë©ë‹ˆë‹¤.';
            const s4 = 'ë‘ ì¸ì¦ì´ ëª¨ë‘ ëë‚˜ë©´ í•˜ë‹¨ì˜ ë‹¤ìŒìœ¼ë¡œ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.';
            return [s1, s2, s3, s4];
        }

        voiceBtn.addEventListener('click', function(){
            voicePanel.classList.toggle('open');
            Voice.toggle(buildVoiceScript());
        });
        voiceCloseBtn.addEventListener('click', function(){ voicePanel.classList.remove('open'); });
        voiceReplayBtn.addEventListener('click', function(){ Voice.start(buildVoiceScript()); });

        document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ Voice.cancel(); } });
        window.addEventListener('pagehide', ()=> Voice.cancel());
        
        async function getAutofill(){
        	  const r = await fetch('/api/autofill', { credentials: 'include' });
        	  if (r.status === 401) return {};
        	  if (!r.ok) throw new Error('autofill api failed');
        	  return r.json(); // { name, phone, residentMasked }
        	}

        	function formatPhone(p){
        	  const d = String(p || '').replace(/\D/g, '');
        	  if (d.length === 11) return d.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3'); // 010-1234-5678
        	  if (d.length === 10) return d.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3'); // 010-123-4567
        	  return p || '';
        	}
        	async function saveAccountToSession(){
        		  const bankEl = document.getElementById('bankName');      // foreign4ì— ìˆìŒ
        		  const acctEl = document.getElementById('accountNumber'); // foreign4ì— ìˆìŒ
        		  const bank = bankEl?.value?.trim() ?? '';
        		  const acct = (acctEl?.value ?? '').replace(/\D/g, '').trim(); // ìˆ«ìë§Œ
        		  if (!bank || !acct) return; // ë¹„ì–´ìˆìœ¼ë©´ ì €ì¥ ì•ˆ í•¨
        		  await fetch('/api/session/account', {
        		    method: 'POST',
        		    headers: {'Content-Type':'application/json'},
        		    credentials: 'include',
        		    body: JSON.stringify({ bankName: bank, accountNumber: acct })
        		  });
        		}

        	async function applyForeign4Phone(){
        	  try{
        	    const d = await getAutofill();
        	    const phoneEl = document.getElementById('phoneNumber');
        	    if (!phoneEl || !d.phone) return;

        	    phoneEl.value = formatPhone(d.phone);
        	    // ì…ë ¥ ë§ˆìŠ¤í¬/ê²€ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ë™ì´ ìˆìœ¼ë©´ ì´ë²¤íŠ¸ í•œ ë²ˆ ë°œìƒì‹œì¼œì¤Œ
        	    phoneEl.dispatchEvent(new Event('input', { bubbles: true }));
        	    phoneEl.dispatchEvent(new Event('change', { bubbles: true }));
        	  }catch(e){
        	    console.warn('autofill(phone) ì‹¤íŒ¨', e);
        	  }
        	}

        	document.addEventListener('DOMContentLoaded', applyForeign4Phone);
    </script>
</body>
</html>
