<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNK 쇼핑환전통장 - 본인확인 (휴대폰 & 계좌)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
        }

        /* Footer styles */
        .bottom-bar {
            flex: none;
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            z-index: 10;
        }
        .bottom-bar button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .bottom-bar button:active { transform: scale(0.98); }

        /* Main content area */
        .main-content {
            flex-grow: 1;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        .section-block {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: none;
            margin-bottom: 0; 
        }
        .section-title .checkmark {
            color: #10b981; 
            font-size: 1.2rem;
            margin-left: 0.5rem;
            display: none; 
        }
        .section-title .title-text {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        /* Form elements */
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            box-sizing: border-box;
            background-color: #f9fafb; 
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .form-group input[readonly] {
            background-color: #e5e7eb; 
            cursor: not-allowed;
        }

        .input-with-button { display: flex; gap: 0.5rem; }
        .input-with-button input { flex-grow: 1; }
        .input-with-button button {
            flex-shrink: 0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }

        .cert-status { 
            font-size: 0.85rem;
            color: #10b981; 
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            width: 100%;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .step-indicator-progress {
            width: 33.33%;
            height: 100%;
            background-color: #2563eb;
            border-radius: 2px;
        }

        #encouragementMessage { white-space: pre-wrap; font-size: 1rem; }
        .hidden { display: none !important; }

        /* Accordion */
        .section-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            border-top: none;
            margin-top: 0;
        }
        .section-content.collapsed { max-height: 0; border-top: none; margin-top: 0; }
        .section-content:not(.collapsed) { border-top: 1px solid #f0f4f8; }
        .section-content-inner { padding: 1.5rem; }

        .section-block.collapsible .section-title { cursor: pointer; }
        .section-block.collapsible .section-title .toggle-icon { transition: transform 0.3s ease; display: inline-block; }
        .section-block.collapsible .section-title.rotated .toggle-icon { transform: rotate(180deg); }
        .section-block.collapsible.confirmed .section-title .toggle-icon { display: none; }

        /* ===== 음성 안내 패널 ===== */
        .voice-panel{
            position:absolute;right:.75rem;top:3.25rem;width:300px;background:#fff;
            border:1px solid #e5e7eb;border-radius:.75rem;box-shadow:0 10px 20px rgba(0,0,0,.08);
            padding:.75rem;z-index:50;display:none
        }
        .voice-panel.open{display:block}

        /* ===== 흰색 확인 버튼 공통 ===== */
        .btn-white{
            background:#fff;
            color:#1f2937; /* gray-800 */
            border:1px solid #d1d5db; /* gray-300 */
        }
        .btn-white:hover{ background:#f9fafb; } /* gray-50 */
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        <!-- Header: 가운데 정렬을 위해 3열 그리드 -->
        <header class="grid grid-cols-3 items-center p-4 bg-white border-b border-gray-200">
            <a href="/foreign" class="justify-self-start flex items-center text-blue-700 font-medium text-base hover:text-blue-800 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
                홈으로
            </a>

            <h1 class="justify-self-center text-xl font-bold text-gray-800 text-center">본인확인</h1>

            <!-- 우측 상단: 음성 안내 버튼 + 패널 -->
            <div class="relative justify-self-end">
                <button id="voiceGuideBtn"
                        class="px-2 py-1 rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-1"
                        aria-pressed="false"
                        aria-label="음성 안내 켜기"
                        title="음성 안내 켜기">
                    <!-- Play -->
                    <svg id="voiceIconPlay" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M3 10v4a1 1 0 001 1h3l3.293 3.293A1 1 0 0011 18v-12a1 1 0 00-1.707-.707L7 8H4a1 1 0 00-1 1zm13.586-3.414a1 1 0 10-1.414 1.414A5.969 5.969 0 0117 12c0 1.657-.672 3.157-1.828 4.243a1 1 0 101.414 1.414A7.968 7.968 0 0019 12a7.968 7.968 0 00-2.414-5.414z"/>
                    </svg>
                    <!-- Stop -->
                    <svg id="voiceIconStop" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M6 6h12v12H6z"/>
                    </svg>
                    <span id="voiceLabel" class="text-xs font-semibold">음성 안내 켜기</span>
                </button>

                <!-- 패널: 도움말 + 다시 듣기 + 닫기 -->
                <div id="voicePanel" class="voice-panel" role="dialog" aria-label="음성 안내 설정">
                    <div class="mb-2 flex items-center justify-between">
                        <p class="text-sm font-semibold text-gray-800">음성 안내</p>
                        <button id="voiceCloseBtn" class="text-gray-500 hover:text-gray-700 text-xs px-2 py-1 rounded" aria-label="설정 닫기">닫기</button>
                    </div>
                    <div class="mb-3 text-xs text-gray-700 leading-5">
                        <p class="mb-1">시작/정지: 우측 상단 ‘<span class="font-semibold">음성 안내 켜기·끄기</span>’ 버튼을 누르세요.</p>
                        <p class="mb-1">휴대폰: <span class="font-semibold">통신사 선택 → 번호 입력 → 인증번호 요청</span> 후 코드 확인을 누르세요.</p>
                        <p class="mb-0">계좌: <span class="font-semibold">은행 선택 → 계좌번호 입력 → 1원 송금 요청</span> 후 입금자명 3자리 확인을 누르세요.</p>
                    </div>
                    <div class="flex">
                        <button id="voiceReplayBtn" class="flex-1 bg-blue-600 text-white rounded-md px-3 py-2 text-sm font-semibold hover:bg-blue-700">다시 듣기</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator mx-4 mt-4">
            <div class="step-indicator-progress"></div>
        </div>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- 응원 문구 -->
            <div id="encouragementMessage" class="text-center text-base font-semibold text-gray-700 p-3 rounded-lg bg-yellow-100 mx-0 mt-0 shadow-sm" style="white-space: pre-wrap;">
                <!-- 메시지는 JavaScript에 의해 동적으로 설정됩니다. -->
            </div>

            <!-- 휴대폰 인증 섹션 -->
            <div id="phoneAuthSection" class="section-block collapsible">
                <h2 class="section-title">
                    <span class="title-text">
                        휴대폰 인증
                        <span id="phoneCheckmark" class="checkmark">✔</span>
                    </span>
                    <svg id="phoneToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="phoneAuthContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="telecomProvider">통신사</label>
                            <select id="telecomProvider">
                                <option value="">통신사를 선택해주세요</option>
                                <option value="SKT">SKT</option>
                                <option value="KT">KT</option>
                                <option value="LG U+">LG U+</option>
                                <option value="MVNO">알뜰폰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">휴대폰 번호</label>
                            <div class="input-with-button">
                                <input type="text" id="phoneNumber" placeholder="010-XXXX-XXXX" maxlength="13">
                                <button id="requestAuthCodeBtn" class="bg-blue-600 text-white hover:bg-blue-700">인증번호 요청</button>
                            </div>
                        </div>
                        <div class="form-group hidden" id="authCodeGroup">
                            <label for="authCode">인증번호</label>
                            <div class="input-with-button">
                                <input type="text" id="authCode" placeholder="인증번호 6자리" maxlength="6">
                                <!-- 확인 버튼: 흰색 -->
                                <button id="verifyAuthCodeBtn" class="btn-white">확인</button>
                            </div>
                            <p id="authCodeTimer" class="text-sm text-gray-500 mt-2 text-center"></p>
                        </div>
                        <p id="phoneCertStatus" class="cert-status hidden text-center"></p>
                    </div>
                </div>
            </div>

            <!-- 계좌 인증 섹션 -->
            <div id="accountAuthSection" class="section-block collapsible">
                <h2 class="section-title">
                    <span class="title-text">
                        계좌 인증
                        <span id="accountCheckmark" class="checkmark">✔</span>
                    </span>
                    <svg id="accountToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="accountAuthContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="bankName">은행</label>
                            <select id="bankName">
                                <option value="">은행을 선택해주세요</option>
                                <option value="국민은행">국민은행</option>
                                <option value="신한은행">신한은행</option>
                                <option value="우리은행">우리은행</option>
                                <option value="하나은행">하나은행</option>
                                <option value="농협은행">농협은행</option>
                                <option value="부산은행">부산은행</option>
                                <option value="BNK경남은행">BNK경남은행</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="accountNumber">계좌번호</label>
                            <div class="input-with-button">
                                <input type="text" id="accountNumber" placeholder="계좌번호를 입력해주세요">
                                <button id="requestTransferBtn" class="bg-blue-600 text-white hover:bg-blue-700">1원 송금 요청</button>
                            </div>
                        </div>
                        
                        <div class="form-group hidden" id="depositCodeGroup">
                            <label for="depositCode">입금자명</label>
                            <div class="input-with-button">
                                <input type="text" id="depositCode" placeholder="입금자명 3자리 숫자를 입력하세요" maxlength="3">
                                <!-- 확인 버튼: 흰색 -->
                                <button id="verifyDepositCodeBtn" class="btn-white">확인</button>
                            </div>
                            <p id="depositCodeTimer" class="text-sm text-gray-500 mt-2 text-center"></p>
                        </div>
                        <p id="accountCertStatus" class="cert-status hidden text-center"></p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Bottom Bar -->
        <footer class="bottom-bar">
            <button id="prevButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300">이전</button>
            <button id="nextButton" class="bg-blue-600 text-white hover:bg-blue-700">다음으로</button>
        </footer>
    </div>

    <script>
        // --- DOM 요소 정의 ---
        const homeButton = document.querySelector('header a');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const encouragementMessageDiv = document.getElementById('encouragementMessage');

        // 휴대폰 인증 섹션
        const phoneAuthSection = document.getElementById('phoneAuthSection');
        const phoneAuthTitle = phoneAuthSection.querySelector('.section-title');
        const phoneCheckmark = document.getElementById('phoneCheckmark');
        const phoneAuthContent = document.getElementById('phoneAuthContent');
        const phoneToggleIcon = document.getElementById('phoneToggleIcon');
        const telecomProviderSelect = document.getElementById('telecomProvider');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const requestAuthCodeBtn = document.getElementById('requestAuthCodeBtn');
        const authCodeGroup = document.getElementById('authCodeGroup');
        const authCodeInput = document.getElementById('authCode');
        const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
        const authCodeTimer = document.getElementById('authCodeTimer');
        const phoneCertStatus = document.getElementById('phoneCertStatus');

        // 계좌 인증 섹션
        const accountAuthSection = document.getElementById('accountAuthSection');
        const accountAuthTitle = accountAuthSection.querySelector('.section-title');
        const accountCheckmark = document.getElementById('accountCheckmark');
        const accountAuthContent = document.getElementById('accountAuthContent');
        const accountToggleIcon = document.getElementById('accountToggleIcon');
        const bankNameSelect = document.getElementById('bankName');
        const accountNumberInput = document.getElementById('accountNumber');
        const requestTransferBtn = document.getElementById('requestTransferBtn');
        const depositCodeGroup = document.getElementById('depositCodeGroup');
        const depositCodeInput = document.getElementById('depositCode');
        const verifyDepositCodeBtn = document.getElementById('verifyDepositCodeBtn');
        const depositCodeTimer = document.getElementById('depositCodeTimer');
        const accountCertStatus = document.getElementById('accountCertStatus');

        // ===== 음성 안내 요소
        const voiceBtn = document.getElementById('voiceGuideBtn');
        const voiceIconPlay = document.getElementById('voiceIconPlay');
        const voiceIconStop = document.getElementById('voiceIconStop');
        const voiceLabel = document.getElementById('voiceLabel');
        const voicePanel = document.getElementById('voicePanel');
        const voiceCloseBtn = document.getElementById('voiceCloseBtn');
        const voiceReplayBtn = document.getElementById('voiceReplayBtn');

        // --- 상태 변수 ---
        let phoneAuthenticated = false;
        let accountAuthenticated = false;

        let phoneCountdownInterval;
        let accountCountdownInterval;

        let simulatedAuthCode = '123456';
        let simulatedDepositCode = '';

        // --- 초기 UI 설정 함수 ---
        function initializeUI() {
            phoneAuthContent.classList.remove('collapsed');
            phoneAuthTitle.classList.add('rotated');
            accountAuthContent.classList.remove('collapsed');
            accountAuthTitle.classList.add('rotated');
            updateNextButtonState(); 
        }

        // --- '다음' 버튼 및 응원 메시지 ---
        function updateNextButtonState() {
            if (phoneAuthenticated && accountAuthenticated) {
                nextButton.disabled = false;
                nextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                encouragementMessageDiv.textContent = '모든 본인 확인 절차가 완료되었습니다! 🎉\n다음 단계로 이동해 주세요 😄';
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                encouragementMessageDiv.textContent = '본인 확인의 마지막 단계입니다.\n조금만 더 힘내주세요! 💪';
            }
        }

        // --- 인증 타이머 공통 ---
        function startTimer(timerElement, buttonToDisable, buttonToEnable, duration, onExpireCallback) {
            let timer = duration;
            clearInterval(phoneCountdownInterval); 
            clearInterval(accountCountdownInterval);

            let currentInterval;
            if (timerElement === authCodeTimer) {
                currentInterval = setInterval(updateTimer, 1000);
                phoneCountdownInterval = currentInterval;
            } else if (timerElement === depositCodeTimer) {
                currentInterval = setInterval(updateTimer, 1000);
                accountCountdownInterval = currentInterval;
            }
            
            timerElement.classList.remove('hidden');
            buttonToDisable.disabled = true;
            buttonToDisable.classList.add('bg-gray-400', 'cursor-not-allowed');
            buttonToDisable.classList.remove('bg-blue-600', 'hover:bg-blue-700');

            function updateTimer() {
                const minutes = parseInt(timer / 60, 10);
                const seconds = parseInt(timer % 60, 10);

                timerElement.textContent = `남은 시간: ${minutes < 10 ? "0" + minutes : minutes}:${seconds < 10 ? "0" + seconds : seconds}`;

                if (--timer < 0) {
                    clearInterval(currentInterval);
                    timerElement.textContent = '인증 시간이 만료되었습니다. 다시 요청해주세요.';
                    timerElement.style.color = '#ef4444';
                    buttonToEnable.disabled = false;
                    buttonToEnable.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    buttonToEnable.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    if (onExpireCallback) onExpireCallback();
                }
            }
        }

        // --- 휴대폰 번호 자동 포맷 ---
        phoneNumberInput.addEventListener('input', (event) => {
            let value = event.target.value.replace(/[^0-9]/g, '');
            let formattedValue = '';

            if (value.startsWith('010')) {
                if (value.length > 10) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7, 11);
                } else if (value.length > 6) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7);
                } else if (value.length > 3) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3);
                } else {
                    formattedValue = value;
                }
            } else {
                formattedValue = value;
            }

            event.target.value = formattedValue.substring(0, 13);
        });

        // --- 아코디언 토글 ---
        function toggleAccordion(contentElement, titleElement, toggleIconElement, sectionBlockElement) {
            if (sectionBlockElement.classList.contains('confirmed')) return;
            contentElement.classList.toggle('collapsed');
            titleElement.classList.toggle('rotated');
            if (contentElement.classList.contains('collapsed')) {
                toggleIconElement.classList.remove('rotated');
            } else {
                toggleIconElement.classList.add('rotated');
            }
        }

        // --- 이벤트 핸들러 ---

        // 휴대폰 인증번호 요청
        requestAuthCodeBtn.addEventListener('click', () => {
            const telecom = telecomProviderSelect.value;
            const phoneNum = phoneNumberInput.value;

            if (!telecom || !phoneNum) { alert('통신사와 휴대폰 번호를 모두 입력해주세요.'); return; }

            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(phoneNum)) { alert('유효한 휴대폰 번호 형식을 입력해주세요 (예: 010-XXXX-XXXX)'); return; }

            simulatedAuthCode = Math.floor(100000 + Math.random() * 900000).toString(); 

            authCodeGroup.classList.remove('hidden');
            // 확인 버튼 활성화: 흰색 스타일 유지
            verifyAuthCodeBtn.disabled = false;
            verifyAuthCodeBtn.classList.remove('bg-gray-200','bg-gray-400','cursor-not-allowed','bg-blue-600','hover:bg-blue-700');
            verifyAuthCodeBtn.classList.add('btn-white');

            setTimeout(() => {
                authCodeInput.value = simulatedAuthCode;
                authCodeTimer.textContent = '';
                authCodeTimer.style.color = '';
                clearInterval(phoneCountdownInterval);
                requestAuthCodeBtn.disabled = true;
                requestAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestAuthCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }, 3000);

            startTimer(authCodeTimer, requestAuthCodeBtn, requestAuthCodeBtn, 180, () => {
                if (!phoneAuthenticated) {
                    verifyAuthCodeBtn.disabled = true;
                    verifyAuthCodeBtn.classList.remove('btn-white');
                    verifyAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            }); 
        });

        // 휴대폰 인증번호 확인
        verifyAuthCodeBtn.addEventListener('click', () => {
            const enteredCode = authCodeInput.value;

            if (enteredCode === simulatedAuthCode) {
                clearInterval(phoneCountdownInterval); 
                authCodeTimer.classList.add('hidden');
                phoneCertStatus.textContent = '휴대폰 인증이 완료되었습니다. ✅';
                phoneCertStatus.style.color = '#10b981';
                phoneCertStatus.classList.remove('hidden');
                
                verifyAuthCodeBtn.disabled = true;
                verifyAuthCodeBtn.classList.remove('btn-white');
                verifyAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

                requestAuthCodeBtn.disabled = true; 
                requestAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestAuthCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                
                telecomProviderSelect.disabled = true; 
                phoneNumberInput.disabled = true; 
                authCodeInput.disabled = true; 

                phoneAuthenticated = true;
                updateNextButtonState();
                
                setTimeout(() => {
                    phoneAuthContent.classList.add('collapsed'); 
                    phoneAuthTitle.classList.remove('rotated'); 
                    phoneCheckmark.style.display = 'inline-block';
                    phoneAuthSection.classList.add('confirmed');
                }, 1000);
            } else {
                alert('인증번호가 일치하지 않습니다. 다시 확인해주세요.');
                authCodeInput.value = '';
            }
        });

        // 1원 송금 요청
        requestTransferBtn.addEventListener('click', () => {
            const bank = bankNameSelect.value;
            const account = accountNumberInput.value;

            if (!bank || !account) { alert('은행과 계좌번호를 모두 입력해주세요.'); return; }
            if (!/^\d+$/.test(account)) { alert('유효한 계좌번호를 입력해주세요 (숫자만 입력).'); return; }

            simulatedDepositCode = Math.floor(100 + Math.random() * 900).toString(); 

            depositCodeGroup.classList.remove('hidden');
            // 확인 버튼 활성화: 흰색 스타일 유지
            verifyDepositCodeBtn.disabled = false;
            verifyDepositCodeBtn.classList.remove('bg-gray-200','bg-gray-400','cursor-not-allowed','bg-blue-600','hover:bg-blue-700');
            verifyDepositCodeBtn.classList.add('btn-white');

            setTimeout(() => {
                depositCodeInput.value = simulatedDepositCode;
                depositCodeTimer.textContent = '';
                depositCodeTimer.style.color = '';
                clearInterval(accountCountdownInterval);
                requestTransferBtn.disabled = true;
                requestTransferBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestTransferBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }, 3000);

            startTimer(depositCodeTimer, requestTransferBtn, requestTransferBtn, 180, () => {
                if (!accountAuthenticated) {
                    verifyDepositCodeBtn.disabled = true;
                    verifyDepositCodeBtn.classList.remove('btn-white');
                    verifyDepositCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            });
        });

        // 입금자명 확인
        verifyDepositCodeBtn.addEventListener('click', () => {
            const enteredCode = depositCodeInput.value;

            if (enteredCode === simulatedDepositCode) {
                clearInterval(accountCountdownInterval); 
                depositCodeTimer.classList.add('hidden');
                accountCertStatus.textContent = '계좌 인증이 완료되었습니다. ✅';
                accountCertStatus.style.color = '#10b981';
                accountCertStatus.classList.remove('hidden');
                
                bankNameSelect.disabled = true;
                accountNumberInput.disabled = true;
                requestTransferBtn.disabled = true;
                requestTransferBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestTransferBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                depositCodeInput.disabled = true;
                verifyDepositCodeBtn.disabled = true;
                verifyDepositCodeBtn.classList.remove('btn-white');
                verifyDepositCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

                accountAuthenticated = true;
                updateNextButtonState();
                
                setTimeout(() => {
                    accountAuthContent.classList.add('collapsed'); 
                    accountAuthTitle.classList.remove('rotated'); 
                    accountCheckmark.style.display = 'inline-block';
                    accountAuthSection.classList.add('confirmed');
                }, 1000);
            } else {
                alert('입금자명이 일치하지 않습니다. 다시 확인해주세요.');
                depositCodeInput.value = '';
            }
        });

        // --- 내비게이션 버튼 ---
        homeButton.addEventListener('click', function(event) {
            event.preventDefault();
            Voice.cancel();
            window.location.href = '/foreign';
        });

        prevButton.addEventListener('click', function() {
            Voice.cancel();
            window.location.href = '/foreign3';
        });

        nextButton.addEventListener('click', async function() {
        	  if (phoneAuthenticated && accountAuthenticated) {
        	    try { await saveAccountToSession(); } catch (e) { console.warn(e); }
        	    Voice.cancel();
        	    window.location.href = '/foreign5';
        	  } else {
        	    alert('모든 본인 확인 절차(휴대폰, 계좌)를 완료해야 다음 단계로 진행할 수 있습니다.');
        	  }
        	});

        // 섹션 제목 클릭 시 아코디언 토글
        phoneAuthTitle.addEventListener('click', () => {
            toggleAccordion(phoneAuthContent, phoneAuthTitle, phoneToggleIcon, phoneAuthSection);
        });
        accountAuthTitle.addEventListener('click', () => {
            toggleAccordion(accountAuthContent, accountAuthTitle, accountToggleIcon, accountAuthSection);
        });

        // DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initializeUI);

        /* ===== 음성 안내 (Web Speech + 네이티브 브릿지) ===== */
        const Voice = (function(){
            let speaking = false;
            let queue = [];
            let current = null;

            const hasWebSpeech = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
            const hasAndroid = !!window.AndroidTTS?.speak;
            const hasIOS = !!(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.tts);

            function useNativeSpeak(text){
                const r = 1.0;
                if(hasAndroid){
                    try{ window.AndroidTTS.speak(String(text), r); return true; }catch(e){ console.warn(e); }
                }
                if(hasIOS){
                    try{ window.webkit.messageHandlers.tts.postMessage({action:'speak', text:String(text), rate:r}); return true; }catch(e){ console.warn(e); }
                }
                return false;
            }
            function useNativeStop(){
                if(hasAndroid){
                    try{ window.AndroidTTS.stop(); return true; }catch(e){ console.warn(e); }
                }
                if(hasIOS){
                    try{ window.webkit.messageHandlers.tts.postMessage({action:'stop'}); return true; }catch(e){ console.warn(e); }
                }
                return false;
            }

            function speakWeb(text, onend){
                const u = new SpeechSynthesisUtterance(String(text));
                u.lang = 'ko-KR';
                u.rate = 1.0;
                u.onend = onend || null;
                u.onerror = function(){ onend && onend(); };
                window.speechSynthesis.speak(u);
            }

            function nextInQueue(){
                if(queue.length === 0){ current = null; speaking = false; setUI(false); return; }
                current = queue.shift();
                if(useNativeSpeak(current)){
                    speaking = true; setUI(true);
                    const approx = Math.max(1500, current.length * 60);
                    setTimeout(()=>{ nextInQueue(); }, approx);
                }else if(hasWebSpeech){
                    speaking = true; setUI(true);
                    speakWeb(current, ()=> nextInQueue());
                }else{
                    speaking = false; setUI(false);
                }
            }

            function setUI(isOn){
                voiceBtn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
                voiceIconPlay.classList.toggle('hidden', isOn);
                voiceIconStop.classList.toggle('hidden', !isOn);
                voiceLabel.textContent = isOn ? '음성 안내 끄기' : '음성 안내 켜기';
                voiceBtn.setAttribute('aria-label', voiceLabel.textContent);
                voiceBtn.setAttribute('title', voiceLabel.textContent);
            }

            function start(scriptLines){
                if(speaking) cancel();
                queue = Array.isArray(scriptLines) ? scriptLines.slice() : [String(scriptLines||'')];
                nextInQueue();
            }

            function cancel(){
                queue = [];
                current = null;
                speaking = false;
                useNativeStop();
                if(('speechSynthesis' in window)){ try{ window.speechSynthesis.cancel(); }catch(e){} }
                setUI(false);
            }

            function toggle(scriptLines){
                if(speaking){ cancel(); }
                else{ start(scriptLines); }
            }

            return { start, cancel, toggle, isSpeaking:()=>speaking };
        })();

        function buildVoiceScript(){
            const s1 = '안내: 지금은 본인확인 단계입니다. 휴대폰 인증과 계좌 인증을 완료해 주세요.';
            const s2 = '휴대폰 인증: 통신사를 선택하고 휴대폰 번호를 입력한 뒤 인증번호 요청을 누르세요. 인증번호를 입력하고 확인을 누르면 완료됩니다.';
            const s3 = '계좌 인증: 은행을 선택하고 계좌번호를 입력한 뒤 1원 송금 요청을 누르세요. 도착한 입금자명 숫자 3자리를 입력하고 확인을 누르면 완료됩니다.';
            const s4 = '두 인증이 모두 끝나면 하단의 다음으로 버튼이 활성화됩니다.';
            return [s1, s2, s3, s4];
        }

        voiceBtn.addEventListener('click', function(){
            voicePanel.classList.toggle('open');
            Voice.toggle(buildVoiceScript());
        });
        voiceCloseBtn.addEventListener('click', function(){ voicePanel.classList.remove('open'); });
        voiceReplayBtn.addEventListener('click', function(){ Voice.start(buildVoiceScript()); });

        document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ Voice.cancel(); } });
        window.addEventListener('pagehide', ()=> Voice.cancel());
        
        async function getAutofill(){
        	  const r = await fetch('/api/autofill', { credentials: 'include' });
        	  if (r.status === 401) return {};
        	  if (!r.ok) throw new Error('autofill api failed');
        	  return r.json(); // { name, phone, residentMasked }
        	}

        	function formatPhone(p){
        	  const d = String(p || '').replace(/\D/g, '');
        	  if (d.length === 11) return d.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3'); // 010-1234-5678
        	  if (d.length === 10) return d.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3'); // 010-123-4567
        	  return p || '';
        	}
        	async function saveAccountToSession(){
        		  const bankEl = document.getElementById('bankName');      // foreign4에 있음
        		  const acctEl = document.getElementById('accountNumber'); // foreign4에 있음
        		  const bank = bankEl?.value?.trim() ?? '';
        		  const acct = (acctEl?.value ?? '').replace(/\D/g, '').trim(); // 숫자만
        		  if (!bank || !acct) return; // 비어있으면 저장 안 함
        		  await fetch('/api/session/account', {
        		    method: 'POST',
        		    headers: {'Content-Type':'application/json'},
        		    credentials: 'include',
        		    body: JSON.stringify({ bankName: bank, accountNumber: acct })
        		  });
        		}

        	async function applyForeign4Phone(){
        	  try{
        	    const d = await getAutofill();
        	    const phoneEl = document.getElementById('phoneNumber');
        	    if (!phoneEl || !d.phone) return;

        	    phoneEl.value = formatPhone(d.phone);
        	    // 입력 마스크/검증 라이브러리 연동이 있으면 이벤트 한 번 발생시켜줌
        	    phoneEl.dispatchEvent(new Event('input', { bubbles: true }));
        	    phoneEl.dispatchEvent(new Event('change', { bubbles: true }));
        	  }catch(e){
        	    console.warn('autofill(phone) 실패', e);
        	  }
        	}

        	document.addEventListener('DOMContentLoaded', applyForeign4Phone);
    </script>
</body>
</html>
