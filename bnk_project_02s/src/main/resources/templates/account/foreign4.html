<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNK 쇼핑환전통장 - 본인확인 (휴대폰 & 계좌)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
        }

        /* Header styles */
        header {
            flex: none; /* Do not grow/shrink */
        }
        
        /* Footer styles */
        .bottom-bar {
            flex: none; /* Do not grow/shrink */
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            z-index: 10;
        }
        .bottom-bar button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .bottom-bar button:active {
            transform: scale(0.98);
        }

        /* Main content area */
        .main-content {
            flex-grow: 1; /* Allow content to fill available space */
            padding: 0.75rem; 
            display: flex;
            flex-direction: column;
            gap: 1rem; 
            overflow-y: auto; 
        }

        .section-block {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Ensure rounded corners */
        }

        .section-title {
            font-size: 1rem; /* Adjusted for consistency */
            font-weight: 600; /* Adjusted for consistency */
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem; /* Padding added to title itself */
            border-bottom: none;
            margin-bottom: 0; 
        }
        .section-title .checkmark {
            color: #10b981; 
            font-size: 1.2rem;
            margin-left: 0.5rem;
            display: none; 
        }
        .section-title .title-text {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            box-sizing: border-box;
            background-color: #f9fafb; 
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .form-group input[readonly] {
            background-color: #e5e7eb; 
            cursor: not-allowed;
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }
        .input-with-button input {
            flex-grow: 1;
        }
        .input-with-button button {
            flex-shrink: 0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }

        .cert-status { 
            font-size: 0.85rem;
            color: #10b981; 
            margin-top: 0.5rem;
            font-weight: 500;
        }

        /* Step Indicator Styles */
        .step-indicator {
            display: flex;
            width: 100%;
            height: 4px; 
            background-color: #e0e0e0; 
            border-radius: 2px;
            overflow: hidden; 
            margin-top: 0.5rem; 
        }

        .step-indicator-progress {
            width: 33.33%; 
            height: 100%;
            background-color: #2563eb; 
            border-radius: 2px;
        }

        /* Added for textContent \n support */
        #encouragementMessage {
            white-space: pre-wrap;
            font-size: 1rem; /* Adjusted for consistency */
        }
        .hidden {
            display: none !important;
        }

        /* Accordion styles */
        .section-content {
            max-height: 1000px; /* Sufficiently large initial height */
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            border-top: none; /* No border by default */
            margin-top: 0; /* No margin by default */
            /* Removed direct padding from here */
        }
        .section-content.collapsed {
            max-height: 0;
            /* Padding from inner div will also collapse */
            border-top: none; 
            margin-top: 0; 
        }
        .section-content:not(.collapsed) {
            border-top: 1px solid #f0f4f8; 
        }

        .section-content-inner { /* New inner div for content padding */
            padding: 1.5rem; /* Apply padding here */
        }

        .section-block.collapsible .section-title {
            cursor: pointer;
        }
        .section-block.collapsible .section-title .toggle-icon {
            transition: transform 0.3s ease;
            display: inline-block;
        }
        .section-block.collapsible .section-title.rotated .toggle-icon {
            transform: rotate(180deg);
        }
        .section-block.collapsible.confirmed .section-title .toggle-icon {
            display: none; 
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        <!-- Header -->
        <header class="flex items-center justify-between p-4 bg-white border-b border-gray-200">
            <a href="/foreign0" class="flex items-center text-blue-700 font-medium text-base hover:text-blue-800 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
                홈으로
            </a>
            <h1 class="text-xl font-bold text-gray-800">본인확인</h1>
            <button class="p-2 rounded-full text-gray-500 hover:bg-gray-100 transition-colors duration-300 opacity-0 cursor-default">
                <!-- Placeholder for symmetry, or add a relevant icon if needed -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354v15.304m0 0l-6.5-6.5m6.5 6.5l6.5-6.5" />
                </svg>
            </button>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator mx-4 mt-4">
            <div class="step-indicator-progress"></div>
        </div>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- 응원 문구 -->
            <div id="encouragementMessage" class="text-center text-base font-semibold text-gray-700 p-3 rounded-lg bg-yellow-100 mx-0 mt-0 shadow-sm" style="white-space: pre-wrap;">
                <!-- 메시지는 JavaScript에 의해 동적으로 설정됩니다. -->
            </div>

            <!-- 휴대폰 인증 섹션 -->
            <div id="phoneAuthSection" class="section-block collapsible">
                <h2 class="section-title">
                    <span class="title-text">
                        휴대폰 인증
                        <span id="phoneCheckmark" class="checkmark">✔</span>
                    </span>
                    <svg id="phoneToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="phoneAuthContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="telecomProvider">통신사</label>
                            <select id="telecomProvider">
                                <option value="">통신사를 선택해주세요</option>
                                <option value="SKT">SKT</option>
                                <option value="KT">KT</option>
                                <option value="LG U+">LG U+</option>
                                <option value="MVNO">알뜰폰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">휴대폰 번호</label>
                            <div class="input-with-button">
                                <input type="text" id="phoneNumber" placeholder="010-XXXX-XXXX" maxlength="13">
                                <button id="requestAuthCodeBtn" class="bg-blue-600 text-white hover:bg-blue-700">인증번호 요청</button>
                            </div>
                        </div>
                        <div class="form-group hidden" id="authCodeGroup">
                            <label for="authCode">인증번호</label>
                            <div class="input-with-button">
                                <input type="text" id="authCode" placeholder="인증번호 6자리" maxlength="6">
                                <button id="verifyAuthCodeBtn" class="bg-gray-200 text-gray-700 hover:bg-gray-300">확인</button>
                            </div>
                            <p id="authCodeTimer" class="text-sm text-gray-500 mt-2 text-center"></p>
                        </div>
                        <p id="phoneCertStatus" class="cert-status hidden text-center"></p>
                    </div>
                </div>
            </div>

            <!-- 계좌 인증 섹션 -->
            <div id="accountAuthSection" class="section-block collapsible">
                <h2 class="section-title">
                    <span class="title-text">
                        계좌 인증
                        <span id="accountCheckmark" class="checkmark">✔</span>
                    </span>
                    <svg id="accountToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="accountAuthContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="bankName">은행</label>
                            <select id="bankName">
                                <option value="">은행을 선택해주세요</option>
                                <option value="국민은행">국민은행</option>
                                <option value="신한은행">신한은행</option>
                                <option value="우리은행">우리은행</option>
                                <option value="하나은행">하나은행</option>
                                <option value="농협은행">농협은행</option>
                                <option value="부산은행">부산은행</option>
                                <option value="BNK경남은행">BNK경남은행</option>
                                <!-- 기타 은행 추가 가능 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="accountNumber">계좌번호</label>
                            <div class="input-with-button">
                                <input type="text" id="accountNumber" placeholder="계좌번호를 입력해주세요">
                                <button id="requestTransferBtn" class="bg-blue-600 text-white hover:bg-blue-700">1원 송금 요청</button>
                            </div>
                        </div>
                        
                        <div class="form-group hidden" id="depositCodeGroup">
                            <label for="depositCode">입금자명</label>
                            <div class="input-with-button">
                                <input type="text" id="depositCode" placeholder="입금자명 3자리 숫자를 입력하세요" maxlength="3">
                                <button id="verifyDepositCodeBtn" class="bg-gray-200 text-gray-700 hover:bg-gray-300">확인</button>
                            </div>
                            <p id="depositCodeTimer" class="text-sm text-gray-500 mt-2 text-center"></p>
                        </div>
                        <p id="accountCertStatus" class="cert-status hidden text-center"></p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Bottom Bar -->
        <footer class="bottom-bar">
            <button id="prevButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300">이전</button>
            <button id="nextButton" class="bg-blue-600 text-white hover:bg-blue-700">다음으로</button>
        </footer>
    </div>

    <script>
        // --- DOM 요소 정의 ---
        const homeButton = document.querySelector('header a');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const encouragementMessageDiv = document.getElementById('encouragementMessage');

        // 휴대폰 인증 섹션
        const phoneAuthSection = document.getElementById('phoneAuthSection');
        const phoneAuthTitle = phoneAuthSection.querySelector('.section-title');
        const phoneCheckmark = document.getElementById('phoneCheckmark');
        const phoneAuthContent = document.getElementById('phoneAuthContent');
        const phoneToggleIcon = document.getElementById('phoneToggleIcon'); // SVG 아이콘
        const telecomProviderSelect = document.getElementById('telecomProvider');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const requestAuthCodeBtn = document.getElementById('requestAuthCodeBtn');
        const authCodeGroup = document.getElementById('authCodeGroup');
        const authCodeInput = document.getElementById('authCode');
        const verifyAuthCodeBtn = document.getElementById('verifyAuthCodeBtn');
        const authCodeTimer = document.getElementById('authCodeTimer');
        const phoneCertStatus = document.getElementById('phoneCertStatus');

        // 계좌 인증 섹션
        const accountAuthSection = document.getElementById('accountAuthSection');
        const accountAuthTitle = accountAuthSection.querySelector('.section-title');
        const accountCheckmark = document.getElementById('accountCheckmark');
        const accountAuthContent = document.getElementById('accountAuthContent');
        const accountToggleIcon = document.getElementById('accountToggleIcon'); // SVG 아이콘
        const bankNameSelect = document.getElementById('bankName');
        const accountNumberInput = document.getElementById('accountNumber');
        const requestTransferBtn = document.getElementById('requestTransferBtn');
        const depositCodeGroup = document.getElementById('depositCodeGroup');
        const depositCodeInput = document.getElementById('depositCode');
        const verifyDepositCodeBtn = document.getElementById('verifyDepositCodeBtn');
        const depositCodeTimer = document.getElementById('depositCodeTimer');
        const accountCertStatus = document.getElementById('accountCertStatus');


        // --- 상태 변수 ---
        let phoneAuthenticated = false;
        let accountAuthenticated = false;

        let phoneCountdownInterval;
        let accountCountdownInterval;

        let simulatedAuthCode = '123456'; // 시뮬레이션용 휴대폰 인증번호
        let simulatedDepositCode = ''; // 시뮬레이션용 계좌 입금자명 (3자리 숫자)

        // localStorage에서 추출된 정보는 이 페이지에서 직접 사용되지 않지만, 다음 페이지를 위해 유지될 수 있음
        const extractedUserInfo = JSON.parse(localStorage.getItem('extractedUserInfo')) || {
            name: '정보 없음',
            dob: '정보 없음',
            gender: '정보 없음'
        };


        // --- 초기 UI 설정 함수 ---
        function initializeUI() {
            // 초기에는 두 섹션 모두 열려있게 설정
            phoneAuthContent.classList.remove('collapsed');
            phoneAuthTitle.classList.add('rotated'); // 캐럿 표시
            accountAuthContent.classList.remove('collapsed');
            accountAuthTitle.classList.add('rotated'); // 캐럿 표시
            
            // 모든 인증이 완료되지 않았다면 초기 메시지 설정
            updateNextButtonState(); 
        }

        // --- '다음' 버튼 활성화/비활성화 및 응원 메시지 업데이트 함수 ---
        function updateNextButtonState() {
            if (phoneAuthenticated && accountAuthenticated) {
                nextButton.disabled = false;
                nextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                // 변경된 메시지
                encouragementMessageDiv.textContent = '모든 본인 확인 절차가 완료되었습니다! 🎉\n다음 단계로 이동해 주세요 😄';
                // 배경색은 노란색으로 유지
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                // 모든 인증이 완료되지 않았다면, 항상 이 초기 메시지를 표시
                encouragementMessageDiv.textContent = '본인 확인의 마지막 단계입니다.\n조금만 더 힘내주세요! 💪';
                // 배경색은 노란색으로 유지
            }
        }

        // --- 인증번호/입금자명 타이머 공통 함수 ---
        function startTimer(timerElement, buttonToDisable, buttonToEnable, duration, onExpireCallback) {
            let timer = duration;
            // 모든 타이머 clearInterval 호출하여 혼동 방지 (동시에 여러 타이머가 돌지 않도록)
            clearInterval(phoneCountdownInterval); 
            clearInterval(accountCountdownInterval);

            let currentInterval;
            if (timerElement === authCodeTimer) {
                currentInterval = setInterval(updateTimer, 1000);
                phoneCountdownInterval = currentInterval; // 올바른 변수에 할당
            } else if (timerElement === depositCodeTimer) {
                currentInterval = setInterval(updateTimer, 1000);
                accountCountdownInterval = currentInterval; // 올바른 변수에 할당
            }
            
            timerElement.classList.remove('hidden');
            buttonToDisable.disabled = true;
            buttonToDisable.classList.add('bg-gray-400', 'cursor-not-allowed');
            buttonToDisable.classList.remove('bg-blue-600', 'hover:bg-blue-700');

            function updateTimer() {
                const minutes = parseInt(timer / 60, 10);
                const seconds = parseInt(timer % 60, 10);

                timerElement.textContent = `남은 시간: ${minutes < 10 ? "0" + minutes : minutes}:${seconds < 10 ? "0" + seconds : seconds}`;

                if (--timer < 0) {
                    clearInterval(currentInterval); // 해당 타이머만 중지
                    timerElement.textContent = '인증 시간이 만료되었습니다. 다시 요청해주세요.';
                    timerElement.style.color = '#ef4444'; // Red color
                    buttonToEnable.disabled = false;
                    buttonToEnable.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    buttonToEnable.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    if (onExpireCallback) {
                        onExpireCallback();
                    }
                }
            }
        }

        // --- 휴대폰 번호 자동 포맷팅 함수 ---
        phoneNumberInput.addEventListener('input', (event) => {
            let value = event.target.value.replace(/[^0-9]/g, ''); // 숫자 이외의 문자 제거
            let formattedValue = '';

            if (value.startsWith('010')) {
                if (value.length > 10) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7, 11);
                } else if (value.length > 6) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3, 7) + '-' + value.substring(7);
                } else if (value.length > 3) {
                    formattedValue = value.substring(0, 3) + '-' + value.substring(3);
                } else {
                    formattedValue = value;
                }
            } else {
                formattedValue = value;
            }

            event.target.value = formattedValue.substring(0, 13);
        });

        // --- 아코디언 토글 함수 ---
        function toggleAccordion(contentElement, titleElement, toggleIconElement, sectionBlockElement) {
            // 이미 인증 완료된 섹션은 클릭해도 토글되지 않음
            if (sectionBlockElement.classList.contains('confirmed')) {
                return;
            }
            contentElement.classList.toggle('collapsed');
            titleElement.classList.toggle('rotated');
            if (contentElement.classList.contains('collapsed')) {
                toggleIconElement.classList.remove('rotated'); // 아이콘이 아래를 보도록
            } else {
                toggleIconElement.classList.add('rotated'); // 아이콘이 위를 보도록
            }
        }

        // --- 이벤트 핸들러 ---

        // 휴대폰 인증번호 요청 버튼
        requestAuthCodeBtn.addEventListener('click', () => {
            const telecom = telecomProviderSelect.value;
            const phoneNum = phoneNumberInput.value;

            if (!telecom || !phoneNum) {
                alert('통신사와 휴대폰 번호를 모두 입력해주세요.');
                return;
            }

            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(phoneNum)) {
                alert('유효한 휴대폰 번호 형식을 입력해주세요 (예: 010-XXXX-XXXX)');
                return;
            }

            // 새로운 인증번호 생성
            simulatedAuthCode = Math.floor(100000 + Math.random() * 900000).toString(); 

            authCodeGroup.classList.remove('hidden');
            verifyAuthCodeBtn.disabled = false;
            verifyAuthCodeBtn.classList.remove('bg-gray-200', 'cursor-not-allowed');
            verifyAuthCodeBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            // 3초 후 인증번호 자동 입력 (메시지 없음)
            setTimeout(() => {
                authCodeInput.value = simulatedAuthCode;
                authCodeTimer.textContent = ''; // 메시지 제거
                authCodeTimer.style.color = ''; // 스타일 초기화
                clearInterval(phoneCountdownInterval); // 타이머 중지
                requestAuthCodeBtn.disabled = true; // 요청 버튼 비활성화
                requestAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestAuthCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }, 3000); // 3초 (3000 밀리초) 지연

            startTimer(authCodeTimer, requestAuthCodeBtn, requestAuthCodeBtn, 180, () => {
                // 이 콜백은 타이머가 0이 될 때 실행되지만, 자동 입력되면 이미 중지됨
                // 만약 자동 입력 전에 타이머가 만료되면 이 메시지가 표시됨
                if (!phoneAuthenticated) { // 이미 인증되지 않은 경우에만 타이머 만료 처리
                    verifyAuthCodeBtn.disabled = true; 
                    verifyAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    verifyAuthCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                }
            }); 
        });

        // 휴대폰 인증번호 확인 버튼
        verifyAuthCodeBtn.addEventListener('click', () => {
            const enteredCode = authCodeInput.value;

            if (enteredCode === simulatedAuthCode) {
                clearInterval(phoneCountdownInterval); 
                authCodeTimer.classList.add('hidden');
                phoneCertStatus.textContent = '휴대폰 인증이 완료되었습니다. ✅';
                phoneCertStatus.style.color = '#10b981';
                phoneCertStatus.classList.remove('hidden');
                
                // UI 잠금
                verifyAuthCodeBtn.disabled = true;
                verifyAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                verifyAuthCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

                requestAuthCodeBtn.disabled = true; 
                requestAuthCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestAuthCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                
                telecomProviderSelect.disabled = true; 
                phoneNumberInput.disabled = true; 
                authCodeInput.disabled = true; 

                phoneAuthenticated = true;
                updateNextButtonState();
                
                // 인증 완료 메시지 표시 후 1초 뒤 아코디언 닫기
                setTimeout(() => {
                    phoneAuthContent.classList.add('collapsed'); 
                    phoneAuthTitle.classList.remove('rotated'); // 캐럿 숨기기
                    phoneCheckmark.style.display = 'inline-block'; // 체크 표시 보이기
                    phoneAuthSection.classList.add('confirmed'); // 인증 완료 상태 클래스 추가
                }, 1000); // 1초 (1000 밀리초) 지연
            } else {
                alert('인증번호가 일치하지 않습니다. 다시 확인해주세요.');
                authCodeInput.value = '';
            }
        });

        // 1원 송금 요청 버튼
        requestTransferBtn.addEventListener('click', () => {
            const bank = bankNameSelect.value;
            const account = accountNumberInput.value;

            if (!bank || !account) {
                alert('은행과 계좌번호를 모두 입력해주세요.');
                return;
            }

            if (!/^\d+$/.test(account)) {
                alert('유효한 계좌번호를 입력해주세요 (숫자만 입력).');
                return;
            }

            // 새로운 입금자명 생성
            simulatedDepositCode = Math.floor(100 + Math.random() * 900).toString(); 

            depositCodeGroup.classList.remove('hidden');
            verifyDepositCodeBtn.disabled = false;
            verifyDepositCodeBtn.classList.remove('bg-gray-200', 'cursor-not-allowed');
            verifyDepositCodeBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            // 3초 후 입금자명 자동 입력 (메시지 없음)
            setTimeout(() => {
                depositCodeInput.value = simulatedDepositCode;
                depositCodeTimer.textContent = ''; // 메시지 제거
                depositCodeTimer.style.color = ''; // 스타일 초기화
                clearInterval(accountCountdownInterval); // 타이머 중지
                requestTransferBtn.disabled = true; // 요청 버튼 비활성화
                requestTransferBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestTransferBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }, 3000); // 3초 (3000 밀리초) 지연

            startTimer(depositCodeTimer, requestTransferBtn, requestTransferBtn, 180, () => {
                // 이 콜백은 타이머가 0이 될 때 실행되지만, 자동 입력되면 이미 중지됨
                if (!accountAuthenticated) { // 이미 인증되지 않은 경우에만 타이머 만료 처리
                    verifyDepositCodeBtn.disabled = true;
                    verifyDepositCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    verifyDepositCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                }
            });
        });

        // 입금자명 확인 버튼
        verifyDepositCodeBtn.addEventListener('click', () => {
            const enteredCode = depositCodeInput.value;

            if (enteredCode === simulatedDepositCode) {
                clearInterval(accountCountdownInterval); 
                depositCodeTimer.classList.add('hidden');
                accountCertStatus.textContent = '계좌 인증이 완료되었습니다. ✅';
                accountCertStatus.style.color = '#10b981';
                accountCertStatus.classList.remove('hidden');
                
                // UI 잠금
                bankNameSelect.disabled = true;
                accountNumberInput.disabled = true;
                requestTransferBtn.disabled = true;
                requestTransferBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                requestTransferBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                depositCodeInput.disabled = true;
                verifyDepositCodeBtn.disabled = true;
                verifyDepositCodeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                verifyDepositCodeBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

                accountAuthenticated = true;
                updateNextButtonState();
                
                // 인증 완료 메시지 표시 후 1초 뒤 아코디언 닫기
                setTimeout(() => {
                    accountAuthContent.classList.add('collapsed'); 
                    accountAuthTitle.classList.remove('rotated'); // 캐럿 숨기기
                    accountCheckmark.style.display = 'inline-block'; // 체크 표시 보이기
                    accountAuthSection.classList.add('confirmed'); // 인증 완료 상태 클래스 추가
                }, 1000); // 1초 (1000 밀리초) 지연
            } else {
                alert('입금자명이 일치하지 않습니다. 다시 확인해주세요.');
                depositCodeInput.value = '';
            }
        });

        // --- 내비게이션 버튼 이벤트 리스너 ---
        homeButton.addEventListener('click', function(event) {
            event.preventDefault();
            window.location.href = '/foreign0';
        });

        prevButton.addEventListener('click', function() {
            window.location.href = '/foreign3'; // 이전 페이지로 이동 (신분증 촬영 페이지)
        });

        nextButton.addEventListener('click', function() {
            if (phoneAuthenticated && accountAuthenticated) {
                window.location.href = '/foreign5'; // 다음 단계 페이지로 이동 (새로운 foreign5 페이지)
            } else {
                alert('모든 본인 확인 절차(휴대폰, 계좌)를 완료해야 다음 단계로 진행할 수 있습니다.');
            }
        });

        // 섹션 제목 클릭 시 아코디언 토글 (인증 완료 상태가 아닐 때만)
        phoneAuthTitle.addEventListener('click', () => {
            toggleAccordion(phoneAuthContent, phoneAuthTitle, phoneToggleIcon, phoneAuthSection);
        });
        accountAuthTitle.addEventListener('click', () => {
            toggleAccordion(accountAuthContent, accountAuthTitle, accountToggleIcon, accountAuthSection);
        });


        // DOMContentLoaded 이벤트 발생 시 UI 초기화
        document.addEventListener('DOMContentLoaded', initializeUI);
    </script>
</body>
</html>
