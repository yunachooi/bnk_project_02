<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNK ÏáºÌïëÌôòÏ†ÑÌÜµÏû• - Ïã†Î∂ÑÏ¶ù Ï†úÏ∂ú</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
        }

        /* Header styles */
        header {
            flex: none; /* Do not grow/shrink */
        }
        
        /* Footer styles */
        .bottom-bar {
            flex: none; /* Do not grow/shrink */
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            z-index: 10;
        }
        .bottom-bar button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .bottom-bar button:active {
            transform: scale(0.98);
        }

        /* Main content area */
        .main-content {
            flex-grow: 1; /* Allow content to fill available space */
            padding: 0.75rem 1.5rem 1.5rem; /* Adjusted padding */
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Increased gap */
            overflow-y: auto; 
        }

        .section-block {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Ensure rounded corners */
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: none;
            margin-bottom: 0; 
        }
        .section-title .checkmark {
            color: #10b981; 
            font-size: 1.2rem;
            margin-left: 0.5rem;
            display: none; 
        }
        .section-title .title-text {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea { /* Added textarea */
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            box-sizing: border-box;
            background-color: #f9fafb; 
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus { /* Added textarea */
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .form-group input[disabled],
        .form-group textarea[disabled] { /* Added textarea */
            background-color: #e5e7eb; 
            cursor: not-allowed;
        }

        /* Step Indicator Styles */
        .step-indicator {
            display: flex;
            width: 100%;
            height: 4px; 
            background-color: #e0e0e0; 
            border-radius: 2px;
            overflow: hidden; 
            margin-top: 0.5rem; 
        }

        .step-indicator-progress {
            width: 33.33%; /* 1/3 progress */
            height: 100%;
            background-color: #2563eb; 
            border-radius: 2px;
        }

        /* ID Card Frame and Capture Button Styles */
        .id-card-frame {
            border: 2px solid #a0aec0; /* Darker border for definition */
            border-radius: 0.75rem;
            background-color: #f0f4f8; /* Light background for the card */
            aspect-ratio: 1.585 / 1; /* Standard ID card aspect ratio (e.g., Credit Card 85.6mm x 53.98mm) */
            max-width: 90%; /* Max width relative to parent */
            width: 320px; /* Fixed width for better control on larger screens, will shrink on small */
            height: auto; /* Maintain aspect ratio */
            margin: 0 auto; /* Center the frame */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Ensure image fits within rounded corners */
            position: relative; /* For overlay positioning */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* More subtle shadow */
            cursor: pointer; /* Indicate clickability */
            transition: all 0.3s ease;
        }

        .id-card-frame:hover {
            border-color: #2563eb;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .capture-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 1rem;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Slightly transparent overlay */
            z-index: 10; /* Ensure it's on top */
            border-radius: 0.75rem; /* Match frame */
        }

        .photo-placeholder-icon {
            font-size: 3rem; /* Larger icon */
            color: #9ca3af; /* Gray color */
            margin-bottom: 0.5rem;
        }
        .photo-placeholder-text {
            color: #4b5563;
            font-size: 1.1rem; /* Slightly larger text */
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            justify-content: center; /* Center the buttons */
            gap: 0.75rem; /* Space between buttons */
            margin-top: 2rem; /* Spacing from ID card frame */
        }

        .action-button { /* General style for action buttons */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .capture-btn { /* Specific style for initial capture button */
            background-color: #2563eb;
            color: white;
        }
        .capture-btn:hover {
            background-color: #1d4ed8;
        }
        .capture-btn:active {
            transform: scale(0.98);
        }

        .confirm-btn {
            background-color: #10b981; /* Green for confirm */
            color: white;
        }
        .confirm-btn:hover {
            background-color: #0d926b;
        }

        .retake-btn {
            background-color: #ef4444; /* Red for retake */
            color: white;
        }
        .retake-btn:hover {
            background-color: #cc2929;
        }

        /* Styles for live camera feed and captured image */
        #cameraFeed, #previewImage {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures the video/image covers the area without distortion */
            border-radius: 0.75rem; /* Match frame radius */
            position: absolute; /* Position within the frame */
            top: 0;
            left: 0;
            z-index: 1; /* Below overlay, above background */
        }
        
        .hidden {
            display: none !important;
        }

        /* Accordion styles */
        .section-content {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            border-top: none; 
            margin-top: 0; 
        }
        .section-content.collapsed {
            max-height: 0;
            /* No padding here */
            border-top: none; 
            margin-top: 0; 
        }
        .section-content:not(.collapsed) {
            border-top: 1px solid #f0f4f8; 
        }

        .section-content-inner { /* Inner div for content padding */
            padding: 1.5rem; 
        }

        .section-block.collapsible .section-title {
            cursor: pointer;
        }
        .section-block.collapsible .section-title .toggle-icon {
            transition: transform 0.3s ease;
            display: inline-block;
        }
        .section-block.collapsible .section-title.rotated .toggle-icon {
            transform: rotate(180deg);
        }
        .section-block.collapsible.confirmed .section-title .toggle-icon {
            display: none; 
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        <!-- Header -->
        <header class="flex items-center justify-between p-4 bg-white border-b border-gray-200">
            <a href="/foreign" class="flex items-center text-blue-700 font-medium text-base hover:text-blue-800 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
                ÌôàÏúºÎ°ú
            </a>
            <h1 class="text-xl font-bold text-gray-800">Ïã†Î∂ÑÏ¶ù Ï†úÏ∂ú</h1>
            <button class="p-2 rounded-full text-gray-500 hover:bg-gray-100 transition-colors duration-300 opacity-0 cursor-default">
                <!-- Placeholder for symmetry -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354v15.304m0 0l-6.5-6.5m6.5 6.5l6.5-6.5" />
                </svg>
            </button>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator mx-4 mt-4">
            <div class="step-indicator-progress"></div>
        </div>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Ïã†Î∂ÑÏ¶ù Ï¥¨ÏòÅ ÏÑπÏÖò -->
            <div id="idCardSection" class="section-block collapsible">
                <h2 id="idCardTitle" class="section-title">
                    <span class="title-text">
                        Ï£ºÎØºÎì±Î°ùÏ¶ù Ï¥¨ÏòÅ
                        <span id="idCardCheckmark" class="checkmark">‚úî</span>
                    </span>
                    <svg id="idCardToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="idCardContent" class="section-content">
                    <div class="section-content-inner">
                        <p class="text-gray-600 text-sm mb-4 text-center">
                            ÎÑ§Î™® Ïπ∏Ïóê ÎßûÏ∂∞ Ï£ºÎØºÎì±Î°ùÏ¶ùÏùÑ Ï¥¨ÏòÅÌï¥Ï£ºÏÑ∏Ïöî!
                        </p>
                        <div id="idCardFrame" class="id-card-frame">
                            <video id="cameraFeed" autoplay playsinline style="display: none;"></video>
                            <img id="previewImage" src="#" alt="Ïã†Î∂ÑÏ¶ù Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞" style="display: none;">
                            <div id="captureOverlay" class="capture-overlay">
                                <span class="photo-placeholder-icon">üì∏</span>
                                <span class="photo-placeholder-text">Ïã†Î∂ÑÏ¶ùÏùÑ Ï¥¨ÏòÅÌï¥Ï£ºÏÑ∏Ïöî</span>
                            </div>
                            <!-- Hidden canvas for capturing frames -->
                            <canvas id="hiddenCanvas" style="display: none;"></canvas>
                        </div>
                        <div id="actionButtons" class="action-buttons">
                            <button id="captureButton" class="action-button capture-btn">Ï¥¨ÏòÅ</button>
                            <button id="confirmButton" class="action-button confirm-btn hidden">ÌôïÏù∏</button>
                            <button id="retakeButton" class="action-button retake-btn hidden">Ïû¨Ï¥¨ÏòÅ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ï∂îÏ∂úÎêú Ï†ïÎ≥¥ ÏÑπÏÖò (Ïà®Í≤®Ï†∏ ÏûàÎã§Í∞Ä Ï¥¨ÏòÅ ÏôÑÎ£å Ïãú ÎÇòÌÉÄÎÇ®) -->
            <div id="extractedInfoSection" class="section-block collapsible hidden">
                <h2 id="extractedInfoTitle" class="section-title">
                    <span class="title-text">
                        Ïã†Î∂ÑÏ¶ù Ï†ïÎ≥¥
                        <span id="extractedInfoCheckmark" class="checkmark">‚úî</span>
                    </span>
                    <svg id="extractedInfoToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="extractedInfoContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="extractedName">ÏÑ±Î™Ö</label>
                            <input type="text" id="extractedName" placeholder="ÌôçÍ∏∏Îèô">
                        </div>
                        <div class="form-group">
                            <label for="extractedResidentId">Ï£ºÎØºÎì±Î°ùÎ≤àÌò∏</label>
                            <input type="text" id="extractedResidentId" placeholder="Ïòà: 900101-1234567">
                        </div>
                        <div class="flex justify-center mt-6">
                            <button id="confirmInfoButton" class="action-button capture-btn">Ï†ïÎ≥¥ ÌôïÏù∏</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Bottom Bar -->
        <footer class="bottom-bar">
            <button id="prevButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300">Ïù¥Ï†Ñ</button>
            <button id="nextButton" class="bg-gray-400 text-white cursor-not-allowed" disabled>Îã§ÏùåÏúºÎ°ú</button>
        </footer>
    </div>

    <script>
        // --- DOM ÏöîÏÜå Ï†ïÏùò ---
        const homeButton = document.querySelector('header a');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');

        // Ïã†Î∂ÑÏ¶ù Ï¥¨ÏòÅ ÏÑπÏÖò Í¥ÄÎ†® ÏöîÏÜå
        const idCardSection = document.getElementById('idCardSection');
        const idCardTitle = document.getElementById('idCardTitle');
        const idCardCheckmark = document.getElementById('idCardCheckmark');
        const idCardToggleIcon = document.getElementById('idCardToggleIcon');
        const idCardContent = document.getElementById('idCardContent');

        const idCardFrame = document.getElementById('idCardFrame');
        const cameraFeed = document.getElementById('cameraFeed'); // Changed from idCardInput
        const previewImage = document.getElementById('previewImage');
        const captureOverlay = document.getElementById('captureOverlay');
        const hiddenCanvas = document.getElementById('hiddenCanvas'); // New canvas element
        
        const actionButtonsDiv = document.getElementById('actionButtons');
        const captureButton = document.getElementById('captureButton'); 
        const confirmButton = document.getElementById('confirmButton'); 
        const retakeButton = document.getElementById('retakeButton');   
        
        // Ï∂îÏ∂úÎêú Ï†ïÎ≥¥ ÏÑπÏÖò Í¥ÄÎ†® ÏöîÏÜå
        const extractedInfoSection = document.getElementById('extractedInfoSection');
        const extractedInfoTitle = document.getElementById('extractedInfoTitle');
        const extractedInfoCheckmark = document.getElementById('extractedInfoCheckmark');
        const extractedInfoToggleIcon = document.getElementById('extractedInfoToggleIcon');
        const extractedInfoContent = document.getElementById('extractedInfoContent');

        const extractedNameInput = document.getElementById('extractedName');
        const extractedResidentIdInput = document.getElementById('extractedResidentId'); 
        const confirmInfoButton = document.getElementById('confirmInfoButton'); 

        // --- ÏÉÅÌÉú Î≥ÄÏàò ---
        let idCardPhotoConfirmed = false; // Ïã†Î∂ÑÏ¶ù ÏÇ¨ÏßÑ Ï¥¨ÏòÅ Î∞è ÌôïÏù∏ ÏôÑÎ£å Ïó¨Î∂Ä
        let extractedInfoConfirmed = false; // Ï∂îÏ∂úÎêú Ï†ïÎ≥¥ ÌôïÏù∏ ÏôÑÎ£å Ïó¨Î∂Ä
        let cameraStream = null; // To hold the MediaStream object

        // --- Ïπ¥Î©îÎùº ÏãúÏûë Ìï®Ïàò ---
        async function startCamera() {
            try {
                // Request camera access, preferring the rear camera on mobile
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment' 
                    }
                });
                cameraFeed.srcObject = stream;
                cameraFeed.play(); // Start playing the video stream
                
                cameraFeed.style.display = 'block'; // Show the video feed
                captureOverlay.classList.add('hidden'); // Hide the initial overlay
                cameraStream = stream; // Store the stream for later stopping
            } catch (err) {
                console.error("Error accessing camera: ", err);
                // If camera access fails, keep the overlay as a fallback visual.
                // You might want to display a user-friendly message here.
                cameraFeed.style.display = 'none';
                captureOverlay.classList.remove('hidden');
            }
        }

        // --- Ïä§ÎÉÖÏÉ∑ Ï¥¨ÏòÅ Ìï®Ïàò ---
        function takeSnapshot() {
            if (!cameraStream || cameraFeed.style.display === 'none') {
                alert('Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶ºÏù¥ ÌôúÏÑ±ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÍ±∞ÎÇò Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // Set canvas dimensions to match video dimensions
            hiddenCanvas.width = cameraFeed.videoWidth;
            hiddenCanvas.height = cameraFeed.videoHeight;

            const context = hiddenCanvas.getContext('2d');
            // Draw the current video frame onto the canvas
            context.drawImage(cameraFeed, 0, 0, hiddenCanvas.width, hiddenCanvas.height);

            // Stop the camera stream after taking a snapshot
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraFeed.srcObject = null;
                cameraStream = null;
            }

            // Display the captured image
            previewImage.src = hiddenCanvas.toDataURL('image/png');
            previewImage.style.display = 'block'; // Show the captured image
            cameraFeed.style.display = 'none'; // Hide the live camera feed

            idCardPhotoConfirmed = false; // Photo is taken, but not yet 'confirmed' by the user
            updateNextButtonState(); // Update next button state

            simulateOcrExtraction(); // Simulate OCR
            
            // Button states
            captureButton.classList.add('hidden');
            confirmButton.classList.remove('hidden');
            retakeButton.classList.remove('hidden');
            confirmButton.disabled = false;
            confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            confirmButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        // --- Ï¥àÍ∏∞ UI ÏÑ§Ï†ï Ìï®Ïàò ---
        function initializeUI() {
            // Ï¥àÍ∏∞ÏóêÎäî ID Ïπ¥Îìú ÏÑπÏÖòÏù¥ Ïó¥Î†§ÏûàÍ≤å ÏÑ§Ï†ï
            idCardContent.classList.remove('collapsed');
            idCardTitle.classList.add('rotated'); // Ï∫êÎüø ÌëúÏãú

            // Ïã†Î∂ÑÏ¶ù Ï†ïÎ≥¥ ÏÑπÏÖòÏùÄ Ï≤òÏùåÏóêÎäî ÏôÑÏ†ÑÌûà Ïà®ÍπÄ
            extractedInfoSection.classList.add('hidden');
            extractedInfoContent.classList.add('collapsed'); 
            extractedInfoCheckmark.style.display = 'none';

            // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º ÏãúÏûë
            startCamera(); 

            // Ï¥àÍ∏∞ Î≤ÑÌäº ÏÉÅÌÉú ÏÑ§Ï†ï
            captureButton.classList.remove('hidden');
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');

            updateNextButtonState(); 
        }

        // --- ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä Ìï®Ïàò ---
        function toggleAccordion(contentElement, titleElement, toggleIconElement, sectionBlockElement) {
            // Ïù¥ÎØ∏ Ïù∏Ï¶ù ÏôÑÎ£åÎêú ÏÑπÏÖòÏùÄ ÌÅ¥Î¶≠Ìï¥ÎèÑ ÌÜ†Í∏ÄÎêòÏßÄ ÏïäÏùå
            if (sectionBlockElement.classList.contains('confirmed')) {
                return;
            }
            contentElement.classList.toggle('collapsed');
            titleElement.classList.toggle('rotated');
            if (contentElement.classList.contains('collapsed')) {
                toggleIconElement.classList.remove('rotated'); 
            } else {
                toggleIconElement.classList.add('rotated'); 
            }
        }

        // --- Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ---
        
        // ID Ïπ¥Îìú ÌîÑÎ†àÏûÑ ÌÅ¥Î¶≠ Ïãú Ïä§ÎÉÖÏÉ∑ Ï¥¨ÏòÅ Ìä∏Î¶¨Í±∞ (Ïπ¥Î©îÎùº ÌîºÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêú ÏÉÅÌÉúÏùº ÎïåÎßå)
        idCardFrame.addEventListener('click', () => {
            if (cameraFeed.style.display === 'block') { // Live camera feed is visible
                takeSnapshot();
            }
        });
        
        // Ï¥¨ÏòÅ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ïä§ÎÉÖÏÉ∑ Ï¥¨ÏòÅ Ìä∏Î¶¨Í±∞
        captureButton.addEventListener('click', (event) => {
            event.stopPropagation(); 
            takeSnapshot();
        });
        
        // Ïû¨Ï¥¨ÏòÅ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
        retakeButton.addEventListener('click', () => {
            // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            idCardPhotoConfirmed = false;
            extractedInfoConfirmed = false;
            updateNextButtonState();

            // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Ï¥àÍ∏∞Ìôî
            previewImage.src = "#";
            previewImage.style.display = 'none';
            // captureOverlay.classList.remove('hidden'); // Overlay is handled by startCamera()
            
            // Ï∂îÏ∂úÎêú Ï†ïÎ≥¥ ÏÑπÏÖò Ïà®Í∏∞Í∏∞ Î∞è Ï¥àÍ∏∞Ìôî
            extractedInfoSection.classList.add('hidden'); 
            extractedInfoContent.classList.add('collapsed'); 
            extractedInfoTitle.classList.remove('rotated'); 
            extractedInfoCheckmark.style.display = 'none'; 
            extractedNameInput.value = '';
            extractedResidentIdInput.value = '';

            // Î≤ÑÌäº ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî: 'Ï¥¨ÏòÅ' Î≥¥Ïù¥Í∏∞, 'ÌôïÏù∏'/'Ïû¨Ï¥¨ÏòÅ' Ïà®Í∏∞Í∏∞
            captureButton.classList.remove('hidden');
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');

            // ÏûÖÎ†• ÌôúÏÑ±Ìôî
            extractedNameInput.disabled = false;
            extractedResidentIdInput.disabled = false;
            confirmInfoButton.disabled = false; 

            // ÏïÑÏΩîÎîîÏñ∏ Îã§Ïãú Ïó¥Í∏∞
            idCardContent.classList.remove('collapsed');
            idCardTitle.classList.add('rotated');
            idCardCheckmark.style.display = 'none'; 
            idCardSection.classList.remove('confirmed'); 

            // Ïπ¥Î©îÎùº Ïû¨ÏãúÏûë
            startCamera();
        });

        // Ï¥¨ÏòÅ ÌôïÏù∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú (Ïã†Î∂ÑÏ¶ù ÏÇ¨ÏßÑ ÌôïÏù∏)
        confirmButton.addEventListener('click', () => {
            idCardPhotoConfirmed = true; 
            updateNextButtonState(); 

            // Ï£ºÎØºÎì±Î°ùÏ¶ù Ï¥¨ÏòÅ ÏòÜÏóê Ï≤¥ÌÅ¨ ÌëúÏãú
            idCardCheckmark.style.display = 'inline-block'; 
            idCardSection.classList.add('confirmed'); 
            
            // Ï¥¨ÏòÅ Í¥ÄÎ†® Î≤ÑÌäº Ïà®Í∏∞Í∏∞
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');

            // 1Ï¥à Îí§ Ï£ºÎØºÎì±Î°ùÏ¶ù Ï¥¨ÏòÅ ÏïÑÏΩîÎîîÏñ∏ Îã´Í∏∞
            setTimeout(() => {
                idCardContent.classList.add('collapsed'); 
                idCardTitle.classList.remove('rotated'); 

                // Ïã†Î∂ÑÏ¶ù Ï†ïÎ≥¥ ÏïÑÏΩîÎîîÏñ∏ ÎÇòÏò§Í≤å ÌïòÍ≥† Ïó¥Í∏∞
                extractedInfoSection.classList.remove('hidden'); 
                extractedInfoContent.classList.remove('collapsed');
                extractedInfoTitle.classList.add('rotated');
                extractedInfoSection.classList.remove('confirmed'); 
                extractedInfoCheckmark.style.display = 'none'; 

                // 'Ï†ïÎ≥¥ ÌôïÏù∏' Î≤ÑÌäº Î≥¥Ïù¥Í≤å
                confirmInfoButton.classList.remove('hidden');
                confirmInfoButton.disabled = false;
                confirmInfoButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmInfoButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                
            }, 1000); 
        });

        // Ï†ïÎ≥¥ ÌôïÏù∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú (Ï∂îÏ∂úÎêú Ïã†Î∂ÑÏ¶ù Ï†ïÎ≥¥ ÌôïÏù∏)
        confirmInfoButton.addEventListener('click', () => {
            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ (Ïã§Ï†ú ÌôòÍ≤ΩÏóêÏÑúÎäî Îçî Ï†ïÍµêÌïòÍ≤å)
            if (!extractedNameInput.value.trim() || !extractedResidentIdInput.value.trim()) {
                alert('ÏÑ±Î™ÖÍ≥º Ï£ºÎØºÎì±Î°ùÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            extractedInfoConfirmed = true; 
            updateNextButtonState(); 

            // Ïã†Î∂ÑÏ¶ù Ï†ïÎ≥¥ ÏòÜÏóê Ï≤¥ÌÅ¨ ÌëúÏãú
            extractedInfoCheckmark.style.display = 'inline-block';
            extractedInfoSection.classList.add('confirmed'); 

            // Ï†ïÎ≥¥ ÏûÖÎ†• ÌïÑÎìú ÎπÑÌôúÏÑ±Ìôî
            extractedNameInput.disabled = true;
            extractedResidentIdInput.disabled = true;
            confirmInfoButton.disabled = true;
            confirmInfoButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            confirmInfoButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');

            // 1Ï¥à Îí§ ÏïÑÏΩîÎîîÏñ∏ Îã´Í∏∞
            setTimeout(() => {
                extractedInfoContent.classList.add('collapsed');
                extractedInfoTitle.classList.remove('rotated'); 
            }, 1000);
        });


        // OCR Ï∂îÏ∂ú ÏãúÎÆ¨Î†àÏù¥ÏÖò Ìï®Ïàò
        function simulateOcrExtraction() {
            // ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞
            const dummyName = "ÌôçÍ∏∏Îèô"; 
            const dummyResidentId = "900101-1234567"; 

            extractedNameInput.value = dummyName;
            extractedResidentIdInput.value = dummyResidentId;
            
            // Îã§Ïùå ÌéòÏù¥ÏßÄÏóêÏÑú ÏÇ¨Ïö©Ìï† Ï†ïÎ≥¥Î•º localStorageÏóê Ï†ÄÏû•
            const userInfo = {
                name: dummyName,
                residentId: dummyResidentId
            };
            localStorage.setItem('extractedUserInfo', JSON.stringify(userInfo));
        }

        // --- 'Îã§Ïùå' Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî Ìï®Ïàò ---
        function updateNextButtonState() {
            // Ïã†Î∂ÑÏ¶ù ÏÇ¨ÏßÑ ÌôïÏù∏Í≥º Ï∂îÏ∂úÎêú Ï†ïÎ≥¥ ÌôïÏù∏Ïù¥ Î™®Îëê ÏôÑÎ£åÎêòÏñ¥Ïïº 'Îã§Ïùå' Î≤ÑÌäº ÌôúÏÑ±Ìôî
            if (idCardPhotoConfirmed && extractedInfoConfirmed) {
                nextButton.disabled = false;
                nextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }
        
        // --- ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ---
        homeButton.addEventListener('click', function(event) {
            event.preventDefault();
            window.location.href = '/foreign';
        });

        prevButton.addEventListener('click', function() {
            window.location.href = '/foreign2'; 
        });

        nextButton.addEventListener('click', function() {
            if (idCardPhotoConfirmed && extractedInfoConfirmed) {
                window.location.href = '/foreign4'; 
            } else {
                alert('Î™®Îì† Ïã†Î∂ÑÏ¶ù Í¥ÄÎ†® Ï†àÏ∞®Î•º ÏôÑÎ£åÌï¥Ïïº Îã§Ïùå Îã®Í≥ÑÎ°ú ÏßÑÌñâÌï† Ïàò ÏûàÏäµÎãàÎã§.'); 
            }
        });

        // ÏÑπÏÖò Ï†úÎ™© ÌÅ¥Î¶≠ Ïãú ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä (Ïù∏Ï¶ù ÏôÑÎ£å ÏÉÅÌÉúÍ∞Ä ÏïÑÎãê ÎïåÎßå)
        idCardTitle.addEventListener('click', () => {
            toggleAccordion(idCardContent, idCardTitle, idCardToggleIcon, idCardSection);
        });
        extractedInfoTitle.addEventListener('click', () => {
            toggleAccordion(extractedInfoContent, extractedInfoTitle, extractedInfoToggleIcon, extractedInfoSection);
        });

        // DOMContentLoaded Ïù¥Î≤§Ìä∏ Î∞úÏÉù Ïãú UI Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', initializeUI);

    </script>
</body>
</html>
