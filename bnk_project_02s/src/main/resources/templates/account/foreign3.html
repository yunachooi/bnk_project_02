<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNK 쇼핑환전통장 - 신분증 제출</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
        }

        /* Footer styles */
        .bottom-bar {
            flex: none; 
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            z-index: 10;
        }
        .bottom-bar button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .bottom-bar button:active {
            transform: scale(0.98);
        }

        /* Main content area */
        .main-content {
            flex-grow: 1;
            padding: 0.75rem 1.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto; 
        }

        .section-block {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: none;
            margin-bottom: 0; 
        }
        .section-title .checkmark {
            color: #10b981; 
            font-size: 1.2rem;
            margin-left: 0.5rem;
            display: none; 
        }
        .section-title .title-text {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        /* Form elements */
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            box-sizing: border-box;
            background-color: #f9fafb; 
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .form-group input[disabled],
        .form-group textarea[disabled] {
            background-color: #e5e7eb; 
            cursor: not-allowed;
        }

        /* Step Indicator Styles */
        .step-indicator {
            display: flex;
            width: 100%;
            height: 4px; 
            background-color: #e0e0e0; 
            border-radius: 2px;
            overflow: hidden; 
            margin-top: 0.5rem; 
        }
        .step-indicator-progress {
            width: 33.33%;
            height: 100%;
            background-color: #2563eb; 
            border-radius: 2px;
        }

        /* ID Card Frame and Capture Button Styles */
        .id-card-frame {
            border: 2px solid #a0aec0;
            border-radius: 0.75rem;
            background-color: #f0f4f8;
            aspect-ratio: 1.585 / 1;
            max-width: 90%;
            width: 320px;
            height: auto;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .id-card-frame:hover {
            border-color: #2563eb;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        .capture-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 1rem;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 10;
            border-radius: 0.75rem;
        }
        .photo-placeholder-icon { font-size: 3rem; color: #9ca3af; margin-bottom: 0.5rem; }
        .photo-placeholder-text { color: #4b5563; font-size: 1.1rem; font-weight: 600; }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 2rem;
        }
        .action-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .capture-btn { background-color: #2563eb; color: white; }
        .capture-btn:hover { background-color: #1d4ed8; }
        .capture-btn:active { transform: scale(0.98); }
        .confirm-btn { background-color: #10b981; color: white; }
        .confirm-btn:hover { background-color: #0d926b; }
        .retake-btn { background-color: #ef4444; color: white; }
        .retake-btn:hover { background-color: #cc2929; }

        #cameraFeed, #previewImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        .hidden { display: none !important; }

        /* Accordion styles */
        .section-content {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            border-top: none; 
            margin-top: 0; 
        }
        .section-content.collapsed { max-height: 0; border-top: none; margin-top: 0; }
        .section-content:not(.collapsed) { border-top: 1px solid #f0f4f8; }
        .section-content-inner { padding: 1.5rem; }
        .section-block.collapsible .section-title { cursor: pointer; }
        .section-block.collapsible .section-title .toggle-icon { transition: transform 0.3s ease; display: inline-block; }
        .section-block.collapsible .section-title.rotated .toggle-icon { transform: rotate(180deg); }
        .section-block.collapsible.confirmed .section-title .toggle-icon { display: none; }

        /* ===== 음성 안내: 패널 ===== */
        .voice-panel{
            position:absolute;right:.75rem;top:3.25rem;width:300px;background:#fff;
            border:1px solid #e5e7eb;border-radius:.75rem;box-shadow:0 10px 20px rgba(0,0,0,.08);
            padding:.75rem;z-index:50;display:none
        }
        .voice-panel.open{display:block}

        /* ===== 로딩 오버레이 (OCR 호출 중) ===== */
        .loading-overlay{
            position: fixed; inset: 0; background: rgba(255,255,255,.6);
            display:none; align-items:center; justify-content:center; z-index:100;
        }
        .loading-overlay.open{display:flex}
        .spinner{
            width: 52px; height: 52px; border-radius: 9999px; border: 6px solid #e5e7eb; border-top-color:#2563eb; animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg);} }
        .toast{
            position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
            background:#111827; color:#fff; padding:.6rem .9rem; border-radius:.6rem; font-size:.9rem;
            box-shadow:0 10px 20px rgba(0,0,0,.18); display:none; z-index:120;
        }
        .toast.open{display:block}
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        <!-- Header -->
        <header class="grid grid-cols-3 items-center p-4 bg-white border-b border-gray-200">
            <a href="/foreign" class="justify-self-start flex items-center text-blue-700 font-medium text-base hover:text-blue-800 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
                홈으로
            </a>

            <h1 class="justify-self-center text-xl font-bold text-gray-800 text-center">신분증 제출</h1>

            <!-- 우측 상단: 음성 안내 -->
            <div class="relative justify-self-end">
                <button id="voiceGuideBtn"
                        class="px-2 py-1 rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-1"
                        aria-pressed="false"
                        aria-label="음성 안내 켜기"
                        title="음성 안내 켜기">
                    <svg id="voiceIconPlay" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M3 10v4a1 1 0 001 1h3l3.293 3.293A1 1 0 0011 18v-12a1 1 0 00-1.707-.707L7 8H4a1 1 0 00-1 1zm13.586-3.414a1 1 0 10-1.414 1.414A5.969 5.969 0 0117 12c0 1.657-.672 3.157-1.828 4.243a1 1 0 101.414 1.414A7.968 7.968 0 0019 12a7.968 7.968 0 00-2.414-5.414z"/>
                    </svg>
                    <svg id="voiceIconStop" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M6 6h12v12H6z"/>
                    </svg>
                    <span id="voiceLabel" class="text-xs font-semibold">음성 안내 켜기</span>
                </button>

                <div id="voicePanel" class="voice-panel" role="dialog" aria-label="음성 안내 설정">
                    <div class="mb-2 flex items-center justify-between">
                        <p class="text-sm font-semibold text-gray-800">음성 안내</p>
                        <button id="voiceCloseBtn" class="text-gray-500 hover:text-gray-700 text-xs px-2 py-1 rounded" aria-label="설정 닫기">닫기</button>
                    </div>
                    <div class="mb-3 text-xs text-gray-700 leading-5">
                        <p class="mb-1">시작/정지: ‘<span class="font-semibold">음성 안내 켜기·끄기</span>’ 버튼을 누르세요.</p>
                        <p class="mb-1"><span class="font-semibold">주민등록증을 네모 칸에 맞춘 뒤 촬영</span>해 주세요. 사진을 확인하고 정보가 맞으면 <span class="font-semibold">정보 확인</span> 버튼을 누르세요.</p>
                    </div>
                    <div class="flex">
                        <button id="voiceReplayBtn" class="flex-1 bg-blue-600 text-white rounded-md px-3 py-2 text-sm font-semibold hover:bg-blue-700">다시 듣기</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator mx-4 mt-4">
            <div class="step-indicator-progress"></div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- 신분증 촬영 섹션 -->
            <div id="idCardSection" class="section-block collapsible">
                <h2 id="idCardTitle" class="section-title">
                    <span class="title-text">
                        주민등록증 촬영
                        <span id="idCardCheckmark" class="checkmark">✔</span>
                    </span>
                    <svg id="idCardToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="idCardContent" class="section-content">
                    <div class="section-content-inner">
                        <p class="text-gray-600 text-sm mb-4 text-center">
                            네모 칸에 맞춰 주민등록증을 촬영해주세요!
                        </p>
                        <div id="idCardFrame" class="id-card-frame">
                            <video id="cameraFeed" autoplay playsinline style="display: none;"></video>
                            <img id="previewImage" src="#" alt="신분증 이미지 미리보기" style="display: none;">
                            <div id="captureOverlay" class="capture-overlay">
                                <span class="photo-placeholder-icon">📸</span>
                                <span class="photo-placeholder-text">신분증을 촬영해주세요</span>
                            </div>
                            <canvas id="hiddenCanvas" style="display: none;"></canvas>
                        </div>
                        <div id="actionButtons" class="action-buttons">
                            <button id="captureButton" class="action-button capture-btn">촬영</button>
                            <button id="confirmButton" class="action-button confirm-btn hidden">확인</button>
                            <button id="retakeButton" class="action-button retake-btn hidden">재촬영</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 추출된 정보 섹션 -->
            <div id="extractedInfoSection" class="section-block collapsible hidden">
                <h2 id="extractedInfoTitle" class="section-title">
                    <span class="title-text">
                        신분증 정보
                        <span id="extractedInfoCheckmark" class="checkmark">✔</span>
                    </span>
                    <svg id="extractedInfoToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="extractedInfoContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="extractedName">성명</label>
                            <input type="text" id="extractedName" placeholder="홍길동">
                        </div>
                        <div class="form-group">
                            <label for="extractedResidentId">주민등록번호</label>
                            <input type="text" id="extractedResidentId" placeholder="예: 900101-1234567">
                        </div>
                        <div class="flex justify-center mt-6">
                            <button id="confirmInfoButton" class="action-button capture-btn">정보 확인</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bottom-bar">
            <button id="prevButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300">이전</button>
            <button id="nextButton" class="bg-gray-400 text-white cursor-not-allowed" disabled>다음으로</button>
        </footer>
    </div>

    <!-- 로딩/토스트 -->
    <div id="loadingOverlay" class="loading-overlay"><div class="spinner" aria-label="처리 중"></div></div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        /* =========================
         *  🔧 설정
         * ========================= */
        // /api/ocr 엔드포인트가 없으면 false 유지(기본값). 있으면 true로 전환.
        const USE_OCR = false;

        /* =========================
         *  공통: 자동채움(/api/autofill)
         * ========================= */
        let __AUTOFILL_CACHE__ = null;
        async function getAutofill(){
            if (__AUTOFILL_CACHE__) return __AUTOFILL_CACHE__;
            const r = await fetch('/api/autofill', { credentials:'include' });
            if (!r.ok) throw new Error('autofill api failed');
            __AUTOFILL_CACHE__ = await r.json(); // { name, phone, residentMasked, bankName, accountMasked }
            return __AUTOFILL_CACHE__;
        }

        async function applyAutofillToForeign3(){
            try{
                const d = await getAutofill();
                const nameEl = document.getElementById('extractedName');
                const rrnEl  = document.getElementById('extractedResidentId');

                if (nameEl && d.name) nameEl.value = d.name;

                // 주민번호는 마스킹만 보여주고 제출 금지
                if (rrnEl && d.residentMasked){
                    rrnEl.value = d.residentMasked;
                    rrnEl.readOnly = true;
                    rrnEl.disabled = true;       // form 제출 차단
                    rrnEl.removeAttribute('name');
                    rrnEl.setAttribute('autocomplete','off');
                }

                // 정보 섹션 노출(촬영 전에도 사용자 확인 가능)
                const section  = document.getElementById('extractedInfoSection');
                const content  = document.getElementById('extractedInfoContent');
                const titleHdr = document.getElementById('extractedInfoTitle');
                if (section && content && titleHdr){
                    section.classList.remove('hidden');
                    content.classList.remove('collapsed');
                    titleHdr.classList.add('rotated');
                }
            }catch(e){
                console.warn('autofill 실패', e);
            }
        }

        /* =========================
         *  원본 스크립트 (필요 변수)
         * ========================= */
        const homeButton = document.querySelector('header a');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');

        // 신분증 촬영 섹션 관련 요소
        const idCardSection = document.getElementById('idCardSection');
        const idCardTitle = document.getElementById('idCardTitle');
        const idCardCheckmark = document.getElementById('idCardCheckmark');
        const idCardToggleIcon = document.getElementById('idCardToggleIcon');
        const idCardContent = document.getElementById('idCardContent');

        const idCardFrame = document.getElementById('idCardFrame');
        const cameraFeed = document.getElementById('cameraFeed');
        const previewImage = document.getElementById('previewImage');
        const captureOverlay = document.getElementById('captureOverlay');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        
        const actionButtonsDiv = document.getElementById('actionButtons');
        const captureButton = document.getElementById('captureButton'); 
        const confirmButton = document.getElementById('confirmButton'); 
        const retakeButton = document.getElementById('retakeButton');   
        
        // 추출된 정보 섹션 관련 요소
        const extractedInfoSection = document.getElementById('extractedInfoSection');
        const extractedInfoTitle = document.getElementById('extractedInfoTitle');
        const theExtractedInfoCheckmark = document.getElementById('extractedInfoCheckmark');
        const extractedInfoToggleIcon = document.getElementById('extractedInfoToggleIcon');
        const extractedInfoContent = document.getElementById('extractedInfoContent');

        const extractedNameInput = document.getElementById('extractedName');
        const extractedResidentIdInput = document.getElementById('extractedResidentId'); 
        const confirmInfoButton = document.getElementById('confirmInfoButton'); 

        // 음성 안내 요소
        const voiceBtn = document.getElementById('voiceGuideBtn');
        const voiceIconPlay = document.getElementById('voiceIconPlay');
        const voiceIconStop = document.getElementById('voiceIconStop');
        const voiceLabel = document.getElementById('voiceLabel');
        const voicePanel = document.getElementById('voicePanel');
        const voiceCloseBtn = document.getElementById('voiceCloseBtn');
        const voiceReplayBtn = document.getElementById('voiceReplayBtn');

        // 로딩/토스트
        const loadingOverlay = document.getElementById('loadingOverlay');
        const toast = document.getElementById('toast');
        function showLoading(on){ loadingOverlay.classList.toggle('open', !!on); }
        function showToast(msg){ toast.textContent = msg; toast.classList.add('open'); setTimeout(()=>toast.classList.remove('open'), 2500); }

        // 상태 변수
        let idCardPhotoConfirmed = false;
        let extractedInfoConfirmed = false;
        let cameraStream = null;

        // 카메라 시작
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
                cameraFeed.srcObject = stream;
                cameraFeed.play();
                cameraFeed.style.display = 'block';
                captureOverlay.classList.add('hidden');
                cameraStream = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                cameraFeed.style.display = 'none';
                captureOverlay.classList.remove('hidden');
                showToast('카메라 권한을 확인해 주세요.');
            }
        }

        // 스냅샷
        function takeSnapshot() {
            if (!cameraStream || cameraFeed.style.display === 'none') {
                alert('카메라 스트림이 활성화되지 않았습니다. 잠시 후 다시 시도하거나 권한을 확인해주세요.');
                return;
            }
            hiddenCanvas.width = cameraFeed.videoWidth;
            hiddenCanvas.height = cameraFeed.videoHeight;
            const context = hiddenCanvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, hiddenCanvas.width, hiddenCanvas.height);

            // 카메라 정지
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraFeed.srcObject = null;
                cameraStream = null;
            }

            // 미리보기 표시
            previewImage.src = hiddenCanvas.toDataURL('image/png');
            previewImage.style.display = 'block';
            cameraFeed.style.display = 'none';

            idCardPhotoConfirmed = false;
            updateNextButtonState();

            // 버튼 전환
            captureButton.classList.add('hidden');
            confirmButton.classList.remove('hidden');
            retakeButton.classList.remove('hidden');
            confirmButton.disabled = false;
            confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            confirmButton.classList.add('bg-blue-600', 'hover:bg-blue-700');

            // 🔁 OCR 사용 여부
            if (USE_OCR) {
                ocrViaServer(previewImage.src);
            } else {
                // OCR 미사용: 정보 섹션만 열어주고, 자동채움 재적용(혹시 촬영 전 미적용 대비)
                applyAutofillToForeign3().then(()=>{
                    showToast('촬영 완료: 정보를 확인해 주세요.');
                });
            }
        }

        // 초기 UI
        function initializeUI() {
            idCardContent.classList.remove('collapsed');
            idCardTitle.classList.add('rotated');

            extractedInfoSection.classList.add('hidden');
            extractedInfoContent.classList.add('collapsed'); 
            theExtractedInfoCheckmark.style.display = 'none';

            startCamera(); 

            captureButton.classList.remove('hidden');
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');

            updateNextButtonState(); 
        }

        // 아코디언 토글
        function toggleAccordion(contentElement, titleElement, toggleIconElement, sectionBlockElement) {
            if (sectionBlockElement.classList.contains('confirmed')) return;
            contentElement.classList.toggle('collapsed');
            titleElement.classList.toggle('rotated');
            if (contentElement.classList.contains('collapsed')) toggleIconElement.classList.remove('rotated');
            else toggleIconElement.classList.add('rotated');
        }

        // 이벤트
        idCardFrame.addEventListener('click', () => {
            if (cameraFeed.style.display === 'block') takeSnapshot();
        });
        captureButton.addEventListener('click', (event) => {
            event.stopPropagation(); 
            takeSnapshot();
        });
        retakeButton.addEventListener('click', () => {
            idCardPhotoConfirmed = false;
            extractedInfoConfirmed = false;
            updateNextButtonState();

            previewImage.src = "#";
            previewImage.style.display = 'none';
            
            extractedInfoSection.classList.add('hidden'); 
            extractedInfoContent.classList.add('collapsed'); 
            extractedInfoTitle.classList.remove('rotated'); 
            theExtractedInfoCheckmark.style.display = 'none'; 
            extractedNameInput.value = '';
            extractedResidentIdInput.value = '';

            captureButton.classList.remove('hidden');
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');

            extractedNameInput.disabled = false;
            extractedResidentIdInput.disabled = false;
            confirmInfoButton.disabled = false; 

            idCardContent.classList.remove('collapsed');
            idCardTitle.classList.add('rotated');
            idCardCheckmark.style.display = 'none'; 
            idCardSection.classList.remove('confirmed'); 

            startCamera();
            // 재촬영 시에도 자동채움 다시 적용
            applyAutofillToForeign3();
        });

        // "확인" 클릭: 촬영 완료 처리 + 정보 섹션 오픈
        confirmButton.addEventListener('click', () => {
            idCardPhotoConfirmed = true; 
            updateNextButtonState(); 
            idCardCheckmark.style.display = 'inline-block'; 
            idCardSection.classList.add('confirmed'); 
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');
            setTimeout(() => {
                idCardContent.classList.add('collapsed'); 
                idCardTitle.classList.remove('rotated'); 
                extractedInfoSection.classList.remove('hidden'); 
                extractedInfoContent.classList.remove('collapsed');
                extractedInfoTitle.classList.add('rotated');
                extractedInfoSection.classList.remove('confirmed'); 
                theExtractedInfoCheckmark.style.display = 'none'; 
                confirmInfoButton.classList.remove('hidden');
                confirmInfoButton.disabled = false;
                confirmInfoButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmInfoButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 600);
        });

        // 정보 확인 버튼
        confirmInfoButton.addEventListener('click', () => {
            if (!extractedNameInput.value.trim() || !extractedResidentIdInput.value.trim()) {
                alert('성명과 주민등록번호를 모두 확인해 주세요.');
                return;
            }
            extractedInfoConfirmed = true; 
            updateNextButtonState(); 
            theExtractedInfoCheckmark.style.display = 'inline-block';
            extractedInfoSection.classList.add('confirmed'); 
            extractedNameInput.disabled = true;
            extractedResidentIdInput.disabled = true;
            confirmInfoButton.disabled = true;
            confirmInfoButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            confirmInfoButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            setTimeout(() => {
                extractedInfoContent.classList.add('collapsed');
                extractedInfoTitle.classList.remove('rotated'); 
            }, 600);
        });

        // === (선택) 서버 OCR 호출 ===
        async function ocrViaServer(dataUrl){
            try{
                showLoading(true);
                const res = await fetch('/api/ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageDataUrl: dataUrl })
                });
                if(!res.ok){
                    const t = await res.text();
                    throw new Error(t || 'OCR 요청 실패');
                }
                const json = await res.json();
                if(json.name){ extractedNameInput.value = json.name; }
                if(json.residentId){ extractedResidentIdInput.value = json.residentId; }

                extractedInfoSection.classList.remove('hidden');
                extractedInfoContent.classList.remove('collapsed');
                extractedInfoTitle.classList.add('rotated');

                if(!json.name && !json.residentId){
                    showToast('인식률이 낮아요. 값을 확인/수정해 주세요.');
                }else{
                    showToast('OCR 완료: 값이 채워졌어요. 확인을 눌러주세요.');
                }

                try{
                    localStorage.setItem('extractedUserInfo', JSON.stringify({
                        name: extractedNameInput.value || '',
                        residentId: extractedResidentIdInput.value || '',
                        raw: json.rawText || ''
                    }));
                }catch(e){}
            }catch(e){
                console.error(e);
                showToast('OCR 실패: 네트워크 또는 할당량을 확인해 주세요.');
            }finally{
                showLoading(false);
            }
        }

        // 다음 버튼 상태
        function updateNextButtonState() {
            if (idCardPhotoConfirmed && extractedInfoConfirmed) {
                nextButton.disabled = false;
                nextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }
        
        // 내비게이션
        homeButton.addEventListener('click', function(event) {
            event.preventDefault();
            Voice.cancel();
            window.location.href = '/foreign';
        });
        prevButton.addEventListener('click', function() {
            Voice.cancel();
            window.location.href = '/foreign2'; 
        });
        nextButton.addEventListener('click', function() {
            if (idCardPhotoConfirmed && extractedInfoConfirmed) {
                Voice.cancel();
                window.location.href = '/foreign4'; 
            } else {
                alert('모든 신분증 관련 절차를 완료해야 다음 단계로 진행할 수 있습니다.'); 
            }
        });
        idCardTitle.addEventListener('click', () => {
            toggleAccordion(idCardContent, idCardTitle, idCardToggleIcon, idCardSection);
        });
        extractedInfoTitle.addEventListener('click', () => {
            toggleAccordion(extractedInfoContent, extractedInfoTitle, extractedInfoToggleIcon, extractedInfoSection);
        });

        // 초기화 + 자동채움 적용
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            applyAutofillToForeign3();
        });

        /* ===== 음성 안내 (Web Speech + 네이티브 브릿지) ===== */
        const Voice = (function(){
            let speaking = false;
            let queue = [];
            let current = null;

            const hasWebSpeech = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
            const hasAndroid = !!window.AndroidTTS?.speak;
            const hasIOS = !!(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.tts);

            function useNativeSpeak(text){
                const r = 1.0;
                if(hasAndroid){
                    try{ window.AndroidTTS.speak(String(text), r); return true; }catch(e){ console.warn(e); }
                }
                if(hasIOS){
                    try{ window.webkit.messageHandlers.tts.postMessage({action:'speak', text:String(text), rate:r}); return true; }catch(e){ console.warn(e); }
                }
                return false;
            }
            function useNativeStop(){
                if(hasAndroid){
                    try{ window.AndroidTTS.stop(); return true; }catch(e){ console.warn(e); }
                }
                if(hasIOS){
                    try{ window.webkit.messageHandlers.tts.postMessage({action:'stop'}); return true; }catch(e){ console.warn(e); }
                }
                return false;
            }

            function speakWeb(text, onend){
                const u = new SpeechSynthesisUtterance(String(text));
                u.lang = 'ko-KR';
                u.rate = 1.0;
                u.onend = onend || null;
                u.onerror = function(){ console.warn('TTS error'); onend && onend(); };
                window.speechSynthesis.speak(u);
            }

            function nextInQueue(){
                if(queue.length === 0){ current = null; speaking = false; setUI(false); return; }
                current = queue.shift();
                if(useNativeSpeak(current)){
                    speaking = true; setUI(true);
                    const approx = Math.max(1500, current.length * 60);
                    setTimeout(()=>{ nextInQueue(); }, approx);
                }else if(hasWebSpeech){
                    speaking = true; setUI(true);
                    speakWeb(current, ()=> nextInQueue());
                }else{
                    speaking = false; setUI(false);
                }
            }

            function setUI(isOn){
                voiceBtn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
                voiceIconPlay.classList.toggle('hidden', isOn);
                voiceIconStop.classList.toggle('hidden', !isOn);
                voiceLabel.textContent = isOn ? '음성 안내 끄기' : '음성 안내 켜기';
                voiceBtn.setAttribute('aria-label', voiceLabel.textContent);
                voiceBtn.setAttribute('title', voiceLabel.textContent);
            }

            function start(scriptLines){
                if(speaking) cancel();
                queue = Array.isArray(scriptLines) ? scriptLines.slice() : [String(scriptLines||'')];
                nextInQueue();
            }
            function cancel(){
                queue = [];
                current = null;
                speaking = false;
                useNativeStop();
                if(('speechSynthesis' in window)){ try{ window.speechSynthesis.cancel(); }catch(e){} }
                setUI(false);
            }
            function toggle(scriptLines){
                if(speaking){ cancel(); }
                else{ start(scriptLines); }
            }
            return { start, cancel, toggle, isSpeaking:()=>speaking };
        })();

        function buildVoiceScript(){
            const line1 = '안내: 주민등록증을 네모 칸에 맞춘 뒤, 촬영 버튼을 눌러 주세요.';
            const line2 = '사진을 확인하고 정보가 맞으면, 정보 확인 버튼을 눌러 다음 단계로 진행합니다.';
            const line3 = '모든 절차가 끝나면 하단의 다음으로 버튼이 활성화됩니다.';
            return [line1, line2, line3];
        }

        voiceBtn.addEventListener('click', function(){
            voicePanel.classList.toggle('open');
            Voice.toggle(buildVoiceScript());
        });
        voiceCloseBtn.addEventListener('click', function(){
            voicePanel.classList.remove('open');
        });
        voiceReplayBtn.addEventListener('click', function(){
            Voice.start(buildVoiceScript());
        });

        document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ Voice.cancel(); } });
        window.addEventListener('pagehide', ()=> Voice.cancel());
        
        async function getAutofill(){
        	  const r = await fetch('/api/autofill', { credentials: 'include' });
        	  if (r.status === 401) return {};        // 비로그인/세션없음
        	  if (!r.ok) throw new Error('autofill api failed');
        	  return r.json();                         // {name, phone, residentMasked}
        	}

        	// foreign3 채우기: 이름 + 주민번호(마스킹만, 제출 차단)
        	async function applyAutofillToForeign3(){
        	  try {
        	    const d = await getAutofill();

        	    const nameEl = document.getElementById('extractedName');
        	    if (nameEl && d.name) nameEl.value = d.name;

        	    const rrnEl  = document.getElementById('extractedResidentId');
        	    if (rrnEl && d.residentMasked){
        	      rrnEl.value = d.residentMasked;
        	      rrnEl.readOnly = true;          // 수정 불가
        	      rrnEl.disabled = true;          // 폼 제출 차단
        	      rrnEl.removeAttribute('name');  // 혹시 name 있으면 제거
        	      rrnEl.setAttribute('autocomplete','off');
        	    }

        	    // 아코디언/섹션이 접혀 있으면 보여주기(있을 때만)
        	    const sec = document.getElementById('extractedInfoSection');
        	    const cont= document.getElementById('extractedInfoContent');
        	    const ttl = document.getElementById('extractedInfoTitle');
        	    if (sec && cont && ttl){
        	      sec.classList.remove('hidden');
        	      cont.classList.remove('collapsed');
        	      ttl.classList.add('rotated');
        	    }
        	  } catch(e){
        	    console.warn('autofill 실패', e);
        	  }
        	}

        	document.addEventListener('DOMContentLoaded', applyAutofillToForeign3);
    </script>
</body>
</html>
