<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNK ì‡¼í•‘í™˜ì „í†µì¥ - ì‹ ë¶„ì¦ ì œì¶œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
        }

        /* Footer styles */
        .bottom-bar {
            flex: none; 
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
            z-index: 10;
        }
        .bottom-bar button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .bottom-bar button:active {
            transform: scale(0.98);
        }

        /* Main content area */
        .main-content {
            flex-grow: 1;
            padding: 0.75rem 1.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto; 
        }

        .section-block {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: none;
            margin-bottom: 0; 
        }
        .section-title .checkmark {
            color: #10b981; 
            font-size: 1.2rem;
            margin-left: 0.5rem;
            display: none; 
        }
        .section-title .title-text {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        /* Form elements */
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            box-sizing: border-box;
            background-color: #f9fafb; 
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .form-group input[disabled],
        .form-group textarea[disabled] {
            background-color: #e5e7eb; 
            cursor: not-allowed;
        }

        /* Step Indicator Styles */
        .step-indicator {
            display: flex;
            width: 100%;
            height: 4px; 
            background-color: #e0e0e0; 
            border-radius: 2px;
            overflow: hidden; 
            margin-top: 0.5rem; 
        }
        .step-indicator-progress {
            width: 33.33%;
            height: 100%;
            background-color: #2563eb; 
            border-radius: 2px;
        }

        /* ID Card Frame and Capture Button Styles */
        .id-card-frame {
            border: 2px solid #a0aec0;
            border-radius: 0.75rem;
            background-color: #f0f4f8;
            aspect-ratio: 1.585 / 1;
            max-width: 90%;
            width: 320px;
            height: auto;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .id-card-frame:hover {
            border-color: #2563eb;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        .capture-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 1rem;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 10;
            border-radius: 0.75rem;
        }
        .photo-placeholder-icon { font-size: 3rem; color: #9ca3af; margin-bottom: 0.5rem; }
        .photo-placeholder-text { color: #4b5563; font-size: 1.1rem; font-weight: 600; }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 2rem;
        }
        .action-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .capture-btn { background-color: #2563eb; color: white; }
        .capture-btn:hover { background-color: #1d4ed8; }
        .capture-btn:active { transform: scale(0.98); }
        .confirm-btn { background-color: #10b981; color: white; }
        .confirm-btn:hover { background-color: #0d926b; }
        .retake-btn { background-color: #ef4444; color: white; }
        .retake-btn:hover { background-color: #cc2929; }

        #cameraFeed, #previewImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        .hidden { display: none !important; }

        /* Accordion styles */
        .section-content {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            border-top: none; 
            margin-top: 0; 
        }
        .section-content.collapsed { max-height: 0; border-top: none; margin-top: 0; }
        .section-content:not(.collapsed) { border-top: 1px solid #f0f4f8; }
        .section-content-inner { padding: 1.5rem; }
        .section-block.collapsible .section-title { cursor: pointer; }
        .section-block.collapsible .section-title .toggle-icon { transition: transform 0.3s ease; display: inline-block; }
        .section-block.collapsible .section-title.rotated .toggle-icon { transform: rotate(180deg); }
        .section-block.collapsible.confirmed .section-title .toggle-icon { display: none; }

        /* ===== ìŒì„± ì•ˆë‚´: íŒ¨ë„ ===== */
        .voice-panel{
            position:absolute;right:.75rem;top:3.25rem;width:300px;background:#fff;
            border:1px solid #e5e7eb;border-radius:.75rem;box-shadow:0 10px 20px rgba(0,0,0,.08);
            padding:.75rem;z-index:50;display:none
        }
        .voice-panel.open{display:block}

        /* ===== ë¡œë”© ì˜¤ë²„ë ˆì´ (OCR í˜¸ì¶œ ì¤‘) ===== */
        .loading-overlay{
            position: fixed; inset: 0; background: rgba(255,255,255,.6);
            display:none; align-items:center; justify-content:center; z-index:100;
        }
        .loading-overlay.open{display:flex}
        .spinner{
            width: 52px; height: 52px; border-radius: 9999px; border: 6px solid #e5e7eb; border-top-color:#2563eb; animation: spin 0.9s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg);} }
        .toast{
            position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
            background:#111827; color:#fff; padding:.6rem .9rem; border-radius:.6rem; font-size:.9rem;
            box-shadow:0 10px 20px rgba(0,0,0,.18); display:none; z-index:120;
        }
        .toast.open{display:block}
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        <!-- Header -->
        <header class="grid grid-cols-3 items-center p-4 bg-white border-b border-gray-200">
            <a href="/foreign" class="justify-self-start flex items-center text-blue-700 font-medium text-base hover:text-blue-800 transition-colors duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
                í™ˆìœ¼ë¡œ
            </a>

            <h1 class="justify-self-center text-xl font-bold text-gray-800 text-center">ì‹ ë¶„ì¦ ì œì¶œ</h1>

            <!-- ìš°ì¸¡ ìƒë‹¨: ìŒì„± ì•ˆë‚´ -->
            <div class="relative justify-self-end">
                <button id="voiceGuideBtn"
                        class="px-2 py-1 rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-1"
                        aria-pressed="false"
                        aria-label="ìŒì„± ì•ˆë‚´ ì¼œê¸°"
                        title="ìŒì„± ì•ˆë‚´ ì¼œê¸°">
                    <svg id="voiceIconPlay" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M3 10v4a1 1 0 001 1h3l3.293 3.293A1 1 0 0011 18v-12a1 1 0 00-1.707-.707L7 8H4a1 1 0 00-1 1zm13.586-3.414a1 1 0 10-1.414 1.414A5.969 5.969 0 0117 12c0 1.657-.672 3.157-1.828 4.243a1 1 0 101.414 1.414A7.968 7.968 0 0019 12a7.968 7.968 0 00-2.414-5.414z"/>
                    </svg>
                    <svg id="voiceIconStop" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M6 6h12v12H6z"/>
                    </svg>
                    <span id="voiceLabel" class="text-xs font-semibold">ìŒì„± ì•ˆë‚´ ì¼œê¸°</span>
                </button>

                <div id="voicePanel" class="voice-panel" role="dialog" aria-label="ìŒì„± ì•ˆë‚´ ì„¤ì •">
                    <div class="mb-2 flex items-center justify-between">
                        <p class="text-sm font-semibold text-gray-800">ìŒì„± ì•ˆë‚´</p>
                        <button id="voiceCloseBtn" class="text-gray-500 hover:text-gray-700 text-xs px-2 py-1 rounded" aria-label="ì„¤ì • ë‹«ê¸°">ë‹«ê¸°</button>
                    </div>
                    <div class="mb-3 text-xs text-gray-700 leading-5">
                        <p class="mb-1">ì‹œì‘/ì •ì§€: â€˜<span class="font-semibold">ìŒì„± ì•ˆë‚´ ì¼œê¸°Â·ë„ê¸°</span>â€™ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                        <p class="mb-1"><span class="font-semibold">ì£¼ë¯¼ë“±ë¡ì¦ì„ ë„¤ëª¨ ì¹¸ì— ë§ì¶˜ ë’¤ ì´¬ì˜</span>í•´ ì£¼ì„¸ìš”. ì‚¬ì§„ì„ í™•ì¸í•˜ê³  ì •ë³´ê°€ ë§ìœ¼ë©´ <span class="font-semibold">ì •ë³´ í™•ì¸</span> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                    </div>
                    <div class="flex">
                        <button id="voiceReplayBtn" class="flex-1 bg-blue-600 text-white rounded-md px-3 py-2 text-sm font-semibold hover:bg-blue-700">ë‹¤ì‹œ ë“£ê¸°</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator mx-4 mt-4">
            <div class="step-indicator-progress"></div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- ì‹ ë¶„ì¦ ì´¬ì˜ ì„¹ì…˜ -->
            <div id="idCardSection" class="section-block collapsible">
                <h2 id="idCardTitle" class="section-title">
                    <span class="title-text">
                        ì£¼ë¯¼ë“±ë¡ì¦ ì´¬ì˜
                        <span id="idCardCheckmark" class="checkmark">âœ”</span>
                    </span>
                    <svg id="idCardToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="idCardContent" class="section-content">
                    <div class="section-content-inner">
                        <p class="text-gray-600 text-sm mb-4 text-center">
                            ë„¤ëª¨ ì¹¸ì— ë§ì¶° ì£¼ë¯¼ë“±ë¡ì¦ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”!
                        </p>
                        <div id="idCardFrame" class="id-card-frame">
                            <video id="cameraFeed" autoplay playsinline style="display: none;"></video>
                            <img id="previewImage" src="#" alt="ì‹ ë¶„ì¦ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" style="display: none;">
                            <div id="captureOverlay" class="capture-overlay">
                                <span class="photo-placeholder-icon">ğŸ“¸</span>
                                <span class="photo-placeholder-text">ì‹ ë¶„ì¦ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”</span>
                            </div>
                            <canvas id="hiddenCanvas" style="display: none;"></canvas>
                        </div>
                        <div id="actionButtons" class="action-buttons">
                            <button id="captureButton" class="action-button capture-btn">ì´¬ì˜</button>
                            <button id="confirmButton" class="action-button confirm-btn hidden">í™•ì¸</button>
                            <button id="retakeButton" class="action-button retake-btn hidden">ì¬ì´¬ì˜</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¶”ì¶œëœ ì •ë³´ ì„¹ì…˜ -->
            <div id="extractedInfoSection" class="section-block collapsible hidden">
                <h2 id="extractedInfoTitle" class="section-title">
                    <span class="title-text">
                        ì‹ ë¶„ì¦ ì •ë³´
                        <span id="extractedInfoCheckmark" class="checkmark">âœ”</span>
                    </span>
                    <svg id="extractedInfoToggleIcon" class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </h2>
                <div id="extractedInfoContent" class="section-content">
                    <div class="section-content-inner">
                        <div class="form-group">
                            <label for="extractedName">ì„±ëª…</label>
                            <input type="text" id="extractedName" placeholder="í™ê¸¸ë™">
                        </div>
                        <div class="form-group">
                            <label for="extractedResidentId">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</label>
                            <input type="text" id="extractedResidentId" placeholder="ì˜ˆ: 900101-1234567">
                        </div>
                        <div class="flex justify-center mt-6">
                            <button id="confirmInfoButton" class="action-button capture-btn">ì •ë³´ í™•ì¸</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bottom-bar">
            <button id="prevButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300">ì´ì „</button>
            <button id="nextButton" class="bg-gray-400 text-white cursor-not-allowed" disabled>ë‹¤ìŒìœ¼ë¡œ</button>
        </footer>
    </div>

    <!-- ë¡œë”©/í† ìŠ¤íŠ¸ -->
    <div id="loadingOverlay" class="loading-overlay"><div class="spinner" aria-label="ì²˜ë¦¬ ì¤‘"></div></div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        /* =========================
         *  ğŸ”§ ì„¤ì •
         * ========================= */
        // /api/ocr ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ìœ¼ë©´ false ìœ ì§€(ê¸°ë³¸ê°’). ìˆìœ¼ë©´ trueë¡œ ì „í™˜.
        const USE_OCR = false;

        /* =========================
         *  ê³µí†µ: ìë™ì±„ì›€(/api/autofill)
         * ========================= */
        let __AUTOFILL_CACHE__ = null;
        async function getAutofill(){
            if (__AUTOFILL_CACHE__) return __AUTOFILL_CACHE__;
            const r = await fetch('/api/autofill', { credentials:'include' });
            if (!r.ok) throw new Error('autofill api failed');
            __AUTOFILL_CACHE__ = await r.json(); // { name, phone, residentMasked, bankName, accountMasked }
            return __AUTOFILL_CACHE__;
        }

        async function applyAutofillToForeign3(){
            try{
                const d = await getAutofill();
                const nameEl = document.getElementById('extractedName');
                const rrnEl  = document.getElementById('extractedResidentId');

                if (nameEl && d.name) nameEl.value = d.name;

                // ì£¼ë¯¼ë²ˆí˜¸ëŠ” ë§ˆìŠ¤í‚¹ë§Œ ë³´ì—¬ì£¼ê³  ì œì¶œ ê¸ˆì§€
                if (rrnEl && d.residentMasked){
                    rrnEl.value = d.residentMasked;
                    rrnEl.readOnly = true;
                    rrnEl.disabled = true;       // form ì œì¶œ ì°¨ë‹¨
                    rrnEl.removeAttribute('name');
                    rrnEl.setAttribute('autocomplete','off');
                }

                // ì •ë³´ ì„¹ì…˜ ë…¸ì¶œ(ì´¬ì˜ ì „ì—ë„ ì‚¬ìš©ì í™•ì¸ ê°€ëŠ¥)
                const section  = document.getElementById('extractedInfoSection');
                const content  = document.getElementById('extractedInfoContent');
                const titleHdr = document.getElementById('extractedInfoTitle');
                if (section && content && titleHdr){
                    section.classList.remove('hidden');
                    content.classList.remove('collapsed');
                    titleHdr.classList.add('rotated');
                }
            }catch(e){
                console.warn('autofill ì‹¤íŒ¨', e);
            }
        }

        /* =========================
         *  ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ (í•„ìš” ë³€ìˆ˜)
         * ========================= */
        const homeButton = document.querySelector('header a');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');

        // ì‹ ë¶„ì¦ ì´¬ì˜ ì„¹ì…˜ ê´€ë ¨ ìš”ì†Œ
        const idCardSection = document.getElementById('idCardSection');
        const idCardTitle = document.getElementById('idCardTitle');
        const idCardCheckmark = document.getElementById('idCardCheckmark');
        const idCardToggleIcon = document.getElementById('idCardToggleIcon');
        const idCardContent = document.getElementById('idCardContent');

        const idCardFrame = document.getElementById('idCardFrame');
        const cameraFeed = document.getElementById('cameraFeed');
        const previewImage = document.getElementById('previewImage');
        const captureOverlay = document.getElementById('captureOverlay');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        
        const actionButtonsDiv = document.getElementById('actionButtons');
        const captureButton = document.getElementById('captureButton'); 
        const confirmButton = document.getElementById('confirmButton'); 
        const retakeButton = document.getElementById('retakeButton');   
        
        // ì¶”ì¶œëœ ì •ë³´ ì„¹ì…˜ ê´€ë ¨ ìš”ì†Œ
        const extractedInfoSection = document.getElementById('extractedInfoSection');
        const extractedInfoTitle = document.getElementById('extractedInfoTitle');
        const theExtractedInfoCheckmark = document.getElementById('extractedInfoCheckmark');
        const extractedInfoToggleIcon = document.getElementById('extractedInfoToggleIcon');
        const extractedInfoContent = document.getElementById('extractedInfoContent');

        const extractedNameInput = document.getElementById('extractedName');
        const extractedResidentIdInput = document.getElementById('extractedResidentId'); 
        const confirmInfoButton = document.getElementById('confirmInfoButton'); 

        // ìŒì„± ì•ˆë‚´ ìš”ì†Œ
        const voiceBtn = document.getElementById('voiceGuideBtn');
        const voiceIconPlay = document.getElementById('voiceIconPlay');
        const voiceIconStop = document.getElementById('voiceIconStop');
        const voiceLabel = document.getElementById('voiceLabel');
        const voicePanel = document.getElementById('voicePanel');
        const voiceCloseBtn = document.getElementById('voiceCloseBtn');
        const voiceReplayBtn = document.getElementById('voiceReplayBtn');

        // ë¡œë”©/í† ìŠ¤íŠ¸
        const loadingOverlay = document.getElementById('loadingOverlay');
        const toast = document.getElementById('toast');
        function showLoading(on){ loadingOverlay.classList.toggle('open', !!on); }
        function showToast(msg){ toast.textContent = msg; toast.classList.add('open'); setTimeout(()=>toast.classList.remove('open'), 2500); }

        // ìƒíƒœ ë³€ìˆ˜
        let idCardPhotoConfirmed = false;
        let extractedInfoConfirmed = false;
        let cameraStream = null;

        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
                cameraFeed.srcObject = stream;
                cameraFeed.play();
                cameraFeed.style.display = 'block';
                captureOverlay.classList.add('hidden');
                cameraStream = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                cameraFeed.style.display = 'none';
                captureOverlay.classList.remove('hidden');
                showToast('ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            }
        }

        // ìŠ¤ëƒ…ìƒ·
        function takeSnapshot() {
            if (!cameraStream || cameraFeed.style.display === 'none') {
                alert('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            hiddenCanvas.width = cameraFeed.videoWidth;
            hiddenCanvas.height = cameraFeed.videoHeight;
            const context = hiddenCanvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, hiddenCanvas.width, hiddenCanvas.height);

            // ì¹´ë©”ë¼ ì •ì§€
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraFeed.srcObject = null;
                cameraStream = null;
            }

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            previewImage.src = hiddenCanvas.toDataURL('image/png');
            previewImage.style.display = 'block';
            cameraFeed.style.display = 'none';

            idCardPhotoConfirmed = false;
            updateNextButtonState();

            // ë²„íŠ¼ ì „í™˜
            captureButton.classList.add('hidden');
            confirmButton.classList.remove('hidden');
            retakeButton.classList.remove('hidden');
            confirmButton.disabled = false;
            confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            confirmButton.classList.add('bg-blue-600', 'hover:bg-blue-700');

            // ğŸ” OCR ì‚¬ìš© ì—¬ë¶€
            if (USE_OCR) {
                ocrViaServer(previewImage.src);
            } else {
                // OCR ë¯¸ì‚¬ìš©: ì •ë³´ ì„¹ì…˜ë§Œ ì—´ì–´ì£¼ê³ , ìë™ì±„ì›€ ì¬ì ìš©(í˜¹ì‹œ ì´¬ì˜ ì „ ë¯¸ì ìš© ëŒ€ë¹„)
                applyAutofillToForeign3().then(()=>{
                    showToast('ì´¬ì˜ ì™„ë£Œ: ì •ë³´ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
                });
            }
        }

        // ì´ˆê¸° UI
        function initializeUI() {
            idCardContent.classList.remove('collapsed');
            idCardTitle.classList.add('rotated');

            extractedInfoSection.classList.add('hidden');
            extractedInfoContent.classList.add('collapsed'); 
            theExtractedInfoCheckmark.style.display = 'none';

            startCamera(); 

            captureButton.classList.remove('hidden');
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');

            updateNextButtonState(); 
        }

        // ì•„ì½”ë””ì–¸ í† ê¸€
        function toggleAccordion(contentElement, titleElement, toggleIconElement, sectionBlockElement) {
            if (sectionBlockElement.classList.contains('confirmed')) return;
            contentElement.classList.toggle('collapsed');
            titleElement.classList.toggle('rotated');
            if (contentElement.classList.contains('collapsed')) toggleIconElement.classList.remove('rotated');
            else toggleIconElement.classList.add('rotated');
        }

        // ì´ë²¤íŠ¸
        idCardFrame.addEventListener('click', () => {
            if (cameraFeed.style.display === 'block') takeSnapshot();
        });
        captureButton.addEventListener('click', (event) => {
            event.stopPropagation(); 
            takeSnapshot();
        });
        retakeButton.addEventListener('click', () => {
            idCardPhotoConfirmed = false;
            extractedInfoConfirmed = false;
            updateNextButtonState();

            previewImage.src = "#";
            previewImage.style.display = 'none';
            
            extractedInfoSection.classList.add('hidden'); 
            extractedInfoContent.classList.add('collapsed'); 
            extractedInfoTitle.classList.remove('rotated'); 
            theExtractedInfoCheckmark.style.display = 'none'; 
            extractedNameInput.value = '';
            extractedResidentIdInput.value = '';

            captureButton.classList.remove('hidden');
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');

            extractedNameInput.disabled = false;
            extractedResidentIdInput.disabled = false;
            confirmInfoButton.disabled = false; 

            idCardContent.classList.remove('collapsed');
            idCardTitle.classList.add('rotated');
            idCardCheckmark.style.display = 'none'; 
            idCardSection.classList.remove('confirmed'); 

            startCamera();
            // ì¬ì´¬ì˜ ì‹œì—ë„ ìë™ì±„ì›€ ë‹¤ì‹œ ì ìš©
            applyAutofillToForeign3();
        });

        // "í™•ì¸" í´ë¦­: ì´¬ì˜ ì™„ë£Œ ì²˜ë¦¬ + ì •ë³´ ì„¹ì…˜ ì˜¤í”ˆ
        confirmButton.addEventListener('click', () => {
            idCardPhotoConfirmed = true; 
            updateNextButtonState(); 
            idCardCheckmark.style.display = 'inline-block'; 
            idCardSection.classList.add('confirmed'); 
            confirmButton.classList.add('hidden');
            retakeButton.classList.add('hidden');
            setTimeout(() => {
                idCardContent.classList.add('collapsed'); 
                idCardTitle.classList.remove('rotated'); 
                extractedInfoSection.classList.remove('hidden'); 
                extractedInfoContent.classList.remove('collapsed');
                extractedInfoTitle.classList.add('rotated');
                extractedInfoSection.classList.remove('confirmed'); 
                theExtractedInfoCheckmark.style.display = 'none'; 
                confirmInfoButton.classList.remove('hidden');
                confirmInfoButton.disabled = false;
                confirmInfoButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmInfoButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 600);
        });

        // ì •ë³´ í™•ì¸ ë²„íŠ¼
        confirmInfoButton.addEventListener('click', () => {
            if (!extractedNameInput.value.trim() || !extractedResidentIdInput.value.trim()) {
                alert('ì„±ëª…ê³¼ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ë¥¼ ëª¨ë‘ í™•ì¸í•´ ì£¼ì„¸ìš”.');
                return;
            }
            extractedInfoConfirmed = true; 
            updateNextButtonState(); 
            theExtractedInfoCheckmark.style.display = 'inline-block';
            extractedInfoSection.classList.add('confirmed'); 
            extractedNameInput.disabled = true;
            extractedResidentIdInput.disabled = true;
            confirmInfoButton.disabled = true;
            confirmInfoButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            confirmInfoButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            setTimeout(() => {
                extractedInfoContent.classList.add('collapsed');
                extractedInfoTitle.classList.remove('rotated'); 
            }, 600);
        });

        // === (ì„ íƒ) ì„œë²„ OCR í˜¸ì¶œ ===
        async function ocrViaServer(dataUrl){
            try{
                showLoading(true);
                const res = await fetch('/api/ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageDataUrl: dataUrl })
                });
                if(!res.ok){
                    const t = await res.text();
                    throw new Error(t || 'OCR ìš”ì²­ ì‹¤íŒ¨');
                }
                const json = await res.json();
                if(json.name){ extractedNameInput.value = json.name; }
                if(json.residentId){ extractedResidentIdInput.value = json.residentId; }

                extractedInfoSection.classList.remove('hidden');
                extractedInfoContent.classList.remove('collapsed');
                extractedInfoTitle.classList.add('rotated');

                if(!json.name && !json.residentId){
                    showToast('ì¸ì‹ë¥ ì´ ë‚®ì•„ìš”. ê°’ì„ í™•ì¸/ìˆ˜ì •í•´ ì£¼ì„¸ìš”.');
                }else{
                    showToast('OCR ì™„ë£Œ: ê°’ì´ ì±„ì›Œì¡Œì–´ìš”. í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                }

                try{
                    localStorage.setItem('extractedUserInfo', JSON.stringify({
                        name: extractedNameInput.value || '',
                        residentId: extractedResidentIdInput.value || '',
                        raw: json.rawText || ''
                    }));
                }catch(e){}
            }catch(e){
                console.error(e);
                showToast('OCR ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” í• ë‹¹ëŸ‰ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            }finally{
                showLoading(false);
            }
        }

        // ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ
        function updateNextButtonState() {
            if (idCardPhotoConfirmed && extractedInfoConfirmed) {
                nextButton.disabled = false;
                nextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                nextButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }
        
        // ë‚´ë¹„ê²Œì´ì…˜
        homeButton.addEventListener('click', function(event) {
            event.preventDefault();
            Voice.cancel();
            window.location.href = '/foreign';
        });
        prevButton.addEventListener('click', function() {
            Voice.cancel();
            window.location.href = '/foreign2'; 
        });
        nextButton.addEventListener('click', function() {
            if (idCardPhotoConfirmed && extractedInfoConfirmed) {
                Voice.cancel();
                window.location.href = '/foreign4'; 
            } else {
                alert('ëª¨ë“  ì‹ ë¶„ì¦ ê´€ë ¨ ì ˆì°¨ë¥¼ ì™„ë£Œí•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); 
            }
        });
        idCardTitle.addEventListener('click', () => {
            toggleAccordion(idCardContent, idCardTitle, idCardToggleIcon, idCardSection);
        });
        extractedInfoTitle.addEventListener('click', () => {
            toggleAccordion(extractedInfoContent, extractedInfoTitle, extractedInfoToggleIcon, extractedInfoSection);
        });

        // ì´ˆê¸°í™” + ìë™ì±„ì›€ ì ìš©
        document.addEventListener('DOMContentLoaded', () => {
            initializeUI();
            applyAutofillToForeign3();
        });

        /* ===== ìŒì„± ì•ˆë‚´ (Web Speech + ë„¤ì´í‹°ë¸Œ ë¸Œë¦¿ì§€) ===== */
        const Voice = (function(){
            let speaking = false;
            let queue = [];
            let current = null;

            const hasWebSpeech = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
            const hasAndroid = !!window.AndroidTTS?.speak;
            const hasIOS = !!(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.tts);

            function useNativeSpeak(text){
                const r = 1.0;
                if(hasAndroid){
                    try{ window.AndroidTTS.speak(String(text), r); return true; }catch(e){ console.warn(e); }
                }
                if(hasIOS){
                    try{ window.webkit.messageHandlers.tts.postMessage({action:'speak', text:String(text), rate:r}); return true; }catch(e){ console.warn(e); }
                }
                return false;
            }
            function useNativeStop(){
                if(hasAndroid){
                    try{ window.AndroidTTS.stop(); return true; }catch(e){ console.warn(e); }
                }
                if(hasIOS){
                    try{ window.webkit.messageHandlers.tts.postMessage({action:'stop'}); return true; }catch(e){ console.warn(e); }
                }
                return false;
            }

            function speakWeb(text, onend){
                const u = new SpeechSynthesisUtterance(String(text));
                u.lang = 'ko-KR';
                u.rate = 1.0;
                u.onend = onend || null;
                u.onerror = function(){ console.warn('TTS error'); onend && onend(); };
                window.speechSynthesis.speak(u);
            }

            function nextInQueue(){
                if(queue.length === 0){ current = null; speaking = false; setUI(false); return; }
                current = queue.shift();
                if(useNativeSpeak(current)){
                    speaking = true; setUI(true);
                    const approx = Math.max(1500, current.length * 60);
                    setTimeout(()=>{ nextInQueue(); }, approx);
                }else if(hasWebSpeech){
                    speaking = true; setUI(true);
                    speakWeb(current, ()=> nextInQueue());
                }else{
                    speaking = false; setUI(false);
                }
            }

            function setUI(isOn){
                voiceBtn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
                voiceIconPlay.classList.toggle('hidden', isOn);
                voiceIconStop.classList.toggle('hidden', !isOn);
                voiceLabel.textContent = isOn ? 'ìŒì„± ì•ˆë‚´ ë„ê¸°' : 'ìŒì„± ì•ˆë‚´ ì¼œê¸°';
                voiceBtn.setAttribute('aria-label', voiceLabel.textContent);
                voiceBtn.setAttribute('title', voiceLabel.textContent);
            }

            function start(scriptLines){
                if(speaking) cancel();
                queue = Array.isArray(scriptLines) ? scriptLines.slice() : [String(scriptLines||'')];
                nextInQueue();
            }
            function cancel(){
                queue = [];
                current = null;
                speaking = false;
                useNativeStop();
                if(('speechSynthesis' in window)){ try{ window.speechSynthesis.cancel(); }catch(e){} }
                setUI(false);
            }
            function toggle(scriptLines){
                if(speaking){ cancel(); }
                else{ start(scriptLines); }
            }
            return { start, cancel, toggle, isSpeaking:()=>speaking };
        })();

        function buildVoiceScript(){
            const line1 = 'ì•ˆë‚´: ì£¼ë¯¼ë“±ë¡ì¦ì„ ë„¤ëª¨ ì¹¸ì— ë§ì¶˜ ë’¤, ì´¬ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.';
            const line2 = 'ì‚¬ì§„ì„ í™•ì¸í•˜ê³  ì •ë³´ê°€ ë§ìœ¼ë©´, ì •ë³´ í™•ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.';
            const line3 = 'ëª¨ë“  ì ˆì°¨ê°€ ëë‚˜ë©´ í•˜ë‹¨ì˜ ë‹¤ìŒìœ¼ë¡œ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.';
            return [line1, line2, line3];
        }

        voiceBtn.addEventListener('click', function(){
            voicePanel.classList.toggle('open');
            Voice.toggle(buildVoiceScript());
        });
        voiceCloseBtn.addEventListener('click', function(){
            voicePanel.classList.remove('open');
        });
        voiceReplayBtn.addEventListener('click', function(){
            Voice.start(buildVoiceScript());
        });

        document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ Voice.cancel(); } });
        window.addEventListener('pagehide', ()=> Voice.cancel());
        
        async function getAutofill(){
        	  const r = await fetch('/api/autofill', { credentials: 'include' });
        	  if (r.status === 401) return {};        // ë¹„ë¡œê·¸ì¸/ì„¸ì…˜ì—†ìŒ
        	  if (!r.ok) throw new Error('autofill api failed');
        	  return r.json();                         // {name, phone, residentMasked}
        	}

        	// foreign3 ì±„ìš°ê¸°: ì´ë¦„ + ì£¼ë¯¼ë²ˆí˜¸(ë§ˆìŠ¤í‚¹ë§Œ, ì œì¶œ ì°¨ë‹¨)
        	async function applyAutofillToForeign3(){
        	  try {
        	    const d = await getAutofill();

        	    const nameEl = document.getElementById('extractedName');
        	    if (nameEl && d.name) nameEl.value = d.name;

        	    const rrnEl  = document.getElementById('extractedResidentId');
        	    if (rrnEl && d.residentMasked){
        	      rrnEl.value = d.residentMasked;
        	      rrnEl.readOnly = true;          // ìˆ˜ì • ë¶ˆê°€
        	      rrnEl.disabled = true;          // í¼ ì œì¶œ ì°¨ë‹¨
        	      rrnEl.removeAttribute('name');  // í˜¹ì‹œ name ìˆìœ¼ë©´ ì œê±°
        	      rrnEl.setAttribute('autocomplete','off');
        	    }

        	    // ì•„ì½”ë””ì–¸/ì„¹ì…˜ì´ ì ‘í˜€ ìˆìœ¼ë©´ ë³´ì—¬ì£¼ê¸°(ìˆì„ ë•Œë§Œ)
        	    const sec = document.getElementById('extractedInfoSection');
        	    const cont= document.getElementById('extractedInfoContent');
        	    const ttl = document.getElementById('extractedInfoTitle');
        	    if (sec && cont && ttl){
        	      sec.classList.remove('hidden');
        	      cont.classList.remove('collapsed');
        	      ttl.classList.add('rotated');
        	    }
        	  } catch(e){
        	    console.warn('autofill ì‹¤íŒ¨', e);
        	  }
        	}

        	document.addEventListener('DOMContentLoaded', applyAutofillToForeign3);
    </script>
</body>
</html>
