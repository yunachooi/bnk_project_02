<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#ffffff"/>
  <title>BNK ì‡¼í•‘í™˜ì „í†µì¥ - ì¹´ë“œ ë°œê¸‰ ì‹ ì²­</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- ë‹¤ìŒ(ì¹´ì¹´ì˜¤) ìš°í¸ë²ˆí˜¸ API -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <style>
    :root{ --bottom-bar-h:72px; --vh:1vh; }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;}
    body{
      font-family:'Inter',sans-serif; background:#f0f4f8; margin:0; padding:0; overflow-x:hidden; color:#111827;
      font-size:16px; line-height:1.5;
    }

    .container{ width:100%; background:#fff; min-height:100dvh; min-height:calc(var(--vh,1vh)*100); display:flex; flex-direction:column; overflow:hidden; }

    /* Header */
    header{ position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid #e5e7eb; }
    .header-bar{ position:relative; display:flex; align-items:center; justify-content:space-between; padding:.75rem 1rem; }
    .header-back{ display:flex; align-items:center; gap:.25rem; color:#ef4444; font-weight:800; text-decoration:none; padding:.25rem .375rem; border-radius:.5rem;}
    .header-back svg{ width:20px; height:20px; }
    .header-title{ font-size:1.15rem; font-weight:800; }

    /* Sticky: step + encouragement */
    .sticky-top-wrap{ position:sticky; top:48px; z-index:40; background:#fff; padding:.5rem 1rem .5rem; border-bottom:1px solid #eef2f7; }
    .step-indicator{ display:flex; width:100%; height:4px; background:#e5e7eb; margin:0 0 .5rem; }
    .step-indicator-progress{ width:50%; height:100%; background:#ef4444; }

    /* Main */
    .main-content{
      flex:1 1 auto; padding:.75rem 1rem 1rem; display:flex; flex-direction:column; gap:.75rem;
      overflow-y:auto; max-width:40rem; margin:0 auto; width:100%;
      padding-bottom:calc(var(--bottom-bar-h) + env(safe-area-inset-bottom,0px) + 12px);
    }

    /* Accordion */
    .accordion-section{ background:#fff; border:1px solid #eef2f7; border-radius:.75rem; box-shadow:0 4px 12px rgba(0,0,0,.05); overflow:hidden; scroll-margin-top:140px; }
    .accordion-header{ padding:.9rem 1rem; border-bottom:1px solid #eef2f7; display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:1.1rem; cursor:pointer; }
    .accordion-header svg{ transition:transform .25s; }
    .accordion-header.active svg{ transform:rotate(180deg); }
    .accordion-section .checkmark{ display:none; color:#10b981; font-size:1.1rem; margin-left:.5rem; }
    .accordion-section.confirmed .checkmark{ display:inline-block; }
    .accordion-section.confirmed .accordion-header .toggle-icon{ display:none; }
    .accordion-section.confirmed .accordion-header{ cursor:default; }

    /* Smooth open/close */
    .accordion-content{
      overflow:hidden;
      max-height:0;
      transition:max-height .35s ease, opacity .25s ease;
      opacity:0;
      border-top:1px solid #eef2f7;
      padding:0 1rem;
    }
    .accordion-content.open{ opacity:1; padding:.75rem 1rem; }

    /* Form cards */
    .form-section-card{ background:#fff; border:1px solid #eef2f7; border-radius:.75rem; padding:1.25rem 1rem; margin-bottom:.75rem; box-shadow:0 2px 8px rgba(0,0,0,.05); display:flex; flex-direction:column; gap:1rem; }
    .form-group{ margin-bottom:.75rem; }
    .form-group label{ display:block; font-size:.9rem; font-weight:800; color:#374151; margin-bottom:.4rem; }
    .form-group input,.form-group select{ width:100%; padding:.7rem 1rem; border:1px solid #d1d5db; border-radius:.5rem; font-size:1rem; background:#f9fafb; color:#111827; }
    .form-group input:focus,.form-group select:focus{ outline:none; border-color:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.2); }
    .radio-group{ display:flex; gap:1rem; flex-wrap:nowrap; }
    .radio-group label{ display:flex; align-items:center; gap:.4rem; font-weight:800; white-space:nowrap; }
    .radio-group input{ transform:scale(1.2); accent-color:#ef4444; }

    /* Card slider centered */
    .card-slider-wrapper{ position:relative; width:100%; overflow:hidden; border-radius:.75rem; background:#f9fafb; padding:.75rem; box-shadow:inset 0 0 0 1px rgba(0,0,0,0.05); }
    .card-slider{
      --slide-w: 260px;
      display:flex; overflow-x:auto; gap:.75rem; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;
      padding:0 calc((100% - var(--slide-w))/2);
      justify-content:flex-start; align-items:center;
    }
    .card-slider::-webkit-scrollbar{ display:none; }
    .card-slide-item{ flex:0 0 var(--slide-w); scroll-snap-align:center; display:flex; flex-direction:column; align-items:center; padding:.6rem; border-radius:.75rem; border:2px solid transparent; transition:.2s; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.08); user-select:none; }
    .card-slide-item.selected{ border-color:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.35); background:#ffebeb; }
    .card-slide-item img{ width:100%; height:150px; border-radius:.5rem; object-fit:cover; margin-bottom:.5rem; cursor:pointer; }
    .card-slide-item span{ font-size:.95rem; font-weight:800; color:#374151; text-align:center; }
    .slider-buttons{ display:flex; justify-content:center; gap:.75rem; margin-top:.6rem; }
    .slider-buttons button{ padding:.7rem 1.2rem; border-radius:.6rem; font-weight:800; font-size:.95rem; background:#ef4444; color:#fff; border:none; transition:.2s; }
    .slider-buttons button:hover{ background:#dc2626; }
    .slider-buttons button:disabled{ background:#9ca3af; cursor:not-allowed; }
    .slider-arrow{ position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,.35); color:#fff; border:none; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:10; font-size:1.2rem; font-weight:bold; transition:.2s;}
    .slider-arrow:hover{ background:rgba(0,0,0,.5); }
    .slider-arrow.left{ left:.25rem; }
    .slider-arrow.right{ right:.25rem; }

    /* Bottom bar */
    .bottom-bar{ position:sticky; bottom:0; left:0; right:0; flex:none; width:100%; background:#fff; border-top:1px solid #e2e8f0; padding:.5rem 1rem; padding-bottom:calc(.5rem + env(safe-area-inset-bottom,0px)); box-shadow:0 -4px 12px rgba(0,0,0,.03); display:flex; justify-content:space-around; gap:.5rem; z-index:60; }
    .bottom-bar button{ flex:1; padding:.9rem 1rem; border-radius:.9rem; font-weight:800; font-size:1rem; transition:background-color .2s, transform .15s; box-shadow:0 2px 6px rgba(0,0,0,.08); border:none; user-select:none; }
    .bottom-bar button:active{ transform:scale(.98); }

    /* Modals (common) */
    .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:1000; opacity:0; visibility:hidden; transition:opacity .25s, visibility .25s; padding:1rem; }
    .modal-overlay.show{ opacity:1; visibility:visible; }
    .modal-content{ background:#fff; border-radius:.9rem; box-shadow:0 8px 24px rgba(0,0,0,.2); max-width:430px; width:96vw; transform:translateY(-12px); transition:transform .25s; }
    .modal-overlay.show .modal-content{ transform:translateY(0); }
    .modal-header-like{ display:flex; align-items:center; justify-content:space-between; padding:.9rem 1rem; border-bottom:1px solid #e5e7eb; font-weight:800; }
    .modal-title{ text-align:center; font-weight:800; font-size:1.05rem; }
    .modal-body{ padding:1rem; }
    .modal-footer{ padding:.8rem 1rem; border-top:1px solid #e5e7eb; display:flex; justify-content:center; gap:.5rem; }
    .close-x{ background:none; border:none; font-size:1.25rem; color:#9ca3af; cursor:pointer; }
    .close-x:hover{ color:#4b5563; }
    .modal-button{ display:block; width:100%; background:#ef4444; color:#fff; font-weight:800; padding:.75rem 1rem; border-radius:.6rem; border:none; cursor:pointer; transition:.2s; }
    .modal-button:hover{ background:#dc2626; }

    /* Terms modal specific */
    .terms-page{ display:none; flex-direction:column; }
    .terms-page.active{ display:flex; }
    .summary-scroll{ padding:1rem; }
    .summary-list{ list-style:none; padding:0; margin:0; }
    .summary-list li{ background:#fff; border:2px solid #ef4444; border-radius:.75rem; padding:.9rem; margin-bottom:.7rem; color:#4b5563; line-height:1.5; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .summary-num{ font-weight:800; color:#111827; margin-right:.45rem; }
    .summary-title{ font-weight:800; color:#111827; }
    .pdf-viewer-iframe{ width:100%; height:60vh; border:1px solid #e0e0e0; border-radius:.5rem; background:#fff; }

    /* ê³µí†µ ê²½ê³  */
    .inline-warning{ margin-top:.25rem; color:#ef4444; font-weight:500; font-size:.9rem; line-height:1.35; text-align:center; }
    .inline-warning--modal{ margin-top:.5rem; }

    /* Image preview modal */
    .image-modal .modal-content{ background:rgba(0,0,0,.92); max-width:900px; width:96vw; color:#fff; border-radius:.6rem; }
    .image-modal .modal-header-like{ border-bottom:none; }
    .image-stage{ width:100%; height:80vh; max-height:80vh; display:flex; align-items:center; justify-content:center; overflow:auto; }
    #zoomImg{ max-width:95vw; max-height:80vh; object-fit:contain; border-radius:.5rem; transform-origin:center center; transition:transform .15s ease; }
    .image-caption{ text-align:center; padding:.25rem .75rem 1rem; color:#e5e7eb; font-weight:700; }

    /* ===== ìŒì„± ì•ˆë‚´: íŒ¨ë„ ===== */
    .voice-panel{
      position:absolute; right:.25rem; top:2.9rem; width:300px; background:#fff;
      border:1px solid #e5e7eb; border-radius:.75rem; box-shadow:0 10px 20px rgba(0,0,0,.08);
      padding:.75rem; z-index:80; display:none;
    }
    .voice-panel.open{display:block}

    @media (max-width:420px){
      body{font-size:15px;}
      .pdf-viewer-iframe{ height:56vh; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div class="header-bar">
        <a href="/foreign" class="header-back">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
          </svg>
          í™ˆìœ¼ë¡œ
        </a>

        <!-- ê°€ìš´ë° ì •ë ¬ ì œëª© -->
        <h1 class="header-title absolute left-1/2 -translate-x-1/2 m-0">ì¹´ë“œ ë°œê¸‰ ì‹ ì²­</h1>

        <!-- ìš°ì¸¡ ìƒë‹¨: ìŒì„± ì•ˆë‚´ ë²„íŠ¼ + íŒ¨ë„ -->
        <div class="relative ml-auto">
          <button id="voiceGuideBtn"
                  class="px-2 py-1 rounded-full text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center gap-1"
                  aria-pressed="false"
                  aria-label="ìŒì„± ì•ˆë‚´ ì¼œê¸°"
                  title="ìŒì„± ì•ˆë‚´ ì¼œê¸°">
            <!-- Play -->
            <svg id="voiceIconPlay" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M3 10v4a1 1 0 001 1h3l3.293 3.293A1 1 0 0011 18v-12a1 1 0 00-1.707-.707L7 8H4a1 1 0 00-1 1zm13.586-3.414a1 1 0 10-1.414 1.414A5.969 5.969 0 0117 12c0 1.657-.672 3.157-1.828 4.243a1 1 0 101.414 1.414A7.968 7.968 0 0019 12a7.968 7.968 0 00-2.414-5.414z"/>
            </svg>
            <!-- Stop -->
            <svg id="voiceIconStop" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M6 6h12v12H6z"/>
            </svg>
            <span id="voiceLabel" class="text-xs font-semibold">ìŒì„± ì•ˆë‚´ ì¼œê¸°</span>
          </button>

          <!-- íŒ¨ë„ -->
          <div id="voicePanel" class="voice-panel" role="dialog" aria-label="ìŒì„± ì•ˆë‚´ ì„¤ì •">
            <div class="mb-2 flex items-center justify-between">
              <p class="text-sm font-semibold text-gray-800">ìŒì„± ì•ˆë‚´</p>
              <button id="voiceCloseBtn" class="text-gray-500 hover:text-gray-700 text-xs px-2 py-1 rounded" aria-label="ì„¤ì • ë‹«ê¸°">ë‹«ê¸°</button>
            </div>
            <div class="mb-3 text-xs text-gray-700 leading-5">
              <p class="mb-1"><span class="font-semibold">ì¹´ë“œ ê°€ì… ë°©ë²•ê³¼ ê´€ë ¨ëœ ê°„ë‹¨í•œ ì„¤ëª…</span>ì„ ìŒì„±ìœ¼ë¡œ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.</p>
            </div>
            <div class="flex">
              <button id="voiceReplayBtn" class="flex-1 bg-red-500 text-white rounded-md px-3 py-2 text-sm font-semibold hover:bg-red-600">ë‹¤ì‹œ ë“£ê¸°</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Sticky progress + encouragement -->
    <div class="sticky-top-wrap">
      <div class="step-indicator"><div class="step-indicator-progress"></div></div>
      <div id="encouragementMessage" class="text-center text-base font-semibold text-gray-700 p-3 rounded-lg bg-yellow-100 mx-0 mt-2 shadow-sm">
        ì¹´ë“œ ë°œê¸‰ ì‹ ì²­ë§Œ í•˜ë©´ ëì´ì—ìš”!<br>ì¡°ê¸ˆë§Œ ë” í˜ë‚´ìš”. ğŸ˜Š
      </div>
    </div>

    <!-- Main -->
    <main class="main-content">
      <!-- ì¹´ë“œ ë””ìì¸ -->
      <section id="cardDesignSection" class="accordion-section">
        <div class="accordion-header" data-accordion="card-design">
          <span>ì¹´ë“œ ë””ìì¸ ì„ íƒ <span id="cardDesignCheckmark" class="checkmark">âœ”</span></span>
          <svg class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
        </div>
        <div class="accordion-content" id="card-design-content">
          <div class="card-slider-wrapper">
            <button class="slider-arrow left" id="slideLeftBtn">&lt;</button>
            <div class="card-slider" id="cardSlider">
              <div class="card-slide-item" data-card-id="card-a">
                <img src="images/option1.png" alt="BNKì‡¼í•‘í™˜ì „ì²´í¬ì¹´ë“œ A">
                <span>BNKì‡¼í•‘í™˜ì „ì²´í¬ì¹´ë“œ A</span>
              </div>
              <div class="card-slide-item" data-card-id="card-b">
                <img src="images/option2.png" alt="BNKì‡¼í•‘í™˜ì „ì²´í¬ì¹´ë“œ B">
                <span>BNKì‡¼í•‘í™˜ì „ì²´í¬ì¹´ë“œ B</span>
              </div>
              <div class="card-slide-item" data-card-id="card-c">
                <img src="images/option3.png" alt="BNKì‡¼í•‘í™˜ì „ì²´í¬ì¹´ë“œ C">
                <span>BNKì‡¼í•‘í™˜ì „ì²´í¬ì¹´ë“œ C</span>
              </div>
            </div>
            <button class="slider-arrow right" id="slideRightBtn">&gt;</button>
          </div>
          <div class="slider-buttons">
            <button id="selectCardBtn">ì„ íƒ</button>
          </div>
          <div id="cardWarning" class="inline-warning" style="display:none;"></div>
        </div>
      </section>

      <!-- ê³ ê° ì •ë³´ -->
      <section id="customerInfoSection" class="accordion-section">
        <div class="accordion-header" data-accordion="customer-info">
          <span>ê³ ê° ì •ë³´ ì¶”ê°€ í™•ì¸ <span id="customerInfoCheckmark" class="checkmark">âœ”</span></span>
          <svg class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
        </div>
        <div class="accordion-content" id="customer-info-content">
          <div class="form-section-card">
            <div class="form-group mb-0">
              <label for="english-name">ì˜ë¬¸ëª… ì´ë¦„ ì…ë ¥</label>
              <input type="text" id="english-name" placeholder="ì˜ˆ: HONG GILDONG" class="w-full uppercase" />
              <div id="englishWarn" class="inline-warning" style="display:none;"></div>
            </div>
          </div>

          <div class="form-section-card mt-3">
            <div class="form-group mb-0">
              <label for="occupation">ì§ì—… êµ¬ë¶„</label>
              <select id="occupation" class="w-full">
                <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
                <option value="ìì˜ì—…">ìì˜ì—…</option>
                <option value="í•™ìƒ">í•™ìƒ</option>
                <option value="ì£¼ë¶€">ì£¼ë¶€</option>
                <option value="ë¬´ì§">ë¬´ì§</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
              </select>
            </div>
          </div>

          <div class="form-section-card mt-3">
            <div class="form-group mb-0">
              <label>ë³¸ì¸ì˜ ìê¸ˆì¸ê°€ìš”?</label>
              <div class="radio-group">
                <label><input type="radio" name="own-funds" value="yes" id="own-funds-yes"> ì˜ˆ</label>
                <label><input type="radio" name="own-funds" value="no" id="own-funds-no"> ì•„ë‹ˆì˜¤</label>
              </div>
            </div>
          </div>

          <!-- ì£¼ì†Œ ì…ë ¥ -->
          <div class="form-section-card mt-3">
            <div class="form-group">
              <label>ì¹´ë“œ ìˆ˜ë ¹ë°›ì„ ì£¼ì†Œ</label>
              <div class="flex gap-2">
                <input id="postalCode" type="text" class="flex-1" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                <button id="findAddressBtn" type="button" class="modal-button" style="width:auto;">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
              </div>
            </div>
            <div class="form-group">
              <label for="baseAddress">ê¸°ë³¸ì£¼ì†Œ</label>
              <input id="baseAddress" type="text" placeholder="ì˜ˆ: ë¶€ì‚°ê´‘ì—­ì‹œ OOêµ¬ OOë¡œ 123" readonly>
            </div>
            <div class="form-group">
              <label for="detailAddress">ìƒì„¸ì£¼ì†Œ</label>
              <input id="detailAddress" type="text" placeholder="ì˜ˆ: 101ë™ 1001í˜¸">
            </div>
            <button id="addressDoneBtn" class="modal-button" style="width:auto;">ì£¼ì†Œ ì…ë ¥ ì™„ë£Œ</button>
            <div id="customerInfoWarning" class="inline-warning" style="display:none;"></div>
          </div>
        </div>
      </section>

      <!-- ì•½ê´€ ë™ì˜ -->
      <section id="termsDocsSection" class="accordion-section">
        <div class="accordion-header" data-accordion="terms-docs">
          <span>ì¹´ë“œ ì‹ ì²­ ì•½ê´€ ë™ì˜ <span id="termsDocsCheckmark" class="checkmark">âœ”</span></span>
          <svg class="toggle-icon h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
        </div>
        <div class="accordion-content" id="terms-docs-content">
          <div class="form-group">
            <button id="openTermsModalBtn" class="w-full modal-button">ì•½ê´€ ë° ì„¤ëª…ì„œ ë™ì˜</button>
            <div id="termsWarning" class="inline-warning" style="display:none;"></div>
          </div>
        </div>
      </section>
    </main>

    <!-- Bottom -->
    <footer class="bottom-bar">
      <button id="prevButton" class="bg-gray-200 text-gray-700 hover:bg-gray-300">ì´ì „</button>
      <button id="nextButton" class="bg-gray-400 text-white cursor-not-allowed" disabled>ë‹¤ìŒìœ¼ë¡œ</button>
    </footer>
  </div>

  <!-- ì•½ê´€/ì„¤ëª…ì„œ ëª¨ë‹¬ -->
  <div id="termsModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header-like">
        <div class="modal-title" id="termsModalTitle">ì•½ê´€ ë° ì„¤ëª…ì„œ ë™ì˜ (1/4)</div>
        <button class="close-x" data-close="termsModal">Ã—</button>
      </div>
      <div class="modal-body">
        <!-- 1) ìš”ì•½ -->
        <div id="termsPage1" class="terms-page active">
          <div class="summary-scroll">
            <h4 class="font-bold text-gray-800 text-lg mb-4 text-center">ìš”ì•½ë³¸</h4>
            <ol class="summary-list">
              <li><span class="summary-num">1.</span><span class="summary-title">ì²´í¬ì¹´ë“œ ê°œì¸íšŒì› í‘œì¤€ì•½ê´€</span><br><span class="summary-content">ì¹´ë“œ ì‚¬ìš©/ê´€ë¦¬ì˜ ê¸°ë³¸ ê·œì¹™ê³¼ ìˆ˜ìˆ˜ë£Œ, ì´ìš© ì œí•œ ë° ë¶„ìŸ ì²˜ë¦¬ ì ˆì°¨ ë“±ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</span></li>
              <li><span class="summary-num">2.</span><span class="summary-title">ê°œì¸(ì‹ ìš©)ì •ë³´ í•„ìˆ˜ì  ì „ì²´ ë™ì˜ì„œ</span><br><span class="summary-content">ìˆ˜ì§‘Â·ì´ìš© í•­ëª©, ëª©ì , ë³´ìœ ê¸°ê°„ ë° ì œ3ì ì œê³µ ë“± í•„ìˆ˜ ë™ì˜ ì‚¬í•­ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</span></li>
              <li><span class="summary-num">3.</span><span class="summary-title">í¬ì¸íŠ¸ ì´ìš©ì•½ê´€</span><br><span class="summary-content">í¬ì¸íŠ¸ ì ë¦½Â·ì‚¬ìš©Â·ì†Œë©¸ ê¸°ì¤€ ë° ìœ ì˜ì‚¬í•­ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.</span></li>
            </ol>
          </div>
        </div>
        <!-- 2~4) PDF -->
        <div id="termsPage2" class="terms-page">
          <h4 class="font-bold text-gray-800 text-lg mb-2 text-center">ì²´í¬ì¹´ë“œ ê°œì¸íšŒì› í‘œì¤€ì•½ê´€</h4>
          <iframe src="https://drive.google.com/file/d/1OuKPmFPrSpbFmtjotrSB6t3F0-ImZcTR/preview" class="pdf-viewer-iframe" allow="autoplay"></iframe>
        </div>
        <div id="termsPage3" class="terms-page">
          <h4 class="font-bold text-gray-800 text-lg mb-2 text-center">ê°œì¸(ì‹ ìš©)ì •ë³´ í•„ìˆ˜ì  ì „ì²´ ë™ì˜ì„œ</h4>
          <iframe src="https://drive.google.com/file/d/12YvgPzqPEiDAUCNji1FYq_HnO6fWEFjG/preview" class="pdf-viewer-iframe" allow="autoplay"></iframe>
        </div>
        <div id="termsPage4" class="terms-page">
          <h4 class="font-bold text-gray-800 text-lg mb-2 text-center">í¬ì¸íŠ¸ ì´ìš©ì•½ê´€</h4>
          <iframe src="https://drive.google.com/file/d/1du1hO_sc9w4uWZGe9aLpniKznJywOHpt/preview" class="pdf-viewer-iframe" allow="autoplay"></iframe>
        </div>
      </div>
      <div class="modal-footer">
        <button id="termsAgreeBtn" class="modal-button">ë™ì˜ ë° ê³„ì†</button>
      </div>
    </div>
  </div>

  <!-- í•„ìˆ˜ ì„œë¥˜ ë°›ê¸° -->
  <div id="sendDocumentsModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header-like">
        <div class="modal-title">í•„ìˆ˜ ì„œë¥˜ ë°›ê¸°</div>
        <button class="close-x" data-close="sendDocumentsModal">Ã—</button>
      </div>
      <div class="modal-body">
        <p class="text-gray-700 text-base mb-4 text-center">
          í•„ìˆ˜ ì„œë¥˜ë¥¼ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë°›ìœ¼ì‹œê² ì–´ìš”?<br>
          <span class="text-sm text-gray-500">ë¬¸ì ë˜ëŠ” ì´ë©”ì¼ ì¤‘ í•˜ë‚˜ë§Œ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤.</span>
        </p>

        <div class="form-group mb-4">
          <label for="smsNumberInput">íœ´ëŒ€í° ë²ˆí˜¸</label>
          <input type="tel" id="smsNumberInput" class="w-full" placeholder="ì˜ˆ: 01012345678" inputmode="numeric" pattern="[0-9]*">
          <button id="sendBySmsBtn" class="modal-button mt-3">ë¬¸ìë¡œ ë°›ê¸°</button>
          <div id="smsWarn" class="inline-warning inline-warning--modal" style="display:none;"></div>
        </div>

        <div class="form-group mb-2">
          <label for="emailAddressInput">ì´ë©”ì¼ ì£¼ì†Œ</label>
          <input type="email" id="emailAddressInput" class="w-full" placeholder="ì˜ˆ: yourname@example.com">
          <button id="sendByEmailBtn" class="modal-button mt-3">ì´ë©”ì¼ë¡œ ë°›ê¸°</button>
          <div id="emailWarn" class="inline-warning inline-warning--modal" style="display:none;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="sendDocumentsCloseBtn" class="w-full font-bold py-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ê³µìš© ì•ˆë‚´ ëª¨ë‹¬ -->
  <div id="infoModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header-like">
        <div class="modal-title">ì•ˆë‚´</div>
        <button class="close-x" data-close="infoModal">Ã—</button>
      </div>
      <div class="modal-body">
        <p id="infoModalMsg" class="text-center text-gray-700 whitespace-pre-line"></p>
      </div>
      <div class="modal-footer">
        <button id="infoModalOk" class="modal-button">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì¹´ë“œ ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
  <div id="imageModal" class="modal-overlay image-modal">
    <div class="modal-content">
      <div class="modal-header-like">
        <div class="modal-title" id="imageCaption">ë¯¸ë¦¬ë³´ê¸°</div>
        <button class="close-x" data-close="imageModal" style="color:#fff;">Ã—</button>
      </div>
      <div class="image-stage" id="imageStage">
        <img id="zoomImg" src="" alt="">
      </div>
      <div class="image-caption" id="imageAlt"></div>
    </div>
  </div>

  <!-- ì¹´ë“œ ì„ íƒ í™•ì¸ ëª¨ë‹¬ -->
  <div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header-like">
        <div class="modal-title">í™•ì¸</div>
        <button class="close-x" data-close="confirmModal">Ã—</button>
      </div>
      <div class="modal-body">
        <p id="confirmMsg" class="text-center text-gray-700 whitespace-pre-line"></p>
      </div>
      <div class="modal-footer" style="gap:.5rem;">
        <button id="confirmCancel" class="modal-button" style="background:#9ca3af">ì·¨ì†Œ</button>
        <button id="confirmOk" class="modal-button">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== ê³µí†µ ===== */
    const STORAGE_KEY = 'bnkCardIssueData';
    function setVHUnit(){ const vh=window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', `${vh}px`);}
    setVHUnit(); window.addEventListener('resize', setVHUnit);

    function openModal(id){ document.getElementById(id).classList.add('show'); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    document.querySelectorAll('.close-x').forEach(btn=> btn.addEventListener('click', ()=> closeModal(btn.dataset.close)));
    document.getElementById('infoModalOk').addEventListener('click', ()=> closeModal('infoModal'));
    function showCenter(msg, ms){ document.getElementById('infoModalMsg').textContent=msg; openModal('infoModal'); if(ms){ setTimeout(()=> closeModal('infoModal'), ms); } }

    /* ===== ì•„ì½”ë””ì–¸ ì—´ê³  ë‹«ê¸° ===== */
    function setAccordionOpen(sectionEl, open){
      const header = sectionEl.querySelector('.accordion-header');
      const content = sectionEl.querySelector('.accordion-content');
      if(open){
        header.classList.add('active');
        content.classList.add('open');
        content.style.maxHeight = content.scrollHeight + 'px';
      }else{
        header.classList.remove('active');
        content.style.maxHeight = content.scrollHeight + 'px';
        requestAnimationFrame(()=>{
          content.style.maxHeight = '0px';
          content.classList.remove('open');
        });
      }
    }
    const cardDesignSection = document.getElementById('cardDesignSection');
    const customerInfoSection = document.getElementById('customerInfoSection');
    const termsDocsSection = document.getElementById('termsDocsSection');

    document.querySelectorAll('.accordion-header').forEach(h=>{
      h.addEventListener('click', ()=>{
        const section = h.parentElement;
        if(section.classList.contains('confirmed')) return;
        const open = h.classList.contains('active');
        document.querySelectorAll('.accordion-section').forEach(s=>{
          if(s!==section && !s.classList.contains('confirmed')) setAccordionOpen(s, false);
        });
        setAccordionOpen(section, !open);
        section.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    const prevButton=document.getElementById('prevButton');
    const nextButton=document.getElementById('nextButton');
    prevButton.addEventListener('click', ()=> { Voice.cancel(); location.href='/foreign'; });

    let isCardDesignCompleted=false, isCustomerInfoCompleted=false, isTermsAndDocsCompleted=false;

    function updateNext(){
      if(isCardDesignCompleted && isCustomerInfoCompleted && isTermsAndDocsCompleted){
        nextButton.disabled=false;
        nextButton.classList.remove('bg-gray-400','cursor-not-allowed');
        nextButton.classList.add('bg-red-500');
      }else{
        nextButton.disabled=true;
        nextButton.classList.add('bg-gray-400','cursor-not-allowed');
        nextButton.classList.remove('bg-red-500');
      }
    }

    /* ===== ì¹´ë“œ ìŠ¬ë¼ì´ë” ===== */
    const cardSlider=document.getElementById('cardSlider');
    const cardSlideItems=document.querySelectorAll('.card-slide-item');
    const selectCardBtn=document.getElementById('selectCardBtn');
    const slideLeftBtn=document.getElementById('slideLeftBtn');
    const slideRightBtn=document.getElementById('slideRightBtn');
    let currentSlideIndex=0, selectedCardId=null;

    function scrollToSlide(i){
      const item=cardSlideItems[i]; if(!item) return;
      const left=item.offsetLeft - (cardSlider.clientWidth - item.clientWidth)/2;
      cardSlider.scroll({left, behavior:'smooth'}); currentSlideIndex=i;
    }
    slideLeftBtn.addEventListener('click', ()=> scrollToSlide(Math.max(0,currentSlideIndex-1)));
    slideRightBtn.addEventListener('click', ()=> scrollToSlide(Math.min(cardSlideItems.length-1,currentSlideIndex+1)));
    cardSlider.addEventListener('scroll', ()=>{
      clearTimeout(cardSlider._t);
      cardSlider._t=setTimeout(()=>{
        const list=[...cardSlideItems];
        const center=window.innerWidth/2;
        let best=0, bestDist=1e9;
        list.forEach((el,i)=>{
          const r=el.getBoundingClientRect();
          const d=Math.abs(r.left + r.width/2 - center);
          if(d<bestDist){ bestDist=d; best=i; }
        });
        currentSlideIndex=best;
        selectCardBtn.disabled=(selectedCardId!==null);
      },80);
    });

    function cardNameById(id){
      if(id==='card-a') return 'BNKì‡¼í•‘í™˜ì „ ì²´í¬ì¹´ë“œA';
      if(id==='card-b') return 'BNKì‡¼í•‘í™˜ì „ ì²´í¬ì¹´ë“œB';
      return 'BNKì‡¼í•‘í™˜ì „ ì²´í¬ì¹´ë“œC';
    }

    function openConfirm(msg, onOk){
      document.getElementById('confirmMsg').textContent=msg;
      openModal('confirmModal');
      document.getElementById('confirmCancel').onclick=()=> closeModal('confirmModal');
      document.getElementById('confirmOk').onclick=()=>{ closeModal('confirmModal'); onOk&&onOk(); };
    }

    document.getElementById('selectCardBtn').addEventListener('click', ()=>{
      const item=cardSlideItems[currentSlideIndex]; if(!item) return;
      const msg=`ì •ë§ '${cardNameById(item.dataset.cardId)}'\në””ìì¸ìœ¼ë¡œ ê²°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
      openConfirm(msg, ()=>{
        selectedCardId=item.dataset.cardId;
        cardSlideItems.forEach(el=> el.classList.toggle('selected', el===item));
        isCardDesignCompleted=true;
        cardDesignSection.classList.add('confirmed');
        setAccordionOpen(cardDesignSection,false);
        setTimeout(()=> setAccordionOpen(customerInfoSection,true), 500);
        saveState();               // ì €ì¥
        updateNext();
      });
    });

    /* ì´ë¯¸ì§€ í™•ëŒ€ */
    const imageModal=document.getElementById('imageModal');
    const zoomImg=document.getElementById('zoomImg');
    const imageCaption=document.getElementById('imageCaption');
    const imageAlt=document.getElementById('imageAlt');
    const imageStage=document.getElementById('imageStage');
    let zoomScale=1,isPanning=false,startX=0,startY=0,scrollLeft=0,scrollTop=0;

    function openImagePreview(src,alt){
      zoomScale=1; zoomImg.style.transform='scale(1)';
      zoomImg.src=src; zoomImg.alt=alt||'';
      imageCaption.textContent='ë¯¸ë¦¬ë³´ê¸°'; imageAlt.textContent=alt||'';
      openModal('imageModal');
    }
    let lastTap=0;
    function toggleZoom(e){
      const now=Date.now(); const dbl=(now-lastTap)<300; lastTap=now;
      if(!dbl) return;
      zoomScale=(zoomScale===1)?2:1; zoomImg.style.transform=`scale(${zoomScale})`;
    }
    zoomImg.addEventListener('click', toggleZoom);
    zoomImg.addEventListener('touchend', toggleZoom);

    imageStage.addEventListener('mousedown', e=>{
      if(zoomScale===1) return;
      isPanning=true; startX=e.pageX-imageStage.offsetLeft; startY=e.pageY-imageStage.offsetTop;
      scrollLeft=imageStage.scrollLeft; scrollTop=imageStage.scrollTop;
    });
    imageStage.addEventListener('mousemove', e=>{
      if(!isPanning) return; e.preventDefault();
      const x=e.pageX-imageStage.offsetLeft, y=e.pageY-imageStage.offsetTop;
      imageStage.scrollLeft=scrollLeft-(x-startX); imageStage.scrollTop=scrollTop-(y-startY);
    });
    ['mouseup','mouseleave'].forEach(evt=> imageStage.addEventListener(evt, ()=> isPanning=false));
    document.querySelectorAll('.card-slide-item img').forEach(img=> img.addEventListener('click', ()=> openImagePreview(img.src,img.alt)));

    /* ===== ê³ ê° ì •ë³´ ===== */
    const englishNameInput=document.getElementById('english-name');
    const englishWarn=document.getElementById('englishWarn');
    const occupationSelect=document.getElementById('occupation');
    const ownFundsRadios=document.querySelectorAll('input[name="own-funds"]');
    const postalCodeInput=document.getElementById('postalCode');
    const baseAddressInput=document.getElementById('baseAddress');
    const detailAddressInput=document.getElementById('detailAddress');
    const findAddressBtn=document.getElementById('findAddressBtn');
    const addressDoneBtn=document.getElementById('addressDoneBtn');
    const customerInfoWarning=document.getElementById('customerInfoWarning');

    function validCustomerInfo(){
      const nameOk=englishNameInput.value.trim().length>0;
      const jobOk=occupationSelect.value!=='';
      const ownOk=[...ownFundsRadios].some(r=>r.checked);
      const addrOk=postalCodeInput.value && baseAddressInput.value && detailAddressInput.value.trim();
      return {nameOk,jobOk,ownOk,addrOk,all:(nameOk&&jobOk&&ownOk&&addrOk)};
    }

    function scheduleSave(){ clearTimeout(scheduleSave._t); scheduleSave._t=setTimeout(saveState, 200); }

    englishNameInput.addEventListener('input', ()=>{
      const hasHangul=/[ã„±-ã…ã…-ã…£ê°€-í£]/.test(englishNameInput.value);
      englishWarn.textContent='ì˜ë¬¸ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: HONG GILDONG).';
      englishWarn.style.display = hasHangul ? 'block' : 'none';
      scheduleSave();
    });
    occupationSelect.addEventListener('change', scheduleSave);
    ownFundsRadios.forEach(r=> r.addEventListener('change', scheduleSave));
    detailAddressInput.addEventListener('input', scheduleSave);

    findAddressBtn.addEventListener('click', ()=>{
      new daum.Postcode({
        oncomplete: function(data){
          postalCodeInput.value = data.zonecode || '';
          baseAddressInput.value = (data.roadAddress || data.jibunAddress || '');
          detailAddressInput.focus();
          scheduleSave();
        }
      }).open();
    });

    addressDoneBtn.addEventListener('click', ()=>{
      const v=validCustomerInfo();
      if(!v.all){
        customerInfoWarning.style.display='block';
        customerInfoWarning.textContent='ì˜ë¬¸ëª…/ì§ì—…/ìê¸ˆ ì—¬ë¶€/ì£¼ì†Œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
      }
      customerInfoWarning.style.display='none';
      isCustomerInfoCompleted=true;
      customerInfoSection.classList.add('confirmed');
      setAccordionOpen(customerInfoSection,false);
      setTimeout(()=> setAccordionOpen(termsDocsSection,true), 500);
      saveState();                       // ì €ì¥
      updateNext();
    });

    /* ===== ì•½ê´€ & ì„œë¥˜ ===== */
    const openTermsModalBtn=document.getElementById('openTermsModalBtn');
    const termsModalTitle=document.getElementById('termsModalTitle');
    const termsPages=document.querySelectorAll('#termsModal .terms-page');
    let termsIdx=0;
    function showTermsPage(i){
      termsPages.forEach((p,idx)=> p.classList.toggle('active', idx===i));
      termsModalTitle.textContent=`ì•½ê´€ ë° ì„¤ëª…ì„œ ë™ì˜ (${i+1}/4)`;
    }
    openTermsModalBtn.addEventListener('click', ()=>{ termsIdx=0; showTermsPage(0); openModal('termsModal'); });
    document.getElementById('termsAgreeBtn').addEventListener('click', ()=>{
      termsIdx++;
      if(termsIdx<termsPages.length){ showTermsPage(termsIdx); }
      else{ closeModal('termsModal'); openModal('sendDocumentsModal'); }
    });

    const smsNumberInput=document.getElementById('smsNumberInput');
    const emailAddressInput=document.getElementById('emailAddressInput');
    const sendBySmsBtn=document.getElementById('sendBySmsBtn');
    const sendByEmailBtn=document.getElementById('sendByEmailBtn');
    const sendDocumentsCloseBtn=document.getElementById('sendDocumentsCloseBtn');
    const smsWarn=document.getElementById('smsWarn');
    const emailWarn=document.getElementById('emailWarn');
    let hasDeliveredDocuments=false;
    let docsDelivery=null;   // {method:'sms'|'email', value:string, at:ISO}

    function validatePhone(v){ return /^\d{10,11}$/.test((v||'').trim()); }
    function validateEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((v||'').trim()); }

    function simulateSend(cb){
      showCenter('ì „ì†¡ ì¤‘...', null);
      setTimeout(()=>{ closeModal('infoModal'); showCenter('ì „ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 1200); setTimeout(cb, 1200); }, 900);
    }

    function finishDocs(){
      hasDeliveredDocuments=true;
      isTermsAndDocsCompleted=true;
      termsDocsSection.classList.add('confirmed');
      setAccordionOpen(termsDocsSection,false);
      saveState();                         // ì €ì¥
      updateNext();
      closeModal('sendDocumentsModal');
    }

    sendBySmsBtn.addEventListener('click', ()=>{
      smsWarn.style.display='none';
      const val=smsNumberInput.value.trim();
      if(!validatePhone(val)){ smsWarn.textContent='íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.'; smsWarn.style.display='block'; return; }
      docsDelivery={method:'sms', value:val, at:new Date().toISOString()};
      simulateSend(finishDocs);
    });

    sendByEmailBtn.addEventListener('click', ()=>{
      emailWarn.style.display='none';
      const val=emailAddressInput.value.trim();
      if(!validateEmail(val)){ emailWarn.textContent='ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.'; emailWarn.style.display='block'; return; }
      docsDelivery={method:'email', value:val, at:new Date().toISOString()};
      simulateSend(finishDocs);
    });

    sendDocumentsCloseBtn.addEventListener('click', ()=>{
      if(!hasDeliveredDocuments){
        showCenter('ë¬¸ì ë˜ëŠ” ì´ë©”ì¼ ì¤‘ í•˜ë‚˜ë¡œ ì„œë¥˜ë¥¼ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.', 1500);
        return;
      }
      closeModal('sendDocumentsModal');
    });

    /* ===== ì €ì¥/ë³µì› ===== */
    function payloadFromUI(){
      const selected = selectedCardId ? {
        id: selectedCardId,
        name: cardNameById(selectedCardId)
      } : null;

      const own = document.querySelector('input[name="own-funds"]:checked')?.value || '';
      const payload = {
        selectedCard: selected,
        customer: {
          englishName: (englishNameInput.value || '').trim(),
          occupation: occupationSelect.value || '',
          ownFunds: own,
          address: {
            postalCode: postalCodeInput.value || '',
            baseAddress: baseAddressInput.value || '',
            detailAddress: detailAddressInput.value || ''
          }
        },
        consent: {
          termsAndDocs: !!isTermsAndDocsCompleted,
          delivered: !!hasDeliveredDocuments,
          method: docsDelivery?.method || '',
          destination: docsDelivery?.value || '',
          consentedAt: docsDelivery?.at || ''
        },
        progress: {
          card: !!isCardDesignCompleted,
          customer: !!isCustomerInfoCompleted,
          terms: !!isTermsAndDocsCompleted
        },
        savedAt: new Date().toISOString()
      };
      return payload;
    }

    function saveState(){
      try{
        const data = payloadFromUI();
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }catch(e){ console.warn('saveState failed', e); }
    }

    function restoreState(){
      try{
        const raw = sessionStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);

        // ì¹´ë“œ
        if(data.selectedCard?.id){
          selectedCardId = data.selectedCard.id;
          cardSlideItems.forEach(el=> el.classList.toggle('selected', el.dataset.cardId===selectedCardId));
          isCardDesignCompleted = !!data.progress?.card;
          if(isCardDesignCompleted) cardDesignSection.classList.add('confirmed');
        }

        // ê³ ê° ì •ë³´
        if(data.customer){
          englishNameInput.value = data.customer.englishName || '';
          occupationSelect.value = data.customer.occupation || '';
          if(data.customer.ownFunds){
            const r = document.querySelector(`input[name="own-funds"][value="${data.customer.ownFunds}"]`);
            if(r) r.checked = true;
          }
          if(data.customer.address){
            postalCodeInput.value = data.customer.address.postalCode || '';
            baseAddressInput.value  = data.customer.address.baseAddress || '';
            detailAddressInput.value = data.customer.address.detailAddress || '';
          }
          isCustomerInfoCompleted = !!data.progress?.customer;
          if(isCustomerInfoCompleted) customerInfoSection.classList.add('confirmed');
        }

        // ì•½ê´€ & ì „ì†¡
        if(data.consent){
          isTermsAndDocsCompleted = !!data.consent.termsAndDocs;
          hasDeliveredDocuments   = !!data.consent.delivered;
          if(isTermsAndDocsCompleted) termsDocsSection.classList.add('confirmed');
          docsDelivery = (data.consent.method? {method:data.consent.method, value:data.consent.destination, at:data.consent.consentedAt} : null);
        }

        // ì—´ë¦´ ê³³ ê²°ì •
        if(!isCardDesignCompleted){ setAccordionOpen(cardDesignSection,true); }
        else if(!isCustomerInfoCompleted){ setAccordionOpen(cardDesignSection,false); setAccordionOpen(customerInfoSection,true); }
        else if(!isTermsAndDocsCompleted){ setAccordionOpen(cardDesignSection,false); setAccordionOpen(customerInfoSection,false); setAccordionOpen(termsDocsSection,true); }
        else { setAccordionOpen(cardDesignSection,false); setAccordionOpen(customerInfoSection,false); setAccordionOpen(termsDocsSection,false); }

        updateNext();
      }catch(e){ console.warn('restoreState failed', e); }
    }

    // ì´ˆê¸° ì—´ë¦¼ ìƒíƒœ(ë³µì› ì „ ê¸°ë³¸ê°’)
    setAccordionOpen(cardDesignSection, true);
    setAccordionOpen(customerInfoSection, false);
    setAccordionOpen(termsDocsSection, false);

    // ë³µì› ì‹œë„
    restoreState();

    // ë‹¤ìŒìœ¼ë¡œ: ì €ì¥ í›„ ì´ë™
    nextButton.addEventListener('click', ()=>{
      if(nextButton.disabled) return;
      saveState();
      Voice.cancel();
      location.href = '/foreign8';
    });

    /* ===== ìŒì„± ì•ˆë‚´ (Web Speech + ë„¤ì´í‹°ë¸Œ ë¸Œë¦¿ì§€) ===== */
    const voiceBtn = document.getElementById('voiceGuideBtn');
    const voiceIconPlay = document.getElementById('voiceIconPlay');
    const voiceIconStop = document.getElementById('voiceIconStop');
    const voiceLabel = document.getElementById('voiceLabel');
    const voicePanel = document.getElementById('voicePanel');
    const voiceCloseBtn = document.getElementById('voiceCloseBtn');
    const voiceReplayBtn = document.getElementById('voiceReplayBtn');

    const Voice = (function(){
      let speaking = false;
      let queue = [];
      let current = null;

      const hasWebSpeech = ('speechSynthesis' in window) && ('SpeechSynthesisUtterance' in window);
      const hasAndroid = !!window.AndroidTTS?.speak;
      const hasIOS = !!(window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.tts);

      function useNativeSpeak(text){
        const r = 1.0;
        if(hasAndroid){
          try{ window.AndroidTTS.speak(String(text), r); return true; }catch(e){ console.warn(e); }
        }
        if(hasIOS){
          try{ window.webkit.messageHandlers.tts.postMessage({action:'speak', text:String(text), rate:r}); return true; }catch(e){ console.warn(e); }
        }
        return false;
      }
      function useNativeStop(){
        if(hasAndroid){
          try{ window.AndroidTTS.stop(); return true; }catch(e){ console.warn(e); }
        }
        if(hasIOS){
          try{ window.webkit.messageHandlers.tts.postMessage({action:'stop'}); return true; }catch(e){ console.warn(e); }
        }
        return false;
      }

      function speakWeb(text, onend){
        const u = new SpeechSynthesisUtterance(String(text));
        u.lang = 'ko-KR';
        u.rate = 1.0;
        u.onend = onend || null;
        u.onerror = function(){ onend && onend(); };
        window.speechSynthesis.speak(u);
      }

      function nextInQueue(){
        if(queue.length === 0){ current = null; speaking = false; setUI(false); return; }
        current = queue.shift();
        if(useNativeSpeak(current)){
          speaking = true; setUI(true);
          const approx = Math.max(1500, current.length * 60);
          setTimeout(()=>{ nextInQueue(); }, approx);
        }else if(hasWebSpeech){
          speaking = true; setUI(true);
          speakWeb(current, ()=> nextInQueue());
        }else{
          speaking = false; setUI(false);
        }
      }

      function setUI(isOn){
        voiceBtn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
        voiceIconPlay.classList.toggle('hidden', isOn);
        voiceIconStop.classList.toggle('hidden', !isOn);
        voiceLabel.textContent = isOn ? 'ìŒì„± ì•ˆë‚´ ë„ê¸°' : 'ìŒì„± ì•ˆë‚´ ì¼œê¸°';
        voiceBtn.setAttribute('aria-label', voiceLabel.textContent);
        voiceBtn.setAttribute('title', voiceLabel.textContent);
      }

      function start(lines){
        if(speaking) cancel();
        queue = Array.isArray(lines) ? lines.slice() : [String(lines||'')];
        nextInQueue();
      }
      function cancel(){
        queue = [];
        current = null;
        speaking = false;
        useNativeStop();
        if(('speechSynthesis' in window)){ try{ window.speechSynthesis.cancel(); }catch(e){} }
        setUI(false);
      }
      function toggle(lines){
        if(speaking){ cancel(); } else { start(lines); }
      }
      return { start, cancel, toggle, isSpeaking:()=>speaking };
    })();

    // í˜„ì¬ ì…ë ¥ ìƒíƒœë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°„ë‹¨í•œ ì„¤ëª… + í•­ëª©ë³„ ì•ˆë‚´ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    function buildVoiceScript(){
      const lines = [];
      lines.push('ì¹´ë“œ ë°œê¸‰ ì‹ ì²­ í™”ë©´ì…ë‹ˆë‹¤. ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•´ ì£¼ì„¸ìš”. ì¹´ë“œ ë””ìì¸ ì„ íƒ, ê³ ê° ì •ë³´ ì…ë ¥, ì•½ê´€ ë™ì˜ê°€ ì™„ë£Œë˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.');

      // ì¹´ë“œ ë””ìì¸
      if(selectedCardId){
        lines.push(`ì„ íƒí•œ ì¹´ë“œ ë””ìì¸ì€ ${cardNameById(selectedCardId)} ì…ë‹ˆë‹¤.`);
      }else{
        lines.push('ì•„ì§ ì¹´ë“œ ë””ìì¸ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ì…¨ì–´ìš”. ì¹´ë“œ ë””ìì¸ ì„ íƒ ì˜ì—­ì—ì„œ ì›í•˜ëŠ” ë””ìì¸ì„ ê³ ë¥´ì‹  ë’¤ ì„ íƒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.');
      }

      // ê³ ê° ì •ë³´
      const nameVal = (englishNameInput.value || '').trim();
      const jobVal = (occupationSelect.value || '').trim();
      const ownVal = (document.querySelector('input[name="own-funds"]:checked')?.value || '').trim();
      const addrOk = postalCodeInput.value && baseAddressInput.value && detailAddressInput.value.trim();

      if(nameVal){ lines.push(`ì˜ë¬¸ëª…ì€ ${nameVal}ë¡œ ì…ë ¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`); }
      else{ lines.push('ì˜ë¬¸ëª…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì˜ˆì‹œ, í™ê¸¸ë™ì€ ì—ì´ì¹˜ ì˜¤ ì—” ì§€, ê³µë°±, ì§€ ì•„ì´ ì—˜ ë”” ì˜¤ ì—” ì§€, ì™€ ê°™ì´ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); }

      if(jobVal){ lines.push(`ì§ì—…ì€ ${jobVal}ë¡œ ì„ íƒë˜ì–´ ìˆìŠµë‹ˆë‹¤.`); }
      else{ lines.push('ì§ì—… êµ¬ë¶„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); }

      if(ownVal){ lines.push(`ìê¸ˆ ì¶œì²˜ëŠ” ${ownVal === 'yes' ? 'ë³¸ì¸ ìê¸ˆ' : 'ë³¸ì¸ ì™¸ ìê¸ˆ'}ìœ¼ë¡œ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.`); }
      else{ lines.push('ìê¸ˆì´ ë³¸ì¸ ìê¸ˆì¸ì§€ ì—¬ë¶€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.'); }

      if(addrOk){
        lines.push(`ì¹´ë“œ ìˆ˜ë ¹ ì£¼ì†Œê°€ ì…ë ¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìš°í¸ë²ˆí˜¸ ${postalCodeInput.value}, ê¸°ë³¸ì£¼ì†Œì™€ ìƒì„¸ì£¼ì†Œê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }else{
        lines.push('ì¹´ë“œ ìˆ˜ë ¹ ì£¼ì†Œê°€ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìš°í¸ë²ˆí˜¸ ì°¾ê¸° ë²„íŠ¼ìœ¼ë¡œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      }

      // ì•½ê´€
      if(isTermsAndDocsCompleted){
        lines.push('ì•½ê´€ ë° ì„¤ëª…ì„œ ë™ì˜ì™€ ì„œë¥˜ ì „ë‹¬ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }else{
        lines.push('ì•½ê´€ ë° ì„¤ëª…ì„œ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì•½ê´€ ë³´ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆœì„œëŒ€ë¡œ í™•ì¸ í›„ ë™ì˜í•´ ì£¼ì„¸ìš”.');
      }

      // ì „ì²´ ì§„í–‰ ìƒíƒœ
      if(isCardDesignCompleted && isCustomerInfoCompleted && isTermsAndDocsCompleted){
        lines.push('ëª¨ë“  í•­ëª©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í•˜ë‹¨ì˜ ë‹¤ìŒìœ¼ë¡œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§„í–‰í•´ ì£¼ì„¸ìš”.');
      }else{
        lines.push('ëª¨ë“  í•­ëª©ì´ ì™„ë£Œë˜ë©´ í•˜ë‹¨ì˜ ë‹¤ìŒìœ¼ë¡œ ë²„íŠ¼ì´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í™œì„±í™”ë©ë‹ˆë‹¤.');
      }
      return lines;
    }

    // ìŒì„± ì•ˆë‚´ ë²„íŠ¼/íŒ¨ë„
    voiceBtn.addEventListener('click', function(){
      voicePanel.classList.toggle('open');
      Voice.toggle(buildVoiceScript());
    });
    voiceCloseBtn.addEventListener('click', function(){ voicePanel.classList.remove('open'); });
    voiceReplayBtn.addEventListener('click', function(){ Voice.start(buildVoiceScript()); });

    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ì •ì§€
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ Voice.cancel(); } });
    window.addEventListener('pagehide', ()=> Voice.cancel());
  </script>
</body>
</html>
